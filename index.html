<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Quest</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400;1,600&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>

/* ══════════════════════════════════════════════
   TOKENS
══════════════════════════════════════════════ */
:root {
  --bg:          #0f0d0b;
  --surface:     #161310;
  --surface2:    #1e1a14;
  --surface3:    #252018;

  --border:      #332e22;
  --border-mid:  #4a4230;
  --border-gold: #6b5c34;

  --gold:        #c4a24a;
  --gold-light:  #e2c06a;
  --gold-dim:    #7a6230;
  --gold-glow:   rgba(196,162,74,0.22);

  --xp:          #5b8fcc;
  --xp-dim:      #1c3458;

  --green:       #3a9e6a;
  --red:         #b83c2e;
  --orange:      #d4622a;
  --teal:        #2ab89a;
  --teal-glow:   rgba(42,184,154,0.18);

  --text:        #e6dcc8;
  --text-mid:    #b8a882;
  --text-dim:    #8a7d62;
  --text-dark:   #5a5040;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 18px;
  line-height: 1.5;
  min-height: 100vh;
}

/* Grain */
body::after {
  content: '';
  position: fixed; inset: 0;
  pointer-events: none; z-index: 9999;
  opacity: 0.018;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* ══════════════════════════════════════════════
   APP SHELL
══════════════════════════════════════════════ */
.app {
  max-width: 1080px;
  margin: 0 auto;
  padding: 0 24px 80px;
}

/* ── Header ── */
.header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  padding: 20px 0 16px;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--border);
}
.header-brand { display: flex; align-items: baseline; gap: 12px; }
.header-icon  { display: none; }
.header-sigil {
  font-size: 18px;
  color: var(--gold-dim);
  line-height: 1;
  opacity: 0.7;
  margin-right: 2px;
}
.header h1 {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  color: var(--gold);
  letter-spacing: 0.18em;
  line-height: 1;
}
.header-tagline {
  font-size: 16px;
  color: var(--text-dark);
  font-style: italic;
}
.header-auth {
  display: flex; align-items: center; gap: 10px;
  font-size: 15px; color: var(--text-dark);
}
.header-auth-email { font-style: italic; }
.signout-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-dark);
  padding: 3px 10px; border-radius: 2px;
  cursor: pointer;
  font-family: 'Cinzel', serif;
  font-size: 13px; letter-spacing: 0.08em;
  transition: all 0.2s;
}
.signout-btn:hover { border-color: var(--border-gold); color: var(--text-mid); }

/* ── Two-column layout ── */
.layout {
  display: grid;
  grid-template-columns: 380px 1fr;
  gap: 22px;
  align-items: start;
}
.col-left {
  display: flex;
  flex-direction: column;
  gap: 12px;
  isolation: isolate;  /* prevent child paint escaping column bounds */
  overflow: hidden;    /* hard clip — map canvas translateY stays inside */
}
.col-right {
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-width: 0;
}
@media (max-width: 820px) {
  .layout { grid-template-columns: 1fr; }

}

/* ── Shared inputs ── */
.form-input, .field-input, .hero-name-input, .budget-input {
  background: var(--surface2);
  border: 1px solid var(--border-mid);
  border-radius: 2px;
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 21px;
  padding: 9px 12px;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
.form-input:focus, .field-input:focus,
.hero-name-input:focus, .budget-input:focus { border-color: var(--gold-dim); }
.form-input::placeholder, .field-input::placeholder,
.hero-name-input::placeholder, .budget-input::placeholder { color: var(--text-dark); }

/* ── Shared buttons ── */
.btn-primary {
  width: 100%;
  background: var(--gold-dim);
  border: 1px solid var(--gold-dim);
  border-radius: 2px;
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
  padding: 11px 24px; cursor: pointer; transition: all 0.2s;
}
.btn-primary:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.btn-secondary {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 2px; color: var(--text-dim);
  font-family: 'Cinzel', serif;
  font-size: 14px; letter-spacing: 0.08em;
  padding: 9px 18px; cursor: pointer; transition: all 0.2s;
}
.btn-secondary:hover { border-color: var(--border-gold); color: var(--text-mid); }

/* ── Panel section label ── */
.panel-head {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.panel-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* ══════════════════════════════════════════════
   CHARACTER PANEL (left, top)
══════════════════════════════════════════════ */
.char-panel {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 18px;
  position: relative; overflow: hidden;
}
.char-panel::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}

.char-identity {
  display: flex; align-items: center;
  gap: 12px; margin-bottom: 18px;
}
.char-avatar {
  width: 48px; height: 48px;
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px;
  background: var(--surface2); flex-shrink: 0;
}
.char-name {
  font-family: 'Cinzel', serif;
  font-size: 21px; color: var(--gold);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.char-class { font-size: 16px; color: var(--text-dim); font-style: italic; margin-top: 1px; }
.char-level-badge { margin-left: auto; flex-shrink: 0; text-align: right; }
.level-num {
  font-family: 'Cinzel', serif;
  font-size: 30px; color: var(--gold-light); line-height: 1;
  text-shadow: 0 0 18px var(--gold-glow);
}
.level-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}

/* stat rows */
.stat-block { margin-bottom: 14px; }
.stat-label-row {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-bottom: 5px;
}
.stat-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.14em;
}
.stat-value { font-size: 17px; color: var(--text-dim); }
.stat-value strong { color: var(--xp); font-family: 'Cinzel', serif; font-size: 17px; }
.stat-value.gold-val strong { color: var(--gold); }

.bar-track {
  height: 5px;
  background: var(--surface2);
  border-radius: 100px;
  overflow: hidden;
}
.bar-fill {
  height: 100%; border-radius: 100px;
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1);
  min-width: 0;
}
.bar-fill.xp   { background: linear-gradient(90deg, var(--xp-dim), var(--xp)); }
.bar-fill.coin { background: linear-gradient(90deg, var(--gold-dim), var(--gold)); }
.bar-fill.coin.danger  { background: linear-gradient(90deg, #4a1810, var(--red)); }
.bar-fill.coin.warning { background: linear-gradient(90deg, #4a3010, var(--orange)); }

.stat-sub {
  display: flex; justify-content: space-between;
  margin-top: 3px;
  font-size: 14px; color: var(--text-dark); font-style: italic;
}
.coin-status { font-size: 14px; font-style: italic; }
.coin-status.danger  { color: var(--red); }
.coin-status.warning { color: var(--orange); }

/* Treasury rule */
.rule { height: 1px; background: var(--border); margin: 14px 0 10px; }
.rule-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  text-align: center; margin: -17px 0 12px;
}
.rule-label span {
  background: var(--surface);
  padding: 0 10px;
}

/* Road Gold row */
.vault-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 11px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-left: 2px solid var(--gold-dim);
  border-radius: 2px;
  margin-top: 10px;
}
.vault-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 1px;
}
.vault-sub  { font-size: 15px; color: var(--text-dim); font-style: italic; }
.vault-amount {
  font-family: 'Cinzel', serif;
  font-size: 24px; color: var(--gold);
  text-shadow: 0 0 12px var(--gold-glow);
}
.vault-amount.empty { color: var(--text-dark); font-size: 18px; text-shadow: none; }

/* Floats */
.gold-float, .coin-float, .xp-float {
  position: fixed;
  font-family: 'Cinzel', serif; font-size: 16px;
  pointer-events: none; z-index: 9990; opacity: 0;
}
.gold-float { color: var(--gold); }
.coin-float { color: var(--gold); }
.xp-float   { color: var(--xp); }
.gold-float.pop { animation: floatUp 1.1s ease-out forwards; }
.coin-float.pop { animation: floatDown 1.0s ease-out forwards; }
.xp-float.pop   { animation: floatUp 1.1s ease-out forwards; }
@keyframes floatUp {
  0%   { opacity:1; transform:translateX(-50%) translateY(0) scale(1); }
  15%  { opacity:1; transform:translateX(-50%) translateY(-14px) scale(1.2); }
  100% { opacity:0; transform:translateX(-50%) translateY(-36px) scale(0.9); }
}
@keyframes floatDown {
  0%   { opacity:1; transform:translateX(-50%) translateY(0); }
  100% { opacity:0; transform:translateX(-50%) translateY(20px); }
}
.xp-bar-fill.pulse { animation: barPulse 0.6s ease; }
@keyframes barPulse { 0%,100%{filter:brightness(1)} 50%{filter:brightness(2)} }

/* ══════════════════════════════════════════════
   MAP PANEL (left, below char)
══════════════════════════════════════════════ */
.map-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.map-panel-head {
  padding: 12px 14px 10px;
  display: flex; align-items: flex-start; justify-content: space-between;
}
.map-loc-block { display: flex; flex-direction: column; gap: 1px; }
.map-section-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.16em;
}
.map-current-loc { font-family: 'Cinzel', serif; font-size: 17px; color: var(--gold); }
.map-zone-tag    { font-size: 15px; color: var(--text-dim); font-style: italic; }

.map-right-col  { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
.map-hearts     { display: flex; gap: 3px; }
.map-heart      { font-size: 16px; transition: all 0.3s; }
.map-heart.empty { filter: grayscale(1) opacity(0.2); }

.map-badges-row { display: flex; gap: 4px; }
.badge-slot {
  width: 22px; height: 22px; border-radius: 50%;
  border: 1px solid var(--border); background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; position: relative; cursor: default; transition: all 0.3s;
}
.badge-slot.earned { border-color: var(--gold); box-shadow: 0 0 7px var(--gold-glow); }
.badge-slot.locked { opacity: 0.2; }
.badge-slot .badge-tip {
  display: none; position: absolute;
  bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%);
  background: var(--surface3); border: 1px solid var(--border-mid);
  border-radius: 2px; padding: 3px 7px;
  font-size: 13px; color: var(--text-mid); white-space: nowrap;
  z-index: 100; pointer-events: none;
  font-family: 'Cinzel', serif;
}
.badge-slot:hover .badge-tip { display: block; }

.map-viewport {
  position: relative;
  overflow: hidden;
  border-radius: 4px;
  border: 1px solid var(--border-gold);
}
.node-map {
  position: relative; width: 100%;
}
.node-map svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
.node-map-inner { position: absolute; top: 0; left: 0; width: 100%; }

.map-node-wrap {
  position: absolute; transform: translate(-50%,-50%);
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  cursor: default; z-index: 2;
}
.map-node-circle {
  width: 38px; height: 38px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; transition: all 0.3s;
  border: 1.5px solid var(--border);
  background: rgba(15,13,11,0.85);
  backdrop-filter: blur(2px);
}
.map-node-circle.done   { border-color: var(--gold-dim); opacity: 0.55; background: rgba(122,98,48,0.1); }
.map-node-circle.zone1  { border-color: rgba(180,140,60,0.6); }
.map-node-circle.zone2  { border-color: rgba(180,110,40,0.6); }
.map-node-circle.zone3  { border-color: rgba(60,100,70,0.7); }
.map-node-circle.zone4  { border-color: rgba(120,80,160,0.7); }
.map-node-circle.zone1.current { background: rgba(180,140,60,0.12); box-shadow: 0 0 18px rgba(180,140,60,0.3); }
.map-node-circle.zone2.current { background: rgba(180,110,40,0.12); box-shadow: 0 0 18px rgba(180,110,40,0.3); }
.map-node-circle.zone3.current { background: rgba(60,100,70,0.15); box-shadow: 0 0 18px rgba(60,140,80,0.3); }
.map-node-circle.zone4.current { background: rgba(120,80,160,0.15); box-shadow: 0 0 18px rgba(160,100,220,0.3); }
.map-node-circle.current {
  border-color: var(--gold);
  background: rgba(196,162,74,0.1);
  animation: currentPulse 2.8s ease-in-out infinite;
}
@keyframes currentPulse {
  0%,100% { box-shadow: 0 0 0 3px rgba(196,162,74,0.1), 0 0 12px var(--gold-glow); }
  50%     { box-shadow: 0 0 0 6px rgba(196,162,74,0.04), 0 0 20px var(--gold-glow); }
}
.map-node-circle.ahead  { opacity: 0.2; }
.map-node-circle.badge-node { width: 28px; height: 28px; border-radius: 2px; font-size: 16px; }
.map-node-circle.badge-node.earned { border-color: var(--gold); box-shadow: 0 0 8px var(--gold-glow); }
.map-node-circle.badge-node.ahead  { opacity: 0.15; }

.map-node-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: var(--text-dim);
  text-align: center; white-space: nowrap;
  background: rgba(10,8,6,0.82);
  padding: 2px 6px; border-radius: 2px;
  letter-spacing: 0.04em;
  border: 1px solid rgba(90,70,30,0.3);
}
.map-node-wrap.current .map-node-label {
  color: var(--gold-light);
  border-color: rgba(196,162,74,0.4);
}

.map-more-arrow {
  position: absolute; bottom: 5px; right: 9px;
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.06em;
  display: flex; flex-direction: column; align-items: center; gap: 1px;
  animation: bounceDown 2s ease-in-out infinite;
}
.map-more-arrow.hidden { display: none; }
@keyframes bounceDown { 0%,100%{transform:translateY(0)} 50%{transform:translateY(3px)} }

.road-bonus-track {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 14px;
}
.road-bonus-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.road-bonus-pips { display: flex; gap: 4px; }
.road-pip { width: 12px; height: 4px; border-radius: 100px; background: var(--border); transition: all 0.3s; }
.road-pip.earned { background: var(--teal); box-shadow: 0 0 4px var(--teal-glow); }

/* ══════════════════════════════════════════════
   STREAK (right col, top)
══════════════════════════════════════════════ */
.streak-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 12px 16px;
  display: flex; align-items: center; justify-content: space-between;
  position: relative; overflow: hidden;
  transition: border-color 0.3s;
}
.streak-panel.alive { border-color: rgba(212,98,42,0.3); }
.streak-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--orange), transparent);
  opacity: 0;
}
.streak-panel.alive::before { opacity: 0.45; }
.streak-left  { display: flex; align-items: center; gap: 10px; }
.streak-flame {
  font-size: 22px; line-height: 1;
  filter: drop-shadow(0 0 4px rgba(212,98,42,0.4));
}
.streak-flame.cold { filter: grayscale(0.9); opacity: 0.3; }
.streak-num {
  font-family: 'Cinzel', serif;
  font-size: 26px; color: var(--orange); line-height: 1;
}
.streak-num.cold { color: var(--text-dark); }
.streak-tag { font-size: 17px; color: var(--text-mid); font-style: italic; }
.streak-right {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.08em; text-align: right;
}
.streak-right.logged { color: var(--green); }
.streak-right.urgent { color: var(--orange); animation: urgentPulse 2s ease-in-out infinite; }
@keyframes urgentPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* ══════════════════════════════════════════════
   LOG FORM (right col)
══════════════════════════════════════════════ */
.log-panel {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 18px;
  position: relative; overflow: hidden;
}
.log-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.log-form-grid {
  display: grid;
  grid-template-columns: 1fr 110px auto;
  gap: 10px; align-items: end;
}
@media (max-width: 500px) {
  .log-form-grid { grid-template-columns: 1fr 1fr; }
  .log-btn-wrap  { grid-column: 1 / -1; }
}
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.log-btn {
  background: var(--gold-dim);
  border: 1px solid var(--gold-dim); border-radius: 2px;
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
  padding: 9px 14px; cursor: pointer; white-space: nowrap; width: 100%;
  transition: all 0.18s;
}
.log-btn:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.log-btn.streak-danger {
  border-color: var(--orange);
  box-shadow: 0 0 12px rgba(212,98,42,0.3);
  animation: streakDanger 2s ease-in-out infinite;
}
.log-btn.logged-today {
  border-color: var(--green);
  color: var(--green);
  background: rgba(58,158,106,0.08);
}
@keyframes streakDanger { 0%,100%{box-shadow:0 0 8px rgba(212,98,42,0.3)} 50%{box-shadow:0 0 18px rgba(212,98,42,0.6)} }
.xp-hint { margin-top: 10px; font-size: 15px; color: var(--text-dark); font-style: italic; }

/* ══════════════════════════════════════════════
   LOG LIST (right col)
══════════════════════════════════════════════ */
.log-list-wrap {}
.log-list {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px; overflow: hidden;
}
.log-empty { padding: 28px; text-align: center; color: var(--text-dark); font-size: 17px; font-style: italic; }
.log-item {
  display: grid; grid-template-columns: 22px 1fr auto;
  gap: 10px; align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  animation: slideIn 0.22s ease both;
}
.log-item:last-child { border-bottom: none; }
.log-icon   { font-size: 17px; text-align: center; opacity: 0.65; }
.log-desc   { font-size: 18px; color: var(--text); }
.log-meta   { font-size: 14px; color: var(--text-dark); font-style: italic; }
.log-right  { text-align: right; }
.log-amount { font-family: 'Cinzel', serif; font-size: 17px; color: var(--text-mid); }
.log-xp     { font-size: 14px; color: var(--xp); }

/* section-head alias */
.section-head {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px;
}
.section-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.chronicle-head {
  font-size: 15px;
  color: var(--gold-dim);
  letter-spacing: 0.22em;
  margin-top: 6px;
}
.chronicle-head::after { background: var(--border-gold); }

/* ══════════════════════════════════════════════
   LOGIN
══════════════════════════════════════════════ */
#login-screen { max-width: 400px; margin: 0 auto; }
.login-hero { text-align: center; margin-bottom: 28px; padding-top: 20px; }
.login-hero-icon {
  width: 60px; height: 60px;
  background: var(--surface2);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 28px; margin-bottom: 14px;
}
.login-title { font-family: 'Cinzel', serif; font-size: 22px; color: var(--gold); margin-bottom: 6px; }
.login-sub   { color: var(--text-dim); font-size: 18px; font-style: italic; }
.login-err   { color: var(--red); font-size: 17px; text-align: center; margin-top: 8px; display: none; }
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px; padding: 20px;
  position: relative; overflow: hidden;
}
.card-accent-top, .card-accent-gold, .card-accent-teal {
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.form-field { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; }
.field-label {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.field-input { width: 100%; }

/* ══════════════════════════════════════════════
   ONBOARDING
══════════════════════════════════════════════ */
.ob-card {
  max-width: 540px; margin: 0 auto;
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 36px 32px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s ease both;
}
.ob-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.steps-row {
  display: flex; align-items: center; justify-content: center;
  gap: 6px; margin-bottom: 30px;
}
.step-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--border-mid); transition: all 0.3s; flex-shrink: 0;
}
.step-dot.active { background: var(--gold); width: 18px; border-radius: 2px; box-shadow: 0 0 5px var(--gold-glow); }
.step-dot.done   { background: var(--gold-dim); opacity: 0.5; }
.step-line { width: 14px; height: 1px; background: var(--border); flex-shrink: 0; }
.ob-step { display: none; }
.ob-step.active { display: block; animation: fadeUp 0.3s ease both; }
.ob-icon  { text-align: center; font-size: 42px; margin-bottom: 14px; }
.ob-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold); text-align: center; margin-bottom: 8px; }
.ob-sub {
  color: var(--text-dim); font-size: 18px; font-style: italic;
  text-align: center; line-height: 1.65; margin-bottom: 24px;
  max-width: 400px; margin-left: auto; margin-right: auto;
}
.ob-nav { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }

.name-row { display: flex; max-width: 340px; margin: 0 auto; }
.hero-name-input { border-right: none; border-radius: 2px 0 0 2px; flex: 1; }
.name-btn {
  background: var(--gold-dim); border: 1px solid var(--gold-dim); border-left: none;
  border-radius: 0 2px 2px 0; color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 0.1em;
  padding: 9px 16px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.name-btn:hover { background: var(--gold); color: var(--bg); }

.avatar-grid {
  display: flex; gap: 10px; justify-content: center;
  margin-bottom: 24px; flex-wrap: wrap;
}
.avatar-opt {
  width: 66px; height: 66px;
  border: 1px solid var(--border); border-radius: 3px;
  background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  font-size: 30px; cursor: pointer;
  transition: all 0.2s; position: relative; user-select: none;
}
.avatar-opt:hover { border-color: var(--border-gold); transform: translateY(-2px); }
.avatar-opt.selected { border-color: var(--gold); box-shadow: 0 0 12px var(--gold-glow); }
.avatar-opt.selected::after {
  content: '✓'; position: absolute; bottom: 3px; right: 5px;
  font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold);
}

.class-grid { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }
.class-opt {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 2px; padding: 11px 13px; cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; gap: 12px; user-select: none;
}
.class-opt:hover     { border-color: var(--border-mid); background: var(--surface3); }
.class-opt.selected  { border-color: var(--gold); background: var(--surface3); border-left-width: 3px; }
.class-emoji { font-size: 24px; flex-shrink: 0; width: 30px; text-align: center; }
.class-info  { flex: 1; }
.class-name  { font-family: 'Cinzel', serif; font-size: 16px; color: var(--gold); margin-bottom: 2px; }
.class-desc  { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.45; }
.class-trait {
  font-size: 12px; color: var(--xp);
  text-transform: uppercase; letter-spacing: 0.1em;
  background: rgba(91,143,204,0.1); border: 1px solid rgba(91,143,204,0.2);
  padding: 2px 7px; border-radius: 2px; white-space: nowrap; flex-shrink: 0;
}

.budget-row { display: flex; max-width: 320px; margin: 0 auto; }
.budget-prefix {
  background: var(--surface2); border: 1px solid var(--border-mid); border-right: none;
  border-radius: 2px 0 0 2px; padding: 9px 12px;
  color: var(--gold); font-family: 'Cinzel', serif; font-size: 21px;
  display: flex; align-items: center;
}
.budget-input { border-left: none; border-right: none; border-radius: 0; flex: 1; }
.budget-btn {
  background: var(--gold-dim); border: 1px solid var(--gold-dim); border-left: none;
  border-radius: 0 2px 2px 0; color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 0.1em;
  padding: 9px 16px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.budget-btn:hover { background: var(--gold); color: var(--bg); }

.laws-grid { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }
.law-card {
  display: flex; align-items: flex-start; gap: 12px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 2px; padding: 10px 13px;
}
.law-icon  { font-size: 21px; flex-shrink: 0; width: 24px; text-align: center; margin-top: 2px; opacity: 0.75; }
.law-body  { flex: 1; }
.law-title { font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold-dim); letter-spacing: 0.08em; margin-bottom: 3px; text-transform: uppercase; }
.law-plain { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.55; }

/* ══════════════════════════════════════════════
   OVERLAYS
══════════════════════════════════════════════ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(6,4,2,0.88);
  backdrop-filter: blur(3px);
  display: flex; align-items: center; justify-content: center;
  z-index: 9998; opacity: 0; pointer-events: none;
  transition: opacity 0.28s;
}
.overlay.show { opacity: 1; pointer-events: all; }
.overlay-box {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 28px 32px;
  text-align: center; max-width: 400px; width: 90%;
  position: relative; overflow: hidden;
  transform: scale(0.93) translateY(12px);
  transition: transform 0.32s cubic-bezier(0.34,1.56,0.64,1);
}
.overlay.show .overlay-box { transform: scale(1) translateY(0); }
.overlay-box::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.overlay-box.hostile { border-color: rgba(184,60,46,0.45); }
.overlay-box.hostile::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }
.overlay-box.friendly { border-color: rgba(58,158,106,0.4); }
.overlay-box.friendly::before { background: linear-gradient(90deg, transparent, var(--green), transparent); }
.overlay-box.zone-complete { border-color: rgba(196,162,74,0.45); }
.overlay-box.levelup { border-color: var(--gold-dim); box-shadow: 0 0 40px var(--gold-glow); }
.overlay-box.broken  { border-color: rgba(184,60,46,0.45); }
.overlay-box.broken::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }

.overlay-zone-label {
  font-family: 'Cinzel', serif; font-size: 12px;
  letter-spacing: 0.2em; text-transform: uppercase;
  margin-bottom: 10px; color: var(--text-dark);
}
.overlay-box.hostile  .overlay-zone-label { color: var(--red); }
.overlay-box.friendly .overlay-zone-label { color: var(--green); }
.overlay-box.zone-complete .overlay-zone-label { color: var(--gold); }
.overlay-icon  { font-size: 40px; margin-bottom: 10px; line-height: 1; }
.overlay-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold); margin-bottom: 10px; }
.overlay-desc  { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.7; margin-bottom: 18px; }
.overlay-choices { display: flex; flex-direction: column; gap: 7px; }
.overlay-btn {
  background: var(--surface2); border: 1px solid var(--border-mid);
  border-radius: 2px; color: var(--text);
  font-family: 'Crimson Text', serif; font-size: 18px;
  padding: 11px 16px; cursor: pointer; transition: all 0.18s;
  text-align: left; line-height: 1.5;
}
.overlay-btn:hover { border-color: var(--border-gold); background: var(--surface3); }
.overlay-btn.hostile-choice { border-color: rgba(184,60,46,0.3); }
.overlay-btn.hostile-choice:hover { border-color: var(--red); background: rgba(184,60,46,0.07); }
.overlay-btn.friendly-choice { border-color: rgba(58,158,106,0.3); }
.overlay-btn.friendly-choice:hover { border-color: var(--green); background: rgba(58,158,106,0.07); }
.overlay-btn.primary-choice {
  background: var(--gold-dim); border-color: var(--gold-dim); color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 0.1em; text-align: center;
}
.overlay-btn.primary-choice:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.overlay-btn-cost { display: block; font-size: 15px; color: var(--text-dim); margin-top: 2px; font-style: italic; }
.overlay-btn-disabled { opacity: 0.3; cursor: not-allowed; }
.overlay-btn-disabled:hover { background: var(--surface2) !important; border-color: var(--border-mid) !important; }

.levelup-sparkles { font-size: 22px; letter-spacing: 12px; margin-bottom: 10px; color: var(--gold-dim); }
.levelup-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 4px; }
.levelup-num {
  font-family: 'Cinzel', serif; font-size: 58px; color: var(--gold-light);
  line-height: 1; margin: 4px 0 8px; text-shadow: 0 0 28px var(--gold-glow);
}
.levelup-rank { font-family: 'Cinzel', serif; font-size: 18px; color: var(--gold); margin-bottom: 10px; }
.levelup-msg  { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.7; margin-bottom: 20px; }

.reset-icon  { font-size: 34px; margin-bottom: 10px; }
.reset-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 6px; }
.reset-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold-light); margin-bottom: 14px; }
.reset-breakdown { background: var(--surface2); border: 1px solid var(--border); border-radius: 2px; padding: 11px 13px; margin-bottom: 14px; text-align: left; }
.reset-row { display: flex; justify-content: space-between; font-size: 17px; color: var(--text-dim); padding: 3px 0; }
.reset-row.highlight { color: var(--gold); }
.reset-row.highlight span:last-child { color: var(--gold-light); }
.reset-msg { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.65; margin-bottom: 16px; }
.reset-overlay-box { border-color: rgba(196,162,74,0.35); max-width: 400px; }
.reset-title { font-family: 'Cinzel', serif; font-size: 22px; color: var(--gold); margin-bottom: 16px; text-align: center; }
.reset-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.18em; text-align: center; margin-bottom: 8px; }
.reset-icon { font-size: 32px; text-align: center; margin-bottom: 10px; }

.broken-icon  { font-size: 44px; margin: 6px 0 12px; }
.broken-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--red); margin-bottom: 8px; }
.broken-msg   { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.6; margin-bottom: 16px; }
.broken-gold  { font-family: 'Cinzel', serif; font-size: 24px; color: var(--gold-light); margin-bottom: 4px; }
.broken-cost  { font-size: 15px; color: var(--text-dim); font-style: italic; margin-bottom: 16px; }

/* ══════════════════════════════════════════════
   TOAST
══════════════════════════════════════════════ */
.toast {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%) translateY(14px);
  background: var(--surface2); border: 1px solid var(--border-gold);
  color: var(--text-mid); font-family: 'Crimson Text', serif; font-size: 18px;
  padding: 9px 20px; border-radius: 2px;
  opacity: 0; pointer-events: none; z-index: 8000;
  transition: all 0.26s; white-space: nowrap;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ══════════════════════════════════════════════
   TEASERS
══════════════════════════════════════════════ */
.teasers { }
.teasers-head {
  font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.16em;
  margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
}
.teasers-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.teaser-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px,1fr)); gap: 6px; }
.teaser-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 3px; padding: 12px;
  opacity: 0.28; filter: saturate(0.15); position: relative; transition: all 0.2s;
}
.teaser-card:hover { opacity: 0.44; filter: saturate(0.28); }
.teaser-lock   { position: absolute; top: 8px; right: 10px; font-size: 14px; color: var(--text-dark); }
.teaser-icon   { font-size: 21px; margin-bottom: 4px; }
.teaser-name   { font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-mid); margin-bottom: 2px; }
.teaser-hint   { font-size: 15px; color: var(--text-dim); font-style: italic; line-height: 1.4; }
.teaser-unlock { font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 4px; }

/* ══════════════════════════════════════════════
   ANIMATIONS
══════════════════════════════════════════════ */
@keyframes fadeUp {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}
@keyframes slideIn {
  from { opacity:0; transform:translateX(-5px); }
  to   { opacity:1; transform:translateX(0); }
}



/* ══════════════════════════════════════════════
   /* budget-hero removed — treasury now lives inside char panel */


/* ══════════════════════════════════════════════
   TREASURY — dominant section inside char panel
══════════════════════════════════════════════ */
.treasury-section {
  background: var(--surface2);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 14px 16px;
  margin-bottom: 12px;
  position: relative;
}
.treasury-head {
  display: flex; align-items: baseline;
  justify-content: space-between;
  margin-bottom: 10px;
}
.treasury-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--gold-dim);
  text-transform: uppercase; letter-spacing: 0.2em;
}
.treasury-status {
  font-size: 15px; color: var(--text-dim); font-style: italic;
}
.treasury-status.danger  { color: var(--red); }
.treasury-status.warning { color: var(--orange); }
.treasury-status.good    { color: var(--green); }

.treasury-numbers {
  display: flex; align-items: baseline;
  gap: 7px; margin-bottom: 12px; flex-wrap: wrap;
}
.treasury-remaining {
  font-family: 'Cinzel', serif;
  font-size: 40px; line-height: 1; color: var(--gold-light);
  text-shadow: 0 0 20px var(--gold-glow);
  transition: color 0.35s;
}
.treasury-remaining.danger  { color: var(--red);    text-shadow: none; }
.treasury-remaining.warning { color: var(--orange); text-shadow: none; }
.treasury-of {
  font-size: 16px; color: var(--text-dark); font-style: italic;
}
.treasury-budget {
  font-family: 'Cinzel', serif;
  font-size: 18px; color: var(--text-dim);
}
.treasury-bar-track {
  height: 6px;
  background: var(--surface3);
  border-radius: 100px; overflow: hidden;
  margin-bottom: 6px;
}
.treasury-bar-fill {
  height: 100%; border-radius: 100px;
  background: linear-gradient(90deg, var(--gold-dim), var(--gold));
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1), background 0.35s;
}
.treasury-bar-fill.danger  { background: linear-gradient(90deg, #4a1810, var(--red)); }
.treasury-bar-fill.warning { background: linear-gradient(90deg, #4a3010, var(--orange)); }
.treasury-sub {
  font-size: 15px; color: var(--text-dark); font-style: italic;
}

/* Char panel rule (between vault and XP) */
.char-rule { height: 1px; background: var(--border); margin: 12px 0; }

/* Remove old rule/rule-label if present */
.rule       { height: 1px; background: var(--border); margin: 14px 0 10px; }
.rule-label { display: none; }


/* ══════════════════════════════════════════════
   LOG PAGINATION
══════════════════════════════════════════════ */
.log-pagination {
  display: flex; align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  border-radius: 0 0 3px 3px;
}
.log-more-btn {
  background: transparent;
  border: 1px solid var(--border-mid);
  border-radius: 2px;
  color: var(--text-dim);
  font-family: 'Cinzel', serif;
  font-size: 13px; letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 6px 14px; cursor: pointer;
  transition: all 0.2s;
}
.log-more-btn:hover { border-color: var(--border-gold); color: var(--text-mid); }
.log-more-btn:disabled {
  opacity: 0.3; cursor: default;
}
.log-pagination-count {
  font-size: 15px; color: var(--text-dark); font-style: italic;
}


/* ── Vault inline (inside treasury) ── */
.vault-inline {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 12px;
  padding: 10px 12px;
  background: rgba(0,0,0,0.25);
  border: 1px solid var(--border-gold);
  border-radius: 2px;
  border-left: 3px solid var(--gold-dim);
}
.vault-inline-left { display: flex; align-items: center; gap: 10px; }
.vault-inline-icon { font-size: 18px; line-height: 1; }
.vault-inline-name {
  font-family: 'Cinzel', serif;
  font-size: 14px; color: var(--gold-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
  margin-bottom: 2px;
}
.vault-inline-hint { font-size: 15px; color: var(--text-dark); font-style: italic; }

/* ── Map hearts label ── */
.map-hearts-block { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.map-hearts-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}

/* ── Dev tools ── */
.dev-tools {
  margin-top: 14px;
  padding: 10px 12px;
  border: 1px dashed var(--border);
  border-radius: 2px;
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
}
.dev-tools-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
  margin-right: 4px;
}
.dev-btn {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 2px;
  color: var(--text-dark);
  font-family: 'Cinzel', serif;
  font-size: 12px; letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 4px 10px; cursor: pointer;
  transition: all 0.2s;
}
.dev-btn:hover { border-color: var(--red); color: var(--red); }

/* ── Treasury over-budget ── */
.treasury-bar-fill.over {
  background: var(--red);
  width: 100% !important;
  opacity: 0.4;
}
.treasury-remaining.over { color: var(--red); }

/* ── Wounded mode ── */
.char-panel.wounded {
  border-color: rgba(184,60,46,0.35);
}
.char-panel.wounded::before {
  background: linear-gradient(90deg, transparent, rgba(184,60,46,0.25), transparent) !important;
  opacity: 1 !important;
}
.recovery-track {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid rgba(184,60,46,0.2);
}
.recovery-track.hidden { display: none; }
.recovery-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: rgba(200,80,60,0.75);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.recovery-pips { display: flex; gap: 5px; }
.recovery-pip {
  width: 18px; height: 4px; border-radius: 100px;
  background: rgba(184,60,46,0.2);
  transition: all 0.3s;
}
.recovery-pip.earned {
  background: rgba(200,80,60,0.7);
  box-shadow: 0 0 5px rgba(200,80,60,0.35);
}


/* ══════════════════════════════════════════════
   BADGE RAIL (char panel)
══════════════════════════════════════════════ */
.badge-rail {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  background: var(--surface2);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}
.badge-rail-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex: 0 0 auto;
}
.badge-connector {
  flex: 1;
  height: 1px;
  background: var(--border);
  margin: 0 4px;
  margin-bottom: 14px;
}
.badge-pip {
  width: 32px; height: 32px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--surface3);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  transition: all 0.35s;
  position: relative;
}
.badge-pip.locked {
  opacity: 0.2;
  filter: grayscale(1);
}
.badge-pip.earned {
  border-color: var(--gold);
  background: rgba(196,162,74,0.1);
  opacity: 1;
  filter: none;
  box-shadow: 0 0 8px var(--gold-glow);
}
.badge-pip.earned::after {
  content: '';
  position: absolute; inset: -3px;
  border-radius: 50%;
  border: 1px solid var(--gold-dim);
  opacity: 0.4;
}
.badge-rail-label {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  white-space: nowrap;
}

/* ══════════════════════════════════════════════
   XP BLOCK — more prominent
══════════════════════════════════════════════ */
.xp-block {
  margin-top: 12px;
}
.xp-label-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 6px;
}
.xp-label {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.14em;
}
.xp-nums {
  font-size: 17px;
  color: var(--text-dim);
}
.xp-nums strong {
  color: var(--xp);
  font-family: 'Cinzel', serif;
  font-size: 22px;
}
.xp-bar-track {
  height: 10px;
  background: var(--surface2);
  border-radius: 100px;
  overflow: hidden;
  border: 1px solid var(--border);
}
.xp-bar-fill {
  height: 100%; border-radius: 100px;
  background: linear-gradient(90deg, var(--xp-dim), var(--xp));
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1);
  min-width: 0;
}
.xp-bar-fill.pulse { animation: barPulse 0.6s ease; }
.xp-sub {
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
  font-size: 15px;
  color: var(--text-dark);
  font-style: italic;
}

.ob-budget-hint {
  text-align: center; margin-top: 10px;
  font-size: 15px; color: var(--text-dark);
  font-style: italic;
}
.streak-right-col { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.streak-best { font-size: 13px; color: var(--text-dark); font-style: italic; }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-brand">
      <div class="header-sigil">⚔</div>
      <div>
        <h1>Budget Quest</h1>
        <div class="header-tagline">Your ledger is your legend.</div>
      </div>
    </div>
    <div id="header-auth" class="header-auth" style="display:none;">
      <span class="header-auth-email" id="header-email"></span>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- ── LOGIN ── -->
  <div id="login-screen" style="display:none;">
    <div class="login-hero">
      <div class="login-hero-icon">⚔</div>
      <div class="login-title">Welcome Back, Hero</div>
      <div class="login-sub">Track your spending. Level up. Build your treasury.</div>
    </div>
    <div class="card" style="max-width:420px;margin:0 auto;">
      <div class="card-accent-top"></div>

      <!-- Password login -->
      <div id="login-password-panel">
        <div id="login-form-password">
          <div class="form-field">
            <label class="field-label">Email</label>
            <input class="field-input" id="login-email-pw" type="email" placeholder="your@email.com" autocomplete="email">
          </div>
          <div class="form-field">
            <label class="field-label">Password</label>
            <input class="field-input" id="login-password" type="password" placeholder="Password" autocomplete="current-password">
          </div>
          <button class="btn-primary" onclick="signInWithPassword()">Enter the Realm ⚔</button>
          <div id="login-error-pw" class="login-err"></div>
        </div>
      </div>



    </div>
  </div>

  <!-- ── ONBOARDING ── -->
  <div id="onboarding" style="display: none;">
    <div class="ob-card">

      <div class="steps-row">
        <div class="step-dot active" id="dot-0"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-1"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-3"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-4"></div>
      </div>

      <!-- Step 1: Name -->
      <div class="ob-step active" id="step-0">
        <div class="ob-icon">⚔️</div>
        <div class="ob-title">Name Your Hero</div>
        <div class="ob-sub">Every great journey begins with a name. Yours will be written in the ledgers of the Iron Keep — logged, leveled, and remembered. What do they call you on the road?</div>
        <div class="name-row">
          <input class="hero-name-input" id="hero-name-input" type="text" placeholder="Your hero's name…" maxlength="24" autocomplete="off">
          <button class="name-btn" onclick="goStep(1)">Onward →</button>
        </div>
      </div>

      <!-- Step 2: Avatar -->
      <div class="ob-step" id="step-1">
        <div class="ob-icon">🪞</div>
        <div class="ob-title">Choose Your Form</div>
        <div class="ob-sub">The road ahead is long. Choose the face that will meet it.</div>
        <div class="avatar-grid" id="avatar-grid">
          <div class="avatar-opt" data-avatar="🧙" onclick="selectAvatar(this)">🧙</div>
          <div class="avatar-opt" data-avatar="🧝‍♀️" onclick="selectAvatar(this)">🧝‍♀️</div>
          <div class="avatar-opt" data-avatar="🧔" onclick="selectAvatar(this)">🧔</div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep(0)">← Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep(2)">Choose Your Class →</button>
        </div>
      </div>

      <!-- Step 3: Class -->
      <div class="ob-step" id="step-2">
        <div class="ob-icon">🏰</div>
        <div class="ob-title">Choose Your Class</div>
        <div class="ob-sub">Your class shapes how you walk the road. Every path leads to the Iron Keep — the question is how you travel it.</div>
        <div class="class-grid" id="class-grid">
          <div class="class-opt" data-class="Mage" onclick="selectClass(this)">
            <div class="class-emoji">🔮</div>
            <div class="class-info">
              <div class="class-name">Mage of the Archive</div>
              <div class="class-desc">You see patterns others miss. No hidden fee, no forgotten charge escapes your watch. Knowledge is your sharpest blade.</div>
            </div>
            <div class="class-trait">Wisdom</div>
          </div>
          <div class="class-opt" data-class="Ranger" onclick="selectClass(this)">
            <div class="class-emoji">🏹</div>
            <div class="class-info">
              <div class="class-name">Ranger of the Road</div>
              <div class="class-desc">Steady and relentless. You log daily, hold your streak, and know the road better than any map can show.</div>
            </div>
            <div class="class-trait">Discipline</div>
          </div>
          <div class="class-opt" data-class="Hunter" onclick="selectClass(this)">
            <div class="class-emoji">🐺</div>
            <div class="class-info">
              <div class="class-name">Hunter of Surplus</div>
              <div class="class-desc">Every budget conquered is a trophy on your wall. You track spending like prey — patient, precise, and always closing.</div>
            </div>
            <div class="class-trait">Willpower</div>
          </div>
          <div class="class-opt" data-class="Knight" onclick="selectClass(this)">
            <div class="class-emoji">🗡️</div>
            <div class="class-info">
              <div class="class-name">Knight of the Keep</div>
              <div class="class-desc">Your treasury is your fortress. Overspending shall not pass. You hold the line so the rest of the journey can proceed.</div>
            </div>
            <div class="class-trait">Discipline</div>
          </div>
          <div class="class-opt" data-class="Healer" onclick="selectClass(this)">
            <div class="class-emoji">❤️‍🩹</div>
            <div class="class-info">
              <div class="class-name">Healer of Debts</div>
              <div class="class-desc">Recovery is its own kind of power. You know that every setback on the road can be undone — one logged entry at a time.</div>
            </div>
            <div class="class-trait">Resilience</div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep(1)">← Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep(3)">The Laws of the Road →</button>
        </div>
      </div>

      <!-- Step 4: How it works -->
      <div class="ob-step" id="step-3">
        <div class="ob-icon">📜</div>
        <div class="ob-title">The Laws of the Road</div>
        <div class="ob-sub">Five rules that govern every traveler who walks toward the Iron Keep.</div>
        <div class="laws-grid">
          <div class="law-card">
            <div class="law-icon">⚔️</div>
            <div class="law-body">
              <div class="law-title">Record your spending → earn XP</div>
              <div class="law-plain">Every expense you log earns experience. The amount doesn't matter — the act of logging does. Awareness is the first weapon.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">🔥</div>
            <div class="law-body">
              <div class="law-title">Log daily → forge your streak</div>
              <div class="law-plain">Record at least one expense each day and your streak grows. Streaks multiply XP. Miss a day and the count resets — but the road doesn't end.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">👝</div>
            <div class="law-body">
              <div class="law-title">Face encounters → fill the Road Gold</div>
              <div class="law-plain">The road brings both threats and rewards. Gold earned goes into your Road Gold — spend it to survive hostile encounters, or save it for what lies ahead.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">🗺️</div>
            <div class="law-body">
              <div class="law-title">Level up → advance the map</div>
              <div class="law-plain">Each level pushes you further down a 14-location road toward the Iron Keep. Log five days in a week and earn a Road Bonus — an early advance.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">❤️</div>
            <div class="law-body">
              <div class="law-title">Guard your lives</div>
              <div class="law-plain">You carry three lives. Hostile encounters cost one — or spend Road Gold to hold them. Lose all three and you choose: spend gold to revive in full, or take the XP debt and carry on.</div>
            </div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep(2)">← Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep(4)">Set Your Treasury →</button>
        </div>
      </div>

      <!-- Step 5: Monthly Budget -->
      <div class="ob-step" id="step-4">
        <div class="ob-icon">⚜️</div>
        <div class="ob-title">Fill Your Treasury</div>
        <div class="ob-sub">Every hero needs a war chest. Set your monthly spending limit — this is the gold you have to work with. The road ahead will test it.</div>
        <div class="budget-row">
          <span class="budget-prefix">$</span>
          <input class="budget-input" id="budget-input" type="number" min="1" step="1" placeholder="e.g. 2000" autocomplete="off">
          <button class="budget-btn" onclick="beginJourney()">Begin the Journey ⚔</button>
        </div>
        <div class="ob-budget-hint">You can adjust your treasury at any time from your character sheet.</div>
        <div class="ob-nav" style="margin-top:16px;">
          <button class="btn-secondary" onclick="goStep(3)">← Back</button>
        </div>
      </div>

    </div>
  </div><!-- /onboarding -->

  <!-- ── MAIN ── -->
  <div id="main" style="display: block;">
    <div class="layout">

      <!-- LEFT COLUMN — character sheet -->
      <div class="col-left">
        <div class="char-panel" id="coin-reserve-section">

          <!-- Identity row -->
          <div class="char-identity">
            <div class="char-avatar" id="char-avatar">🧙</div>
            <div style="flex:1;min-width:0;">
              <div class="char-name" id="char-name">Hero</div>
              <div class="char-class" id="char-class">Novice</div>
            </div>
            <div class="char-level-badge">
              <div class="level-num" id="level-num">1</div>
              <div class="level-label">Level</div>
            </div>
          </div>

          <!-- Treasury — most motivating stat: how much budget remains -->
          <div class="treasury-section">
            <div class="treasury-head">
              <span class="treasury-label">⚜ Monthly Treasury</span>
              <span class="treasury-status" id="coin-status"></span>
            </div>
            <div class="treasury-numbers">
              <span class="treasury-remaining" id="coin-current">$0</span>
              <span class="treasury-of" id="treasury-of-label">remaining of</span>
              <span class="treasury-budget">$<span id="coin-max">0</span></span>
            </div>
            <div class="treasury-bar-track">
              <div class="treasury-bar-fill" id="coin-fill" style="width:100%"></div>
            </div>
            <div class="treasury-sub" id="treasury-sub-text"></div>

            <!-- Road Gold — inline within treasury -->
            <div class="vault-inline">
              <div class="vault-inline-left">
                <div class="vault-inline-icon">👝</div>
                <div>
                  <div class="vault-inline-name">Road Gold</div>
                  <div class="vault-inline-hint">Your road insurance — spend on threats, save for rough stretches</div>
                </div>
              </div>
              <div class="vault-amount" id="vault-amount">0 💰</div>
            </div>
          </div>

          <!-- XP — progress engine -->
          <div class="xp-block">
            <div class="xp-label-row">
              <span class="xp-label">✦ Experience</span>
              <span class="xp-nums"><strong id="xp-current">0</strong> / <span id="xp-next-val">80</span> xp</span>
            </div>
            <div class="xp-bar-track">
              <div class="xp-bar-fill" id="xp-fill" style="width:0%"></div>
            </div>
            <div class="xp-sub">
              <span id="xp-bonus-msg"></span>
              <span id="xp-next-msg">80 XP to Level 2</span>
            </div>
            <!-- Recovery track — only visible when wounded -->
            <div class="recovery-track hidden" id="recovery-track">
              <div class="recovery-label" id="recovery-label">Treasury wounded</div>
              <div class="recovery-pips">
                <div class="recovery-pip" id="rpip-1"></div>
                <div class="recovery-pip" id="rpip-2"></div>
                <div class="recovery-pip" id="rpip-3"></div>
              </div>
            </div>
          </div>

          <!-- Streak — character stat -->
          <div class="streak-panel" id="streak-banner">
            <div class="streak-left">
              <span class="streak-flame" id="streak-banner-flame">🔥</span>
              <span class="streak-num" id="streak-count">0</span>
              <span class="streak-tag" id="streak-label">day streak — begin yours</span>
            </div>
            <div class="streak-right-col">
              <div class="streak-right" id="streak-banner-right">Start your streak today</div>
              <div class="streak-best" id="streak-best"></div>
            </div>
          </div>

          <!-- Dev tools — testing only -->
          <div class="dev-tools" id="dev-tools">
            <span class="dev-tools-label">Dev Tools</span>
            <button class="dev-btn" onclick="devWipeLog()">Wipe Log</button>
            <button class="dev-btn" onclick="devWipeStreak()">Reset Streak</button>
            <button class="dev-btn" onclick="devWipeLevel()">Reset Level</button>
            <button class="dev-btn" onclick="devRestart()">Restart Onboarding</button>
          </div>

          <div class="gold-float" id="gold-float"></div>
        </div>



      </div><!-- /col-left -->

      <!-- RIGHT COLUMN -->
      <div class="col-right">

        <!-- Log form -->
        <div class="log-panel">
          <div class="panel-head">Record Your Spending</div>
          <div class="log-form-grid">
            <div class="form-group">
              <label class="form-label">What did you spend on?</label>
              <input class="form-input" id="desc-input" type="text" placeholder="e.g. Morning coffee" autocomplete="off">
            </div>
            <div class="form-group">
              <label class="form-label">Amount ($)</label>
              <input class="form-input" id="amount-input" type="number" min="0.01" step="0.01" placeholder="0.00">
            </div>
            <div class="log-btn-wrap">
              <label class="form-label" style="visibility:hidden">Log</label>
              <button class="log-btn" id="log-btn" onclick="logExpense()">⚔ Log It</button>
            </div>
          </div>
        </div>

        <!-- Expense Chronicle — paginated -->
        <div class="log-list-wrap">
          <div class="section-head chronicle-head">✦ Expense Chronicle</div>
          <div class="log-list" id="log-list"></div>
          <div class="log-pagination" id="log-pagination" style="display:none;">
            <button class="log-more-btn" id="log-more-btn" onclick="showMoreLog()">Show more entries</button>
            <span class="log-pagination-count" id="log-pagination-count"></span>
          </div>
        </div>


        <!-- Map panel -->
        <div class="map-panel" id="map-section">
          <div class="map-panel-head">
            <div class="map-loc-block">
              <span class="map-section-label">⚔ The Journey</span>
              <span class="map-current-loc" id="map-location-name">Hearthstone Village</span>
              <span class="map-zone-tag" id="map-zone-tag">Zone I — The Hearthstone Road</span>
            </div>
            <div class="map-right-col">
              <div class="map-hearts-block">
                <div class="map-hearts-label">Lives</div>
                <div class="map-hearts">
                  <span class="map-heart" id="heart-1">❤️</span>
                  <span class="map-heart" id="heart-2">❤️</span>
                  <span class="map-heart" id="heart-3">❤️</span>
                </div>
              </div>

            </div>
          </div>
          <!-- Badge rail — connected to map milestones -->
          <div class="badge-rail">
            <div class="badge-rail-item" id="badge-zone1">
              <div class="badge-pip locked">🛡️</div>
              <div class="badge-rail-label">Zone I</div>
            </div>
            <div class="badge-connector"></div>
            <div class="badge-rail-item" id="badge-zone2">
              <div class="badge-pip locked">🪙</div>
              <div class="badge-rail-label">Zone II</div>
            </div>
            <div class="badge-connector"></div>
            <div class="badge-rail-item" id="badge-zone3">
              <div class="badge-pip locked">🌿</div>
              <div class="badge-rail-label">Zone III</div>
            </div>
            <div class="badge-connector"></div>
            <div class="badge-rail-item" id="badge-zone4">
              <div class="badge-pip locked">🔒</div>
              <div class="badge-rail-label">Iron Keep</div>
            </div>
          </div>

          <div class="map-viewport" id="map-viewport">
            <div class="node-map" id="node-map">
              <svg id="map-svg" xmlns="http://www.w3.org/2000/svg"></svg>
              <div class="node-map-inner" id="node-map-inner"></div>
            </div>
            <div class="map-more-arrow" id="map-more-arrow">
              <span>more ahead</span><span>▼</span>
            </div>
          </div>
          <div class="road-bonus-track">
            <span class="road-bonus-label" id="road-bonus-label">Road Bonus — log 5 days this week</span>
            <div class="road-bonus-pips">
              <div class="road-pip" id="road-pip-1"></div>
              <div class="road-pip" id="road-pip-2"></div>
              <div class="road-pip" id="road-pip-3"></div>
            </div>
          </div>
        </div>

      </div><!-- /col-right -->
    </div><!-- /layout -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- XP Float -->
<div class="xp-float" id="xp-float"></div>

<!-- Coin Float -->
<div class="coin-float" id="coin-float"></div>

<!-- Month Reset Overlay -->
<div class="overlay" id="reset-overlay">
  <div class="overlay-box reset-overlay-box">
    <div class="reset-icon">📅</div>
    <div class="reset-label">The Road Resets</div>
    <div class="reset-title" id="reset-title">Campaign Complete</div>
    <div class="reset-breakdown" id="reset-breakdown"></div>
    <div class="reset-msg" id="reset-msg"></div>
    <button class="overlay-btn primary-choice" onclick="closeReset()" style="width:100%;text-align:center;">Begin the New Campaign ⚔</button>
  </div>
</div>


<!-- Broken / 0-Hearts Overlay -->
<div class="overlay" id="broken-overlay">
  <div class="overlay-box broken" style="max-width:380px;">
    <div class="broken-icon">💀</div>
    <div class="broken-title">Fallen</div>
    <div class="broken-msg">You've taken too many hits on the road. Your last heart is gone. Spend Road Gold to get back on your feet — or face the XP penalty and carry on broke.</div>
    <div class="broken-gold" id="broken-gold-display">0 🪙</div>
    <div class="broken-cost">Road Gold balance</div>
    <div id="broken-choices"></div>
  </div>
</div>

<!-- Level Up Overlay -->
<div class="overlay" id="levelup-overlay">
  <div class="overlay-box levelup">
    <div class="levelup-sparkles">✦ ✧ ✦</div>
    <div class="levelup-label">Level Up!</div>
    <div class="levelup-num" id="lu-level">2</div>
    <div class="levelup-rank" id="lu-rank">Apprentice</div>
    <div class="levelup-msg" id="lu-msg">Your discipline grows. The realm takes notice.</div>
    <button class="overlay-btn primary-choice" onclick="closeLevelUp()" style="width:100%;text-align:center;">Continue the Quest ✦</button>
  </div>
</div>

<!-- Encounter Overlay -->
<div class="overlay" id="encounter-overlay">
  <div class="overlay-box" id="encounter-box">
    <div class="overlay-zone-label" id="encounter-zone">Encounter</div>
    <div class="overlay-icon" id="encounter-icon">⚔️</div>
    <div class="overlay-title" id="encounter-title">Bandits on the Road</div>
    <div class="overlay-desc" id="encounter-desc">A band of cutpurses blocks your path.</div>
    <div class="overlay-choices" id="encounter-choices"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ─────────────────────────
//  CONSTANTS
// ─────────────────────────
var SAVE_KEY = 'bq_v2';

// Cumulative XP to reach each level (index = level - 1)
var LEVEL_XP = [0, 80, 200, 370, 600, 900, 1270, 1720, 2260, 3000, 4000];

var CLASS_TITLES = {
  Mage:   ['Novice Archivist','Apprentice Mage','Scroll Keeper','Lore Binder','Elder Mage'],
  Ranger: ['Novice Tracker','Trail Walker','Forest Keeper','Silent Warden','Ranger Lord'],
  Hunter: ['Novice Hunter','Coin Stalker','Surplus Seeker','Thrift Predator','Master Hunter'],
  Knight: ['Novice Guard','Shield Bearer','Budget Warden','Iron Keeper','Knight Commander'],
  Healer: ['Novice Mender','Debt Healer','Wound Closer','Recovery Sage','Grand Healer'],
};

var LEVEL_MSGS = [
  'Level two. Streak intact. The road is just getting started.',
  'Your habit is forming. That is harder than it sounds.',
  'Three levels in and you are still logging. Most people have quit by now.',
  'Merchants are starting to recognise someone who knows their numbers.',
  'Halfway there. Your Road Gold is watching.',
  'You\'re building something real here. Keep going.',
  'Clean logs, intact budget, growing streak. This is what mastery looks like.',
  'You have come further than most travellers ever get. That is not nothing.',
  'Top tier. Your ledger speaks for itself at this point.',
  'Maximum rank. The Iron Keep knows your name.',
];

var LOG_ICONS = ['💰','🛒','🍖','🧪','⚔️','📜','🐎','🏰','🔮','💎','🌿','🎒'];

// ─────────────────────────
//  MAP DATA
// ─────────────────────────
var MAP_WAYPOINTS = [
  // Zone 1 — The Hearthstone Road (levels 1-3)
  { id: 0,  icon: '🏘️', name: 'Hearthstone\nVillage',  zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve arrived at Hearthstone Village. Your first stop on a long road. Log something, earn your first XP, and get moving — the Iron Keep isn\'t going to reach itself.' },
  { id: 1,  icon: '🌾', name: 'Harvest\nCrossing',      zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve arrived at Harvest Crossing. Three guilds have been in a territorial dispute over one landmark oak tree for the better part of six years. You eat a meal, check your balance, and let it be their problem.' },
  { id: 2,  icon: '🪨', name: 'Stonepath\nMill',        zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve arrived at Stonepath Mill. The miller here takes exact coin only — no tabs, no credit, no rounding. It\'s the tightest operation on the road. You respect it more than you expected to.' },
  { id: 'z1', icon: '🛡️', name: 'Zone Badge',          zone: 'badge1', badge: 'zone1', zoneName: 'The Hearthstone Road',
    zoneComplete: 'Hearthstone Road: done. First zone cleared. That one was the test. You passed.' },
  // Zone 2 — The Merchant's Pass (levels 4-6)
  { id: 3,  icon: '🏪', name: "Merchant's\nGate",       zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'You\'ve arrived at Merchant\'s Gate. The market here never sleeps — stalls everywhere, deals flying, someone pitching you something every ten steps. Good place to practice saying no and meaning it.' },
  { id: 4,  icon: '🌉', name: 'Copperbridge',           zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'You\'ve arrived at Copperbridge. The copper the bridge was named for was melted down years ago to cover a town debt. Someone still leaves coins on the old plaque anyway. Habits are stubborn things.' },
  { id: 5,  icon: '⛺', name: "Trader's\nCamp",         zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'You\'ve arrived at Trader\'s Camp. Half the people here are heading into the Thornwood. The other half just came out — and they look quietly smug about it. The smug ones seem intact. That\'s encouraging.' },
  { id: 'z2', icon: '🪙', name: 'Zone Badge',          zone: 'badge2', badge: 'zone2', zoneName: "The Merchant's Pass",
    zoneComplete: "Merchant's Pass cleared. Deals, tolls, temptations — all navigated. Budget still breathing. Well played." },
  // Zone 3 — The Thornwood (levels 7-9)
  { id: 6,  icon: '🌲', name: 'Thornwood\nEdge',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve entered the Thornwood. Its reputation is ominous. The reality is just quiet — very, very quiet. You find yourself opening your ledger and getting everything straight without really deciding to. Funny how that works.' },
  { id: 7,  icon: '🌑', name: 'Darkhollow\nPath',       zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve reached Darkhollow Path. The road narrows here, and your thinking narrows with it — in a good way. Strip out the noise and you get clear fast on what you actually need versus what you just sort of want.' },
  { id: 8,  icon: '🌸', name: 'Wayward\nShrine',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve found the Wayward Shrine. Travelers leave small things here as they pass — coins, tokens, notes. You leave a coin. The road genuinely feels lighter after. You can\'t explain it and you\'re not going to try.' },
  { id: 'z3', icon: '🌿', name: 'Zone Badge',          zone: 'badge3', badge: 'zone3', zoneName: 'The Thornwood',
    zoneComplete: 'Thornwood cleared. Turns out it\'s just a forest if you keep logging. You come out the other side intact.' },
  // Zone 4 — The Iron Keep (levels 10+)
  { id: 9,  icon: '🏰', name: 'Iron Keep\nGates',       zone: 4, zoneName: 'The Iron Keep',
    arrival: 'You\'ve reached the Iron Keep Gates. The guards here have seen every kind of traveler. They clock a disciplined one fast. You\'re waved through without a second look. That\'s the highest compliment this gate gives.' },
  { id: 10, icon: '⚔️', name: 'The Iron\nKeep',         zone: 4, zoneName: 'The Iron Keep',
    arrival: 'You\'ve arrived at the Iron Keep. You made it this month — the full road, start to finish. The quartermaster stamps your log without a word. When the new moon comes, the road resets. Your Road Gold carries forward. Your legend does too.' },
  { id: 'z4', icon: '🔒', name: 'Zone Badge',          zone: 'badge4', badge: 'zone4', zoneName: 'The Iron Keep',
    zoneComplete: 'Iron Keep reached. Most people quit somewhere in the Merchant\'s Pass. Your log, your Road Gold, your streak. That\'s what got you here.' },
];

// ─────────────────────────
//  HOSTILE ENCOUNTERS
// ─────────────────────────
var HOSTILE_ENCOUNTERS = [
  {
    id: 'bandits',
    icon: '🗡️',
    title: 'Road Toll. Unofficial.',
    zone: 'Ambush',
    desc: 'Four people have stepped into the road ahead with the specific energy of someone who recently decided \'finders keepers\' is a legal framework. The road is technically free. They have a different interpretation.',
    choiceA: { label: '🛡️ Stare them down', sub: 'Costs 1 Life — they fold' },
    choiceB: { label: '💰 Pay the stupid toll', sub: 'Spend 20 🪙 — move on with your dignity' },
    goldCost: 20
  },
  {
    id: 'tax',
    icon: '📜',
    title: 'Surprise Audit',
    zone: 'Official Nonsense',
    desc: 'A tax collector is waiting roadside with a brand-new ledger and a practiced look of innocence. \'Travel surcharge,\' he says. \'Completely standard.\' You have never heard of this surcharge. Neither has the road.',
    choiceA: { label: '🛡️ Contest it loudly', sub: 'Costs 1 Life — he finds somewhere else to be' },
    choiceB: { label: '💰 Just pay and go', sub: 'Spend 15 🪙 — not worth the argument' },
    goldCost: 15
  },
  {
    id: 'merchant',
    icon: '🛍️',
    title: 'Flash Sale',
    zone: 'Danger Zone',
    desc: 'A merchant cart has appeared at exactly the wrong moment, positioned perfectly to catch foot traffic. Everything marked 40% off. The sign says \'Today Only.\' It always says that. Your budget is watching you very closely right now.',
    choiceA: { label: '🛡️ Walk past without looking', sub: 'Costs 1 Life — willpower is exhausting' },
    choiceB: { label: '💰 Buy one small thing', sub: 'Spend 10 🪙 — controlled damage' },
    goldCost: 10
  },
  {
    id: 'storm',
    icon: '⛈️',
    title: 'Everything at Once',
    zone: 'Bad Day',
    desc: 'Broken wheel. Wrong turn. Surprise rain. One meal that was a mistake in hindsight. Not every day cooperates. The road doesn\'t adjust its schedule for bad luck — it just keeps going, and so do you.',
    choiceA: { label: '🛡️ Push through it', sub: 'Costs 1 Life — arrive tired but intact' },
    choiceB: { label: '💰 Wait it out', sub: 'Spend 18 🪙 — a warm inn, no regrets' },
    goldCost: 18
  },
  {
    id: 'gambler',
    icon: '🎲',
    title: 'Roadside Gambler',
    zone: 'Temptation',
    desc: 'A roadside gambler with a single table and a very confident smile. \'One game. Guaranteed win.\' He\'s said it to every traveler today. His cart is noticeably nicer than most of theirs. Draw your own conclusions.',
    choiceA: { label: '🛡️ Keep walking', sub: 'Costs 1 Life — harder than it sounds' },
    choiceB: { label: '💰 Decline with a coin', sub: 'Spend 12 🪙 — he respects it, oddly' },
    goldCost: 12
  },
];

// ─────────────────────────
//  FRIENDLY ENCOUNTERS
// ─────────────────────────
var FRIENDLY_ENCOUNTERS = [
  {
    id: 'shrine',
    icon: '🌸',
    title: 'Roadside Shrine',
    zone: 'Lucky Find',
    desc: 'There\'s a small shrine just off the path. You stop. Thirty seconds of quiet. Whatever was pressing on you before you sat down is somehow smaller when you stand back up. You\'re not going to question it.',
    reward: { type: 'heart', amount: 1 },
    rewardDesc: '❤️ Life restored'
  },
  {
    id: 'journal',
    icon: '📖',
    title: 'Free Advice (Good Kind)',
    zone: 'Lucky Find',
    desc: 'There\'s a battered notebook wedged under a milestone. Route notes, money tips, hard-won lessons. No name, just: \'For whoever needs it.\' You pick it up. You needed it.',
    reward: { type: 'xp', amount: 55 },
    rewardDesc: '+55 bonus XP'
  },
  {
    id: 'camp',
    icon: '🏕️',
    title: 'Abandoned Camp',
    zone: 'Lucky Find',
    desc: 'An abandoned camp, left in perfect order -- fire still warm, everything stowed. Under a flat stone: a small coin pouch and a note. \'For the next one.\' You pocket it. You\'ll pay it forward eventually.',
    reward: { type: 'gold', amount: 25 },
    rewardDesc: '+25 💰 Road Gold'
  },
  {
    id: 'elder',
    icon: '🧙',
    title: 'Road Veteran',
    zone: 'Friendly Encounter',
    desc: 'An older traveler is sitting on a stump watching people go by. Most get a glance. You get a slow nod -- the deliberate kind. They press a coin into your hand. \'Keep the log clean.\' That\'s all.',
    reward: { type: 'gold', amount: 15 },
    rewardDesc: '+15 💰 Road Gold'
  },
  {
    id: 'griffon',
    icon: '🦅',
    title: 'Clear Road Ahead',
    zone: 'Good News',
    desc: 'Guild cloth tied to a branch ahead — someone came through here before you and left the all-clear marker. Fastest route confirmed, no known hazards. You make genuinely good time.',
    reward: { type: 'xp', amount: 35 },
    rewardDesc: '+35 bonus XP'
  },
  {
    id: 'merchant_deal',
    icon: '🤝',
    title: 'Honest Merchant',
    zone: 'Friendly Encounter',
    desc: 'A travelling merchant flags you down and gives you an actually fair deal — no hidden terms, no pressure, just a clean trade at a reasonable price. You almost don\'t know what to do with that. You manage. A small pouch of road gold changes hands.',
    reward: { type: 'gold', amount: 20 },
    rewardDesc: '+20 💰 Road Gold'
  }
];

// ── STORY ENCOUNTERS (NPC flavor — punchy, no continuity required) ──
var STORY_ENCOUNTERS = {
  z1: [
    {
      id: 'veteran_tab',
      icon: '🍺',
      title: 'The Innkeeper\'s Wall',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'A veteran sellsword has been drinking on credit since the last harvest moon. The innkeeper\'s tally now spans three wall planks. The sellsword hasn\'t glanced at it once. You pay your tab in exact silver and sleep well.'
    },
    {
      id: 'name_on_board',
      icon: '📜',
      title: 'Bounty: The Vanished Merchant',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'The guild notice board has a new posting: a traveling merchant vanished three nights past, owing the Coppersmith\'s Guild 80 gold in unpaid consignment fees. The guild wants him found. You make a note to always settle your accounts before nightfall.'
    },
    {
      id: 'cartographer',
      icon: '🗺️',
      title: 'The Cartographer\'s Wisdom',
      zone: 'Harvest Crossing',
      minPos: 1,
      desc: 'A gnome cartographer has set up her cart at the crossroads — the cart is visibly larger on the inside than the outside, which she declines to explain. She unfurls a map of three alternate routes, each annotated with toll costs, detour fees, and hidden levies. \'Every shortcut has a price. Mine just shows you what it is.\' You buy nothing. You leave better informed.'
    },
    {
      id: 'griffon_rider',
      icon: '🦅',
      title: 'Grounded Rider',
      zone: 'Harvest Crossing',
      minPos: 1,
      desc: 'A griffon rider sits under the crossroads oak, waiting on a healer for her mount\'s torn wing. Could be a week. \'Patience costs less than a second mistake on the road,\' she says to the griffon, who ignores her. Good advice either way.'
    },
    {
      id: 'the_queue',
      icon: '⚖️',
      title: 'The Toll Queue',
      zone: 'Stonepath Mill',
      minPos: 2,
      desc: 'Six travelers in the toll queue. The fifth — a self-declared wizard in budget robes — is three coppers short and baffled by this. The tollmaster has the expression of someone who has seen this every single day for fifteen years. You have exact coin. You\'re through in seconds.'
    },
  ],
  z2: [
    {
      id: 'the_exchange',
      icon: '🏛️',
      title: 'The Moneychanger\'s Guild',
      zone: "Merchant's Gate",
      minPos: 3,
      desc: 'A side door opens briefly — inside, a full hall of guild scribes bent over ledgers, quills moving in eerie unison. One looks up, spots your expense log, and gives a single approving nod before the door swings shut. You\'ll take the endorsement.'
    },
    {
      id: 'bridge_ghost',
      icon: '👻',
      title: 'The Copper Ghost',
      zone: 'Copperbridge',
      minPos: 4,
      desc: 'Locals say a debtor\'s ghost haunts Copperbridge — doomed to count coins he no longer has. You cross at dusk. You don\'t see anything. But you do check your balance twice before you reach the other side.'
    },
    {
      id: 'campfire_rumour',
      icon: '🔥',
      title: 'Around the Fire',
      zone: "Trader's Camp",
      minPos: 5,
      desc: 'Traders swapping road tales by firelight. A dwarf swears he found a coin pouch on a milestone near the Thornwood — enchanted gold, no owner, no curse attached. Nobody believes him. \'Eyes open anyway,\' he says, and means it.'
    },
  ],
  z3: [
    {
      id: 'ranger_warning',
      icon: '🏹',
      title: 'The Sentinel\'s Word',
      zone: 'Thornwood Edge',
      minPos: 6,
      desc: 'A Thornwood sentinel drops from a branch and lands in front of you without a sound. \'Keep moving. Don\'t bargain with anything that glows.\' She\'s back in the canopy before you can ask what she means. You keep moving.'
    },
    {
      id: 'the_quiet',
      icon: '🌲',
      title: 'The Silence Hex',
      zone: 'Darkhollow Path',
      minPos: 7,
      desc: 'An old hex on Darkhollow Path muffles sound within a hundred paces — ancient druid work, they say, to encourage honest thinking. No merchants, no haggling, just the path and your own thoughts. Your accounts have never been clearer.'
    },
    {
      id: 'shrine_offering',
      icon: '🌸',
      title: 'The Road Offering',
      zone: 'Wayward Shrine',
      minPos: 8,
      desc: 'The shrine to Avreth, patron of travelers and honest coin, holds a fresh silver piece left by someone just ahead of you. You add a copper of your own. The road feels less heavy. The priests say Avreth rewards those who track what they carry.'
    },
  ],
  z4: [
    {
      id: 'gate_check',
      icon: '🛡️',
      title: 'The Iron Gate',
      zone: 'Iron Keep Gates',
      minPos: 9,
      desc: 'The Iron Keep gate captain has seen ten thousand travelers. She reads yours in three seconds flat — log in hand, budget intact, no debts trailing behind you. She stamps your writ without a word. Here, that\'s as warm as welcomes get.'
    },
    {
      id: 'the_keep',
      icon: '⚔️',
      title: 'The Keep Quartermaster',
      zone: 'The Iron Keep',
      minPos: 10,
      desc: 'The Keep quartermaster is infamous for turning away merchants who can\'t produce clean books. He holds out his hand. You hand over your log without hesitation. He reads it, raises an eyebrow. \'First one today who didn\'t fumble.\' The gate opens.'
    },
  ]
};
// ─────────────────────────
//  STATE
// ─────────────────────────
var state = {
  name: '',
  avatar: '',
  heroClass: '',
  xp: 0,
  streak: 0,
  lastLogDate: null,
  log: [],
  monthlyBudget: 0,
  coinReserve: 0,
  ironVault: 0,
  currentMonth: '',
  hearts: 3,
  mapPosition: 0,
  badges: [],
  weekLogDays: [],
  weekStart: '',
  roadBonusesThisMonth: 0,
  lastEncounterLog: '',
  bestStreak: 0,
  pendingEncounter: null,
  seenStoryEncounters: [],
  seenArrivals: [],
  lastMapPosition: -1,
  encounterLogCount: 0,
  lastEncounterAtLog: 0
};

// Temp onboarding picks
var obAvatar = '';
var obClass  = '';

// ─────────────────────────
//  SUPABASE
// ─────────────────────────
var SUPABASE_URL = 'https://czolsfnkwqtnkziakclg.supabase.co';
var SUPABASE_KEY = 'sb_publishable_zcYS8yzbinVjqmY1P_RM4w_BjOEExwq';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var currentUserId = null;
var isSigningOut = false;

// ─────────────────────────
//  SAVE / LOAD
// ─────────────────────────
function save() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  if (currentUserId) {
    sb.from('profiles')
      .upsert({ user_id: currentUserId, save_data: state, updated_at: new Date().toISOString() },
               { onConflict: 'user_id' })
      .then(function(res) {
        if (res.error) console.warn('Supabase save error:', res.error.message);
      });
  }
}

function load() {
  var raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  try {
    var parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || !parsed) return;
    if (!Array.isArray(parsed.log)) parsed.log = [];
    ['name','avatar','heroClass','xp','streak','lastLogDate','log','monthlyBudget','coinReserve','ironVault','currentMonth','hearts','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition','encounterLogCount','lastEncounterAtLog','firedOverBudgetEncounter','bestStreak','woundedMode','cleanDayStreak','lastCleanDay','woundedDayStartReserve'].forEach(function(k) {
      if (parsed[k] !== undefined) state[k] = parsed[k];
    });
  } catch(e) { console.warn('Load failed:', e); }
}

async function loadFromSupabase() {
  if (!currentUserId) return;
  try {
    var res = await sb.from('profiles').select('save_data').eq('user_id', currentUserId).single();
    if (res.error || !res.data || !res.data.save_data) return;
    var remote = res.data.save_data;
    if (typeof remote !== 'object') return;
    if (!Array.isArray(remote.log)) remote.log = [];
    ['name','avatar','heroClass','xp','streak','lastLogDate','log','monthlyBudget','coinReserve','ironVault','currentMonth','hearts','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition','encounterLogCount','lastEncounterAtLog','firedOverBudgetEncounter','bestStreak','woundedMode','cleanDayStreak','lastCleanDay','woundedDayStartReserve'].forEach(function(k) {
      if (remote[k] !== undefined) state[k] = remote[k];
    });
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  } catch(e) { console.warn('Supabase load error:', e); }
}

// ─────────────────────────
//  AUTH FUNCTIONS
// ─────────────────────────


async function signInWithPassword() {
  var email    = document.getElementById('login-email-pw').value.trim();
  var password = document.getElementById('login-password').value;
  var errEl    = document.getElementById('login-error-pw');
  errEl.style.display = 'none';

  if (!email || !password) {
    errEl.textContent = 'Enter your email and password.';
    errEl.style.display = 'block';
    return;
  }
  var btn = document.querySelector('#login-form-password .btn-primary');
  btn.textContent = 'Entering…';
  btn.disabled = true;

  var res = await sb.auth.signInWithPassword({ email: email, password: password });
  if (res.error) {
    errEl.textContent = res.error.message === 'Invalid login credentials'
      ? 'Wrong email or password. Try again.'
      : res.error.message;
    errEl.style.display = 'block';
    btn.textContent = 'Enter the Realm ⚔';
    btn.disabled = false;
  }
}



function showLoginError(msg) {
  var el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = 'block';
}



async function signOut() {
  isSigningOut = true;
  try { await sb.auth.signOut(); } catch(e) { console.warn('Sign out error:', e); }
  currentUserId = null;
  localStorage.removeItem(SAVE_KEY);
  Object.assign(state, {
    name:'',avatar:'',heroClass:'',xp:0,streak:0,lastLogDate:null,log:[],
    monthlyBudget:0,coinReserve:0,ironVault:0,currentMonth:'',hearts:3,
    mapPosition:0,badges:[],weekLogDays:[],weekStart:'',roadBonusesThisMonth:0,
    lastEncounterLog:'',pendingEncounter:null,seenStoryEncounters:[],
    seenArrivals:[],lastMapPosition:-1,
    encounterLogCount:0,lastEncounterAtLog:0,firedOverBudgetEncounter:false,
  woundedMode:false,cleanDayStreak:0,lastCleanDay:'',woundedDayStartReserve:null
  });
  document.getElementById('header-auth').style.display = 'none';
  document.getElementById('main').style.display = 'none';
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('login-screen').style.display = 'block';
  isSigningOut = false;
}

// ─────────────────────────
//  INIT
// ─────────────────────────
var _appInitDone = false; // guard: only run full init once per page load

async function initApp() {
  sb.auth.onAuthStateChange(async function(event, session) {
    if (isSigningOut) return;
    if (session && session.user) {
      currentUserId = session.user.id;
      document.getElementById('header-email').textContent = session.user.email;
      document.getElementById('header-auth').style.display = 'flex';
      document.getElementById('login-screen').style.display = 'none';

      // Only run the full load sequence once per page load.
      // onAuthStateChange can fire multiple times (INITIAL_SESSION, SIGNED_IN, TOKEN_REFRESHED)
      // Re-running load() each time would reset state mid-session.
      if (_appInitDone) return;
      _appInitDone = true;

      // Load localStorage FIRST — instant, always available
      load();

      // Then overlay Supabase on top — authoritative remote save
      await loadFromSupabase();

      // Defensive defaults for any missing fields
      if (state.hearts === undefined)              state.hearts = 3;
      if (!state.badges)                           state.badges = [];
      if (!state.weekLogDays)                      state.weekLogDays = [];
      if (state.roadBonusesThisMonth === undefined) state.roadBonusesThisMonth = 0;
      if (!state.lastEncounterLog)                 state.lastEncounterLog = '';
      if (!state.seenStoryEncounters)              state.seenStoryEncounters = [];
      if (!state.seenArrivals)                     state.seenArrivals = [];
      if (state.lastMapPosition === undefined)     state.lastMapPosition = -1;
      if (state.bestStreak === undefined)          state.bestStreak = 0;
      if (state.woundedMode === undefined)           state.woundedMode = false;
      if (state.cleanDayStreak === undefined)        state.cleanDayStreak = 0;
      if (!state.lastCleanDay)                       state.lastCleanDay = '';
      if (state.woundedDayStartReserve === undefined) state.woundedDayStartReserve = null;
      // NOTE: do NOT unconditionally reset firedOverBudgetEncounter here —
      // that caused over-budget encounters to re-fire on every refresh

      checkStreak();
      checkMonthReset();

      if (state.name) {
        document.getElementById('onboarding').style.display = 'none';
        document.getElementById('main').style.display = 'block';
        render();
      } else {
        document.getElementById('onboarding').style.display = 'block';
        document.getElementById('main').style.display = 'none';
      }
    } else {
      currentUserId = null;
      document.getElementById('header-auth').style.display = 'none';
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('main').style.display = 'none';
      document.getElementById('onboarding').style.display = 'none';
    }
  });
}

initApp();

// ─────────────────────────
//  STREAK / DATE HELPERS
// ─────────────────────────
function getToday() { return new Date().toDateString(); }
function getYesterday() {
  var d = new Date(); d.setDate(d.getDate() - 1); return d.toDateString();
}

function checkStreak() {
  var today = getToday();
  var yesterday = getYesterday();
  var last = state.lastLogDate;
  if (!last) return;
  if (last === today) return; // fine
  if (last === yesterday) return; // fine — streak intact until end of today
  // More than 1 day gap — streak broken
  if (last !== yesterday && last !== today) {
    state.streak = 0;
    save();
  }
}

function markLoggedToday() {
  var today = getToday();
  if (state.lastLogDate === today) return; // already logged today
  var yesterday = getYesterday();
  if (state.lastLogDate === yesterday || state.streak === 0) {
    state.streak = (state.streak || 0) + 1;
  } else if (!state.lastLogDate) {
    state.streak = 1;
  }
  state.lastLogDate = today;
  // Track personal best
  if (state.streak > (state.bestStreak || 0)) {
    state.bestStreak = state.streak;
  }
}

// ─────────────────────────
//  WOUNDED MODE
// ─────────────────────────
function enterWoundedMode() {
  if (state.woundedMode) return; // already wounded
  state.woundedMode    = true;
  state.cleanDayStreak = 0;
  state.lastCleanDay   = '';
  save();
}

function checkCleanDay() {
  // Called after each log. A "clean day" = today's logs don't push reserve
  // further negative than it was at start of day, OR reserve is already >= 0.
  // Simpler definition: reserve didn't get MORE negative today.
  // Track by comparing start-of-log-day reserve against current.
  // We use: if reserve is still negative but we logged today without
  // making it worse — that counts. We track via lastCleanDay date.
  if (!state.woundedMode) return;

  var today = new Date().toDateString();

  // Check if today is already counted
  if (state.lastCleanDay === today) return;

  // Today qualifies as clean if coinReserve didn't drop further than yesterday's close.
  // We approximate: if the player logged at least once today and reserve >= what it was
  // at the start of the session, we credit a clean day.
  // Simplest rule: if they didn't push reserve MORE negative today vs when they started logging.
  // We track via state.woundedDayStartReserve set at first log each day.
  if (state.woundedDayStartReserve === undefined || state.woundedDayStartReserve === null) {
    state.woundedDayStartReserve = state.coinReserve;
    return; // first log today — set baseline, don't credit yet
  }

  // Credit clean day if reserve didn't worsen today
  if (state.coinReserve >= state.woundedDayStartReserve) {
    state.lastCleanDay   = today;
    state.cleanDayStreak = (state.cleanDayStreak || 0) + 1;
    if (state.cleanDayStreak >= 3) {
      // Recovery!
      state.woundedMode            = false;
      state.cleanDayStreak         = 0;
      state.lastCleanDay           = '';
      state.woundedDayStartReserve = null;
      save();
      setTimeout(function() {
        showToast('Treasury recovering. The road opens back up. ✦');
        render();
      }, 400);
      return;
    }
    save();
  }
}

function resetWoundedDayBaseline() {
  // Called at start of each new logging day while wounded
  var today = new Date().toDateString();
  if (state.woundedMode && state.lastCleanDay !== today) {
    // New day — reset the day baseline to current reserve
    state.woundedDayStartReserve = state.coinReserve;
  }
}

// ─────────────────────────
//  XP / LEVEL HELPERS
// ─────────────────────────
function getLevelData(xp) {
  var level = 1;
  for (var i = LEVEL_XP.length - 1; i >= 0; i--) {
    if (xp >= LEVEL_XP[i]) { level = i + 1; break; }
  }
  level = Math.min(level, LEVEL_XP.length);
  var xpAtStart = LEVEL_XP[level - 1] || 0;
  var xpAtEnd   = level < LEVEL_XP.length ? LEVEL_XP[level] : LEVEL_XP[LEVEL_XP.length - 1];
  var inLevel   = xp - xpAtStart;
  var needed    = xpAtEnd - xpAtStart;
  var pct       = needed > 0 ? Math.min(100, (inLevel / needed) * 100) : 100;
  var toNext    = Math.max(0, xpAtEnd - xp);
  return { level: level, xpAtEnd: xpAtEnd, pct: pct, toNext: toNext };
}

function getTitle(heroClass, level) {
  var titles = CLASS_TITLES[heroClass] || CLASS_TITLES['Knight'];
  var idx = Math.min(Math.floor((level - 1) / 2), titles.length - 1);
  return titles[idx];
}

// ─────────────────────────
//  MAP HELPERS
// ─────────────────────────
function getMapPosition() { return state.mapPosition || 0; }

function getCurrentWaypoint() {
  var pos = getMapPosition();
  for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
    if (MAP_WAYPOINTS[i].id === pos) return MAP_WAYPOINTS[i];
  }
  return MAP_WAYPOINTS[0];
}

function advanceMap() {
  var pos = getMapPosition();
  // numeric positions: 0-10
  var maxNumeric = 10;
  if (typeof pos === 'number' && pos < maxNumeric) {
    state.mapPosition = pos + 1;
    state.lastMapPosition = pos;
    save();
    return true;
  }
  return false;
}

// ─────────────────────────
//  WEEK ROAD BONUS
// ─────────────────────────
function getWeekStart() {
  var d = new Date();
  var day = d.getDay(); // 0=Sun
  d.setDate(d.getDate() - day);
  return d.toDateString();
}

function checkWeekRoadBonus() {
  var ws = getWeekStart();
  if (state.weekStart !== ws) {
    state.weekStart   = ws;
    state.weekLogDays = [];
  }
  var today = getToday();
  if (state.weekLogDays.indexOf(today) === -1) {
    state.weekLogDays.push(today);
  }
  // 5+ unique days this week → road bonus (up to 3 per month)
  if (state.weekLogDays.length >= 5 && (state.roadBonusesThisMonth || 0) < 3) {
    state.roadBonusesThisMonth = (state.roadBonusesThisMonth || 0) + 1;
    state.weekLogDays = []; // reset so they can earn next week
    showToast('🗺️ Road Bonus earned! Advancing the map...');
    setTimeout(function() {
      if (advanceMap()) { render(); checkZoneBadge(); checkArrival(); }
    }, 1400);
  }
}

// ─────────────────────────
//  ARRIVAL POPUPS
// ─────────────────────────

// ─────────────────────────
//  ARRIVAL GOLD GIFT
// ─────────────────────────
function arrivalGoldAmount(pos) {
  if (pos <= 2) return 12;
  if (pos <= 5) return 10;
  if (pos <= 8) return 8;
  return 6;
}

function giftArrivalGold(pos) {
  var amount = arrivalGoldAmount(pos);
  state.ironVault = (state.ironVault || 0) + amount;
  save();
  render();
  setTimeout(function() {
    fireGoldFloat('+' + amount + ' 💰');
    showToast('💰 +' + amount + ' gold — the road provides.');
  }, 300);
}
function checkArrival() {
  var pos = getMapPosition();
  if (pos === state.lastMapPosition) return;
  var wp = getCurrentWaypoint();
  if (!wp) return;
  if (!Array.isArray(state.seenArrivals)) state.seenArrivals = [];
  var aid = 'arr_' + wp.id;
  if (state.seenArrivals.indexOf(aid) !== -1) return;
  state.seenArrivals.push(aid);
  save();

  if (wp.zoneComplete) {
    // already handled by checkZoneBadge
    return;
  }
  if (wp.arrival) {
    var _pos = pos; // capture for closure
    queueOverlay(function() { showStoryEncounter(wp.icon || '📍', wp.name.replace('\n',' '), wp.arrival, 'story', _pos); });
  }
}

function showStoryEncounter(icon, title, desc, type, goldPos) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box story';
  document.getElementById('encounter-zone').textContent  = '✦ New Location Reached';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = title;
  document.getElementById('encounter-desc').textContent  = desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  // Show gold reward on the button so player knows it's coming
  var goldAmt = (goldPos !== undefined) ? arrivalGoldAmount(goldPos) : 0;
  btn.innerHTML = goldAmt > 0
    ? 'Onward ⚔ <span class="overlay-btn-cost">+' + goldAmt + ' 💰 road gold</span>'
    : 'Onward ⚔';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    if (goldPos !== undefined) giftArrivalGold(goldPos);
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}


// ─────────────────────────
//  BROKEN (0 HEARTS)
// ─────────────────────────
var REVIVE_COST = 30; // gold cost to revive with 3 hearts
var XP_PENALTY  = 50; // xp lost if reviving broke

function checkBroken() {
  if ((state.hearts || 0) <= 0) {
    queueOverlay(function() { showBroken(); });
  }
}

function showBroken() {
  var gold = state.ironVault || 0;
  document.getElementById('broken-gold-display').textContent = gold + ' 💰';

  var choices = document.getElementById('broken-choices');
  choices.innerHTML = '';

  if (gold >= REVIVE_COST) {
    var btnA = document.createElement('button');
    btnA.className = 'overlay-btn hostile-choice';
    btnA.style.width = '100%'; btnA.style.textAlign = 'center';
    btnA.innerHTML = '🪙 Spend ' + REVIVE_COST + ' 💰 to revive<span class="overlay-btn-cost">Hearts restored to full — road continues</span>';
    btnA.onclick = function() { resolveRevive('gold'); };
    choices.appendChild(btnA);
  }

  var btnB = document.createElement('button');
  btnB.className = 'overlay-btn';
  btnB.style.width = '100%'; btnB.style.textAlign = 'center';
  btnB.innerHTML = '💀 Carry on broke<span class="overlay-btn-cost">Lose ' + XP_PENALTY + ' XP — hearts restored, Road Gold untouched</span>';
  btnB.onclick = function() { resolveRevive('xp'); };
  choices.appendChild(btnB);

  document.getElementById('broken-overlay').classList.add('show');
}

function resolveRevive(method) {
  document.getElementById('broken-overlay').classList.remove('show');
  overlayDismissed();
  state.hearts = 3;
  if (method === 'gold') {
    state.ironVault = Math.max(0, (state.ironVault || 0) - REVIVE_COST);
    showToast('💰 ' + REVIVE_COST + ' gold spent — back on your feet.');
    fireGoldFloat('-' + REVIVE_COST + ' 💰');
  } else {
    state.xp = Math.max(0, (state.xp || 0) - XP_PENALTY);
    showToast('💀 Carried on broke — ' + XP_PENALTY + ' XP lost. Hearts restored.');
  }
  save();
  render();
}

// ─────────────────────────
//  OVERLAY QUEUE
// ─────────────────────────
var _overlayQueue = [];
var _overlayActive = false;

function queueOverlay(fn) {
  _overlayQueue.push(fn);
  _drainQueue();
}

function _drainQueue() {
  if (_overlayActive || _overlayQueue.length === 0) return;
  _overlayActive = true;
  var next = _overlayQueue.shift();
  next();
}

// Call this at the END of every overlay dismiss handler
function overlayDismissed() {
  _overlayActive = false;
  // Small gap so the transition plays out before next one appears
  setTimeout(_drainQueue, 350);
}

// ─────────────────────────
//  RANDOM ENCOUNTERS
// ─────────────────────────
function checkEncounter(amount) {
  // Cooldown: skip if last encounter was within the last 2 logs
  if (!state.encounterLogCount) state.encounterLogCount = 0;
  state.encounterLogCount++;
  var lastAt = state.lastEncounterAtLog || 0;
  if (state.encounterLogCount - lastAt < 1) return; // minimum 1 log between encounters

  // 45% chance per eligible expense
  if (Math.random() > 0.55) return; // 55% chance per eligible log

  // Mark that an encounter fired at this log count
  state.lastEncounterAtLog = state.encounterLogCount;
  save();

  // Check for unseen story encounters first (priority)
  var pos = getMapPosition();
  var zone = pos <= 2 ? 'z1' : pos <= 5 ? 'z2' : pos <= 8 ? 'z3' : 'z4';
  var storyPool = STORY_ENCOUNTERS[zone] || [];
  var available = storyPool.filter(function(e) {
    return e.minPos <= pos && (state.seenStoryEncounters || []).indexOf(e.id) === -1;
  });

  // 60% chance to show a story encounter if one is available
  if (available.length > 0 && Math.random() < 0.75) { // 75% to show story if available
    var enc = available[Math.floor(Math.random() * available.length)];
    if (!state.seenStoryEncounters) state.seenStoryEncounters = [];
    state.seenStoryEncounters.push(enc.id);
    save();
    queueOverlay(function() { showStoryEncounterFull(enc); });
    return;
  }

  // Otherwise hostile (40%) or friendly (60%)
  if (Math.random() < 0.40) {
    var hostile = HOSTILE_ENCOUNTERS[Math.floor(Math.random() * HOSTILE_ENCOUNTERS.length)];
    queueOverlay(function() { showEncounter(hostile, true); });
  } else {
    var friendly = FRIENDLY_ENCOUNTERS[Math.floor(Math.random() * FRIENDLY_ENCOUNTERS.length)];
    queueOverlay(function() { showEncounter(friendly, false); });
  }
}

function showStoryEncounterFull(enc) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box story';
  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'Keep Moving ⚔';
  btn.onclick = function() { document.getElementById('encounter-overlay').classList.remove('show'); overlayDismissed(); };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

function showEncounter(enc, isHostile) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box ' + (isHostile ? 'hostile' : 'friendly');

  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;

  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';

  if (isHostile) {
    var btnA = document.createElement('button');
    btnA.className = 'overlay-btn hostile-choice';
    btnA.innerHTML = enc.choiceA.label + '<span class="overlay-btn-cost">' + enc.choiceA.sub + '</span>';
    btnA.onclick = function() { resolveHostile('heart', enc); };

    var btnB = document.createElement('button');
    var goldCost = enc.goldCost || 0;
    var hasGold  = (state.ironVault || 0) >= goldCost;
    if (hasGold) {
      btnB.className = 'overlay-btn';
      btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">' + enc.choiceB.sub + ' (' + (state.ironVault || 0) + ' 💰 available)</span>';
      btnB.onclick = function() { resolveHostile('gold', enc); };
    } else {
      btnB.className = 'overlay-btn overlay-btn-disabled';
      btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">Need ' + goldCost + ' 🪙 Road Gold — you have ' + (state.ironVault || 0) + '</span>';
      btnB.disabled = true;
    }

    choices.appendChild(btnA);
    choices.appendChild(btnB);
  } else {
    var btn = document.createElement('button');
    btn.className = 'overlay-btn friendly-choice';
    btn.innerHTML = 'Accept the reward<span class="overlay-btn-cost">' + enc.rewardDesc + '</span>';
    btn.onclick = function() { resolveFriendly(enc); };
    choices.appendChild(btn);
  }

  document.getElementById('encounter-overlay').classList.add('show');
}

function resolveHostile(choice, enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  overlayDismissed();
  if (choice === 'heart') {
    state.hearts = Math.max(0, (state.hearts || 3) - 1);
    showToast('❤️ Heart spent — the threat is driven back.');
  } else if (choice === 'gold') {
    var cost = enc.goldCost || 0;
    state.ironVault = Math.max(0, (state.ironVault || 0) - cost);
    showToast('💰 ' + cost + ' gold spent — problem solved.');
    fireGoldFloat('-' + cost + ' 💰');
  }
  save();
  render();
  checkBroken();
}

function resolveFriendly(enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  overlayDismissed();
  if (enc.reward.type === 'xp') {
    state.xp += enc.reward.amount;
    showToast('✨ +' + enc.reward.amount + ' bonus XP!');
  } else if (enc.reward.type === 'heart') {
    state.hearts = Math.min(3, (state.hearts || 0) + 1);
    showToast('❤️ Heart restored!');
  } else if (enc.reward.type === 'gold') {
    state.ironVault = (state.ironVault || 0) + enc.reward.amount;
    showToast('💰 +' + enc.reward.amount + ' Road Gold earned!');
    fireGoldFloat('+' + enc.reward.amount + ' 💰');
  }
  save();
  render();
}

function checkZoneBadge() {
  var pos = getMapPosition();
  var badges = state.badges || [];

  if (pos >= 3 && badges.indexOf('zone1') === -1) {
    badges.push('zone1'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🛡️', 'The First Steps', 'You clear the Hearthstone Road. First zone down. It feels smaller looking back.'); });
  }
  if (pos >= 6 && badges.indexOf('zone2') === -1) {
    badges.push('zone2'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🪙', 'Disciplined Traveler', "The Merchant's Pass is behind you. You navigated the markets and kept your budget intact."); });
  }
  if (pos >= 9 && badges.indexOf('zone3') === -1) {
    badges.push('zone3'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🌿', 'Thornwood Survivor', 'Thornwood cleared. Turns out it\'s just a forest if you keep logging. You come out the other side intact.'); });
  }
  if (pos >= 10 && badges.indexOf('zone4') === -1) {
    badges.push('zone4'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🔒', 'Keeper of the Road', 'You have reached the Iron Keep. The road ahead is longer and wider than any map shows. You are ready.'); });
  }
}

function showZoneComplete(icon, badgeName, narrative) {
  var ZONE_GOLD = 25;
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box zone-complete';
  document.getElementById('encounter-zone').textContent  = '✦ Zone Complete';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = 'Badge Earned: ' + badgeName;
  document.getElementById('encounter-desc').textContent  = narrative;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'March Forward ⚔ <span class="overlay-btn-cost">+' + ZONE_GOLD + ' 💰 zone bonus</span>';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    state.ironVault = (state.ironVault || 0) + ZONE_GOLD;
    save(); render();
    setTimeout(function() {
      fireGoldFloat('+' + ZONE_GOLD + ' 💰');
      showToast('💰 +' + ZONE_GOLD + ' gold — zone cleared!');
    }, 300);
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

// ─────────────────────────
//  RENDER MAP
// ─────────────────────────
function renderMap() {
  var pos = getMapPosition();
  var wp  = getCurrentWaypoint();

  if (wp) {
    document.getElementById('map-location-name').textContent = wp.name.replace('\n',' ');
    var zoneNums = ['I','II','III','IV'];
    var zoneIdx  = typeof wp.zone === 'number' ? wp.zone - 1 : 0;
    document.getElementById('map-zone-tag').textContent =
      'Zone ' + (zoneNums[zoneIdx] || 'I') + ' — ' + (wp.zoneName || '');
  }

  // ── MAP DIMENSIONS — full height, no scroll ─────────────────────────
  var W_base = (document.getElementById('map-viewport') || {}).offsetWidth || 340;
  var W = W_base;
  var H = Math.round(W * 2.1); // tall portrait — like a real map
  H = Math.max(460, Math.min(H, 620));

  // Pure linear zig-zag — always forward, no badge spurs
  var NODE_LAYOUT = [
    { id:0,  pct:[50,  4] },   // Hearthstone Village — center top
    { id:1,  pct:[72, 13] },   // Harvest Crossing — right
    { id:2,  pct:[30, 22] },   // Stonepath Mill — left
    { id:3,  pct:[68, 33] },   // Merchant's Gate — right
    { id:4,  pct:[32, 43] },   // Copperbridge — left
    { id:5,  pct:[65, 53] },   // Trader's Camp — right
    { id:6,  pct:[35, 63] },   // Thornwood Edge — left
    { id:7,  pct:[68, 72] },   // Darkhollow Path — right
    { id:8,  pct:[38, 81] },   // Wayward Shrine — left
    { id:9,  pct:[62, 90] },   // Iron Keep Gates — right
    { id:10, pct:[50, 97] },   // The Iron Keep — center bottom
  ];

  // Single continuous road — always forward
  var CONNECTIONS = [
    [0,1],[1,2],[2,3],[3,4],[4,5],[5,6],[6,7],[7,8],[8,9],[9,10],
  ];

  var container  = document.getElementById('node-map');
  var viewport   = document.getElementById('map-viewport');
  var inner      = document.getElementById('node-map-inner');
  var svg        = document.getElementById('map-svg');
  var moreArrow  = document.getElementById('map-more-arrow');
  if (!container || !inner || !svg || !viewport) return;

  container.style.height = H + 'px';
  viewport.style.height  = H + 'px'; // full height — no clipping
  svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
  svg.style.height = H + 'px';
  svg.style.width  = '100%';

  var posMap = {};
  NODE_LAYOUT.forEach(function(n) {
    posMap[n.id] = {
      x: Math.round(W * n.pct[0] / 100),
      y: Math.round(H * n.pct[1] / 100)
    };
  });

  // No camera pan needed — full map visible
  container.style.transform = 'none';
  if (moreArrow) moreArrow.className = 'map-more-arrow hidden';

  function isReached(id) {
    if (typeof id === 'number') return id <= pos;
    var bm = {'z1':3,'z2':6,'z3':9,'z4':10};
    return pos >= (bm[id] || 999);
  }

  // ── SVG DEFS — parchment filter + terrain symbols ──────────────────
  svg.innerHTML = '';

  var defs = document.createElementNS('http://www.w3.org/2000/svg','defs');

  // Parchment noise filter
  defs.innerHTML = [
    '<filter id="road-blur"><feGaussianBlur stdDeviation="0.8"/></filter>',
    '<radialGradient id="vignette" cx="50%" cy="50%" r="60%">',
    '<stop offset="0%" stop-color="transparent"/>',
    '<stop offset="100%" stop-color="rgba(8,6,4,0.55)"/>',
    '</radialGradient>',
    '<radialGradient id="zone1-bg" cx="50%" cy="20%" r="55%">',
    '<stop offset="0%" stop-color="#2a1f0a" stop-opacity="0.9"/>',
    '<stop offset="100%" stop-color="#1a1208" stop-opacity="0.9"/>',
    '</radialGradient>',
    '<radialGradient id="zone2-bg" cx="50%" cy="50%" r="55%">',
    '<stop offset="0%" stop-color="#251608" stop-opacity="0.9"/>',
    '<stop offset="100%" stop-color="#1a1005" stop-opacity="0.9"/>',
    '</radialGradient>',
    '<radialGradient id="zone3-bg" cx="50%" cy="50%" r="55%">',
    '<stop offset="0%" stop-color="#0a1a0e" stop-opacity="0.92"/>',
    '<stop offset="100%" stop-color="#060d08" stop-opacity="0.92"/>',
    '</radialGradient>',
    '<radialGradient id="zone4-bg" cx="50%" cy="80%" r="55%">',
    '<stop offset="0%" stop-color="#140a22" stop-opacity="0.94"/>',
    '<stop offset="100%" stop-color="#0a0614" stop-opacity="0.94"/>',
    '</radialGradient>'
  ].join('');
  svg.appendChild(defs);

  // ── ZONE BACKGROUNDS ────────────────────────────────────────────────
  var zoneBands = [
    { y1: 0,  y2: 24, fill: 'url(#zone1-bg)' },
    { y1: 24, y2: 46, fill: 'url(#zone2-bg)' },
    { y1: 46, y2: 75, fill: 'url(#zone3-bg)' },
    { y1: 75, y2: 100, fill: 'url(#zone4-bg)' },
  ];
  zoneBands.forEach(function(zb) {
    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', '0');
    r.setAttribute('y', Math.round(H * zb.y1/100) + '');
    r.setAttribute('width', W + '');
    r.setAttribute('height', Math.round(H * (zb.y2-zb.y1)/100) + '');
    r.setAttribute('fill', zb.fill);
    svg.appendChild(r);
  });

  // ── SUBTLE TEXTURE OVERLAY — crosshatch pattern ──────────────────────
  // Use a tiny SVG pattern for aged-parchment feel (no filter = no pixelation)
  var patDef = document.createElementNS('http://www.w3.org/2000/svg','pattern');
  patDef.setAttribute('id','hatch'); patDef.setAttribute('width','6');
  patDef.setAttribute('height','6'); patDef.setAttribute('patternUnits','userSpaceOnUse');
  var pl = document.createElementNS('http://www.w3.org/2000/svg','path');
  pl.setAttribute('d','M0,6 L6,0 M-1,1 L1,-1 M5,7 L7,5');
  pl.setAttribute('stroke','rgba(180,140,60,0.04)'); pl.setAttribute('stroke-width','0.5');
  patDef.appendChild(pl);
  defs.appendChild(patDef);
  var texRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
  texRect.setAttribute('x','0'); texRect.setAttribute('y','0');
  texRect.setAttribute('width',W+''); texRect.setAttribute('height',H+'');
  texRect.setAttribute('fill','url(#hatch)');
  svg.appendChild(texRect);

  // ── ZONE SEPARATOR RULES ────────────────────────────────────────────
  var sepPcts = [24, 46, 75];
  sepPcts.forEach(function(pct) {
    var y = Math.round(H * pct/100);
    // Decorative rule — double line with gap
    [-1,1].forEach(function(offset) {
      var l = document.createElementNS('http://www.w3.org/2000/svg','line');
      l.setAttribute('x1','8'); l.setAttribute('y1', y+offset+'');
      l.setAttribute('x2', W-8+''); l.setAttribute('y2', y+offset+'');
      l.setAttribute('stroke','rgba(196,162,74,0.18)');
      l.setAttribute('stroke-width','0.5');
      svg.appendChild(l);
    });
    // Center ornament
    var diamond = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    var cx = Math.round(W/2), cy = y;
    diamond.setAttribute('points', cx+','+( cy-4)+' '+(cx+4)+','+cy+' '+cx+','+(cy+4)+' '+(cx-4)+','+cy);
    diamond.setAttribute('fill','rgba(196,162,74,0.35)');
    svg.appendChild(diamond);
  });

  // ── ZONE NAME LABELS ────────────────────────────────────────────────
  var zoneLabels = [
    { text:'Hearthstone Road', pct: 3,  anchor:'start', x: 10 },
    { text:"Merchant's Pass",  pct: 26, anchor:'start', x: 10 },
    { text:'The Thornwood',    pct: 48, anchor:'start', x: 10 },
    { text:'The Iron Keep',    pct: 77, anchor:'start', x: 10 },
  ];
  zoneLabels.forEach(function(zl) {
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', zl.x+'');
    t.setAttribute('y', Math.round(H * zl.pct/100) + 14 + '');
    t.setAttribute('fill','rgba(196,162,74,0.55)');
    t.setAttribute('font-size','11');
    t.setAttribute('font-family',"'Cinzel', serif");
    t.setAttribute('font-weight','700');
    t.setAttribute('letter-spacing','2.5');
    t.setAttribute('text-anchor', zl.anchor);
    t.textContent = zl.text.toUpperCase();
    svg.appendChild(t);
  });

  // ── LotR-STYLE CARTOGRAPHIC ILLUSTRATIONS ──────────────────────────

  function svgEl(tag, attrs) {
    var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (var k in attrs) el.setAttribute(k, attrs[k]);
    svg.appendChild(el);
    return el;
  }

  function line(x1,y1,x2,y2,stroke,sw,opacity) {
    svgEl('line',{x1:x1,y1:y1,x2:x2,y2:y2,stroke:stroke,'stroke-width':sw||1,opacity:opacity||1,'stroke-linecap':'round'});
  }

  // LotR-style tree: trunk + radiating branch strokes (top-down cartographic symbol)
  function cartTree(cx, cy, sz, op) {
    var col = 'rgba(45,75,40,'+op+')';
    // trunk
    line(cx, cy+sz*0.3, cx, cy-sz*0.1, col, sz*0.18);
    // canopy circle
    svgEl('circle',{cx:cx,cy:cy-sz*0.15,r:sz*0.55,fill:'rgba(35,65,32,'+(op*0.7)+')',stroke:col,'stroke-width':sz*0.12});
    // radiating lines from canopy center
    for (var a=0; a<6; a++) {
      var ang = (a/6)*Math.PI*2;
      var r1=sz*0.1, r2=sz*0.52;
      line(cx+Math.cos(ang)*r1, cy-sz*0.15+Math.sin(ang)*r1,
           cx+Math.cos(ang)*r2, cy-sz*0.15+Math.sin(ang)*r2,
           'rgba(55,90,48,'+(op*0.6)+')', sz*0.08);
    }
  }

  function treeLine(x1,y1,x2,y2,count,sz,op) {
    for (var i=0; i<count; i++) {
      var t = i/(Math.max(count-1,1));
      cartTree(x1+(x2-x1)*t, y1+(y2-y1)*t, sz, op);
    }
  }

  // LotR hill: overlapping stippled mound with contour lines
  function hill(cx, cy, rx, ry, op) {
    var col = 'rgba(110,90,60,'+op+')';
    var col2 = 'rgba(80,65,42,'+(op*0.7)+')';
    // Base ellipse
    svgEl('ellipse',{cx:cx,cy:cy,rx:rx,ry:ry*0.6,fill:'rgba(90,72,48,'+(op*0.35)+')',stroke:col,'stroke-width':0.8});
    // Contour lines — 3 progressively smaller arcs drawn as paths
    for (var t=1; t<=3; t++) {
      var scale = 1 - t*0.22;
      var yo = -ry*0.12*t;
      var path = svgEl('path',{
        d:'M '+(cx-rx*scale)+','+(cy+yo)+' Q '+cx+','+(cy-ry*scale*0.9+yo)+' '+(cx+rx*scale)+','+(cy+yo),
        fill:'none', stroke:col2, 'stroke-width':0.7, opacity:op*0.8
      });
    }
    // Stipple dots on the mound
    for (var d=0; d<8; d++) {
      var ang = (d/8)*Math.PI;
      var dx = Math.cos(ang)*rx*0.55, dy = -Math.abs(Math.sin(ang))*ry*0.45;
      svgEl('circle',{cx:cx+dx,cy:cy+dy,r:0.8,fill:col,opacity:op*0.9});
      svgEl('circle',{cx:cx-dx*0.5,cy:cy+dy*0.7,r:0.6,fill:col,opacity:op*0.7});
    }
  }

  // Keep/fortress symbol: cross-shaped fortification
  function castle(cx, cy, sz, op) {
    var col = 'rgba(130,105,70,'+op+')';
    var col2 = 'rgba(90,70,45,'+(op*0.8)+')';
    // Main keep body
    svgEl('rect',{x:cx-sz*0.35,y:cy-sz*0.7,width:sz*0.7,height:sz*0.9,fill:'rgba(100,80,55,'+(op*0.5)+')',stroke:col,'stroke-width':0.8});
    // Tower left
    svgEl('rect',{x:cx-sz*0.6,y:cy-sz*0.5,width:sz*0.28,height:sz*0.7,fill:'rgba(110,88,58,'+(op*0.4)+')',stroke:col,'stroke-width':0.7});
    // Tower right
    svgEl('rect',{x:cx+sz*0.32,y:cy-sz*0.5,width:sz*0.28,height:sz*0.7,fill:'rgba(110,88,58,'+(op*0.4)+')',stroke:col,'stroke-width':0.7});
    // Battlement notches — main keep
    for (var b=0; b<4; b++) {
      var bx = cx - sz*0.28 + b*sz*0.18;
      svgEl('rect',{x:bx,y:cy-sz*0.82,width:sz*0.1,height:sz*0.15,fill:col});
    }
    // Battlement notches — left tower
    svgEl('rect',{x:cx-sz*0.57,y:cy-sz*0.62,width:sz*0.08,height:sz*0.13,fill:col});
    svgEl('rect',{x:cx-sz*0.42,y:cy-sz*0.62,width:sz*0.08,height:sz*0.13,fill:col});
    // Gate arch
    svgEl('path',{d:'M '+(cx-sz*0.12)+','+(cy+sz*0.2)+' Q '+cx+','+(cy-sz*0.05)+' '+(cx+sz*0.12)+','+(cy+sz*0.2),
      fill:'rgba(20,14,8,'+(op*1.5)+')',stroke:col2,'stroke-width':0.5});
    // Cross window
    line(cx, cy-sz*0.45, cx, cy-sz*0.15, col2, sz*0.07, op);
    line(cx-sz*0.12, cy-sz*0.32, cx+sz*0.12, cy-sz*0.32, col2, sz*0.07, op);
  }

  // Compass rose — bottom right corner
  function compass(cx, cy, sz) {
    var col = 'rgba(196,162,74,0.55)';
    var colFaint = 'rgba(196,162,74,0.25)';
    // Cardinal spokes
    var dirs = [[0,-1],[1,0],[0,1],[-1,0]];
    dirs.forEach(function(d) {
      line(cx+d[0]*sz*0.25, cy+d[1]*sz*0.25, cx+d[0]*sz, cy+d[1]*sz, col, 0.8);
    });
    // Intercardinal spokes (shorter)
    [[1,-1],[1,1],[-1,1],[-1,-1]].forEach(function(d) {
      var n = Math.sqrt(2);
      line(cx+d[0]/n*sz*0.2, cy+d[1]/n*sz*0.2, cx+d[0]/n*sz*0.7, cy+d[1]/n*sz*0.7, colFaint, 0.6);
    });
    // N arrow tip (diamond)
    svgEl('polygon',{
      points: cx+','+(cy-sz)+' '+(cx-sz*0.15)+','+(cy-sz*0.55)+' '+cx+','+(cy-sz*0.2)+' '+(cx+sz*0.15)+','+(cy-sz*0.55),
      fill:col
    });
    // Center dot
    svgEl('circle',{cx:cx,cy:cy,r:sz*0.12,fill:col});
    // N label
    var t = svgEl('text',{x:cx,y:cy-sz*1.15,'text-anchor':'middle',fill:col,'font-size':sz*0.55,'font-family':"'Cinzel',serif",'font-weight':'700'});
    t.textContent = 'N';
  }

  // ── PLACE ILLUSTRATIONS ──────────────────────────────────────────────

  // Zone 1 — Hearthstone Road: rolling hills flanking the path
  var z1y = Math.round(H * 0.10);
  hill(Math.round(W*0.12), z1y+5, 22, 14, 0.55);
  hill(Math.round(W*0.22), z1y+12, 18, 11, 0.4);
  hill(Math.round(W*0.85), z1y+5,  22, 14, 0.55);
  hill(Math.round(W*0.75), z1y+12, 18, 11, 0.4);
  // Smaller hills mid-zone
  hill(Math.round(W*0.10), Math.round(H*0.18), 14, 9, 0.35);
  hill(Math.round(W*0.88), Math.round(H*0.18), 14, 9, 0.35);

  // Zone 2 — Merchant's Pass: sparse trees, merchant camp suggestion
  treeLine(Math.round(W*0.08), Math.round(H*0.30), Math.round(W*0.08), Math.round(H*0.42), 4, 7, 0.45);
  treeLine(Math.round(W*0.92), Math.round(H*0.30), Math.round(W*0.92), Math.round(H*0.42), 4, 7, 0.45);

  // Zone 3 — Thornwood: dense forest both sides
  treeLine(Math.round(W*0.06), Math.round(H*0.50), Math.round(W*0.10), Math.round(H*0.72), 6, 8, 0.55);
  treeLine(Math.round(W*0.14), Math.round(H*0.52), Math.round(W*0.10), Math.round(H*0.70), 4, 6, 0.38);
  treeLine(Math.round(W*0.90), Math.round(H*0.50), Math.round(W*0.88), Math.round(H*0.72), 6, 8, 0.55);
  treeLine(Math.round(W*0.82), Math.round(H*0.52), Math.round(W*0.86), Math.round(H*0.70), 4, 6, 0.38);
  // Extra tree depth
  treeLine(Math.round(W*0.06), Math.round(H*0.60), Math.round(W*0.12), Math.round(H*0.65), 3, 5, 0.28);
  treeLine(Math.round(W*0.88), Math.round(H*0.60), Math.round(W*0.94), Math.round(H*0.65), 3, 5, 0.28);

  // Zone 4 — Iron Keep: castle illustration center-top of zone
  castle(Math.round(W*0.50), Math.round(H*0.83), 20, 0.65);
  // Flanking towers (smaller)
  castle(Math.round(W*0.15), Math.round(H*0.87), 12, 0.45);
  castle(Math.round(W*0.85), Math.round(H*0.87), 12, 0.45);

  // Compass rose — bottom-right
  compass(W - 28, H - 28, 16);

  // ── ROAD CONNECTIONS — curved bezier paths ──────────────────────────
  function makePath(a, b) {
    // Gentle S-curve between two points
    var dx = b.x - a.x, dy = b.y - a.y;
    var mx1 = a.x + dx*0.25 + dy*0.08;
    var my1 = a.y + dy*0.4  - dx*0.05;
    var mx2 = b.x - dx*0.25 + dy*0.08;
    var my2 = b.y - dy*0.4  - dx*0.05;
    return 'M '+a.x+' '+a.y+' C '+mx1+' '+my1+', '+mx2+' '+my2+', '+b.x+' '+b.y;
  }

  CONNECTIONS.forEach(function(conn) {
    var a = posMap[conn[0]], b = posMap[conn[1]];
    if (!a || !b) return;
    var traveled = isReached(conn[0]) && isReached(conn[1]);

    // Road shadow (depth)
    var shadow = document.createElementNS('http://www.w3.org/2000/svg','path');
    shadow.setAttribute('d', makePath(a,b));
    shadow.setAttribute('stroke','rgba(0,0,0,0.5)');
    shadow.setAttribute('stroke-width', traveled ? '5' : '3.5');
    shadow.setAttribute('fill','none');
    shadow.setAttribute('stroke-linecap','round');
    svg.appendChild(shadow);

    // Road body
    var path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', makePath(a,b));
    if (traveled) {
      path.setAttribute('stroke','rgba(196,162,74,0.7)');
      path.setAttribute('stroke-width','2.5');
    } else {
      path.setAttribute('stroke','rgba(90,75,50,0.3)');
      path.setAttribute('stroke-width','1.8');
      path.setAttribute('stroke-dasharray','5 7');
    }
    path.setAttribute('fill','none');
    path.setAttribute('stroke-linecap','round');
    svg.appendChild(path);
  });

  // Vignette overlay
  var vig = document.createElementNS('http://www.w3.org/2000/svg','rect');
  vig.setAttribute('x','0'); vig.setAttribute('y','0');
  vig.setAttribute('width',W+''); vig.setAttribute('height',H+'');
  vig.setAttribute('fill','url(#vignette)');
  vig.setAttribute('pointer-events','none');
  svg.appendChild(vig);

  // ── NODE DOM ELEMENTS ───────────────────────────────────────────────
  inner.innerHTML = '';
  inner.style.height = H + 'px';

  NODE_LAYOUT.forEach(function(layout) {
    var wpData = null;
    for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
      if (MAP_WAYPOINTS[i].id === layout.id) { wpData = MAP_WAYPOINTS[i]; break; }
    }
    if (!wpData) return;

    // Skip badge nodes — they're celebrated via overlay, not shown on map
    if (typeof layout.id === 'string') return;

    var isDone    = layout.id < pos;
    var isCurrent = layout.id === pos;

    var px = posMap[layout.id];

    var wrap = document.createElement('div');
    wrap.className = 'map-node-wrap' + (isCurrent ? ' current' : '');
    wrap.style.left = px.x + 'px';
    wrap.style.top  = px.y + 'px';

    var circle = document.createElement('div');
    var zoneClass = typeof wpData.zone === 'number' ? ' zone' + wpData.zone : '';
    var cc = 'map-node-circle' + zoneClass;
    cc += isDone ? ' done' : isCurrent ? ' current' : ' ahead';
    circle.className = cc;
    circle.textContent = wpData.icon;

    var label = document.createElement('div');
    label.className = 'map-node-label';
    label.textContent = wpData.name.replace('\n',' ');

    wrap.appendChild(circle);
    wrap.appendChild(label);
    inner.appendChild(wrap);
  });

  // Road bonus pips
  var bonuses = Math.min(3, state.roadBonusesThisMonth || 0);
  for (var i = 1; i <= 3; i++) {
    var pip = document.getElementById('road-pip-' + i);
    if (pip) pip.className = 'road-pip' + (i <= bonuses ? ' earned' : '');
  }
  // Road bonus countdown label
  var rbLabel = document.getElementById('road-bonus-label');
  if (rbLabel) {
    var daysLogged = (state.weekLogDays || []).length;
    var daysNeeded = Math.max(0, 5 - daysLogged);
    if (bonuses >= 3) {
      rbLabel.textContent = '✦ All Road Bonuses earned this month';
    } else if (daysNeeded === 0) {
      rbLabel.textContent = '✦ Road Bonus earned — advancing the map!';
    } else if (daysLogged === 0) {
      rbLabel.textContent = 'Road Bonus — log 5 days this week to advance early';
    } else {
      rbLabel.textContent = daysNeeded + ' more day' + (daysNeeded === 1 ? '' : 's') + ' this week for a Road Bonus';
    }
  }

  // Hearts
  for (var h = 1; h <= 3; h++) {
    var heart = document.getElementById('heart-' + h);
    if (heart) {
      var filled = h <= (state.hearts !== undefined ? state.hearts : 3);
      heart.className = 'map-heart' + (filled ? '' : ' empty');
      heart.textContent = filled ? '❤️' : '🖤';
    }
  }

  // Badge slots
  ['zone1','zone2','zone3','zone4'].forEach(function(bid) {
    var el = document.getElementById('badge-' + bid);
    if (!el) return;
    var pip = el.querySelector('.badge-pip');
    if (pip) pip.className = (state.badges||[]).indexOf(bid) !== -1 ? 'badge-pip earned' : 'badge-pip locked';
  });
}

// ─────────────────────────
//  RENDER
// ─────────────────────────
function getCurrentMonth() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
}

function checkMonthReset() {
  var thisMonth = getCurrentMonth();
  if (!state.currentMonth) {
    state.currentMonth = thisMonth;
    if (state.monthlyBudget > 0 && state.coinReserve === 0) {
      state.coinReserve = state.monthlyBudget;
    }
    save();
    return;
  }
  if (state.currentMonth !== thisMonth) {
    var prevMonth        = state.currentMonth;
    var prevZoneReached  = getMapPosition();
    var prevLog          = (state.log || []).length;
    var prevBest         = state.bestStreak || 0;
    var prevVault        = state.ironVault || 0;

    // Reset monthly state — map + treasury + encounters
    state.coinReserve              = state.monthlyBudget;
    state.currentMonth             = thisMonth;
    state.roadBonusesThisMonth     = 0;
    state.firedOverBudgetEncounter = false;
    state.mapPosition              = 0;
    state.lastMapPosition          = -1;
    state.badges                   = [];
    state.log                      = [];
    state.seenArrivals             = [];
    state.seenStoryEncounters      = [];
    state.encounterLogCount        = 0;
    state.lastEncounterAtLog       = 0;
    state.hearts                   = 3;
    state.woundedMode              = false;
    state.cleanDayStreak           = 0;
    state.lastCleanDay             = '';
    state.woundedDayStartReserve   = null;
    // Vault carries over — it's the reward for discipline
    save();
    if (state.name) { showMonthReset(prevMonth, prevZoneReached, prevLog, prevBest, prevVault); }
  }
}

function showMonthReset(prevMonth, prevPos, prevLogCount, prevBest, prevVault) {
  var parts = prevMonth.split('-');
  var monthName = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1)
    .toLocaleString('default', { month: 'long', year: 'numeric' });

  var ZONE_NAMES = ['Hearthstone Road','Hearthstone Road','Hearthstone Road',
    "Merchant's Pass","Merchant's Pass","Merchant's Pass",
    'The Thornwood','The Thornwood','The Thornwood',
    'The Iron Keep','The Iron Keep'];
  var zoneReached = ZONE_NAMES[Math.min(prevPos, ZONE_NAMES.length-1)] || 'Hearthstone Road';

  var reachedIronKeep = prevPos >= 10;
  var flavor = reachedIronKeep
    ? 'You reached the Iron Keep. The gates remember the traveler who kept their books clean. A new road opens — same hero, fresh treasury.'
    : 'The road resets with the moon. Your Road Gold carries over — everything you earned on the road is yours to keep. Begin again.';

  var bd = document.getElementById('reset-breakdown');
  bd.innerHTML =
    '<div class="reset-row"><span>Campaign</span><span>' + monthName + '</span></div>' +
    '<div class="reset-row"><span>Furthest zone</span><span>' + zoneReached + '</span></div>' +
    '<div class="reset-row"><span>Expenses logged</span><span>' + (prevLogCount||0) + '</span></div>' +
    '<div class="reset-row"><span>Best streak</span><span>' + (prevBest||0) + ' days</span></div>' +
    '<div class="reset-row highlight"><span>New treasury</span><span>$' + state.monthlyBudget + '</span></div>' +
    '<div class="reset-row"><span>Road Gold carried over</span><span>' + prevVault + ' 💰</span></div>';

  document.getElementById('reset-msg').textContent = flavor;
  document.getElementById('reset-overlay').classList.add('show');
}

function closeReset() {
  document.getElementById('reset-overlay').classList.remove('show');
  overlayDismissed();
}

function renderCoins() {
  if (!state.monthlyBudget) {
    document.getElementById('coin-reserve-section').style.display = 'none';
    return;
  }
  document.getElementById('coin-reserve-section').style.display = 'block';

  var budget  = state.monthlyBudget;
  var reserve = state.coinReserve || 0; // can be negative
  var spent   = budget - reserve;
  var isOver  = reserve < 0;
  var overBy  = isOver ? Math.abs(reserve) : 0;
  var remPct  = isOver ? 0 : Math.min(100, Math.max(0, (reserve / budget) * 100));

  var remEl    = document.getElementById('coin-current');
  var ofLabel  = document.getElementById('treasury-of-label');
  var fillEl   = document.getElementById('coin-fill');
  var statusEl = document.getElementById('coin-status');
  var subEl    = document.getElementById('treasury-sub-text');

  document.getElementById('coin-max').textContent = budget.toFixed(0);

  fillEl.style.width = remPct + '%';
  fillEl.className   = 'treasury-bar-fill';
  remEl.className    = 'treasury-remaining';
  statusEl.className = 'treasury-status';

  if (isOver) {
    remEl.textContent    = '-$' + overBy.toFixed(0);
    if (ofLabel) ofLabel.textContent = 'over budget of';
    fillEl.classList.add('danger');
    remEl.classList.add('danger');
    statusEl.classList.add('danger');
    statusEl.textContent = '⚠ Over budget';
    subEl.textContent    = '$' + spent.toFixed(0) + ' spent — $' + overBy.toFixed(0) + ' over limit';
  } else if (remPct <= 10) {
    remEl.textContent    = '$' + reserve.toFixed(0);
    if (ofLabel) ofLabel.textContent = 'remaining of';
    fillEl.classList.add('danger');
    remEl.classList.add('danger');
    statusEl.classList.add('danger');
    statusEl.textContent = 'Running on fumes';
    subEl.textContent    = '$' + spent.toFixed(0) + ' spent — ' + Math.round(remPct) + '% left';
  } else if (remPct <= 30) {
    remEl.textContent    = '$' + reserve.toFixed(0);
    if (ofLabel) ofLabel.textContent = 'remaining of';
    fillEl.classList.add('warning');
    remEl.classList.add('warning');
    statusEl.classList.add('warning');
    statusEl.textContent = 'Getting low';
    subEl.textContent    = '$' + spent.toFixed(0) + ' spent — ' + Math.round(remPct) + '% left';
  } else if (remPct >= 70) {
    remEl.textContent    = '$' + reserve.toFixed(0);
    if (ofLabel) ofLabel.textContent = 'remaining of';
    statusEl.classList.add('good');
    statusEl.textContent = 'Treasury strong';
    subEl.textContent    = '$' + spent.toFixed(0) + ' spent — well within your limits';
  } else {
    remEl.textContent    = '$' + reserve.toFixed(0);
    if (ofLabel) ofLabel.textContent = 'remaining of';
    statusEl.classList.add('good');
    statusEl.textContent = 'On track';
    subEl.textContent    = '$' + spent.toFixed(0) + ' spent this month';
  }

  var vaultEl   = document.getElementById('vault-amount');
  var vaultGold = state.ironVault || 0;
  vaultEl.textContent = vaultGold + ' 💰';
  vaultEl.className   = vaultGold > 0 ? 'vault-amount' : 'vault-amount empty';
}

function render() {
  var ld = getLevelData(state.xp);

  document.getElementById('char-avatar').textContent = state.avatar || '🛡️';
  document.getElementById('char-name').textContent   = state.name   || '—';
  document.getElementById('char-class').textContent  = getTitle(state.heroClass, ld.level);
  document.getElementById('level-num').textContent   = ld.level;

  document.getElementById('xp-current').textContent  = state.xp;
  document.getElementById('xp-next-val').textContent = ld.xpAtEnd;
  document.getElementById('xp-fill').style.width     = ld.pct + '%';

  document.getElementById('xp-next-msg').textContent =
    ld.level < LEVEL_XP.length
      ? ld.toNext + ' XP to Level ' + (ld.level + 1)
      : 'Maximum rank achieved!';

  var today      = new Date().toDateString();
  var loggedToday = state.lastLogDate === today;
  var streakCount = state.streak || 0;

  document.getElementById('streak-count').textContent = streakCount;

  var banner  = document.getElementById('streak-banner');
  var flameEl = document.getElementById('streak-banner-flame');
  var countEl = document.getElementById('streak-count');
  var rightEl = document.getElementById('streak-banner-right');

  banner.className = 'streak-panel';
  flameEl.className = 'streak-flame';
  countEl.className = 'streak-num';
  rightEl.className = 'streak-right';

  if (loggedToday) {
    banner.classList.add('alive');
    rightEl.classList.add('logged');
    rightEl.textContent = '✓ Logged today';
    document.getElementById('streak-label').textContent =
      streakCount > 1 ? 'day streak — keep it going!' : 'day streak — great start!';
  } else if (streakCount > 0) {
    banner.classList.add('danger');
    rightEl.classList.add('urgent');
    rightEl.textContent = '⚠ Log today or lose it';
    document.getElementById('streak-label').textContent = 'day streak — at risk';
  } else {
    flameEl.classList.add('cold');
    countEl.classList.add('cold');
    rightEl.textContent = 'Start your streak today';
    document.getElementById('streak-label').textContent = 'day streak — log to begin';
  }

  // Best streak
  var bestEl = document.getElementById('streak-best');
  if (bestEl) {
    var best = state.bestStreak || 0;
    bestEl.textContent = best > 0 ? 'Best: ' + best + ' days' : '';
  }

  // XP bonus indicator
  var bonusMsg = document.getElementById('xp-bonus-msg');
  if (bonusMsg && !state.woundedMode) {
    var streakBonus = Math.min(5, Math.floor(streakCount / 5));
    if (streakBonus > 0 && loggedToday) {
      bonusMsg.textContent = '🔥 Streak bonus active — earning extra XP';
      bonusMsg.style.color = 'var(--xp)';
    } else {
      bonusMsg.textContent = 'Log expenses to earn XP';
      bonusMsg.style.color = '';
    }
  }

  renderLog();
  renderCoins();
  renderMap();
  checkZoneBadge();

  // Wounded mode UI — recovery track inside XP block
  var recoveryTrack = document.getElementById('recovery-track');
  var charPanel     = document.getElementById('coin-reserve-section');
  if (recoveryTrack) {
    if (state.woundedMode) {
      recoveryTrack.classList.remove('hidden');
      var clean    = state.cleanDayStreak || 0;
      var daysLeft = 3 - clean;
      // Recovery label — compact, one line
      var recovLabel = document.getElementById('recovery-label');
      if (recovLabel) recovLabel.textContent = daysLeft === 1 ? 'One clean day to recover' : daysLeft + ' clean days to recover';
      // Pips
      for (var rp = 1; rp <= 3; rp++) {
        var pip = document.getElementById('rpip-' + rp);
        if (pip) pip.className = 'recovery-pip' + (rp <= clean ? ' earned' : '');
      }
      if (charPanel) charPanel.classList.add('wounded');
    } else {
      recoveryTrack.classList.add('hidden');
      if (charPanel) charPanel.classList.remove('wounded');
    }
  }

  // XP sub line — wounded takes priority over streak bonus message
  var xpBonusEl = document.getElementById('xp-bonus-msg');
  if (xpBonusEl) {
    if (state.woundedMode) {
      xpBonusEl.textContent = '🩸 60% XP — treasury wounded';
      xpBonusEl.style.color = 'rgba(200,80,60,0.8)';
    }
    // (non-wounded case already handled above in streak section)
  }

  // Log button state
  var logBtn = document.getElementById('log-btn');
  if (logBtn) {
    var today2 = new Date().toDateString();
    var loggedToday2 = state.lastLogDate === today2;
    var streakLive = (state.streak || 0) > 0;
    logBtn.className = 'log-btn';
    if (loggedToday2) {
      logBtn.classList.add('logged-today');
      logBtn.textContent = '✓ Logged Today';
    } else if (streakLive) {
      logBtn.classList.add('streak-danger');
      logBtn.innerHTML = '⚔ Log It';
    } else {
      logBtn.innerHTML = '⚔ Log It';
    }
  }
  // Sync road strip
  var rsLoc  = document.getElementById('road-strip-loc');
  var rsZone = document.getElementById('road-strip-zone');
  if (rsLoc && rsZone) {
    var pos = state.mapPosition || 0;
    var wp  = MAP_WAYPOINTS[pos] || MAP_WAYPOINTS[0];
    rsLoc.textContent  = (wp.name || '').replace('\n', ' ');
    rsZone.textContent = 'Zone ' + (wp.zone || 'I');
  }
  // Sync road-strip hearts
  ['road-heart-1','road-heart-2','road-heart-3'].forEach(function(id, i) {
    var el = document.getElementById(id);
    if (el) el.className = 'map-heart' + (i < (state.hearts || 3) ? '' : ' empty');
  });
  // Sync road-strip road pips
  var roadDays = state.roadBonusDays || 0;
  ['road-strip-pip-1','road-strip-pip-2','road-strip-pip-3'].forEach(function(id, i) {
    var el = document.getElementById(id);
    if (el) el.className = 'road-pip' + (i < roadDays ? ' earned' : '');
  });
  checkArrival();
}

var LOG_PAGE_SIZE = 3;
var logVisibleCount = LOG_PAGE_SIZE;

function renderLog() {
  logVisibleCount = LOG_PAGE_SIZE; // reset on fresh render
  renderLogPage();
}

function showMoreLog() {
  logVisibleCount += LOG_PAGE_SIZE;
  renderLogPage();
}

function collapseLog() {
  logVisibleCount = LOG_PAGE_SIZE;
  renderLogPage();
  // Scroll chronicle heading into view smoothly
  var wrap = document.querySelector('.log-list-wrap');
  if (wrap) wrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderLogPage() {
  var list = document.getElementById('log-list');
  list.innerHTML = '';

  if (!state.log || state.log.length === 0) {
    var empty = document.createElement('div');
    empty.className = 'log-empty';
    empty.textContent = 'No entries yet. Log your first expense above to earn XP!';
    list.appendChild(empty);
    document.getElementById('log-pagination').style.display = 'none';
    return;
  }

  var allItems = state.log.slice().reverse();
  var visible  = allItems.slice(0, logVisibleCount);
  var total    = allItems.length;
  var showing  = Math.min(logVisibleCount, total);

  visible.forEach(function(entry) {
    var el = document.createElement('div');
    el.className = 'log-item';
    var amt  = parseFloat(entry.amount).toFixed(2);
    var icon = entry.icon || '💰';
    var meta = entry.ts ? formatDate(entry.ts) : '';
    el.innerHTML =
      '<div class="log-icon">' + icon + '</div>' +
      '<div>' +
        '<div class="log-desc">' + esc(entry.desc) + '</div>' +
        (meta ? '<div class="log-meta">' + meta + '</div>' : '') +
      '</div>' +
      '<div class="log-right">' +
        '<div class="log-amount">$' + amt + '</div>' +
        '<div class="log-xp">+' + entry.xpGained + ' XP</div>' +
      '</div>';
    list.appendChild(el);
  });

  var pagEl   = document.getElementById('log-pagination');
  var moreBtn = document.getElementById('log-more-btn');
  var countEl = document.getElementById('log-pagination-count');
  var hasMore = showing < total;

  pagEl.style.display = 'flex';
  countEl.textContent = showing + ' of ' + total + ' entries';
  moreBtn.disabled    = !hasMore;
  moreBtn.textContent = hasMore ? 'Show more ▾' : 'All shown';

  // Collapse button — visible whenever more than default is showing
  var collapseBtn = document.getElementById('log-collapse-btn');
  if (collapseBtn) {
    collapseBtn.style.display = logVisibleCount > LOG_PAGE_SIZE ? 'block' : 'none';
  }
}

function formatDate(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─────────────────────────
//  ONBOARDING
// ─────────────────────────
var currentStep = 0;

function goStep(n) {
  if (n > currentStep) {
    if (currentStep === 0) {
      var name = document.getElementById('hero-name-input').value.trim();
      if (!name) { showToast('Name your hero first.'); return; }
    }
    if (currentStep === 1) {
      if (!obAvatar) { showToast('Choose your avatar first.'); return; }
    }
    if (currentStep === 2) {
      if (!obClass) { showToast('Choose your class first.'); return; }
    }
  }

  document.getElementById('step-' + currentStep).classList.remove('active');
  currentStep = n;
  document.getElementById('step-' + currentStep).classList.add('active');

  for (var i = 0; i <= 4; i++) {
    var dot = document.getElementById('dot-' + i);
    if (!dot) continue;
    dot.className = 'step-dot';
    if (i < currentStep)        dot.classList.add('done');
    else if (i === currentStep) dot.classList.add('active');
  }

  document.getElementById('onboarding').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function selectAvatar(el) {
  document.querySelectorAll('.avatar-opt').forEach(function(a) { a.classList.remove('selected'); });
  el.classList.add('selected');
  obAvatar = el.getAttribute('data-avatar');
}

function selectClass(el) {
  document.querySelectorAll('.class-opt').forEach(function(c) { c.classList.remove('selected'); });
  el.classList.add('selected');
  obClass = el.getAttribute('data-class');
}

function beginJourney() {
  var budget = parseFloat(document.getElementById('budget-input').value);
  if (!budget || budget <= 0) { showToast('Set your monthly treasury first.'); return; }
  if (!obClass)                { showToast('Choose your class first.'); return; }
  var heroName = document.getElementById('hero-name-input').value.trim();
  if (!heroName)               { showToast('Name your hero first.'); return; }

  // Full clean slate — new character, new journey
  state.name          = heroName;
  state.avatar        = obAvatar || '🛡️';
  state.heroClass     = obClass;
  state.xp            = 0;
  state.streak        = 0;
  state.lastLogDate   = null;
  state.log           = [];
  state.monthlyBudget = Math.round(budget);
  state.coinReserve   = Math.round(budget);
  state.ironVault     = 0;
  state.currentMonth  = getCurrentMonth();
  state.hearts        = 3;
  state.mapPosition   = 0;
  state.lastMapPosition = -1;
  state.badges        = [];
  state.weekLogDays   = [];
  state.weekStart     = '';
  state.roadBonusesThisMonth     = 0;
  state.firedOverBudgetEncounter = false;
  state.encounterLogCount        = 0;
  state.lastEncounterAtLog       = 0;
  state.seenStoryEncounters      = [];
  state.seenArrivals             = [];
  state.lastEncounterLog         = '';
  state.woundedMode              = false;
  state.cleanDayStreak           = 0;
  state.lastCleanDay             = '';

  save();
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  render();
  showToast('Welcome to the road, ' + state.name + '. The Iron Keep awaits.');
}

document.getElementById('hero-name-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') goStep(1);
});

// ─────────────────────────
//  LOG EXPENSE
// ─────────────────────────
function logExpense() {
  var descEl   = document.getElementById('desc-input');
  var amountEl = document.getElementById('amount-input');
  var desc     = descEl.value.trim();
  var amount   = parseFloat(amountEl.value);

  if (!desc)                { showToast('Describe your expense.'); return; }
  if (!amount || amount <= 0) { showToast('Enter a valid amount.'); return; }

  var prevLevel = getLevelData(state.xp).level;

  var streakBonus = Math.min(5, Math.floor((state.streak || 0) / 5));
  var currentLevel = getLevelData(state.xp).level;
  var baseXp = currentLevel <= 3 ? 30 : 15;
  var xpGained = baseXp + streakBonus;

  // Wounded mode: 60% XP — you're traveling damaged
  if (state.woundedMode) {
    xpGained = Math.max(1, Math.round(xpGained * 0.6));
  }

  // Reset the day baseline if first log today while wounded
  resetWoundedDayBaseline();

  markLoggedToday();
  state.xp += xpGained;

  var entry = {
    id:       String(Date.now()) + String(Math.floor(Math.random() * 10000)),
    desc:     desc,
    amount:   amount,
    xpGained: xpGained,
    icon:     LOG_ICONS[Math.floor(Math.random() * LOG_ICONS.length)],
    ts:       new Date().toISOString()
  };

  if (!Array.isArray(state.log)) state.log = [];
  state.log.push(entry);

  if (state.monthlyBudget > 0) {
    var prevReserve = state.coinReserve || 0;
    state.coinReserve = prevReserve - amount;
    fireCoinFloat('-$' + amount.toFixed(0));
    // First time going over budget this month — fire a hostile encounter
    if (prevReserve >= 0 && state.coinReserve < 0 && !state.firedOverBudgetEncounter) {
      state.firedOverBudgetEncounter = true;
      enterWoundedMode(); // begin wounded state
      setTimeout(function() {
        queueOverlay(function() {
          showEncounter({
            id: 'over_budget',
            icon: '💸',
            title: 'Budget Broken',
            zone: 'Treasury Alert',
            desc: 'You\'ve spent past your monthly limit. The road ahead costs more than your treasury can cover. Time to decide: dig in and recover, or spend your way through.',
            choiceA: { label: '🛡️ Accept the hit', sub: 'Costs 1 Life — you acknowledge the overspend' },
            choiceB: { label: '💰 Cover with Road Gold', sub: 'Spend 25 🪙 — absorb the damage' },
            goldCost: 25
          }, true);
        });
      }, 800);
    }
  }

  checkWeekRoadBonus();
  checkEncounter(amount);
  // Check clean day recovery while wounded
  if (state.woundedMode) checkCleanDay();
  save();
  render();

  descEl.value   = '';
  amountEl.value = '';
  descEl.focus();

  fireXpFloat('+' + xpGained + ' XP');

  var fill = document.getElementById('xp-fill');
  fill.classList.remove('pulse');
  void fill.offsetWidth;
  fill.classList.add('pulse');
  setTimeout(function() { fill.classList.remove('pulse'); }, 800);

  var newLevel = getLevelData(state.xp).level;
  if (newLevel > prevLevel) {
    // Level-up advances map: level 2 -> pos 1, level 3 -> pos 2, etc.
    var targetPos = newLevel - 1;
    if (targetPos > getMapPosition() && targetPos <= 10) {
      state.mapPosition = targetPos;
      state.lastMapPosition = targetPos - 1;
      save();
    }
    queueOverlay(function() { showLevelUp(newLevel); });
  }
}

function fireGoldFloat(text) {
  var floatEl = document.getElementById('gold-float');
  if (!floatEl) return;
  var track = document.getElementById('vault-amount');
  if (!track) return;
  var rect = track.getBoundingClientRect();
  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top + window.scrollY) + 'px';
  floatEl.textContent = text;
  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

function fireXpFloat(text) {
  var floatEl = document.getElementById('xp-float');
  var track   = document.getElementById('xp-fill');
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

function fireCoinFloat(text) {
  var floatEl = document.getElementById('coin-float');
  var track   = document.getElementById('coin-fill');
  if (!track) return;
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY + rect.height) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

// ─────────────────────────
//  LEVEL UP
// ─────────────────────────
function showLevelUp(level) {
  save();
  document.getElementById('lu-level').textContent = level;
  document.getElementById('lu-rank').textContent  = getTitle(state.heroClass, level);
  document.getElementById('lu-msg').textContent   = LEVEL_MSGS[Math.min(level - 2, LEVEL_MSGS.length - 1)];
  document.getElementById('levelup-overlay').classList.add('show');
  renderCoins();
}

function closeLevelUp() {
  document.getElementById('levelup-overlay').classList.remove('show');
  render();
  checkZoneBadge();
  setTimeout(function() { checkArrival(); }, 400);
  overlayDismissed();
}

// ─────────────────────────
//  TOAST
// ─────────────────────────
var toastTimer;
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, 2800);
}

// ─────────────────────────
//  KEYBOARD
// ─────────────────────────
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Enter') return;
  var a = document.activeElement;
  if (a && (a.id === 'desc-input' || a.id === 'amount-input')) {
    logExpense();
  }
});

// DEV TOOLS
function devWipeLog() {
  if (!confirm('Wipe all log entries and reset treasury to full budget?\n(XP, level, and map position kept)')) return;
  state.log             = [];
  state.coinReserve     = state.monthlyBudget || 0;
  // Reset encounter + arrival tracking so no stale popups fire
  state.encounterLogCount        = 0;
  state.lastEncounterAtLog       = 0;
  state.seenStoryEncounters      = [];
  state.seenArrivals             = [];
  state.firedOverBudgetEncounter = false;
  // Sync lastMapPosition to current so checkArrival sees no change
  state.lastMapPosition = state.mapPosition;
  // Drain any queued overlays
  _overlayQueue   = [];
  _overlayActive  = false;
  save(); render();
  showToast('Log wiped. Treasury reset to full.');
}
function devWipeStreak() {
  if (!confirm('Reset current streak to 0?\n(Best streak record kept)')) return;
  state.streak      = 0;
  state.lastLogDate = null;
  save(); render();
  showToast('Streak reset to zero.');
}

function devWipeLevel() {
  if (!confirm('Reset XP and level back to zero?\n(Map position and log kept)')) return;
  state.xp = 0;
  save(); render();
  showToast('XP reset. Back to Level 1.');
}

function devRestart() {
  if (!confirm('Restart onboarding?\nAll progress will be cleared — name, class, budget, log, map.')) return;
  // Clear localStorage
  localStorage.removeItem(SAVE_KEY);
  // Reset state to blank
  state.name = ''; state.avatar = ''; state.heroClass = '';
  state.xp = 0; state.streak = 0; state.lastLogDate = null;
  state.log = []; state.monthlyBudget = 0; state.coinReserve = 0;
  state.ironVault = 0; state.currentMonth = ''; state.hearts = 3;
  state.mapPosition = 0; state.badges = []; state.weekLogDays = [];
  state.weekStart = ''; state.roadBonusesThisMonth = 0;
  state.lastEncounterLog = ''; state.pendingEncounter = null;
  state.seenStoryEncounters = []; state.seenArrivals = [];
  state.lastMapPosition = -1; state.encounterLogCount = 0;
  state.lastEncounterAtLog = 0; state.firedOverBudgetEncounter = false;
  // Also wipe from Supabase if logged in
  if (currentUserId) {
    sb.from('profiles').delete().eq('user_id', currentUserId).then(function(){});
  }
  // Reset onboarding pick state
  obAvatar = ''; obClass = '';
  document.querySelectorAll('.avatar-opt, .class-opt').forEach(function(el) {
    el.classList.remove('selected');
  });
  var nameInput = document.getElementById('hero-name-input');
  if (nameInput) nameInput.value = '';
  var budgetInput = document.getElementById('budget-input');
  if (budgetInput) budgetInput.value = '';

  // Reset onboarding step counter to 0
  currentStep = 0;
  document.querySelectorAll('.ob-step').forEach(function(s){ s.classList.remove('active'); });
  var s0 = document.getElementById('step-0');
  if (s0) s0.classList.add('active');
  // Reset step dots
  for (var i = 0; i <= 4; i++) {
    var dot = document.getElementById('dot-' + i);
    if (!dot) continue;
    dot.className = 'step-dot';
    if (i === 0) dot.classList.add('active');
  }
  // Show onboarding, hide main
  document.getElementById('main').style.display = 'none';
  document.getElementById('onboarding').style.display = 'block';
  document.getElementById('onboarding').scrollIntoView({ behavior: 'smooth', block: 'start' });
  showToast('A new hero rises. Begin your journey.');
}
</script>

</body>
</html>
