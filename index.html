<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Quest</title>
<link href="Budget%20Quest_22226_files/css2.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0e0c0a;
  --surface: #181410;
  --surface2: #201c14;
  --border: #3d3520;
  --border-gold: #7a6530;
  --gold: #c9a84c;
  --gold-light: #e8c96a;
  --gold-dim: #9a7d3a;
  --red: #c0392b;
  --red-dim: #5a1a14;
  --green: #27ae60;
  --green-dim: #1a6b3c;
  --text: #e8dfc8;
  --text-dim: #b0a080;
  --text-dark: #8a7a62;
  --xp-color: #4a9eff;
  --xp-dim: #1a3a6b;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 16px;
  min-height: 100vh;
  background-image:
    radial-gradient(ellipse at 20% 0%, rgba(201,168,76,0.05) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 100%, rgba(74,158,255,0.04) 0%, transparent 60%);
}
body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 1000;
  opacity: 0.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

.app { max-width: 680px; margin: 0 auto; padding: 32px 16px 100px; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  text-align: center;
  padding: 32px 0 24px;
  border-bottom: 1px solid var(--border-gold);
  margin-bottom: 28px;
  position: relative;
}
.header::before, .header::after {
  content: '‚¨°';
  color: var(--gold-dim);
  font-size: 12px;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
}
.header::before { left: 0; }
.header::after { right: 0; }
.header h1 {
  font-family: 'Cinzel', serif;
  font-size: clamp(24px, 5vw, 40px);
  color: var(--gold);
  letter-spacing: 0.1em;
  text-shadow: 0 0 40px rgba(201,168,76,0.35);
}
.header .tagline {
  color: var(--text-dim);
  font-size: 14px;
  margin-top: 6px;
  font-style: italic;
}

/* ‚îÄ‚îÄ LAWS OF THE REALM ‚îÄ‚îÄ */
.laws-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 22px;
}
.law-card {
  display: flex;
  align-items: flex-start;
  gap: 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 13px 15px;
  transition: border-color 0.2s;
}
.law-card { cursor: default; }
.law-icon {
  font-size: 22px;
  flex-shrink: 0;
  width: 32px;
  text-align: center;
  margin-top: 1px;
}
.law-body { flex: 1; }
.law-title {
  font-family: 'Cinzel', serif;
  font-size: 12px;
  color: var(--gold);
  margin-bottom: 4px;
  line-height: 1.4;
}
.law-plain {
  font-size: 13px;
  color: var(--text-dim);
  line-height: 1.6;
}

/* ‚îÄ‚îÄ ONBOARDING CARD ‚îÄ‚îÄ */
.onboarding-card {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 4px;
  padding: 32px 28px;
  position: relative;
  overflow: hidden;
  animation: fadeUp 0.5s ease both;
}
.onboarding-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
}

/* Step dots */
.steps-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-bottom: 28px;
}
.step-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--border);
  transition: all 0.3s;
  flex-shrink: 0;
}
.step-dot.active { background: var(--gold); box-shadow: 0 0 8px rgba(201,168,76,0.6); }
.step-dot.done { background: var(--gold-dim); }
.step-line { width: 28px; height: 1px; background: var(--border); flex-shrink: 0; }

/* Steps */
.ob-step { display: none; }
.ob-step.active { display: block; animation: fadeUp 0.3s ease both; }

.ob-title {
  font-family: 'Cinzel', serif;
  color: var(--gold);
  font-size: 18px;
  text-align: center;
  margin-bottom: 8px;
}
.ob-sub {
  color: var(--text-dim);
  font-style: italic;
  font-size: 14px;
  text-align: center;
  line-height: 1.65;
  margin-bottom: 22px;
  max-width: 480px;
  margin-left: auto;
  margin-right: auto;
}

/* Name input */
.name-row {
  display: flex;
  gap: 0;
  justify-content: center;
  max-width: 340px;
  margin: 0 auto;
}
.hero-name-input {
  background: var(--surface2);
  border: 1px solid var(--border-gold);
  border-right: none;
  border-radius: 3px 0 0 3px;
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 17px;
  padding: 11px 16px;
  outline: none;
  flex: 1;
  transition: border-color 0.2s;
}
.hero-name-input:focus { border-color: var(--gold); }
.hero-name-input::placeholder { color: var(--text-dark); }

/* Avatar picker */
.avatar-grid {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
}
.avatar-opt {
  width: 72px; height: 72px;
  border: 2px solid var(--border);
  border-radius: 4px;
  background: var(--surface2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 34px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  user-select: none;
}
.avatar-opt:hover { border-color: var(--gold-dim); background: #2a2418; transform: translateY(-2px); }
.avatar-opt.selected {
  border-color: var(--gold);
  box-shadow: 0 0 16px rgba(201,168,76,0.4);
  background: #2a2418;
}
.avatar-opt.selected::after {
  content: '‚úì';
  position: absolute;
  bottom: 3px; right: 5px;
  font-size: 10px;
  font-family: 'Cinzel', serif;
  color: var(--gold);
}

/* Class picker */
.class-grid {
  display: flex;
  flex-direction: column;
  gap: 9px;
  margin-bottom: 22px;
}
.class-opt {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 13px 16px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 14px;
  user-select: none;
}
.class-opt:hover { border-color: var(--gold-dim); background: #272118; }
.class-opt.selected { border-color: var(--gold); background: #272118; box-shadow: inset 3px 0 0 var(--gold); }
.class-emoji { font-size: 26px; flex-shrink: 0; width: 36px; text-align: center; }
.class-info { flex: 1; }
.class-name { font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold); margin-bottom: 2px; }
.class-desc { font-size: 12px; color: var(--text-dim); font-style: italic; line-height: 1.5; }
.class-trait {
  font-size: 10px;
  color: var(--xp-color);
  text-transform: uppercase;
  letter-spacing: 0.07em;
  background: rgba(74,158,255,0.1);
  border: 1px solid rgba(74,158,255,0.2);
  padding: 2px 8px;
  border-radius: 10px;
  white-space: nowrap;
  flex-shrink: 0;
}

/* Nav buttons */
.ob-nav {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 6px;
}
.ob-btn {
  background: var(--gold-dim);
  border: 1px solid var(--gold);
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 0.08em;
  padding: 11px 28px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s;
}
.ob-btn:hover { background: var(--gold); color: var(--bg); }
.ob-btn.secondary {
  background: transparent;
  border-color: var(--border-gold);
  color: var(--text-dim);
}
.ob-btn.secondary:hover { border-color: var(--gold-dim); color: var(--text); }

/* ‚îÄ‚îÄ CHARACTER CARD ‚îÄ‚îÄ */
.character-card {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 4px;
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
  animation: fadeUp 0.4s ease both;
}
.character-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
}
.char-top {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 18px;
}
.char-avatar {
  width: 60px; height: 60px;
  border: 2px solid var(--border-gold);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30px;
  background: var(--surface2);
  flex-shrink: 0;
}
.char-info { flex: 1; min-width: 0; }
.char-name {
  font-family: 'Cinzel', serif;
  font-size: 19px;
  color: var(--gold);
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.char-class {
  font-size: 13px;
  color: var(--text);
  font-style: italic;
}
.char-level { text-align: right; flex-shrink: 0; }
.level-num {
  font-family: 'Cinzel', serif;
  font-size: 32px;
  color: var(--gold-light);
  line-height: 1;
}
.level-label {
  font-size: 11px;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

/* ‚îÄ‚îÄ XP BAR (salient) ‚îÄ‚îÄ */
.xp-label-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 7px;
}
.xp-title-text {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--xp-color);
  text-transform: uppercase;
  letter-spacing: 0.12em;
}
.xp-count-text { font-size: 18px; color: var(--text-dim); }
.xp-count-text strong {
  font-family: 'Cinzel', serif;
  font-size: 18px !important;
  color: var(--xp-color);
  
}
.xp-bar-track {
  height: 28px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
  position: relative;
}
.xp-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #152d5e 0%, #2560b8 55%, #4a9eff 100%);
  border-radius: 14px;
  transition: width 0.85s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  min-width: 0;
}


/* ‚îÄ‚îÄ STREAK BANNER ‚îÄ‚îÄ */
.streak-banner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 13px 18px;
  margin-bottom: 16px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: var(--surface);
  position: relative;
  overflow: hidden;
  animation: fadeUp 0.4s 0.05s ease both;
  transition: border-color 0.3s, background 0.3s;
}
.streak-banner::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, #e8622a, transparent);
  opacity: 0.7;
}
.streak-banner.alive {
  border-color: rgba(232, 98, 42, 0.45);
  background: linear-gradient(90deg, rgba(232,98,42,0.06) 0%, var(--surface) 60%);
}
.streak-banner.danger {
  border-color: rgba(232, 98, 42, 0.25);
  background: var(--surface);
}
.streak-banner-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.streak-banner-flame {
  font-size: 26px;
  line-height: 1;
  filter: drop-shadow(0 0 6px rgba(232,98,42,0.5));
}
.streak-banner-flame.cold {
  filter: grayscale(0.8);
  opacity: 0.5;
}
.streak-banner-text {
  display: flex;
  align-items: baseline;
  gap: 8px;
}
.streak-banner-count {
  font-family: 'Cinzel', serif;
  font-size: 28px;
  color: #e8622a;
  line-height: 1;
}
.streak-banner-count.cold { color: var(--text-dark); }
.streak-banner-label {
  font-size: 13px;
  color: var(--text-dim);
  font-style: italic;
}
.streak-banner-right {
  font-size: 11px;
  color: var(--text-dark);
  font-family: 'Cinzel', serif;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  text-align: right;
}
.streak-banner-right.logged {
  color: var(--green);
}
.streak-banner-right.urgent {
  color: #e8622a;
  animation: urgentPulse 2s ease-in-out infinite;
}
@keyframes urgentPulse {
  0%, 100% { opacity: 1; }
  50%       { opacity: 0.5; }
}

.xp-next-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-top: 5px;
}
.xp-earn-hint {
  font-size: 11px;
  color: var(--text-dim);
  font-style: italic;
}
.xp-next-msg {
  font-size: 12px;
  color: var(--text-dim);
  font-style: italic;
  text-align: right;
}

/* Treasury Divider */
.card-divider {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 18px 0 14px;
}
.card-divider::before,
.card-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}
.card-divider-label {
  font-family: 'Cinzel', serif;
  font-size: 10px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.18em;
  white-space: nowrap;
}

/* Coin status row */
.coin-status-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-top: 5px;
  gap: 8px;
}
.coin-earn-hint {
  font-size: 11px;
  color: var(--text-dim);
  font-style: italic;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ COIN RESERVE ‚îÄ‚îÄ */
.coin-reserve-section {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}
.coin-label-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 7px;
}
.coin-title-text {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 0.12em;
}
.coin-count-text { font-size: 15px; color: var(--text-dim); }
.coin-count-text strong {
  font-family: 'Cinzel', serif;
  font-size: 16px;
  color: var(--gold);
}
.coin-bar-track {
  height: 18px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 9px;
  overflow: hidden;
  position: relative;
}
.coin-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #5a3e10 0%, #a06c1a 55%, #c9a84c 100%);
  border-radius: 9px;
  transition: width 0.85s cubic-bezier(0.4, 0, 0.2, 1);
  min-width: 0;
}
.coin-bar-fill.danger {
  background: linear-gradient(90deg, #5a1a14 0%, #a03020 55%, #c0392b 100%);
}
.coin-bar-fill.warning {
  background: linear-gradient(90deg, #5a3e10 0%, #b07820 55%, #e8a820 100%);
}
.coin-status {
  font-size: 12px;
  color: var(--text-dim);
  text-align: right;
  margin-top: 5px;
  font-style: italic;
}
.coin-status.danger { color: var(--red); }
.coin-status.warning { color: #e8a820; }

/* ‚îÄ‚îÄ IRON VAULT ‚îÄ‚îÄ */
.iron-vault-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 14px;
  padding: 11px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  position: relative;
  overflow: hidden;
}
.iron-vault-row::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: linear-gradient(180deg, var(--gold-dim), var(--border-gold));
}
.vault-left {
  display: flex;
  align-items: center;
  gap: 10px;
}
.vault-icon { font-size: 18px; }
.vault-label-wrap {}
.vault-title {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--gold-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  line-height: 1;
  margin-bottom: 2px;
}
.vault-subtitle {
  font-size: 11px;
  color: var(--text-dim);
  font-style: italic;
}
.vault-amount {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  color: var(--gold);
  text-align: right;
}
.vault-amount.empty { color: var(--text-dark); font-size: 14px; }

/* ‚îÄ‚îÄ COIN FLOAT ‚îÄ‚îÄ */
.coin-float {
  position: fixed;
  font-family: 'Cinzel', serif;
  font-size: 14px;
  color: var(--gold);
  pointer-events: none;
  z-index: 9000;
  opacity: 0;
  font-weight: bold;
}
.coin-float.pop {
  animation: coinDrain 1.1s ease-out forwards;
}
@keyframes coinDrain {
  0%   { opacity: 1; transform: translateX(-50%) translateY(0);   }
  100% { opacity: 0; transform: translateX(-50%) translateY(28px); }
}

/* ‚îÄ‚îÄ MONTH RESET OVERLAY ‚îÄ‚îÄ */
.reset-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.92);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s;
}
.reset-overlay.show { opacity: 1; pointer-events: all; }
.reset-box {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 6px;
  padding: 44px 48px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  position: relative;
  overflow: hidden;
  transform: scale(0.85) translateY(20px);
  transition: transform 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.reset-overlay.show .reset-box { transform: scale(1) translateY(0); }
.reset-box::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
}
.reset-icon { font-size: 40px; margin-bottom: 12px; }
.reset-label {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.22em;
  margin-bottom: 8px;
}
.reset-title {
  font-family: 'Cinzel', serif;
  font-size: 22px;
  color: var(--gold);
  margin-bottom: 16px;
  text-shadow: 0 0 30px rgba(201,168,76,0.4);
}
.reset-breakdown {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 14px 18px;
  margin-bottom: 20px;
  text-align: left;
}
.reset-row {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  color: var(--text);
  padding: 4px 0;
}
.reset-row.highlight { color: var(--gold); font-family: 'Cinzel', serif; font-size: 13px; }
.reset-row span:last-child { color: var(--text); }
.reset-row.highlight span:last-child { color: var(--gold); }
.reset-msg {
  font-style: italic;
  color: var(--text-dim);
  font-size: 13px;
  line-height: 1.7;
  margin-bottom: 24px;
}
.reset-close {
  background: var(--gold-dim);
  border: 1px solid var(--gold);
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 0.1em;
  padding: 11px 28px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s;
}
.reset-close:hover { background: var(--gold); color: var(--bg); }

/* ‚îÄ‚îÄ LOG SECTION ‚îÄ‚îÄ */
.log-section {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 4px;
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
  animation: fadeUp 0.4s 0.08s ease both;
}
.log-section::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--xp-color), transparent);
}

.section-head {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 0.14em;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.log-form-grid {
  display: grid;
  grid-template-columns: 1fr 110px auto;
  gap: 10px;
  align-items: end;
}
@media (max-width: 500px) {
  .log-form-grid { grid-template-columns: 1fr 1fr; }
  .log-btn-wrap  { grid-column: 1 / -1; }
}

.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label  { font-size: 10px; color: var(--text); text-transform: uppercase; letter-spacing: 0.08em; }
.form-input {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 3px;
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 15px;
  padding: 9px 11px;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
.form-input:focus { border-color: var(--gold-dim); }
.form-input::placeholder { color: var(--text-dark); }

.log-btn {
  background: var(--gold-dim);
  border: 1px solid var(--gold);
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 0.06em;
  padding: 9px 18px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  width: 100%;
}
.log-btn:hover  { background: var(--gold); color: var(--bg); }
.log-btn:active { transform: scale(0.97); }

.xp-hint {
  margin-top: 11px;
  font-size: 12px;
  color: var(--text-dim);
  font-style: italic;
  text-align: center;
}

/* ‚îÄ‚îÄ CHRONICLE ‚îÄ‚îÄ */
.log-list-wrap { margin-bottom: 20px; animation: fadeUp 0.4s 0.16s ease both; }
.log-list {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 4px;
  overflow: hidden;
}
.log-empty {
  padding: 24px;
  text-align: center;
  color: var(--text-dark);
  font-style: italic;
  font-size: 14px;
}
.log-item {
  display: grid;
  grid-template-columns: 28px 1fr auto;
  gap: 10px;
  align-items: center;
  padding: 11px 14px;
  border-bottom: 1px solid var(--border);
  animation: slideIn 0.3s ease both;
}
.log-item:last-child { border-bottom: none; }
.log-icon  { font-size: 16px; text-align: center; }
.log-desc  { font-size: 14px; color: var(--text); }
.log-meta  { font-size: 11px; color: var(--text-dim); font-style: italic; }
.log-right { text-align: right; }
.log-amount { font-family: 'Cinzel', serif; font-size: 13px; }
.log-xp    { font-size: 12px; color: var(--xp-color); }


/* ‚îÄ‚îÄ LEVEL UP ‚îÄ‚îÄ */
.levelup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.87);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s;
}
.levelup-overlay.show { opacity: 1; pointer-events: all; }
.levelup-box {
  background: var(--surface);
  border: 1px solid var(--gold);
  border-radius: 6px;
  padding: 44px 52px;
  text-align: center;
  position: relative;
  overflow: hidden;
  transform: scale(0.8) translateY(20px);
  transition: transform 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
  max-width: 380px;
  width: 90%;
}
.levelup-overlay.show .levelup-box { transform: scale(1) translateY(0); }
.levelup-box::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
}
.levelup-sparkles { font-size: 30px; letter-spacing: 6px; margin-bottom: 10px; }
.levelup-label {
  font-family: 'Cinzel', serif;
  font-size: 12px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.22em;
  margin-bottom: 4px;
}
.levelup-num {
  font-family: 'Cinzel', serif;
  font-size: 62px;
  color: var(--gold);
  line-height: 1;
  margin: 2px 0 8px;
  text-shadow: 0 0 40px rgba(201,168,76,0.55);
}
.levelup-rank {
  font-family: 'Cinzel', serif;
  font-size: 16px;
  color: var(--gold-light);
  margin-bottom: 14px;
}
.levelup-msg {
  font-style: italic;
  color: var(--text-dim);
  font-size: 14px;
  line-height: 1.7;
  margin-bottom: 24px;
  padding: 0 8px;
}
.levelup-close {
  background: var(--gold-dim);
  border: 1px solid var(--gold);
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 0.1em;
  padding: 11px 28px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s;
}
.levelup-close:hover { background: var(--gold); color: var(--bg); }

/* ‚îÄ‚îÄ TEASERS ‚îÄ‚îÄ */
.teasers { margin-top: 28px; animation: fadeUp 0.5s 0.3s ease both; }
.teasers-head {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.14em;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.teasers-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.teaser-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
  gap: 10px;
}
.teaser-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 14px 16px;
  opacity: 0.38;
  filter: saturate(0.2);
  position: relative;
  transition: opacity 0.2s, filter 0.2s;
}
.teaser-card:hover { opacity: 0.55; filter: saturate(0.4); }
.teaser-lock { position: absolute; top: 9px; right: 10px; font-size: 11px; color: var(--text-dark); }
.teaser-icon { font-size: 22px; margin-bottom: 7px; }
.teaser-name { font-family: 'Cinzel', serif; font-size: 12px; color: var(--gold-dim); margin-bottom: 4px; }
.teaser-hint { font-size: 11px; color: var(--text-dim); font-style: italic; line-height: 1.5; }
.teaser-unlock { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 8px; }

/* ‚îÄ‚îÄ ENCOUNTER BOX VARIANTS ‚îÄ‚îÄ */
.encounter-box.story {
  border-color: var(--border-gold);
}
.encounter-box.story .encounter-zone {
  color: var(--gold-dim);
}
.encounter-box.arrival {
  border-color: #4a9eff;
  box-shadow: 0 0 32px rgba(74,158,255,0.15);
}
.encounter-box.arrival .encounter-zone {
  color: #4a9eff;
}
.encounter-box.zone-complete {
  border-color: var(--gold);
  box-shadow: 0 0 40px rgba(201,168,76,0.25);
}
.encounter-box.zone-complete .encounter-zone {
  color: var(--gold);
  font-size: 13px;
}
.encounter-box.zone-complete .encounter-title {
  color: var(--gold-light);
}
.encounter-btn.story-choice {
  background: var(--surface2);
  border-color: var(--border-gold);
  color: var(--text-dim);
}
.encounter-btn.story-choice:hover {
  background: var(--surface);
  border-color: var(--gold-dim);
  color: var(--text);
}
.map-hearts {
  display: flex;
  align-items: center;
  gap: 6px;
}
.map-heart {
  font-size: 16px;
  transition: all 0.3s;
  filter: drop-shadow(0 0 3px rgba(192,57,43,0.5));
  line-height: 1;
}
.map-heart.empty {
  filter: grayscale(1) opacity(0.2);
}

/* ‚îÄ‚îÄ BADGES (compact on character card) ‚îÄ‚îÄ */
.badges-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.badges-label {
  font-family: 'Cinzel', serif;
  font-size: 10px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-right: 4px;
  flex-shrink: 0;
}
.badge-slot {
  width: 30px; height: 30px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--surface2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  position: relative;
  transition: all 0.3s;
  cursor: default;
}
.badge-slot.earned {
  border-color: var(--gold);
  box-shadow: 0 0 8px rgba(201,168,76,0.4);
}
.badge-slot.locked { opacity: 0.2; }
.badge-slot .badge-tip {
  display: none;
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 4px 8px;
  font-size: 10px;
  color: var(--text-dim);
  white-space: nowrap;
  font-family: 'Cinzel', serif;
  z-index: 100;
  pointer-events: none;
}
.badge-slot:hover .badge-tip { display: block; }

/* ‚îÄ‚îÄ NODE MAP ‚îÄ‚îÄ */
.map-panel {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 0 0 4px 4px;
  padding: 20px 20px 16px;
  position: relative;
  overflow: hidden;
  border-top: none;
}
.map-panel::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.map-top-bar {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 14px;
  gap: 12px;
}
.map-top-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.map-section-label {
  font-family: 'Cinzel', serif;
  font-size: 10px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.14em;
}
.map-current-loc {
  font-family: 'Cinzel', serif;
  font-size: 14px;
  color: var(--gold);
}
.map-zone-tag {
  font-size: 12px;
  color: var(--text);
  font-style: italic;
  opacity: 0.7;
}

/* Map right column (hearts + badges stacked) */
.map-right-col {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
  flex-shrink: 0;
}
.map-badges-row {
  display: flex;
  gap: 5px;
  align-items: center;
}

/* Map viewport ‚Äî windowed view, clips to show ~5 nodes at a time */
.map-viewport {
  position: relative;
  width: 100%;
  height: 260px;
  overflow: hidden;
  border-radius: 4px;
}
/* Top fade ‚Äî reveals content came from above */
.map-viewport::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 40px;
  background: linear-gradient(180deg, var(--surface) 0%, transparent 100%);
  z-index: 10;
  pointer-events: none;
  transition: opacity 0.5s;
}
/* Bottom fade ‚Äî signals map continues below */
.map-viewport::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 48px;
  background: linear-gradient(0deg, var(--surface) 0%, transparent 100%);
  z-index: 10;
  pointer-events: none;
}
/* "More ahead" arrow at bottom of viewport */
.map-more-arrow {
  position: absolute;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 20;
  font-size: 11px;
  color: var(--gold-dim);
  font-family: 'Cinzel', serif;
  letter-spacing: 0.1em;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1px;
  pointer-events: none;
  animation: arrowBob 2s ease-in-out infinite;
  opacity: 0.7;
}
.map-more-arrow.hidden { display: none; }
@keyframes arrowBob {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50%       { transform: translateX(-50%) translateY(3px); }
}

/* The scrollable world inside the viewport */
.node-map {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}
.node-map svg {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  pointer-events: none;
}
.node-map-inner {
  position: relative;
  z-index: 2;
}

/* Individual map nodes */
.map-node-wrap {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  transform: translate(-50%, -50%);
  cursor: default;
}
.map-node-circle {
  width: 48px; height: 48px;
  border-radius: 50%;
  border: 2px solid var(--border);
  background: var(--surface2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  transition: all 0.4s;
  position: relative;
}
.map-node-circle.done {
  border-color: var(--gold-dim);
  background: #1c1808;
  opacity: 0.65;
}
.map-node-circle.current {
  border-color: var(--gold);
  background: #2a2010;
  box-shadow: 0 0 18px rgba(201,168,76,0.55);
  animation: nodeGlow 2.5s ease-in-out infinite;
}
.map-node-circle.ahead {
  opacity: 0.28;
  filter: saturate(0.15);
}
.map-node-circle.badge-node {
  width: 42px; height: 42px;
  font-size: 18px;
  border-style: dashed;
}
.map-node-circle.badge-node.earned {
  border-color: var(--gold);
  border-style: solid;
  box-shadow: 0 0 14px rgba(201,168,76,0.5);
  opacity: 1;
  filter: none;
}
@keyframes nodeGlow {
  0%, 100% { box-shadow: 0 0 14px rgba(201,168,76,0.4); }
  50%       { box-shadow: 0 0 28px rgba(201,168,76,0.75); }
}
.map-node-label {
  font-family: 'Cinzel', serif;
  font-size: 9px;
  color: var(--text-dark);
  text-align: center;
  line-height: 1.3;
  max-width: 60px;
  white-space: nowrap;
}
.map-node-wrap.current .map-node-label { color: var(--gold-dim); }

/* Zone region labels */
.zone-region-label {
  position: absolute;
  font-family: 'Cinzel', serif;
  font-size: 8px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.12em;
  opacity: 0.5;
  pointer-events: none;
}

/* Road bonus row */
.road-bonus-track {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 14px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.road-bonus-label {
  font-size: 11px;
  color: var(--text-dim);
  font-style: italic;
  flex: 1;
}
.road-bonus-pips {
  display: flex;
  gap: 4px;
  align-items: center;
}
.road-pip {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--border);
  transition: all 0.3s;
}
.road-pip.earned {
  background: var(--gold);
  box-shadow: 0 0 5px rgba(201,168,76,0.5);
}

/* Character card + map as unified block */
.hero-block {
  margin-bottom: 20px;
  animation: fadeUp 0.4s ease both;
}
.hero-block .character-card {
  border-radius: 4px 4px 0 0;
  margin-bottom: 0;
  border-bottom: 1px solid var(--border);
  animation: none;
}

/* ‚îÄ‚îÄ ENCOUNTER OVERLAY ‚îÄ‚îÄ */
.encounter-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.92);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s;
}
.encounter-overlay.show { opacity: 1; pointer-events: all; }
.encounter-box {
  background: var(--surface);
  border-radius: 6px;
  padding: 36px 40px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  position: relative;
  overflow: hidden;
  transform: scale(0.85) translateY(20px);
  transition: transform 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.encounter-overlay.show .encounter-box { transform: scale(1) translateY(0); }
.encounter-box.hostile {
  border: 1px solid var(--red);
}
.encounter-box.hostile::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--red), transparent);
}
.encounter-box.friendly {
  border: 1px solid var(--green);
}
.encounter-box.friendly::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--green), transparent);
}
.encounter-zone {
  font-family: 'Cinzel', serif;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  margin-bottom: 6px;
}
.encounter-box.hostile .encounter-zone { color: var(--red); }
.encounter-box.friendly .encounter-zone { color: var(--green); }
.encounter-icon { font-size: 44px; margin-bottom: 12px; line-height: 1; }
.encounter-title {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  color: var(--text);
  margin-bottom: 10px;
}
.encounter-desc {
  font-size: 14px;
  color: var(--text);
  font-style: italic;
  line-height: 1.7;
  margin-bottom: 22px;
}
.encounter-choices { display: flex; flex-direction: column; gap: 9px; }
.encounter-btn {
  background: transparent;
  border: 1px solid var(--border-gold);
  color: var(--text);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 0.07em;
  padding: 12px 20px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
  line-height: 1.5;
}
.encounter-btn:hover { background: var(--surface2); border-color: var(--gold-dim); }
.encounter-btn.hostile-choice { border-color: rgba(192,57,43,0.4); }
.encounter-btn.hostile-choice:hover { border-color: var(--red); background: rgba(192,57,43,0.08); }
.encounter-btn.friendly-choice { border-color: rgba(39,174,96,0.4); }
.encounter-btn.friendly-choice:hover { border-color: var(--green); background: rgba(39,174,96,0.08); }
.encounter-btn-cost {
  display: block;
  font-size: 10px;
  color: var(--text-dark);
  margin-top: 3px;
  letter-spacing: 0.05em;
}
.encounter-btn-disabled {
  opacity: 0.38;
  cursor: not-allowed;
  border-color: var(--border) !important;
  background: transparent !important;
}
.encounter-btn-disabled:hover {
  background: transparent !important;
  border-color: var(--border) !important;
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(16px);
  background: var(--surface);
  border: 1px solid var(--border-gold);
  color: var(--text);
  font-size: 13px;
  padding: 10px 20px;
  border-radius: 3px;
  opacity: 0;
  pointer-events: none;
  z-index: 8000;
  transition: all 0.3s;
  white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(-6px); }
  to   { opacity: 1; transform: translateX(0); }
}
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <h1>‚öî Budget Quest</h1>
    <div class="tagline">Turn financial discipline into heroic progress.</div>
    <div id="header-auth" style="display:none;margin-top:8px;font-size:12px;color:var(--text-dark);">
      <span id="header-email"></span>
      <button onclick="signOut()" style="margin-left:12px;background:none;border:1px solid var(--border);color:var(--text-dark);padding:3px 10px;border-radius:3px;cursor:pointer;font-size:11px;">Sign Out</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ -->
  <div id="login-screen" style="display:none;">
    <div class="onboarding-card" style="max-width:400px;margin:0 auto;">
      <div style="text-align:center;font-size:48px;margin-bottom:16px">üõ°Ô∏è</div>
      <div class="ob-title">Enter the Realm</div>
      <div class="ob-sub" style="margin-bottom:24px;">Every hero needs a name on the ledger. Enter your email and we'll send you a link to claim your place on the road.</div>
      <div id="login-form">
        <div class="name-row" style="flex-direction:column;gap:10px;">
          <input class="hero-name-input" id="login-email" type="email" placeholder="your@email.com" autocomplete="email" style="border-radius:3px;width:100%;">
          <button class="ob-btn" style="width:100%;justify-content:center;" onclick="sendMagicLink()">Claim Your Place on the Road ‚öî</button>
        </div>
        <div id="login-error" style="color:var(--red);font-size:13px;text-align:center;margin-top:10px;display:none;"></div>
      </div>
      <div id="login-sent" style="display:none;text-align:center;">
        <div style="font-size:36px;margin-bottom:12px">‚úâÔ∏è</div>
        <div style="color:var(--gold);font-family:'Cinzel',serif;font-size:16px;margin-bottom:8px;">Your summons has been sent</div>
        <div style="color:var(--text-dim);font-size:14px;line-height:1.6;">A magic link rides to <strong id="sent-email" style="color:var(--text)"></strong>.<br>Click it to enter the realm and begin your journey.</div>
        <button onclick="resetLoginForm()" style="margin-top:16px;background:none;border:none;color:var(--text-dark);font-size:12px;cursor:pointer;text-decoration:underline;">Use a different email</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ -->
  <div id="onboarding" style="display: none;">
    <div class="onboarding-card">

      <div class="steps-row">
        <div class="step-dot done" id="dot-0"></div>
        <div class="step-line"></div>
        <div class="step-dot active" id="dot-1"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-3"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-4"></div>
      </div>

      <!-- Step 1: Name -->
      <div class="ob-step active" id="step-0">
        <div style="text-align:center;font-size:44px;margin-bottom:14px">üõ°Ô∏è</div>
        <div class="ob-title">Your Legend Begins</div>
        <div class="ob-sub">Every coin you track is an act of discipline. Every logged expense builds your power. What name shall history remember?</div>
        <div class="name-row">
          <input class="hero-name-input" id="hero-name-input" type="text" placeholder="Name your hero‚Ä¶" maxlength="24" autocomplete="off" value="Timli">
          <button class="ob-btn" style="border-radius:0 3px 3px 0;white-space:nowrap" onclick="goStep(1)">Next ‚Üí</button>
        </div>
      </div>

      <!-- Step 2: Avatar -->
      <div class="ob-step" id="step-1">
        <div class="ob-title">Choose Your Form</div>
        <div class="ob-sub">How shall you appear in the chronicles of the realm?</div>
        <div class="avatar-grid" id="avatar-grid">
          <div class="avatar-opt" data-avatar="üßô" onclick="selectAvatar(this)">üßô</div>
          <div class="avatar-opt" data-avatar="üßù‚Äç‚ôÄÔ∏è" onclick="selectAvatar(this)">üßù‚Äç‚ôÄÔ∏è</div>
          <div class="avatar-opt" data-avatar="üßî" onclick="selectAvatar(this)">üßî</div>
        </div>
       <div class="ob-nav">
  <button class="ob-btn secondary" onclick="goStep(0)">‚Üê Back</button>
  <button class="ob-btn" onclick="goStep(2)">Choose Class ‚Üí</button>
</div>
      </div>

      <!-- Step 3: Class -->
      <div class="ob-step" id="step-2">
        <div class="ob-title">Choose Your Class</div>
        <div class="ob-sub">Your class shapes the path ahead. All roads lead to mastery.</div>
        <div class="class-grid" id="class-grid">
          <div class="class-opt" data-class="Mage" onclick="selectClass(this)">
            <div class="class-emoji">üîÆ</div>
            <div class="class-info">
              <div class="class-name">Mage of the Archive</div>
              <div class="class-desc">You wield knowledge as a weapon. Subscriptions and hidden fees hold no power over you.</div>
            </div>
            <div class="class-trait">Wisdom</div>
          </div>
          <div class="class-opt" data-class="Ranger" onclick="selectClass(this)">
            <div class="class-emoji">üèπ</div>
            <div class="class-info">
              <div class="class-name">Ranger of the Forest</div>
              <div class="class-desc">Discipline is your nature. You log daily, break no streaks, and spend only with intention.</div>
            </div>
            <div class="class-trait">Discipline</div>
          </div>
          <div class="class-opt" data-class="Hunter" onclick="selectClass(this)">
            <div class="class-emoji">üê∫</div>
            <div class="class-info">
              <div class="class-name">Hunter of Surplus</div>
              <div class="class-desc">You pursue savings aggressively. Every budget you beat is a trophy on your wall.</div>
            </div>
            <div class="class-trait">Willpower</div>
          </div>
          <div class="class-opt" data-class="Knight" onclick="selectClass(this)">
            <div class="class-emoji">üó°Ô∏è</div>
            <div class="class-info">
              <div class="class-name">Knight of the Keep</div>
              <div class="class-desc">You defend your budget with honor. Overspending is a foe that shall not pass.</div>
            </div>
            <div class="class-trait">Discipline</div>
          </div>
          <div class="class-opt" data-class="Healer" onclick="selectClass(this)">
            <div class="class-emoji">‚ù§Ô∏è‚Äçü©π</div>
            <div class="class-info">
              <div class="class-name">Healer of Debts</div>
              <div class="class-desc">Recovery is your power. You restore what was lost and patience is your greatest asset.</div>
            </div>
            <div class="class-trait">Wisdom</div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="ob-btn secondary" onclick="goStep(1)">‚Üê Back</button>
          <button class="ob-btn" onclick="goStep(3)">The Laws of the Realm ‚Üí</button>
        </div>
      </div>

      <!-- Step 4: Laws of the Realm -->
      <div class="ob-step" id="step-3">
        <div style="text-align:center;font-size:36px;margin-bottom:10px">üìú</div>
        <div class="ob-title">The Laws of the Realm</div>
        <div class="ob-sub">Five laws govern your journey. Know them before you ride.</div>
        <div class="laws-grid">
          <div class="law-card">
            <div class="law-icon">‚öîÔ∏è</div>
            <div class="law-body">
              <div class="law-title">Log Expenses ‚Üí Earn XP</div>
              <div class="law-plain">Every purchase you record earns experience. The amount doesn't matter ‚Äî the act of tracking does.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">üî•</div>
            <div class="law-body">
              <div class="law-title">Log Daily ‚Üí Build Your Streak</div>
              <div class="law-plain">Log at least once every day to grow your streak. Streaks boost your XP. Miss a day and it resets to zero.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">üîí</div>
            <div class="law-body">
              <div class="law-title">Stay Under Budget ‚Üí Fill the Iron Vault</div>
              <div class="law-plain">Your monthly budget is your Coin Reserve. Any gold left unspent at month's end is sealed in the Iron Vault ‚Äî your trophy of discipline.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">üó∫Ô∏è</div>
            <div class="law-body">
              <div class="law-title">Level Up ‚Üí Advance the Map</div>
              <div class="law-plain">Each level moves you forward on The Journey ‚Äî a world map of 14 locations across 4 zones. Log well and earn Road Bonuses that accelerate your progress.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">‚ù§Ô∏è</div>
            <div class="law-body">
              <div class="law-title">Hearts Protect You on the Road</div>
              <div class="law-plain">The road has hazards ‚Äî bandits, tax collectors, temptation merchants. You start with 3 hearts. Spend one to block a threat, or pay from your Iron Vault instead. Shrines and scouts restore them.</div>
            </div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="ob-btn secondary" onclick="goStep(2)">‚Üê Back</button>
          <button class="ob-btn" onclick="goStep(4)">Set Your Treasury ‚Üí</button>
        </div>
      </div>

      <!-- Step 5: Monthly Budget -->
      <div class="ob-step" id="step-4">
        <div style="text-align:center;font-size:44px;margin-bottom:14px">üè¶</div>
        <div class="ob-title">Forge Your Monthly Treasury</div>
        <div class="ob-sub">What is your monthly budget? This becomes your Coin Reserve ‚Äî your gold to spend each month. Any surplus at month's end is sealed in the Iron Vault.</div>
        <div class="name-row">
          <span style="background:var(--surface2);border:1px solid var(--border-gold);border-right:none;border-radius:3px 0 0 3px;padding:11px 14px;color:var(--gold-dim);font-family:'Cinzel',serif;font-size:15px;">$</span>
          <input class="hero-name-input" id="budget-input" type="number" min="1" step="1" placeholder="e.g. 2000" style="border-radius:0;border-left:none;" autocomplete="off">
          <button class="ob-btn" style="border-radius:0 3px 3px 0;white-space:nowrap" onclick="beginJourney()">Begin the Quest ‚öî</button>
        </div>
        <div style="text-align:center;margin-top:14px;font-size:12px;color:var(--text-dark);font-style:italic;">You can update this anytime. No judgment ‚Äî only discipline.</div>
        <div class="ob-nav" style="margin-top:18px;">
          <button class="ob-btn secondary" onclick="goStep(3)">‚Üê Back</button>
        </div>
      </div>

    </div>
  </div><!-- /onboarding -->

  <!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
  <div id="main" style="display: block;">

    <!-- ‚îÄ‚îÄ HERO BLOCK: character card + map panel as one unified unit ‚îÄ‚îÄ -->
    <div class="hero-block">

      <!-- Character Card (top half) -->
      <div class="character-card">
        <div class="char-top">
          <div class="char-avatar" id="char-avatar">üßô</div>
          <div class="char-info">
            <div class="char-name" id="char-name">Hero</div>
            <div class="char-class" id="char-class">Novice</div>
          </div>
          <div class="char-level">
            <div class="level-num" id="level-num">1</div>
            <div class="level-label">Level</div>
          </div>
        </div>

        <!-- XP -->
        <div class="xp-label-row">
          <span class="xp-title-text">‚öî Experience (XP)</span>
          <span class="xp-count-text"><strong id="xp-current">0</strong> / <span id="xp-next-val">80</span> XP</span>
        </div>
        <div class="xp-bar-track">
          <div class="xp-bar-fill" id="xp-fill" style="width:0%"></div>
        </div>
        <div class="xp-next-row">
          <span class="xp-earn-hint">Earned by logging expenses</span>
          <span class="xp-next-msg" id="xp-next-msg">80 XP until Level 2</span>
        </div>

        <!-- Treasury Divider -->
        <div class="card-divider"><span class="card-divider-label">Treasury</span></div>

        <!-- Coin Reserve -->
        <div class="coin-reserve-section" id="coin-reserve-section">
          <div class="coin-label-row">
            <span class="coin-title-text">‚öú Monthly Coin Reserve</span>
            <span class="coin-count-text"><strong id="coin-current">0</strong> / <span id="coin-max">0</span> gold</span>
          </div>
          <div class="coin-bar-track">
            <div class="coin-bar-fill" id="coin-fill" style="width:100%"></div>
          </div>
          <div class="coin-status-row">
            <span class="coin-earn-hint">Your monthly budget ‚Äî depletes as you spend</span>
            <span class="coin-status" id="coin-status"></span>
          </div>

          <!-- Iron Vault -->
          <div class="iron-vault-row">
            <div class="vault-left">
              <div class="vault-icon">üîí</div>
              <div class="vault-label-wrap">
                <div class="vault-title">Iron Vault</div>
                <div class="vault-subtitle">Unspent gold sealed here at month's end ‚Äî reward for staying under budget</div>
              </div>
            </div>
            <div class="vault-amount" id="vault-amount">Empty</div>
          </div>
        </div>

      </div><!-- /character-card -->

      <!-- Map Panel (bottom half, connected) -->
      <div class="map-panel" id="map-section">
        <div class="map-top-bar">
          <div class="map-top-left">
            <span class="map-section-label">‚öî The Journey</span>
            <span class="map-current-loc" id="map-location-name">Hearthstone Village</span>
            <span class="map-zone-tag" id="map-zone-tag">Zone I ‚Äî The Hearthstone Road</span>
          </div>
          <div class="map-right-col">
            <div class="map-hearts">
              <span class="map-heart" id="heart-1">‚ù§Ô∏è</span>
              <span class="map-heart" id="heart-2">‚ù§Ô∏è</span>
              <span class="map-heart" id="heart-3">‚ù§Ô∏è</span>
            </div>
            <div class="map-badges-row">
              <div class="badge-slot locked" id="badge-zone1"><span>üõ°Ô∏è</span><span class="badge-tip">The First Steps</span></div>
              <div class="badge-slot locked" id="badge-zone2"><span>ü™ô</span><span class="badge-tip">Disciplined Traveler</span></div>
              <div class="badge-slot locked" id="badge-zone3"><span>üåø</span><span class="badge-tip">Thornwood Survivor</span></div>
              <div class="badge-slot locked" id="badge-zone4"><span>üîí</span><span class="badge-tip">Keeper of the Iron Vault</span></div>
            </div>
          </div>
        </div>

        <!-- Node map rendered by JS -->
        <div class="map-viewport" id="map-viewport">
          <div class="node-map" id="node-map">
            <svg id="map-svg" xmlns="http://www.w3.org/2000/svg"></svg>
            <div class="node-map-inner" id="node-map-inner"></div>
          </div>
          <div class="map-more-arrow" id="map-more-arrow">
            <span>more ahead</span>
            <span>‚ñº</span>
          </div>
        </div>

        <!-- Road Bonus -->
        <div class="road-bonus-track">
          <span class="road-bonus-label" id="road-bonus-label">Road Bonus ‚Äî log well this week to move faster</span>
          <div class="road-bonus-pips">
            <div class="road-pip" id="road-pip-1"></div>
            <div class="road-pip" id="road-pip-2"></div>
            <div class="road-pip" id="road-pip-3"></div>
          </div>
        </div>
      </div><!-- /map-panel -->

    </div><!-- /hero-block -->

    <!-- Streak Banner -->
    <div class="streak-banner" id="streak-banner">
      <div class="streak-banner-left">
        <span class="streak-banner-flame" id="streak-banner-flame">üî•</span>
        <div class="streak-banner-text">
          <span class="streak-banner-count" id="streak-count">0</span>
          <span class="streak-banner-label" id="streak-label">day streak ‚Äî begin yours</span>
        </div>
      </div>
      <div class="streak-banner-right" id="streak-banner-right">Start your streak today</div>
    </div>

    <!-- Log Form -->
    <div class="log-section">
      <div class="section-head">Record an Expense</div>
      <div class="log-form-grid">
        <div class="form-group">
          <label class="form-label">What did you spend on?</label>
          <input class="form-input" id="desc-input" type="text" placeholder="e.g. Morning coffee" autocomplete="off">
        </div>
        <div class="form-group">
          <label class="form-label">Amount ($)</label>
          <input class="form-input" id="amount-input" type="number" min="0.01" step="0.01" placeholder="0.00">
        </div>
        <div class="log-btn-wrap">
          <label class="form-label" style="visibility:hidden">Log</label>
          <button class="log-btn" id="log-btn" onclick="logExpense()">‚öî Log It</button>
        </div>
      </div>
      <div class="xp-hint">Log an expense ‚Üí earn XP ‚Üí level up ‚Üí advance the map</div>
    </div>

    <!-- Expense Chronicle -->
    <div class="log-list-wrap">
      <div class="section-head">Expense Chronicle</div>
      <div class="log-list" id="log-list"></div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->

<!-- XP Float -->
<div class="xp-float" id="xp-float"></div>

<!-- Coin Float -->
<div class="coin-float" id="coin-float"></div>

<!-- Month Reset Overlay -->
<div class="reset-overlay" id="reset-overlay">
  <div class="reset-box">
    <div class="reset-icon">üè¶</div>
    <div class="reset-label">A New Campaign Begins</div>
    <div class="reset-title">Monthly Reset</div>
    <div class="reset-breakdown" id="reset-breakdown">
      <!-- filled dynamically -->
    </div>
    <div class="reset-msg" id="reset-msg">Your treasury has been replenished. The Iron Vault holds your surplus. Spend wisely, hero.</div>
    <button class="reset-close" onclick="closeReset()">March Forward ‚öî</button>
  </div>
</div>

<!-- Level Up Overlay -->
<div class="levelup-overlay" id="levelup-overlay">
  <div class="levelup-box">
    <div class="levelup-sparkles">‚ú¶‚Äâ‚úß‚Äâ‚ú¶</div>
    <div class="levelup-label">Level Up</div>
    <div class="levelup-num" id="lu-level">2</div>
    <div class="levelup-rank" id="lu-rank">Apprentice</div>    <div class="levelup-msg" id="lu-msg">Your discipline grows stronger. The realm notices.</div>
    <button class="levelup-close" onclick="closeLevelUp()">Continue the Quest</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CONSTANTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var SAVE_KEY = 'bq_v2';

// Cumulative XP to reach each level (index = level - 1)
var LEVEL_XP = [0, 80, 200, 370, 600, 900, 1270, 1720, 2260, 3000, 4000];

var CLASS_TITLES = {
  Mage:   ['Novice Archivist','Apprentice Mage','Scroll Keeper','Lore Binder','Elder Mage'],
  Ranger: ['Novice Tracker','Trail Walker','Forest Keeper','Silent Warden','Ranger Lord'],
  Hunter: ['Novice Hunter','Coin Stalker','Surplus Seeker','Thrift Predator','Master Hunter'],
  Knight: ['Novice Guard','Shield Bearer','Budget Warden','Iron Keeper','Knight Commander'],
  Healer: ['Novice Mender','Debt Healer','Wound Closer','Recovery Sage','Grand Healer'],
};

var LEVEL_MSGS = [
  'The realm whispers your name with growing respect.',
  'Enemies stir in the shadows. Your discipline unnerves them.',
  'Ancient powers take note of your consistency.',
  'A darkness begins to sense you. It fears the disciplined.',
  'Merchants speak of a keeper who cannot be broken.',
  'The old ones said this path would find no hero. They were wrong.',
  'Your ledger has become a weapon. Your restraint, a shield.',
  'Guild halls echo with tales of your perseverance.',
  'You approach the upper tiers of mastery. Few have come this far.',
  'The realm is yours to protect. You have become legend.',
];

var LOG_ICONS = ['üí∞','üõí','üçñ','üß™','‚öîÔ∏è','üìú','üêé','üè∞','üîÆ','üíé','üåø','üéí'];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAP DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var MAP_WAYPOINTS = [
  // Zone 1 ‚Äî The Hearthstone Road (levels 1-3)
  { id: 0,  icon: 'üèòÔ∏è', name: 'Hearthstone\nVillage',  zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'Your journey begins in Hearthstone ‚Äî a village built on old scorch marks that nobody talks about. Log your expenses to earn XP, level up, and move down the road.' },
  { id: 1,  icon: 'üåæ', name: 'Harvest\nCrossing',      zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'The Oldfather Oak is larger than you expected. Three guilds claim ownership of it. None of them are here.' },
  { id: 2,  icon: 'ü™®', name: 'Stonepath\nMill',        zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'The miller takes coin only. No credit, no exceptions. The sign above his door has been there longer than he has.' },
  { id: 'z1', icon: 'üõ°Ô∏è', name: 'Zone Badge',          zone: 'badge1', badge: 'zone1', zoneName: 'The Hearthstone Road',
    zoneComplete: 'You leave the Hearthstone Road behind. It looks smaller from here than it felt while you were on it.' },
  // Zone 2 ‚Äî The Merchant\'s Pass (levels 4-6)
  { id: 3,  icon: 'üè™', name: "Merchant's\nGate",       zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'The original gate collapsed centuries ago. The market that grew up around the ruin never stopped.' },
  { id: 4,  icon: 'üåâ', name: 'Copperbridge',           zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'The copper plating was stripped and sold by a treasurer hiding a deficit. Someone still leaves coins on the memorial plaque.' },
  { id: 5,  icon: '‚õ∫', name: "Trader's\nCamp",         zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'The Thornwood begins fifty yards past the last tent. At night you can\'t tell where the camp ends and the forest starts.' },
  { id: 'z2', icon: 'ü™ô', name: 'Zone Badge',           zone: 'badge2', badge: 'zone2', zoneName: "The Merchant's Pass",
    zoneComplete: "The Merchant's Pass falls behind you. The road ahead grows quieter. That is not entirely reassuring." },
  // Zone 3 ‚Äî The Thornwood (levels 7-9)
  { id: 6,  icon: 'üå≤', name: 'Thornwood\nEdge',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'The tree line begins without warning. You mark your entry point with stones, the way experienced travelers do. You don\'t ask why.' },
  { id: 7,  icon: 'üåë', name: 'Darkhollow\nPath',       zone: 3, zoneName: 'The Thornwood',
    arrival: 'The path narrows. The light here has a grey, used quality. You notice you\'re walking faster without having decided to.' },
  { id: 8,  icon: 'üïØÔ∏è', name: 'Wayward\nShrine',       zone: 3, zoneName: 'The Thornwood',
    arrival: 'Nobody built this shrine. The candles burn without being lit. The offerings left by travelers disappear by morning.' },
  { id: 'z3', icon: 'üåø', name: 'Zone Badge',           zone: 'badge3', badge: 'zone3', zoneName: 'The Thornwood',
    zoneComplete: 'You leave the Thornwood behind. The light on the other side is warmer than you remembered light being.' },
  // Zone 4 ‚Äî The Iron Keep (level 10+)
  { id: 9,  icon: '‚öîÔ∏è', name: 'Iron Keep\nGates',       zone: 4, zoneName: 'The Iron Keep',
    arrival: 'These gates have never been closed ‚Äî not during wars, not during sieges, not once. You walk through them.' },
  { id: 10, icon: 'üè∞', name: 'The Iron\nKeep',         zone: 4, zoneName: 'The Iron Keep',
    arrival: 'From a distance it looked like a fortress. Up close it\'s a city. At its heart: a black tower whose windows are lit by a light with no source.' },
  { id: 'z4', icon: 'üîí', name: 'Zone Badge',           zone: 'badge4', badge: 'zone4', zoneName: 'The Iron Keep',
    zoneComplete: 'You have reached the Iron Keep. The road behind you is longer than it looked when you started. You do not mind.' },
];

// Map position is 0-10 (numeric waypoints only)
// Level thresholds for map advancement: level X unlocks map position Y
var LEVEL_TO_MAP = [0,0,1,2,3,4,5,6,7,8,9,10];

var HOSTILE_ENCOUNTERS = [
  {
    id: 'bandits',
    icon: 'üó°Ô∏è',
    title: 'Bandits on the Road',
    zone: 'Road Hazard',
    desc: 'Three figures step from the shadows ahead, blades drawn. They have been watching the road. They have been watching you. One holds out a hand.',
    choiceA: { label: 'Draw steel and drive them back', cost: 'heart', sub: 'Costs 1 ‚ù§Ô∏è ‚Äî vault protected' },
    choiceB: { label: 'Pay the toll and walk on',       cost: 'vault', sub: 'Lose gold from Iron Vault ‚Äî hearts protected' },
    vaultCost: 0.05
  },
  {
    id: 'taxman',
    icon: 'üìã',
    title: 'The King\'s Collector',
    zone: 'Road Hazard',
    desc: 'A collector in official colours blocks the road with two armed escorts. He has a ledger. He has already found your name in it. He taps the page and waits.',
    choiceA: { label: 'Contest the levy ‚Äî stand your ground', cost: 'heart', sub: 'Costs 1 ‚ù§Ô∏è ‚Äî vault protected' },
    choiceB: { label: 'Pay the levy and move on',             cost: 'vault', sub: 'Lose gold from Iron Vault ‚Äî hearts protected' },
    vaultCost: 0.08
  },
  {
    id: 'thornambush',
    icon: 'üåë',
    title: 'Thornwood Ambush',
    zone: 'Forest Hazard',
    desc: 'They come from both sides of the path at once ‚Äî not bandits, something stranger. They do not speak. They only want what you are carrying. The trees press close.',
    choiceA: { label: 'Fight through ‚Äî spend a Heart',  cost: 'heart', sub: 'Costs 1 ‚ù§Ô∏è ‚Äî vault protected' },
    choiceB: { label: 'Buy your way past',              cost: 'vault', sub: 'Lose gold from Iron Vault ‚Äî hearts protected' },
    vaultCost: 0.06
  },
  {
    id: 'merchant',
    icon: 'üõçÔ∏è',
    title: 'The Silk Road Merchant',
    zone: 'Merchant Encounter',
    desc: 'A merchant with a wagon full of extraordinary things blocks the narrow road and will not move until you look. You look. He knows his craft. Some of it is remarkable. All of it is expensive.',
    choiceA: { label: 'Decline and force your way past', cost: 'heart', sub: 'Costs 1 ‚ù§Ô∏è ‚Äî vault protected' },
    choiceB: { label: 'Pay his price for passage',       cost: 'vault', sub: 'Lose gold from Iron Vault ‚Äî hearts protected' },
    vaultCost: 0.07
  },
  {
    id: 'gateduty',
    icon: '‚öîÔ∏è',
    title: 'The Gate Duty',
    zone: 'Iron Keep ‚Äî Entrance Toll',
    desc: 'The Iron Keep\'s inner gate requires a toll to pass ‚Äî an old law, rarely enforced, suddenly enforced now. The guard is polite. He is also armoured. The gate does not open until someone pays.',
    choiceA: { label: 'Argue your right of passage ‚Äî spend a Heart', cost: 'heart', sub: 'Costs 1 ‚ù§Ô∏è ‚Äî vault protected' },
    choiceB: { label: 'Pay the toll',                                 cost: 'vault', sub: 'Lose gold from Iron Vault ‚Äî hearts protected' },
    vaultCost: 0.09
  }
];

var FRIENDLY_ENCOUNTERS = [
  {
    id: 'scout',
    icon: 'üß≠',
    title: 'A Wandering Scout',
    zone: 'Friendly Encounter',
    desc: 'A road-worn scout steps from the tree line and walks with you a while. She points out things on the path you would have missed. When she leaves she says: "You\'re making good time. Keep it up." It lands like a compliment from someone who doesn\'t give them easily.',
    reward: { type: 'xp', amount: 40 },
    rewardDesc: '+40 bonus XP for your vigilance'
  },
  {
    id: 'shrine',
    icon: 'üïØÔ∏è',
    title: 'Ancient Roadside Shrine',
    zone: 'Discovery',
    desc: 'Half-hidden by moss, an old shrine marks the road. You pause. The road feels lighter afterward, in the way that only happens when you\'ve done something you can\'t fully explain.',
    reward: { type: 'heart', amount: 1 },
    rewardDesc: '‚ù§Ô∏è Heart restored'
  },
  {
    id: 'journal',
    icon: 'üìñ',
    title: 'The Scout\'s Journal',
    zone: 'Discovery',
    desc: 'Tucked beneath a milestone stone: a weathered journal. The margins are full of notes in a careful hand ‚Äî routes, risks, lessons learned the hard way. Whoever left it knew what they were doing. Now some of that knowledge is yours.',
    reward: { type: 'xp', amount: 55 },
    rewardDesc: '+55 bonus XP from the journal\'s wisdom'
  },
  {
    id: 'camp',
    icon: 'üèïÔ∏è',
    title: 'Abandoned Traveler\'s Cache',
    zone: 'Discovery',
    desc: 'A cold camp, recently left in good order. Whoever was here traveled light and left something behind deliberately ‚Äî provisions cached under a flat stone, as if for someone who might need it more. That someone is you.',
    reward: { type: 'vault', amount: 25 },
    rewardDesc: '+25 gold sealed in your Iron Vault'
  },
  {
    id: 'elder',
    icon: 'üßô',
    title: 'The Road Elder',
    zone: 'Friendly Encounter',
    desc: 'An ancient wanderer sits by the roadside watching travelers pass. She looks at you for a long moment, then nods once ‚Äî slowly, deliberately, like someone confirming something they already suspected. She says nothing. She doesn\'t need to.',
    reward: { type: 'xp', amount: 30 },
    rewardDesc: '+30 bonus XP ‚Äî the elder\'s blessing'
  },
  {
    id: 'griffon',
    icon: 'ü¶Ö',
    title: 'The Griffon Rider\'s Token',
    zone: 'Friendly Encounter',
    desc: 'A piece of cloth in guild colours tied to a branch at the roadside ‚Äî a waymarker left by someone who passed before you. Travelers use these to signal the road is clear. Someone wanted you to know you were on the right path.',
    reward: { type: 'xp', amount: 35 },
    rewardDesc: '+35 bonus XP ‚Äî the road is clear ahead'
  }
];

// ‚îÄ‚îÄ STORY ENCOUNTERS (narrative only ‚Äî no mechanical effect) ‚îÄ‚îÄ
// Organised by zone. Player just reads and dismisses. World-building only.
var STORY_ENCOUNTERS = {
  // Zone 1 ‚Äî Hearthstone Road (positions 0, 1, 2)
  z1: [
    {
      id: 'veteran_tab',
      icon: 'üç∫',
      title: 'The Veteran\'s Tab',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'A one-armed soldier nurses the same drink at the inn\'s longest table. The innkeeper marks the wall each time she refills his cup. He hasn\'t looked at the tally once.'
    },
    {
      id: 'name_on_board',
      icon: 'üìå',
      title: 'The Name on the Board',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'A bounty notice ‚Äî fresh ink, no portrait, just a description. You passed someone matching it two days ago, moving fast. You think about whether they knew.'
    },
    {
      id: 'hooded_merchant',
      icon: 'ü™ô',
      title: 'The Hooded Merchant',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'A figure selling Sundering relics from a velvet case. One piece ‚Äî an iron coin stamped with a face that belongs to no known king ‚Äî makes something in your chest go quiet. The price is more than you have. He already knew that.'
    },
    {
      id: 'cartographer',
      icon: 'üó∫Ô∏è',
      title: 'The Cartographer',
      zone: 'Harvest Crossing',
      minPos: 1,
      desc: 'An old woman selling maps of roads that appear on no official chart. A hooded buyer takes one without haggling and vanishes. She watches the space where he was and says nothing.'
    },
    {
      id: 'griffon_rider',
      icon: 'ü¶Ö',
      title: 'The Griffon Rider',
      zone: 'Harvest Crossing',
      minPos: 1,
      desc: 'A rider camped under the oak, her griffon grounded with a torn wing. She\'s hunting a convoy that left two days ahead of her. When you say you haven\'t seen it: "Then it left the road," she says ‚Äî to herself, not you.'
    },
    {
      id: 'argument_oak',
      icon: '‚öñÔ∏è',
      title: 'The Argument at the Oak',
      zone: 'Harvest Crossing',
      minPos: 1,
      desc: 'Two merchant houses in a standoff under the branches. Both keep glancing at a hooded figure watching from the far side of the trunk. Neither will move until he does. He doesn\'t move.'
    },
    {
      id: 'the_queue',
      icon: 'ü™ô',
      title: 'The Queue',
      zone: 'Stonepath Mill',
      minPos: 2,
      desc: 'Six travelers at the toll bridge. The fifth man has been two silvers short for twenty minutes. Oswin waits with the stillness of someone who has outlasted every argument ever made to him.'
    },
    {
      id: 'night_rider',
      icon: 'üåô',
      title: 'The Night Rider',
      zone: 'Stonepath Mill',
      minPos: 2,
      desc: 'Before dawn a rider hammers on the mill door. Urgent voices, then silence, then hoofbeats fading fast. In the morning there\'s a fresh gouge in the doorframe ‚Äî the kind a blade makes. Oswin doesn\'t mention it.'
    },
    {
      id: 'stone_beneath',
      icon: 'üëë',
      title: 'The Stone Beneath the Millstone',
      zone: 'Stonepath Mill',
      minPos: 2,
      desc: 'Beneath the millstone: a royal seal carved deep, the name above it chiselled away. "Been there since before me," Oswin says. "I stopped wondering about it." His tone suggests the opposite.'
    }
  ],
  // Zone 2 ‚Äî Merchant's Pass (positions 3, 4, 5)
  z2: [
    {
      id: 'the_exchange',
      icon: 'üèõÔ∏è',
      title: 'The Exchange',
      zone: "Merchant's Gate",
      minPos: 3,
      desc: 'Through the briefly open door: a vast hall of clerks writing in silence under chandeliers that burn too bright for candlelight. The doors close. The man who exited has already vanished into the crowd.'
    },
    {
      id: 'aldenmoor',
      icon: 'üèöÔ∏è',
      title: 'The Ruin of House Aldenmoor',
      zone: "Merchant's Gate",
      minPos: 3,
      desc: 'An auction on the steps of what was once a grand merchant house. A woman across the street watches her writing desk get carried away by a stranger. She doesn\'t move for a long time.'
    },
    {
      id: 'aldric_sighting',
      icon: 'üëÅÔ∏è',
      title: 'A Familiar Face',
      zone: "Merchant's Gate",
      minPos: 3,
      desc: 'Aldric Vane ‚Äî the moneylender from Hearthstone ‚Äî bent over documents with a man in Exchange colours. A long way from his village. He doesn\'t look up, but somehow you feel accounted for.'
    },
    {
      id: 'toll_daughter',
      icon: 'üìí',
      title: 'The Toll Keeper\'s Daughter',
      zone: 'Copperbridge',
      minPos: 4,
      desc: 'The toll keeper\'s daughter is running the booth while he\'s sick, doing arithmetic faster than he ever did. She keeps a second ledger below the counter. When you catch her eye she holds your gaze. You decide not to ask.'
    },
    {
      id: 'dorvain',
      icon: 'üåä',
      title: 'The Man on the Parapet',
      zone: 'Copperbridge',
      minPos: 4,
      desc: '"That\'s Dorvain," the merchant beside you says ‚Äî the way people mention weather. He\'s on the bridge railing, staring at the river. He doesn\'t seem to notice the world moving around him.'
    },
    {
      id: 'plaque_coin',
      icon: 'ü™ô',
      title: 'The Coin on the Plaque',
      zone: 'Copperbridge',
      minPos: 4,
      desc: 'A gold coin on the treasurer\'s memorial ‚Äî it wasn\'t there this morning. Nobody is claiming it. Nobody is taking it. You leave it where it is.'
    },
    {
      id: 'cartographer_2',
      icon: 'üó∫Ô∏è',
      title: 'The Cartographer Again',
      zone: "Trader's Camp",
      minPos: 5,
      desc: 'The map seller from Harvest Crossing ‚Äî same satchel, new maps annotated in red. "I took one of my roads," she says when you ask how she got here. "The main Thornwood road has been busy lately with things that aren\'t travelers."'
    },
    {
      id: 'wending_rumour',
      icon: 'üî•',
      title: 'The Campfire Story',
      zone: "Trader's Camp",
      minPos: 5,
      desc: 'A trader describes something on the Thornwood roads that appears at the edge of firelight and waits ‚Äî gets closer, he says, the longer you stand still. Most are laughing. One man stares into his cup and says nothing.'
    },
    {
      id: 'dorvain_tent',
      icon: '‚õ∫',
      title: 'The Empty Tent',
      zone: "Trader's Camp",
      minPos: 5,
      desc: 'One tent at the camp\'s edge ‚Äî bedroll laid, fire cold. The traders nearby have moved their fires away. "Dorvain\'s," someone says when you ask. You\'ve heard that name before. You know where.'
    }
  ],
  // Zone 3 ‚Äî The Thornwood (positions 6, 7, 8)
  z3: [
    {
      id: 'the_cairns',
      icon: 'ü™®',
      title: 'The Cairns',
      zone: 'Thornwood Edge',
      minPos: 6,
      desc: 'More stone markers along the tree line than you expected. One has been knocked over deliberately ‚Äî the stones scattered in a pattern that doesn\'t look random. You can\'t say why you\'re sure of that, but you are.'
    },
    {
      id: 'ranger_warning',
      icon: 'üèπ',
      title: 'The Ranger\'s Warning',
      zone: 'Thornwood Edge',
      minPos: 6,
      desc: 'A ranger steps from the tree line without sound, scanning the canopy. "Don\'t stop for anything that sounds like someone you know." She\'s gone before you can ask what she means.'
    },
    {
      id: 'old_marker',
      icon: 'üóø',
      title: 'The Old Marker',
      zone: 'Thornwood Edge',
      minPos: 6,
      desc: 'A waystone older than the road, with a fresh translation scratched beneath the ancient text: HERE THE WENDING TURNED BACK ONCE. The word once is underlined. You keep moving.'
    },
    {
      id: 'abandoned_camp',
      icon: 'üéí',
      title: 'The Abandoned Camp',
      zone: 'Darkhollow Path',
      minPos: 7,
      desc: 'A cold camp off the path, pack left as if the owner stepped away for a moment. At the bottom: a map marked with a location in the Thornwood\'s centre that doesn\'t match any waypoint you know.'
    },
    {
      id: 'the_sound',
      icon: 'üëÇ',
      title: 'The Sound',
      zone: 'Darkhollow Path',
      minPos: 7,
      desc: 'You hear your name ‚Äî quiet, from off the path, deeper in. You stop walking before you\'ve decided to stop. You stand still longer than you should. Then you start moving again, faster.'
    },
    {
      id: 'griffon_camp',
      icon: 'ü¶Ö',
      title: 'The Griffon Rider\'s Camp',
      zone: 'Darkhollow Path',
      minPos: 7,
      desc: 'A camp, several days old. Griffon claw marks on the nearest tree. Guild cloth tied to a branch. The rider from Harvest Crossing was here ‚Äî she left in order, deliberately. You wonder if she found her convoy, or if it found her.'
    },
    {
      id: 'shrine_offering',
      icon: 'üå∏',
      title: 'The Offering',
      zone: 'Wayward Shrine',
      minPos: 8,
      desc: 'Fresh flowers at the shrine base ‚Äî someone was here within the hour, but there are no footprints. You leave something of your own. Walking away you feel lighter in a way you couldn\'t explain.'
    },
    {
      id: 'cartographer_map',
      icon: 'üìú',
      title: 'The Cartographer\'s Map',
      zone: 'Wayward Shrine',
      minPos: 8,
      desc: 'Her map, wedged in the shrine stone. In the margin: it has no shadow. if you see it, keep moving. Below that, in different ink: I got out. you can too.'
    },
    {
      id: 'the_wending',
      icon: 'üåë',
      title: 'The Wending',
      zone: 'Wayward Shrine',
      minPos: 8,
      desc: 'At the shrine\'s edge: something standing where the candlelight ends. Tall. Wrong. Then you understand ‚Äî there\'s no shadow beneath it. None at all. You\'ve stopped walking without deciding to. You start again immediately.'
    }
  ],
  // Zone 4 ‚Äî The Iron Keep (positions 9, 10)
  z4: [
    {
      id: 'seren',
      icon: 'üõ°Ô∏è',
      title: 'Seren',
      zone: 'Iron Keep Gates',
      minPos: 9,
      desc: '"You came through the Thornwood," the Gatekeeper says ‚Äî not a question. "They always walk differently after." As you pass: "Aldric Vane came through three days ago. First time in fifteen years."'
    },
    {
      id: 'veteran_gates',
      icon: 'üéñÔ∏è',
      title: 'An Old Face, Changed',
      zone: 'Iron Keep Gates',
      minPos: 9,
      desc: 'The one-armed soldier from Hearthstone\'s inn ‚Äî clean clothes, campaign medals, sober and purposeful. He sees you, nods once, says nothing, and walks into the Keep ahead of you. You never learned his name.'
    },
    {
      id: 'wanted_gates',
      icon: 'üìå',
      title: 'The Bounty, Doubled',
      zone: 'Iron Keep Gates',
      minPos: 9,
      desc: 'The same bounty from Hearthstone ‚Äî reward doubled, the Exchange seal added below. Two powerful interests, one person. Below both notices, in handwriting you recognise: already inside.'
    },
    {
      id: 'black_tower',
      icon: 'üóº',
      title: 'The Black Tower',
      zone: 'The Iron Keep',
      minPos: 10,
      desc: 'A child on the tower steps, watching the road you came in on. "Waiting to see if it followed you," she says. "It doesn\'t come inside the Keep. It never has." She looks at you. "You kept moving. I can tell."'
    },
    {
      id: 'aldric_keep',
      icon: 'üëÅÔ∏è',
      title: 'Aldric Vane',
      zone: 'The Iron Keep',
      minPos: 10,
      desc: 'You find him in the inner market, alone. When he sees you he looks relieved ‚Äî stranger than surprise. He says nothing about the Exchange or the documents. Just: "You made it through the Thornwood."'
    },
    {
      id: 'road_ahead',
      icon: 'üåÖ',
      title: 'The Road Ahead',
      zone: 'The Iron Keep',
      minPos: 10,
      desc: 'At the Keep\'s far gate: another road, longer and wider, leading somewhere your maps don\'t show. Seren is there. "Where does it go?" She looks at you the way she did when you arrived. "Somewhere worth the journey. If you keep moving."'
    }
  ]
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var state = {
  name: '',
  avatar: '',
  heroClass: '',
  xp: 0,
  streak: 0,
  lastLogDate: null,
  log: [],
  monthlyBudget: 0,
  coinReserve: 0,
  ironVault: 0,
  currentMonth: '',
  hearts: 3,
  mapPosition: 0,
  badges: [],
  weekLogDays: [],
  weekStart: '',
  roadBonusesThisMonth: 0,
  lastEncounterLog: '',
  pendingEncounter: null,
  seenStoryEncounters: [],
  seenArrivals: [],
  lastMapPosition: -1
};

// Temp onboarding picks
var obAvatar = '';
var obClass  = '';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SUPABASE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var SUPABASE_URL = 'https://czolsfnkwqtnkziakclg.supabase.co';
var SUPABASE_KEY = 'sb_publishable_zcYS8yzbinVjqmY1P_RM4w_BjOEExwq';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var currentUserId = null;
var isSigningOut = false;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SAVE / LOAD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function save() {
  // Always write to localStorage immediately for snappy UI
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  // Then sync to Supabase in background if logged in
  if (currentUserId) {
    sb.from('profiles')
      .upsert({ user_id: currentUserId, save_data: state, updated_at: new Date().toISOString() },
               { onConflict: 'user_id' })
      .then(function(res) {
        if (res.error) console.warn('Supabase save error:', res.error.message);
      });
  }
}

function load() {
  var raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  try {
    var parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || !parsed) return;
    if (!Array.isArray(parsed.log)) parsed.log = [];
    ['name','avatar','heroClass','xp','streak','lastLogDate','log','monthlyBudget','coinReserve','ironVault','currentMonth','hearts','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition'].forEach(function(k) {
      if (parsed[k] !== undefined) state[k] = parsed[k];
    });
  } catch(e) { console.warn('Load failed:', e); }
}

async function loadFromSupabase() {
  if (!currentUserId) return;
  try {
    var res = await sb.from('profiles').select('save_data').eq('user_id', currentUserId).single();
    if (res.error || !res.data || !res.data.save_data) return;
    var remote = res.data.save_data;
    if (typeof remote !== 'object') return;
    if (!Array.isArray(remote.log)) remote.log = [];
    ['name','avatar','heroClass','xp','streak','lastLogDate','log','monthlyBudget','coinReserve','ironVault','currentMonth','hearts','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition'].forEach(function(k) {
      if (remote[k] !== undefined) state[k] = remote[k];
    });
    // Sync remote state back to localStorage
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  } catch(e) { console.warn('Supabase load error:', e); }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  AUTH FUNCTIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendMagicLink() {
  var email = document.getElementById('login-email').value.trim();
  if (!email || !email.includes('@')) {
    showLoginError('Please enter a valid email address.');
    return;
  }
  var btn = document.querySelector('#login-form .ob-btn');
  btn.textContent = 'Sending‚Ä¶';
  btn.disabled = true;
  var res = await sb.auth.signInWithOtp({ email: email, options: { shouldCreateUser: true } });
  if (res.error) {
    showLoginError(res.error.message);
    btn.textContent = 'Send Magic Link ‚úâ';
    btn.disabled = false;
  } else {
    document.getElementById('sent-email').textContent = email;
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('login-sent').style.display = 'block';
  }
}

function showLoginError(msg) {
  var el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = 'block';
}

function resetLoginForm() {
  document.getElementById('login-form').style.display = 'block';
  document.getElementById('login-sent').style.display = 'none';
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('login-email').value = '';
  var btn = document.querySelector('#login-form .ob-btn');
  btn.textContent = 'Send Magic Link ‚úâ';
  btn.disabled = false;
}

async function signOut() {
  isSigningOut = true;
  try {
    await sb.auth.signOut();
  } catch(e) {
    console.warn('Sign out error:', e);
  }
  currentUserId = null;
  localStorage.removeItem(SAVE_KEY);
  Object.assign(state, {
    name:'',avatar:'',heroClass:'',xp:0,streak:0,lastLogDate:null,log:[],
    monthlyBudget:0,coinReserve:0,ironVault:0,currentMonth:'',hearts:3,
    mapPosition:0,badges:[],weekLogDays:[],weekStart:'',roadBonusesThisMonth:0,
    lastEncounterLog:'',pendingEncounter:null,seenStoryEncounters:[],
    seenArrivals:[],lastMapPosition:-1
  });
  document.getElementById('header-auth').style.display = 'none';
  document.getElementById('main').style.display = 'none';
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('login-screen').style.display = 'block';
  resetLoginForm();
  isSigningOut = false;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initApp() {
  // Listen for auth state changes (handles magic link redirect)
  sb.auth.onAuthStateChange(async function(event, session) {
    if (isSigningOut) return;
    if (session && session.user) {
      currentUserId = session.user.id;
      // Show email + sign out in header
      document.getElementById('header-email').textContent = session.user.email;
      document.getElementById('header-auth').style.display = 'block';
      document.getElementById('login-screen').style.display = 'none';

      // Load from Supabase first (authoritative), fall back to localStorage
      await loadFromSupabase();
      // If still nothing, try localStorage
      if (!state.name) load();

      // Patch any missing fields
      if (state.hearts === undefined) state.hearts = 3;
      if (!state.badges) state.badges = [];
      if (!state.weekLogDays) state.weekLogDays = [];
      if (state.roadBonusesThisMonth === undefined) state.roadBonusesThisMonth = 0;
      if (!state.lastEncounterLog) state.lastEncounterLog = '';
      if (!state.seenStoryEncounters) state.seenStoryEncounters = [];
      if (!state.seenArrivals) state.seenArrivals = [];
      if (state.lastMapPosition === undefined) state.lastMapPosition = -1;

      checkStreak();
      checkMonthReset();

      if (state.name) {
        document.getElementById('onboarding').style.display = 'none';
        document.getElementById('main').style.display = 'block';
        render();
      } else {
        document.getElementById('onboarding').style.display = 'block';
        document.getElementById('main').style.display = 'none';
      }
    } else {
      // No session ‚Äî show login
      currentUserId = null;
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('onboarding').style.display = 'none';
      document.getElementById('main').style.display = 'none';
      document.getElementById('header-auth').style.display = 'none';
    }
  });

  // Re-render map on resize
  window.addEventListener('resize', function() {
    if (state.name) renderMap();
  });
}

initApp();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LEVEL HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getLevelData(xp) {
  var level = 1;
  for (var i = LEVEL_XP.length - 1; i >= 0; i--) {
    if (xp >= LEVEL_XP[i]) { level = i + 1; break; }
  }
  level = Math.min(level, LEVEL_XP.length);

  var xpAtStart = LEVEL_XP[level - 1] || 0;
  var xpAtEnd   = LEVEL_XP[level] || (xpAtStart + 1000);
  var span      = xpAtEnd - xpAtStart;
  var progress  = xp - xpAtStart;
  var pct       = Math.min(100, Math.max(0, (progress / span) * 100));

  return { level: level, xpAtStart: xpAtStart, xpAtEnd: xpAtEnd, pct: pct, toNext: xpAtEnd - xp };
}

function getTitle(heroClass, level) {
  var titles = CLASS_TITLES[heroClass] || CLASS_TITLES['Knight'];
  var idx = Math.min(Math.floor((level - 1) / 2), titles.length - 1);
  return titles[idx];
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STREAK
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkStreak() {
  if (!state.lastLogDate) return;
  var today     = new Date().toDateString();
  var yesterday = new Date(Date.now() - 86400000).toDateString();
  if (state.lastLogDate !== today && state.lastLogDate !== yesterday) {
    state.streak = 0;
    save();
  }
}

function markLoggedToday() {
  var today     = new Date().toDateString();
  var yesterday = new Date(Date.now() - 86400000).toDateString();
  if (state.lastLogDate === today) return; // already counted today
  if (state.lastLogDate === yesterday) {
    state.streak = (state.streak || 0) + 1;
  } else {
    state.streak = 1;
  }
  state.lastLogDate = today;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAP & ENCOUNTER LOGIC
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getMapPosition() {
  var ld = getLevelData(state.xp);
  var lvl = Math.min(ld.level, LEVEL_TO_MAP.length - 1);
  return LEVEL_TO_MAP[lvl] || 0;
}

function getCurrentWaypoint() {
  var pos = getMapPosition();
  // Find the numeric waypoint with id === pos
  for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
    if (MAP_WAYPOINTS[i].id === pos) return MAP_WAYPOINTS[i];
  }
  return MAP_WAYPOINTS[0];
}

function getZoneForPos(pos) {
  for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
    if (MAP_WAYPOINTS[i].id === pos) return MAP_WAYPOINTS[i].zone;
  }
  return 1;
}

function checkWeekRoadBonus() {
  // Road bonus: earned if player logged >= 5 days this week AND stayed under budget pace
  var today = new Date().toDateString();
  if (!Array.isArray(state.weekLogDays)) state.weekLogDays = [];

  // Get start of current week (Sunday)
  var now = new Date();
  var dayOfWeek = now.getDay();
  var weekStart = new Date(now);
  weekStart.setDate(now.getDate() - dayOfWeek);
  weekStart.setHours(0,0,0,0);
  var weekStartStr = weekStart.toDateString();

  // Reset week tracking if new week
  if (state.weekStart !== weekStartStr) {
    // Evaluate last week before resetting
    if (state.weekStart && state.weekLogDays.length >= 5) {
      // Check budget pace ‚Äî were they under 25% of monthly budget this week?
      var weeklyBudgetPace = state.monthlyBudget * 0.25;
      var weekSpend = 0;
      var weekStartDate = new Date(state.weekStart);
      var weekEndDate = new Date(weekStartDate);
      weekEndDate.setDate(weekStartDate.getDate() + 7);
      if (Array.isArray(state.log)) {
        state.log.forEach(function(entry) {
          var ts = new Date(entry.ts);
          if (ts >= weekStartDate && ts < weekEndDate) weekSpend += parseFloat(entry.amount) || 0;
        });
      }
      if (weekSpend <= weeklyBudgetPace || state.weekLogDays.length >= 6) {
        // Earned road bonus
        state.xp += 50;
        state.roadBonusesThisMonth = (state.roadBonusesThisMonth || 0) + 1;
        save();
        showToast('üåü Road Bonus earned ‚Äî +50 XP for disciplined travel!');
      }
    }
    state.weekStart = weekStartStr;
    state.weekLogDays = [];
    save();
  }

  // Add today to week log days if not already there
  if (state.weekLogDays.indexOf(today) === -1) {
    state.weekLogDays.push(today);
    save();
  }
}

function getZoneKey(pos) {
  if (pos <= 2) return 'z1';
  if (pos <= 5) return 'z2';
  if (pos <= 8) return 'z3';
  return 'z4';
}

function checkArrival() {
  var pos = getMapPosition();
  if (pos === state.lastMapPosition) return;
  // New position ‚Äî find waypoint and show arrival text if not seen
  var wp = getCurrentWaypoint();
  if (wp && wp.arrival && state.seenArrivals.indexOf(pos) === -1) {
    state.seenArrivals.push(pos);
    state.lastMapPosition = pos;
    save();
    setTimeout(function() { showArrivalCard(wp); }, 600);
  } else {
    state.lastMapPosition = pos;
    save();
  }
}

function showArrivalCard(wp) {
  var box = document.getElementById('encounter-box');
  box.className = 'encounter-box arrival';
  document.getElementById('encounter-zone').textContent  = wp.zoneName || 'The Journey';
  document.getElementById('encounter-icon').textContent  = wp.icon || 'üó∫Ô∏è';
  document.getElementById('encounter-title').textContent = wp.name.replace('\n', ' ');
  document.getElementById('encounter-desc').textContent  = wp.arrival;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'encounter-btn story-choice';
  btn.innerHTML = 'Press on';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

function checkEncounter(amount) {
  // Don't fire two encounters on the same log entry
  var entryId = String(Date.now());
  if (state.lastEncounterLog === entryId) return;

  var monthlyBudget = state.monthlyBudget || 0;
  if (monthlyBudget === 0) return;

  var dayOfMonth = new Date().getDate();
  var daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
  var monthProgress = dayOfMonth / daysInMonth;
  var reservePct = (state.coinReserve || 0) / monthlyBudget;

  // ‚îÄ‚îÄ HOSTILE TRIGGERS ‚îÄ‚îÄ
  var hostileType = null;

  // Reserve below 50% ‚Äî spending velocity is too high
  if (reservePct < 0.50) {
    hostileType = 'velocity';
  }
  // Reserve critically low (<15%)
  if (reservePct < 0.15) {
    hostileType = 'depleted';
  }

  if (hostileType) {
    // Pick zone-appropriate hostile encounter
    var pos = getMapPosition();
    var hostile;
    if (pos >= 9) {
      hostile = HOSTILE_ENCOUNTERS[4];
    } else if (pos >= 6) {
      hostile = HOSTILE_ENCOUNTERS[2];
    } else if (hostileType === 'depleted') {
      hostile = HOSTILE_ENCOUNTERS[3]; // Silk Road Merchant ‚Äî scraping the barrel
    } else {
      hostile = HOSTILE_ENCOUNTERS[0]; // Bandits ‚Äî burning through reserves
    }
    // Always fire ‚Äî the pattern warrants it
    if (Math.random() < 0.70) {
      state.lastEncounterLog = entryId;
      save();
      setTimeout(function() { showEncounter(hostile, true); }, 1200);
      return;
    }
  }

  // ‚îÄ‚îÄ STORY ENCOUNTER (narrative only, ~30% chance) ‚îÄ‚îÄ
  if (Math.random() < 0.30) {
    var currentPos = getMapPosition();
    var zoneKey = getZoneKey(currentPos);
    var pool = STORY_ENCOUNTERS[zoneKey] || [];
    // Filter to encounters valid for current position AND not yet seen
    var eligible = pool.filter(function(e) {
      return e.minPos <= currentPos && state.seenStoryEncounters.indexOf(e.id) === -1;
    });
    // If all position-eligible ones seen, allow repeats from eligible-by-position pool only
    if (eligible.length === 0) {
      eligible = pool.filter(function(e) { return e.minPos <= currentPos; });
    }
    if (eligible.length > 0) {
      var story = eligible[Math.floor(Math.random() * eligible.length)];
      if (state.seenStoryEncounters.indexOf(story.id) === -1) {
        state.seenStoryEncounters.push(story.id);
      }
      state.lastEncounterLog = entryId;
      save();
      setTimeout(function() { showStoryEncounter(story); }, 1200);
      return;
    }
  }

  // ‚îÄ‚îÄ FRIENDLY ENCOUNTER (~20% chance when no hostile or story fired) ‚îÄ‚îÄ
  if (Math.random() < 0.20) {
    var friendly = FRIENDLY_ENCOUNTERS[Math.floor(Math.random() * FRIENDLY_ENCOUNTERS.length)];
    state.lastEncounterLog = entryId;
    save();
    setTimeout(function() { showEncounter(friendly, false); }, 1200);
  }
}

function showStoryEncounter(enc) {
  var box = document.getElementById('encounter-box');
  box.className = 'encounter-box story';
  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'encounter-btn story-choice';
  btn.innerHTML = 'Continue the journey';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

function showEncounter(enc, isHostile) {
  var box = document.getElementById('encounter-box');
  box.className = 'encounter-box ' + (isHostile ? 'hostile' : 'friendly');

  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;

  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';

  if (isHostile) {
    var currentVault  = state.ironVault || 0;
    var vaultPenalty  = Math.round(currentVault * enc.vaultCost);
    var vaultViable   = vaultPenalty >= 5;

    var btnA = document.createElement('button');
    btnA.className = 'encounter-btn hostile-choice';
    btnA.innerHTML = enc.choiceA.label + '<span class="encounter-btn-cost">' + enc.choiceA.sub + '</span>';
    btnA.onclick = function() { resolveHostile('heart', enc); };

    var btnB = document.createElement('button');
    if (vaultViable) {
      btnB.className = 'encounter-btn';
      btnB.innerHTML = enc.choiceB.label + '<span class="encounter-btn-cost">Lose ' + vaultPenalty + ' gold from Iron Vault</span>';
      btnB.onclick = function() { resolveHostile('vault', enc); };
    } else {
      btnB.className = 'encounter-btn encounter-btn-disabled';
      btnB.innerHTML = enc.choiceB.label + '<span class="encounter-btn-cost">Iron Vault is empty ‚Äî build your surplus to unlock this option</span>';
      btnB.disabled = true;
    }

    choices.appendChild(btnA);
    choices.appendChild(btnB);
  } else {
    var btn = document.createElement('button');
    btn.className = 'encounter-btn friendly-choice';
    btn.innerHTML = 'Continue the journey<span class="encounter-btn-cost">' + enc.rewardDesc + '</span>';
    btn.onclick = function() { resolveFriendly(enc); };
    choices.appendChild(btn);
  }

  document.getElementById('encounter-overlay').classList.add('show');
}

function resolveHostile(choice, enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  if (choice === 'heart') {
    state.hearts = Math.max(0, (state.hearts || 3) - 1);
    showToast('‚ù§Ô∏è Heart spent ‚Äî the threat is driven back.');
  } else {
    var currentVault = state.ironVault || 0;
    var penalty = Math.round(currentVault * enc.vaultCost);
    if (penalty < 5) {
      // Vault too empty ‚Äî shouldn't happen (button is disabled) but guard anyway
      state.hearts = Math.max(0, (state.hearts || 3) - 1);
      showToast('‚ù§Ô∏è Vault empty ‚Äî heart spent instead.');
    } else {
      state.ironVault = Math.max(0, currentVault - penalty);
      showToast('üí∞ ' + penalty + ' gold taken from Iron Vault.');
    }
  }
  save();
  render();
}

function resolveFriendly(enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  if (enc.reward.type === 'xp') {
    state.xp += enc.reward.amount;
    showToast('‚ú® +' + enc.reward.amount + ' bonus XP!');
  } else if (enc.reward.type === 'heart') {
    state.hearts = Math.min(3, (state.hearts || 0) + 1);
    showToast('‚ù§Ô∏è Heart restored!');
  } else if (enc.reward.type === 'vault') {
    state.ironVault = (state.ironVault || 0) + enc.reward.amount;
    showToast('üîí +' + enc.reward.amount + ' gold sealed in Iron Vault!');
  }
  save();
  render();
}

function checkZoneBadge() {
  var pos = getMapPosition();
  var badges = state.badges || [];

  if (pos >= 3 && badges.indexOf('zone1') === -1) {
    badges.push('zone1');
    state.badges = badges;
    save();
    setTimeout(function() {
      showZoneComplete('üõ°Ô∏è', 'The First Steps', 'You leave the Hearthstone Road behind. It looks smaller from here than it felt while you were on it.');
    }, 800);
  }
  if (pos >= 6 && badges.indexOf('zone2') === -1) {
    badges.push('zone2');
    state.badges = badges;
    save();
    setTimeout(function() {
      showZoneComplete('ü™ô', 'Disciplined Traveler', "The Merchant's Pass falls behind you. The road ahead grows quieter. That is not entirely reassuring.");
    }, 800);
  }
  if (pos >= 9 && badges.indexOf('zone3') === -1) {
    badges.push('zone3');
    state.badges = badges;
    save();
    setTimeout(function() {
      showZoneComplete('üåø', 'Thornwood Survivor', 'You leave the Thornwood behind. The light on the other side is warmer than you remembered light being. You do not stop moving until you are well clear of the tree line.');
    }, 800);
  }
  if (pos >= 10 && badges.indexOf('zone4') === -1) {
    badges.push('zone4');
    state.badges = badges;
    save();
    setTimeout(function() {
      showZoneComplete('üîí', 'Keeper of the Iron Vault', 'You have reached the Iron Keep. The road behind you is longer than it looked when you started. The road ahead is longer still. You do not mind.');
    }, 800);
  }
}

function showZoneComplete(icon, badgeName, narrative) {
  var box = document.getElementById('encounter-box');
  box.className = 'encounter-box zone-complete';
  document.getElementById('encounter-zone').textContent  = '‚ú¶ Zone Complete';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = 'Badge Earned: ' + badgeName;
  document.getElementById('encounter-desc').textContent  = narrative;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'encounter-btn story-choice';
  btn.innerHTML = 'March Forward ‚öî';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

function showBadgeToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, 4000);
}

function renderMap() {
  var pos = getMapPosition();
  var wp  = getCurrentWaypoint();

  // Update header text
  if (wp) {
    document.getElementById('map-location-name').textContent = wp.name.replace('\n',' ');
    var zoneNums = ['I','II','III','IV'];
    var zoneIdx  = typeof wp.zone === 'number' ? wp.zone - 1 : 0;
    document.getElementById('map-zone-tag').textContent =
      'Zone ' + (zoneNums[zoneIdx] || 'I') + ' ‚Äî ' + (wp.zoneName || '');
  }

  // ‚îÄ‚îÄ NODE LAYOUT ‚îÄ‚îÄ
  // Vertical map: all positions as % of total map height (which is taller than viewport)
  // X positions spread nodes horizontally; Y flows top‚Üíbottom
  // TOTAL MAP HEIGHT = 820px, VIEWPORT = 260px
  // Camera pans to keep current node ~35% from top of viewport
  var TOTAL_H = 820;
  var VIEWPORT_H = 260;

  var NODE_LAYOUT = [
    // Zone 1 ‚Äî Hearthstone Road
    { id:0,   pct:[50, 4]  },   // Hearthstone Village ‚Äî center
    { id:1,   pct:[22, 13] },   // Harvest Crossing ‚Äî left
    { id:2,   pct:[78, 13] },   // Stonepath Mill ‚Äî right
    { id:'z1',pct:[50, 22] },   // Zone 1 badge
    // Zone 2 ‚Äî Merchant's Pass
    { id:3,   pct:[20, 33] },   // Merchant's Gate ‚Äî left
    { id:4,   pct:[50, 33] },   // Copperbridge ‚Äî center
    { id:5,   pct:[80, 33] },   // Trader's Camp ‚Äî right
    { id:'z2',pct:[50, 43] },   // Zone 2 badge
    // Zone 3 ‚Äî Thornwood
    { id:6,   pct:[22, 55] },   // Thornwood Edge ‚Äî left
    { id:7,   pct:[78, 55] },   // Darkhollow Path ‚Äî right
    { id:8,   pct:[50, 63] },   // Wayward Shrine ‚Äî center
    { id:'z3',pct:[50, 72] },   // Zone 3 badge
    // Zone 4 ‚Äî Iron Keep
    { id:9,   pct:[50, 83] },   // Iron Keep Gates
    { id:10,  pct:[50, 92] },   // The Iron Keep
    { id:'z4',pct:[78, 83] },   // Zone 4 badge
  ];

  var CONNECTIONS = [
    [0,1],[0,2],
    [1,'z1'],[2,'z1'],
    ['z1',3],['z1',4],
    [3,4],[4,5],
    [4,'z2'],[5,'z2'],
    ['z2',6],['z2',7],
    [6,8],[7,8],
    [8,'z3'],
    ['z3',9],
    [9,10],[9,'z4'],
  ];

  var container  = document.getElementById('node-map');
  var viewport   = document.getElementById('map-viewport');
  var inner      = document.getElementById('node-map-inner');
  var svg        = document.getElementById('map-svg');
  var moreArrow  = document.getElementById('map-more-arrow');
  if (!container || !inner || !svg || !viewport) return;

  var W = viewport.offsetWidth || 400;
  var H = TOTAL_H;
  container.style.height = H + 'px';
  svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
  svg.style.height = H + 'px';

  // Build pixel position lookup
  var posMap = {};
  NODE_LAYOUT.forEach(function(n) {
    posMap[n.id] = {
      x: Math.round(W * n.pct[0] / 100),
      y: Math.round(H * n.pct[1] / 100)
    };
  });

  // ‚îÄ‚îÄ CAMERA PAN ‚îÄ‚îÄ
  // Find current node Y position, pan so it appears at ~30% from top of viewport
  var currentNodeY = 0;
  var currentLayout = NODE_LAYOUT.find ? NODE_LAYOUT.find(function(n){ return n.id === pos; }) : null;
  if (!currentLayout) {
    for (var ci = 0; ci < NODE_LAYOUT.length; ci++) {
      if (NODE_LAYOUT[ci].id === pos) { currentLayout = NODE_LAYOUT[ci]; break; }
    }
  }
  if (currentLayout) {
    currentNodeY = Math.round(H * currentLayout.pct[1] / 100);
  }
  // Target: current node appears at 30% from top of viewport
  var targetScrollTop = currentNodeY - Math.round(VIEWPORT_H * 0.30);
  targetScrollTop = Math.max(0, Math.min(H - VIEWPORT_H, targetScrollTop));
  container.style.transform = 'translateY(' + (-targetScrollTop) + 'px)';

  // Show/hide "more ahead" arrow ‚Äî show if there are nodes below viewport bottom
  var viewportBottom = targetScrollTop + VIEWPORT_H;
  var hasNodesBelow = false;
  NODE_LAYOUT.forEach(function(n) {
    if (typeof n.id === 'number' && n.id > pos) {
      var ny = Math.round(H * n.pct[1] / 100);
      if (ny > viewportBottom - 60) hasNodesBelow = true;
    }
  });
  if (moreArrow) moreArrow.className = 'map-more-arrow' + (hasNodesBelow ? '' : ' hidden');

  // ‚îÄ‚îÄ SVG CONNECTIONS ‚îÄ‚îÄ
  svg.innerHTML = '';

  function isReached(id) {
    if (typeof id === 'number') return id <= pos;
    var bm = {'z1':3,'z2':6,'z3':9,'z4':10};
    return pos >= (bm[id] || 999);
  }

  // Draw zone watermark text
  var zoneWatermarks = [
    { text:'HEARTHSTONE ROAD', y: 8  },
    { text:"MERCHANT'S PASS",  y: 30 },
    { text:'THORNWOOD',        y: 52 },
    { text:'IRON KEEP',        y: 79 },
  ];
  zoneWatermarks.forEach(function(zw) {
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', '4%');
    t.setAttribute('y', zw.y + '%');
    t.setAttribute('fill', '#221c0e');
    t.setAttribute('font-size', '8');
    t.setAttribute('font-family', 'Cinzel, serif');
    t.setAttribute('letter-spacing', '2');
    t.textContent = zw.text;
    svg.appendChild(t);
  });

  // Draw horizontal zone separator lines
  var zoneSepY = [26, 49, 77];
  zoneSepY.forEach(function(pct) {
    var line = document.createElementNS('http://www.w3.org/2000/svg','line');
    var y = Math.round(H * pct / 100);
    line.setAttribute('x1', '0'); line.setAttribute('y1', y);
    line.setAttribute('x2', W);   line.setAttribute('y2', y);
    line.setAttribute('stroke', '#201a0a');
    line.setAttribute('stroke-width', '1');
    line.setAttribute('stroke-dasharray', '3 6');
    svg.appendChild(line);
  });

  CONNECTIONS.forEach(function(conn) {
    var a = posMap[conn[0]], b = posMap[conn[1]];
    if (!a || !b) return;
    var line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', a.x); line.setAttribute('y1', a.y);
    line.setAttribute('x2', b.x); line.setAttribute('y2', b.y);
    var traveled = isReached(conn[0]) && isReached(conn[1]);
    line.setAttribute('stroke', traveled ? '#7a6530' : '#1e1808');
    line.setAttribute('stroke-width', traveled ? '2.5' : '1.5');
    if (!traveled) line.setAttribute('stroke-dasharray', '4 5');
    line.setAttribute('stroke-linecap', 'round');
    svg.appendChild(line);
  });

  // ‚îÄ‚îÄ NODE DOM ELEMENTS ‚îÄ‚îÄ
  inner.innerHTML = '';
  inner.style.height = H + 'px';

  NODE_LAYOUT.forEach(function(layout) {
    var wpData = null;
    for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
      if (MAP_WAYPOINTS[i].id === layout.id) { wpData = MAP_WAYPOINTS[i]; break; }
    }
    if (!wpData) return;

    var isBadge  = typeof layout.id === 'string';
    var isEarned = isBadge && (state.badges||[]).indexOf(wpData.badge) !== -1;
    var isDone   = !isBadge && layout.id < pos;
    var isCurrent= !isBadge && layout.id === pos;
    var isAhead  = isBadge ? !isEarned : layout.id > pos;

    var px = posMap[layout.id];

    var wrap = document.createElement('div');
    wrap.className = 'map-node-wrap' + (isCurrent ? ' current' : '');
    wrap.style.left = px.x + 'px';
    wrap.style.top  = px.y + 'px';

    var circle = document.createElement('div');
    var cc = 'map-node-circle';
    if (isBadge) cc += ' badge-node' + (isEarned ? ' earned' : ' ahead');
    else cc += isDone ? ' done' : isCurrent ? ' current' : ' ahead';
    circle.className = cc;
    circle.textContent = wpData.icon;

    var label = document.createElement('div');
    label.className = 'map-node-label';
    label.textContent = isBadge
      ? (isEarned ? '‚òÖ ' + wpData.zoneName.split(' ').pop() : '?')
      : wpData.name.replace('\n',' ');

    wrap.appendChild(circle);
    wrap.appendChild(label);
    inner.appendChild(wrap);
  });

  // ‚îÄ‚îÄ ROAD BONUS PIPS ‚îÄ‚îÄ
  var bonuses = Math.min(3, state.roadBonusesThisMonth || 0);
  for (var i = 1; i <= 3; i++) {
    var pip = document.getElementById('road-pip-' + i);
    if (pip) pip.className = 'road-pip' + (i <= bonuses ? ' earned' : '');
  }

  // ‚îÄ‚îÄ HEARTS ‚îÄ‚îÄ
  for (var h = 1; h <= 3; h++) {
    var heart = document.getElementById('heart-' + h);
    if (heart) {
      var filled = h <= (state.hearts !== undefined ? state.hearts : 3);
      heart.className = 'map-heart' + (filled ? '' : ' empty');
      heart.textContent = filled ? '‚ù§Ô∏è' : 'üñ§';
    }
  }

  // ‚îÄ‚îÄ BADGE SLOTS ‚îÄ‚îÄ
  ['zone1','zone2','zone3','zone4'].forEach(function(bid) {
    var slot = document.getElementById('badge-' + bid);
    if (!slot) return;
    slot.className = (state.badges||[]).indexOf(bid) !== -1 ? 'badge-slot earned' : 'badge-slot locked';
  });
}


// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCurrentMonth() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
}

function checkMonthReset() {
  var thisMonth = getCurrentMonth();
  if (!state.currentMonth) {
    // First time ‚Äî just set the month, no ceremony
    state.currentMonth = thisMonth;
    if (state.monthlyBudget > 0 && state.coinReserve === 0) {
      state.coinReserve = state.monthlyBudget;
    }
    save();
    return;
  }
  if (state.currentMonth !== thisMonth) {
    // New month! Calculate surplus
    var surplus = Math.max(0, state.coinReserve);
    var prevMonth = state.currentMonth;
    state.ironVault += surplus;
    state.coinReserve = state.monthlyBudget;
    state.currentMonth = thisMonth;
    save();
    // Show reset ceremony
    if (state.name) {
      showMonthReset(prevMonth, surplus);
    }
  }
}

function showMonthReset(prevMonth, surplus) {
  var parts = prevMonth.split('-');
  var monthName = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1)
    .toLocaleString('default', { month: 'long', year: 'numeric' });

  var bd = document.getElementById('reset-breakdown');
  var surplusLine = surplus > 0
    ? '<div class="reset-row highlight"><span>Sealed in Iron Vault</span><span>+' + surplus + ' gold</span></div>'
    : '<div class="reset-row"><span>Surplus</span><span>None ‚Äî fight harder.</span></div>';

  bd.innerHTML =
    '<div class="reset-row"><span>Campaign</span><span>' + monthName + '</span></div>' +
    '<div class="reset-row"><span>Monthly Budget</span><span>' + state.monthlyBudget + ' gold</span></div>' +
    surplusLine +
    '<div class="reset-row highlight"><span>New Reserve</span><span>' + state.monthlyBudget + ' gold</span></div>' +
    '<div class="reset-row"><span>Iron Vault Total</span><span>' + state.ironVault + ' gold</span></div>';

  var msg = surplus > 0
    ? 'You ended the campaign with ' + surplus + ' gold unspent. It has been sealed in the Iron Vault. Your treasury has been replenished for the new month.'
    : 'You spent every coin last month. A new treasury awaits. May this campaign bring more discipline ‚Äî and surplus for the Vault.';
  document.getElementById('reset-msg').textContent = msg;
  document.getElementById('reset-overlay').classList.add('show');
}

function closeReset() {
  document.getElementById('reset-overlay').classList.remove('show');
}

function renderCoins() {
  if (!state.monthlyBudget) {
    document.getElementById('coin-reserve-section').style.display = 'none';
    return;
  }
  document.getElementById('coin-reserve-section').style.display = 'block';

  var reserve = Math.max(0, state.coinReserve);
  var budget  = state.monthlyBudget;
  var pct     = Math.min(100, Math.max(0, (reserve / budget) * 100));

  document.getElementById('coin-current').textContent = reserve;
  document.getElementById('coin-max').textContent     = budget;

  var fill = document.getElementById('coin-fill');
  fill.style.width = pct + '%';
  fill.className = 'coin-bar-fill';

  var statusEl = document.getElementById('coin-status');
  statusEl.className = 'coin-status';

  if (pct <= 10) {
    fill.classList.add('danger');
    statusEl.classList.add('danger');
    statusEl.textContent = 'Reserves critically low ‚Äî the realm grows uneasy.';
  } else if (pct <= 30) {
    fill.classList.add('warning');
    statusEl.classList.add('warning');
    statusEl.textContent = 'Coins dwindling ‚Äî spend with care, hero.';
  } else if (pct >= 90) {
    statusEl.textContent = 'Treasury nearly full ‚Äî discipline holds strong.';
  } else {
    statusEl.textContent = Math.round(pct) + '% of monthly treasury remaining.';
  }

  var vaultEl = document.getElementById('vault-amount');
  if (state.ironVault > 0) {
    vaultEl.textContent = state.ironVault + ' gold';
    vaultEl.className = 'vault-amount';
  } else {
    vaultEl.textContent = 'Empty';
    vaultEl.className = 'vault-amount empty';
  }

}

function render() {
  var ld = getLevelData(state.xp);

  document.getElementById('char-avatar').textContent = state.avatar || 'üõ°Ô∏è';
  document.getElementById('char-name').textContent   = state.name   || '‚Äî';
  document.getElementById('char-class').textContent  = getTitle(state.heroClass, ld.level);
  document.getElementById('level-num').textContent   = ld.level;

  document.getElementById('xp-current').textContent  = state.xp;
  document.getElementById('xp-next-val').textContent = ld.xpAtEnd;
  document.getElementById('xp-fill').style.width     = ld.pct + '%';

  var nextTitle = getTitle(state.heroClass, ld.level + 1);
  document.getElementById('xp-next-msg').textContent =
    ld.level < LEVEL_XP.length
      ? ld.toNext + ' XP until Level ' + (ld.level + 1)
      : 'Maximum rank achieved';

  var today = new Date().toDateString();
  var loggedToday = state.lastLogDate === today;
  var streakCount = state.streak || 0;

  document.getElementById('streak-count').textContent = streakCount;

  var banner     = document.getElementById('streak-banner');
  var flameEl    = document.getElementById('streak-banner-flame');
  var countEl    = document.getElementById('streak-count');
  var rightEl    = document.getElementById('streak-banner-right');

  banner.className = 'streak-banner';
  flameEl.className = 'streak-banner-flame';
  countEl.className = 'streak-banner-count';
  rightEl.className = 'streak-banner-right';

  if (loggedToday) {
    banner.classList.add('alive');
    rightEl.classList.add('logged');
    rightEl.textContent = '‚úì Logged today';
    document.getElementById('streak-label').textContent =
      streakCount > 1 ? 'day streak ‚Äî burning bright' : 'day streak ‚Äî great start!';
  } else if (streakCount > 0) {
    banner.classList.add('danger');
    rightEl.classList.add('urgent');
    rightEl.textContent = '‚ö† Log today or lose it';
    document.getElementById('streak-label').textContent = 'day streak ‚Äî at risk';
  } else {
    flameEl.classList.add('cold');
    countEl.classList.add('cold');
    rightEl.textContent = 'Start your streak today';
    document.getElementById('streak-label').textContent = 'day streak ‚Äî begin yours';
  }

  renderLog();
  renderCoins();
  renderMap();
  checkZoneBadge();
  checkArrival();
}

function renderLog() {
  var list = document.getElementById('log-list');
  list.innerHTML = ''; // always clear and rebuild

  if (!state.log || state.log.length === 0) {
    var empty = document.createElement('div');
    empty.className = 'log-empty';
    empty.textContent = 'No entries yet. Log your first expense above.';
    list.appendChild(empty);
    return;
  }

  // Show most recent first, up to 20
  var items = state.log.slice().reverse().slice(0, 20);
  items.forEach(function(entry) {
    var el = document.createElement('div');
    el.className = 'log-item';
    var amt  = parseFloat(entry.amount).toFixed(2);
    var icon = entry.icon || 'üí∞';
    var meta = entry.ts ? formatDate(entry.ts) : '';
    el.innerHTML =
      '<div class="log-icon">' + icon + '</div>' +
      '<div>' +
        '<div class="log-desc">' + esc(entry.desc) + '</div>' +
        (meta ? '<div class="log-meta">' + meta + '</div>' : '') +
      '</div>' +
      '<div class="log-right">' +
        '<div class="log-amount">$' + amt + '</div>' +
        '<div class="log-xp">+' + entry.xpGained + ' XP</div>' +
      '</div>';
    list.appendChild(el);
  });
}

function formatDate(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ONBOARDING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var currentStep = 0;

function goStep(n) {
  if (n > currentStep) {
    if (currentStep === 0) {
      var name = document.getElementById('hero-name-input').value.trim();
      if (!name) { showToast('Name your hero first.'); return; }
    }
    if (currentStep === 1) {
      if (!obAvatar) { showToast('Choose your form first.'); return; }
    }
    if (currentStep === 2) {
      if (!obClass) { showToast('Choose your class first.'); return; }
    }
  }

  document.getElementById('step-' + currentStep).classList.remove('active');
  currentStep = n;
  document.getElementById('step-' + currentStep).classList.add('active');

  for (var i = 0; i <= 4; i++) {
    var dot = document.getElementById('dot-' + i);
    if (!dot) continue;
    dot.className = 'step-dot';
    if (i < currentStep)       dot.classList.add('done');
    else if (i === currentStep) dot.classList.add('active');
  }

  document.getElementById('onboarding').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function selectAvatar(el) {
  document.querySelectorAll('.avatar-opt').forEach(function(a) { a.classList.remove('selected'); });
  el.classList.add('selected');
  obAvatar = el.getAttribute('data-avatar');
}

function selectClass(el) {
  document.querySelectorAll('.class-opt').forEach(function(c) { c.classList.remove('selected'); });
  el.classList.add('selected');
  obClass = el.getAttribute('data-class');
}

function beginJourney() {
  var budget = parseFloat(document.getElementById('budget-input').value);
  if (!budget || budget <= 0) { showToast('Set your monthly budget first.'); return; }
  if (!obClass) { showToast('Choose your class first.'); return; }
  state.name          = document.getElementById('hero-name-input').value.trim();
  state.avatar        = obAvatar || 'üõ°Ô∏è';
  state.heroClass     = obClass;
  state.monthlyBudget = Math.round(budget);
  state.coinReserve   = Math.round(budget);
  state.ironVault     = 0;
  state.currentMonth  = getCurrentMonth();
  state.hearts        = 3;
  state.mapPosition   = 0;
  state.badges        = [];
  state.weekLogDays   = [];
  state.weekStart     = '';
  state.roadBonusesThisMonth = 0;
  save();
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  render();
}

document.getElementById('hero-name-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') goStep(1);
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LOG EXPENSE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function logExpense() {
  var descEl   = document.getElementById('desc-input');
  var amountEl = document.getElementById('amount-input');
  var desc     = descEl.value.trim();
  var amount   = parseFloat(amountEl.value);

  if (!desc)               { showToast('Describe your expense.'); return; }
  if (!amount || amount <= 0) { showToast('Enter a valid amount.'); return; }

  var prevLevel = getLevelData(state.xp).level;

  // XP calculation: flat base + streak bonus, NOT proportional to dollar amount
  var streakBonus = Math.min(5, Math.floor((state.streak || 0) / 5));
  var currentLevel = getLevelData(state.xp).level;
  var baseXp;
  if (currentLevel <= 3) {
  baseXp = 30;
  } else {
  baseXp = 15;
}
  var xpGained = baseXp + streakBonus;

  // Update streak BEFORE saving
  markLoggedToday();
  state.xp += xpGained;

  // Build entry object
  var entry = {
    id:       String(Date.now()) + String(Math.floor(Math.random() * 10000)),
    desc:     desc,
    amount:   amount,
    xpGained: xpGained,
    icon:     LOG_ICONS[Math.floor(Math.random() * LOG_ICONS.length)],
    ts:       new Date().toISOString()
  };

  // Push to log (guaranteed array)
  if (!Array.isArray(state.log)) state.log = [];
  state.log.push(entry);

  // Drain coin reserve
  if (state.monthlyBudget > 0) {
    state.coinReserve = Math.max(0, (state.coinReserve || 0) - amount);
    fireCoinFloat('-' + amount.toFixed(0) + ' gold');
  }

  // Road bonus week tracking
  checkWeekRoadBonus();

  // Encounter check
  checkEncounter(amount);

  // Save and render
  save();
  render();

  // Clear inputs
  descEl.value   = '';
  amountEl.value = '';
  descEl.focus();

  // === Feedback ===

  // 1. XP float above the bar
  fireXpFloat('+' + xpGained + ' XP');

  // 2. XP bar pulse
var fill = document.getElementById('xp-fill');
fill.classList.remove('pulse');
void fill.offsetWidth;
fill.classList.add('pulse');
setTimeout(function() { fill.classList.remove('pulse'); }, 800);

  // 3. Level up check
  var newLevel = getLevelData(state.xp).level;
  if (newLevel > prevLevel) {
    setTimeout(function() { showLevelUp(newLevel); }, 900);
  }
}

function fireXpFloat(text) {
  var floatEl = document.getElementById('xp-float');
  var track   = document.getElementById('xp-fill');
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth; // reflow to restart animation
  floatEl.classList.add('pop');
}

function fireCoinFloat(text) {
  var floatEl = document.getElementById('coin-float');
  var track   = document.getElementById('coin-fill');
  if (!track) return;
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY + rect.height) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}


// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LEVEL UP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLevelUp(level) {
  save();
  document.getElementById('lu-level').textContent = level;
  document.getElementById('lu-rank').textContent  = getTitle(state.heroClass, level);
  document.getElementById('lu-msg').textContent   = LEVEL_MSGS[Math.min(level - 2, LEVEL_MSGS.length - 1)];
  document.getElementById('levelup-overlay').classList.add('show');
  renderCoins();
}

function closeLevelUp() {
  document.getElementById('levelup-overlay').classList.remove('show');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TOAST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var toastTimer;
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, 2800);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KEYBOARD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Enter') return;
  var a = document.activeElement;
  if (a && (a.id === 'desc-input' || a.id === 'amount-input')) {
    logExpense();
  }
});

// keyboard shortcut handled above
</script>




<!-- Encounter Overlay -->
<div class="encounter-overlay" id="encounter-overlay">
  <div class="encounter-box" id="encounter-box">
    <div class="encounter-zone" id="encounter-zone">Encounter</div>
    <div class="encounter-icon" id="encounter-icon">‚öîÔ∏è</div>
    <div class="encounter-title" id="encounter-title">Bandits on the Road</div>
    <div class="encounter-desc" id="encounter-desc">A band of cutpurses blocks your path, demanding tribute for your recent spending.</div>
    <div class="encounter-choices" id="encounter-choices">
      <!-- filled dynamically -->
    </div>
  </div>
</div>


<!-- Encounter Overlay -->
<div class="encounter-overlay" id="encounter-overlay">
  <div class="encounter-box" id="encounter-box">
    <div class="encounter-zone" id="encounter-zone">Encounter</div>
    <div class="encounter-icon" id="encounter-icon">‚öîÔ∏è</div>
    <div class="encounter-title" id="encounter-title">Bandits on the Road</div>
    <div class="encounter-desc" id="encounter-desc">A band of cutpurses blocks your path.</div>
    <div class="encounter-choices" id="encounter-choices"></div>
  </div>
</div>

</body></html>