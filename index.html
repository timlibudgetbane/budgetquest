<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Quest</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg:           #0d0f18;
  --bg2:          #111420;
  --surface:      #161925;
  --surface2:     #1c2033;
  --surface3:     #222640;
  --border:       #2a2f4a;
  --border-mid:   #353b5e;
  --border-hi:    #454c78;

  --purple:       #7c5cfc;
  --purple-light: #a78bfa;
  --purple-dim:   #3d2e7e;
  --purple-glow:  rgba(124,92,252,0.25);

  --teal:         #22d3ee;
  --teal-dim:     #0e5a6b;
  --teal-glow:    rgba(34,211,238,0.2);

  --gold:         #f59e0b;
  --gold-light:   #fcd34d;
  --gold-dim:     #78480b;
  --gold-glow:    rgba(245,158,11,0.2);

  --green:        #22c55e;
  --green-dim:    #14532d;
  --red:          #ef4444;
  --red-dim:      #7f1d1d;
  --orange:       #f97316;

  --xp:           var(--purple);
  --xp-track:     var(--purple-dim);

  --text:         #e2e8f0;
  --text-mid:     #94a3b8;
  --text-dim:     #64748b;
  --text-dark:    #3f4a6b;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 15px;
  line-height: 1.5;
  min-height: 100vh;
  background-image:
    radial-gradient(ellipse 60% 40% at 15% 0%, rgba(124,92,252,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 50% 30% at 85% 100%, rgba(34,211,238,0.05) 0%, transparent 70%);
}

.app { max-width: 660px; margin: 0 auto; padding: 28px 16px 120px; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 0 24px;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--border);
}
.header-brand { display: flex; align-items: center; gap: 12px; }
.header-icon {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, var(--purple), #5b21b6);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  box-shadow: 0 0 20px var(--purple-glow);
}
.header h1 {
  font-family: 'Cinzel', serif;
  font-size: 22px;
  color: var(--text);
  letter-spacing: 0.03em;
}
.header-auth {
  display: flex; align-items: center; gap: 10px;
  font-size: 12px; color: var(--text-dim);
}
.header-auth-email { color: var(--text-mid); }
.signout-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 4px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 11px;
  font-family: inherit;
  transition: all 0.2s;
}
.signout-btn:hover { border-color: var(--border-mid); color: var(--text); }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  position: relative;
  overflow: hidden;
}
.card-accent-top {
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--purple), transparent);
}
.card-accent-teal {
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--teal), transparent);
}
.card-accent-gold {
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#login-screen { max-width: 420px; margin: 0 auto; }
.login-hero { text-align: center; margin-bottom: 28px; }
.login-hero-icon {
  width: 72px; height: 72px;
  background: linear-gradient(135deg, var(--purple), #3b1fd8);
  border-radius: 20px;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 36px;
  margin-bottom: 16px;
  box-shadow: 0 0 40px var(--purple-glow);
}
.login-title {
  font-family: 'Cinzel', serif;
  font-size: 24px;
  color: var(--text);
  margin-bottom: 6px;
}
.login-sub { color: var(--text-dim); font-size: 14px; }

.tab-row {
  display: flex;
  background: var(--surface2);
  border-radius: 12px;
  padding: 4px;
  margin-bottom: 20px;
  gap: 4px;
}
.tab-btn {
  flex: 1; padding: 8px; border-radius: 8px;
  border: none; cursor: pointer;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px; font-weight: 600;
  transition: all 0.2s;
}
.tab-btn.active {
  background: var(--purple);
  color: #fff;
  box-shadow: 0 2px 8px var(--purple-glow);
}
.tab-btn:not(.active) { background: transparent; color: var(--text-dim); }

.form-field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
.field-label { font-size: 12px; font-weight: 600; color: var(--text-mid); text-transform: uppercase; letter-spacing: 0.06em; }
.field-input {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 15px;
  padding: 11px 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  width: 100%;
}
.field-input:focus {
  border-color: var(--purple);
  box-shadow: 0 0 0 3px rgba(124,92,252,0.15);
}
.field-input::placeholder { color: var(--text-dark); }

.btn-primary {
  width: 100%;
  background: linear-gradient(135deg, var(--purple), #5b21b6);
  border: none;
  border-radius: 10px;
  color: #fff;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 14px; font-weight: 700;
  padding: 12px 24px;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.02em;
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px var(--purple-glow); }
.btn-primary:active { transform: translateY(0); }

.btn-secondary {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  color: var(--text-mid);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px; font-weight: 600;
  padding: 10px 20px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-secondary:hover { border-color: var(--border-mid); color: var(--text); }

.login-err { color: var(--red); font-size: 13px; text-align: center; margin-top: 8px; display: none; }

/* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ */
.ob-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 32px 28px;
  animation: fadeUp 0.4s ease both;
}

.steps-row {
  display: flex; align-items: center; justify-content: center;
  gap: 6px; margin-bottom: 28px;
}
.step-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--border-mid); transition: all 0.3s; flex-shrink: 0;
}
.step-dot.active { background: var(--purple); box-shadow: 0 0 8px var(--purple-glow); width: 24px; border-radius: 4px; }
.step-dot.done { background: var(--purple-dim); }
.step-line { width: 20px; height: 1px; background: var(--border); flex-shrink: 0; }

.ob-step { display: none; }
.ob-step.active { display: block; animation: fadeUp 0.3s ease both; }

.ob-icon { text-align: center; font-size: 48px; margin-bottom: 12px; }
.ob-title {
  font-family: 'Cinzel', serif;
  font-size: 20px; color: var(--text);
  text-align: center; margin-bottom: 8px;
}
.ob-sub {
  color: var(--text-mid); font-size: 14px;
  text-align: center; line-height: 1.6;
  margin-bottom: 24px; max-width: 420px;
  margin-left: auto; margin-right: auto;
}

/* Name input */
.name-row {
  display: flex; gap: 0;
  justify-content: center;
  max-width: 360px; margin: 0 auto;
}
.hero-name-input {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-right: none;
  border-radius: 10px 0 0 10px;
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 15px; padding: 11px 16px;
  outline: none; flex: 1;
  transition: border-color 0.2s;
}
.hero-name-input:focus { border-color: var(--purple); }
.hero-name-input::placeholder { color: var(--text-dark); }
.name-btn {
  background: var(--purple);
  border: none; border-radius: 0 10px 10px 0;
  color: #fff;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px; font-weight: 700;
  padding: 11px 20px;
  cursor: pointer; white-space: nowrap;
  transition: background 0.2s;
}
.name-btn:hover { background: var(--purple-light); color: var(--bg); }

/* Avatar picker */
.avatar-grid {
  display: flex; gap: 12px;
  justify-content: center; margin-bottom: 24px; flex-wrap: wrap;
}
.avatar-opt {
  width: 72px; height: 72px;
  border: 2px solid var(--border);
  border-radius: 16px;
  background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  font-size: 34px; cursor: pointer;
  transition: all 0.2s; position: relative; user-select: none;
}
.avatar-opt:hover { border-color: var(--purple); transform: translateY(-2px); }
.avatar-opt.selected {
  border-color: var(--purple);
  box-shadow: 0 0 0 3px var(--purple-glow), 0 0 20px var(--purple-glow);
  background: var(--surface3);
}
.avatar-opt.selected::after {
  content: '‚úì';
  position: absolute; bottom: 4px; right: 6px;
  font-size: 10px; font-weight: 800; color: var(--purple);
}

/* Class picker */
.class-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
.class-opt {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; gap: 14px; user-select: none;
}
.class-opt:hover { border-color: var(--border-mid); background: var(--surface3); }
.class-opt.selected {
  border-color: var(--purple);
  background: rgba(124,92,252,0.08);
  box-shadow: inset 3px 0 0 var(--purple);
}
.class-emoji { font-size: 26px; flex-shrink: 0; width: 36px; text-align: center; }
.class-info { flex: 1; }
.class-name { font-weight: 700; font-size: 14px; color: var(--text); margin-bottom: 2px; }
.class-desc { font-size: 12px; color: var(--text-mid); line-height: 1.5; }
.class-trait {
  font-size: 11px; color: var(--purple-light);
  text-transform: uppercase; letter-spacing: 0.06em;
  background: rgba(124,92,252,0.12);
  border: 1px solid rgba(124,92,252,0.25);
  padding: 2px 8px; border-radius: 20px;
  white-space: nowrap; flex-shrink: 0; font-weight: 600;
}

/* Budget input */
.budget-row {
  display: flex; max-width: 340px; margin: 0 auto;
}
.budget-prefix {
  background: var(--surface2);
  border: 1.5px solid var(--border); border-right: none;
  border-radius: 10px 0 0 10px;
  padding: 11px 14px;
  color: var(--gold); font-weight: 700; font-size: 16px;
  display: flex; align-items: center;
}
.budget-input {
  background: var(--surface2);
  border: 1.5px solid var(--border); border-left: none; border-right: none;
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 15px; padding: 11px 16px;
  outline: none; flex: 1;
  transition: border-color 0.2s;
}
.budget-input:focus { border-color: var(--purple); }
.budget-input::placeholder { color: var(--text-dark); }
.budget-btn {
  background: var(--purple);
  border: none; border-radius: 0 10px 10px 0;
  color: #fff;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px; font-weight: 700;
  padding: 11px 20px; cursor: pointer;
  white-space: nowrap; transition: background 0.2s;
}
.budget-btn:hover { background: var(--purple-light); color: var(--bg); }

/* Nav */
.ob-nav {
  display: flex; justify-content: center; gap: 10px; margin-top: 20px;
}

/* Laws grid */
.laws-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
.law-card {
  display: flex; align-items: flex-start; gap: 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 16px;
}
.law-icon { font-size: 20px; flex-shrink: 0; width: 28px; text-align: center; margin-top: 1px; }
.law-body { flex: 1; }
.law-title { font-weight: 700; font-size: 13px; color: var(--text); margin-bottom: 3px; }
.law-plain { font-size: 12px; color: var(--text-mid); line-height: 1.55; }

/* ‚îÄ‚îÄ CHARACTER CARD ‚îÄ‚îÄ */
.hero-block { margin-bottom: 16px; }
.character-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px 16px 0 0;
  padding: 20px;
  border-bottom: 1px solid var(--border);
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s ease both;
}
.char-top {
  display: flex; align-items: center; gap: 16px; margin-bottom: 18px;
}
.char-avatar {
  width: 56px; height: 56px;
  border: 2px solid var(--border-mid);
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 28px;
  background: var(--surface2); flex-shrink: 0;
}
.char-info { flex: 1; min-width: 0; }
.char-name {
  font-weight: 800; font-size: 18px; color: var(--text);
  margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.char-class { font-size: 13px; color: var(--purple-light); font-weight: 500; }
.char-level { text-align: right; flex-shrink: 0; }
.level-num {
  font-family: 'Cinzel', serif;
  font-size: 30px; color: var(--gold-light); line-height: 1;
}
.level-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }

/* XP Bar */
.bar-label-row {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-bottom: 6px;
}
.bar-label-title {
  font-size: 11px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.bar-label-count { font-size: 14px; color: var(--text-mid); }
.bar-label-count strong { color: var(--purple-light); font-weight: 700; }

.bar-track {
  height: 10px;
  background: var(--surface3);
  border-radius: 100px;
  overflow: hidden; position: relative;
}
.bar-fill {
  height: 100%;
  border-radius: 100px;
  transition: width 0.85s cubic-bezier(0.4, 0, 0.2, 1);
  min-width: 0;
}
.bar-fill.xp { background: linear-gradient(90deg, var(--purple-dim), var(--purple), var(--purple-light)); }
.bar-fill.coin { background: linear-gradient(90deg, var(--gold-dim), var(--gold)); }
.bar-fill.coin.danger { background: linear-gradient(90deg, #7f1d1d, var(--red)); }
.bar-fill.coin.warning { background: linear-gradient(90deg, #78350f, var(--orange)); }

.bar-subrow {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-top: 4px;
}
.bar-hint { font-size: 11px; color: var(--text-dim); }
.bar-next { font-size: 11px; color: var(--text-dim); text-align: right; }

/* Divider */
.card-divider {
  display: flex; align-items: center; gap: 10px;
  margin: 16px 0 14px;
}
.card-divider::before, .card-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}
.card-divider-label {
  font-size: 10px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.14em; white-space: nowrap;
}

/* Coin reserve */
.coin-reserve-section { margin-top: 14px; }
.coin-status { font-size: 11px; color: var(--text-dim); text-align: right; }
.coin-status.danger { color: var(--red); }
.coin-status.warning { color: var(--orange); }

/* Iron Vault row */
.iron-vault-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 12px; padding: 12px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  position: relative; overflow: hidden;
}
.iron-vault-row::before {
  content: ''; position: absolute;
  left: 0; top: 0; bottom: 0; width: 3px;
  background: linear-gradient(180deg, var(--gold), var(--gold-dim));
}
.vault-left { display: flex; align-items: center; gap: 10px; }
.vault-icon { font-size: 18px; }
.vault-title { font-size: 11px; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 2px; }
.vault-subtitle { font-size: 11px; color: var(--text-dim); }
.vault-amount { font-weight: 700; font-size: 16px; color: var(--gold-light); }
.vault-amount.empty { color: var(--text-dark); font-size: 13px; font-weight: 500; }

/* Coin float */
.coin-float {
  position: fixed; font-size: 13px; font-weight: 700;
  color: var(--gold); pointer-events: none; z-index: 9000; opacity: 0;
}
.coin-float.pop { animation: coinDrain 1.1s ease-out forwards; }
@keyframes coinDrain {
  0%   { opacity: 1; transform: translateX(-50%) translateY(0); }
  100% { opacity: 0; transform: translateX(-50%) translateY(22px); }
}

/* ‚îÄ‚îÄ STREAK BANNER ‚îÄ‚îÄ */
.streak-banner {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px; margin-bottom: 14px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: var(--surface);
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s 0.05s ease both;
  transition: border-color 0.3s, background 0.3s;
}
.streak-banner.alive {
  border-color: rgba(249,115,22,0.45);
  background: linear-gradient(90deg, rgba(249,115,22,0.06) 0%, var(--surface) 60%);
}
.streak-banner.danger {
  border-color: rgba(249,115,22,0.2);
}
.streak-banner-left { display: flex; align-items: center; gap: 12px; }
.streak-banner-flame {
  font-size: 24px; line-height: 1;
  filter: drop-shadow(0 0 6px rgba(249,115,22,0.5));
}
.streak-banner-flame.cold { filter: grayscale(0.8); opacity: 0.4; }
.streak-banner-text { display: flex; align-items: baseline; gap: 8px; }
.streak-banner-count {
  font-family: 'Cinzel', serif; font-size: 26px;
  color: var(--orange); line-height: 1;
}
.streak-banner-count.cold { color: var(--text-dark); }
.streak-banner-label { font-size: 13px; color: var(--text-mid); }
.streak-banner-right { font-size: 11px; font-weight: 700; color: var(--text-dim); text-align: right; text-transform: uppercase; letter-spacing: 0.06em; }
.streak-banner-right.logged { color: var(--green); }
.streak-banner-right.urgent { color: var(--orange); animation: urgentPulse 2s ease-in-out infinite; }
@keyframes urgentPulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

/* ‚îÄ‚îÄ MAP PANEL ‚îÄ‚îÄ */
.map-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 16px 16px;
  padding: 18px 20px 16px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s 0.05s ease both;
}

.map-top-bar {
  display: flex; align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 14px; gap: 12px;
}
.map-top-left { display: flex; flex-direction: column; gap: 2px; }
.map-section-label {
  font-size: 10px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.map-current-loc { font-weight: 700; font-size: 15px; color: var(--text); }
.map-zone-tag { font-size: 12px; color: var(--text-mid); }

.map-right-col { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
.map-hearts { display: flex; align-items: center; gap: 5px; }
.map-heart { font-size: 15px; transition: all 0.3s; filter: drop-shadow(0 0 3px rgba(239,68,68,0.4)); }
.map-heart.empty { filter: grayscale(1) opacity(0.2); }

.map-badges-row { display: flex; gap: 6px; }
.badge-slot {
  width: 28px; height: 28px; border-radius: 50%;
  border: 1.5px solid var(--border);
  background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; position: relative; cursor: default; transition: all 0.3s;
}
.badge-slot.earned { border-color: var(--gold); box-shadow: 0 0 10px var(--gold-glow); }
.badge-slot.locked { opacity: 0.2; }
.badge-slot .badge-tip {
  display: none; position: absolute;
  bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
  background: var(--surface3); border: 1px solid var(--border-mid);
  border-radius: 6px; padding: 4px 8px;
  font-size: 10px; color: var(--text-mid);
  white-space: nowrap; z-index: 100; pointer-events: none;
  font-weight: 600;
}
.badge-slot:hover .badge-tip { display: block; }

/* Map viewport */
.map-viewport {
  position: relative;
  height: 220px;
  overflow: hidden;
  border-radius: 10px;
  background: var(--bg2);
  border: 1px solid var(--border);
}
.node-map {
  position: relative; width: 100%;
  transition: transform 0.6s cubic-bezier(0.4,0,0.2,1);
}
.node-map svg { position: absolute; top: 0; left: 0; width: 100%; }
.node-map-inner { position: absolute; top: 0; left: 0; width: 100%; }

.map-node-wrap {
  position: absolute;
  transform: translate(-50%, -50%);
  display: flex; flex-direction: column; align-items: center; gap: 5px;
  cursor: default; z-index: 2;
}
.map-node-circle {
  width: 40px; height: 40px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; transition: all 0.3s;
  border: 2px solid var(--border);
  background: var(--surface2);
}
.map-node-circle.done {
  border-color: var(--purple-dim);
  background: rgba(124,92,252,0.15);
  opacity: 0.7;
}
.map-node-circle.current {
  border-color: var(--purple);
  background: rgba(124,92,252,0.2);
  box-shadow: 0 0 0 4px rgba(124,92,252,0.15), 0 0 20px var(--purple-glow);
  animation: currentPulse 2.5s ease-in-out infinite;
}
@keyframes currentPulse {
  0%,100% { box-shadow: 0 0 0 4px rgba(124,92,252,0.15), 0 0 20px var(--purple-glow); }
  50%     { box-shadow: 0 0 0 8px rgba(124,92,252,0.08), 0 0 30px var(--purple-glow); }
}
.map-node-circle.ahead { opacity: 0.3; }
.map-node-circle.badge-node {
  width: 34px; height: 34px; border-radius: 8px; font-size: 14px;
}
.map-node-circle.badge-node.earned {
  border-color: var(--gold);
  background: rgba(245,158,11,0.15);
  box-shadow: 0 0 12px var(--gold-glow);
}
.map-node-circle.badge-node.ahead { opacity: 0.2; }
.map-node-label {
  font-size: 10px; font-weight: 600; color: var(--text-dim);
  text-align: center; white-space: nowrap;
  background: rgba(13,15,24,0.85);
  padding: 2px 6px; border-radius: 4px;
}
.map-node-wrap.current .map-node-label { color: var(--purple-light); }

.map-more-arrow {
  position: absolute; bottom: 8px; right: 12px;
  font-size: 10px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.06em;
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  animation: bounceDown 2s ease-in-out infinite;
}
.map-more-arrow.hidden { display: none; }
@keyframes bounceDown { 0%,100%{transform:translateY(0)} 50%{transform:translateY(3px)} }

/* Road bonus */
.road-bonus-track {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 12px; padding-top: 12px;
  border-top: 1px solid var(--border);
}
.road-bonus-label { font-size: 11px; color: var(--text-dim); }
.road-bonus-pips { display: flex; gap: 5px; }
.road-pip {
  width: 18px; height: 8px; border-radius: 100px;
  background: var(--border); transition: all 0.3s;
}
.road-pip.earned { background: var(--teal); box-shadow: 0 0 6px var(--teal-glow); }

/* ‚îÄ‚îÄ LOG FORM ‚îÄ‚îÄ */
.log-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px; margin-bottom: 14px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s 0.08s ease both;
}

.section-head {
  font-size: 11px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 10px;
}
.section-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.log-form-grid {
  display: grid; grid-template-columns: 1fr 100px auto;
  gap: 10px; align-items: end;
}
@media (max-width: 500px) {
  .log-form-grid { grid-template-columns: 1fr 1fr; }
  .log-btn-wrap  { grid-column: 1 / -1; }
}
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.06em; }
.form-input {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 15px; padding: 10px 12px;
  outline: none; width: 100%;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.form-input:focus {
  border-color: var(--purple);
  box-shadow: 0 0 0 3px rgba(124,92,252,0.12);
}
.form-input::placeholder { color: var(--text-dark); }

.log-btn {
  background: linear-gradient(135deg, var(--purple), #5b21b6);
  border: none; border-radius: 10px;
  color: #fff;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px; font-weight: 700;
  padding: 10px 16px;
  cursor: pointer; white-space: nowrap; width: 100%;
  transition: all 0.2s; letter-spacing: 0.02em;
}
.log-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px var(--purple-glow); }
.log-btn:active { transform: translateY(0); }

.xp-hint { margin-top: 10px; font-size: 12px; color: var(--text-dim); text-align: center; }

/* ‚îÄ‚îÄ LOG LIST ‚îÄ‚îÄ */
.log-list-wrap { margin-bottom: 20px; animation: fadeUp 0.4s 0.14s ease both; }
.log-list {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px; overflow: hidden;
}
.log-empty { padding: 24px; text-align: center; color: var(--text-dim); font-size: 13px; }
.log-item {
  display: grid; grid-template-columns: 28px 1fr auto;
  gap: 10px; align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  animation: slideIn 0.25s ease both;
}
.log-item:last-child { border-bottom: none; }
.log-icon { font-size: 15px; text-align: center; }
.log-desc { font-size: 14px; font-weight: 500; color: var(--text); }
.log-meta { font-size: 11px; color: var(--text-dim); }
.log-right { text-align: right; }
.log-amount { font-weight: 700; font-size: 13px; color: var(--text); }
.log-xp { font-size: 11px; color: var(--purple-light); font-weight: 600; }

/* ‚îÄ‚îÄ XP FLOAT ‚îÄ‚îÄ */
.xp-float {
  position: fixed;
  font-size: 13px; font-weight: 800;
  color: var(--purple-light);
  pointer-events: none; z-index: 9000; opacity: 0;
}
.xp-float.pop { animation: xpFloat 1.2s ease-out forwards; }
@keyframes xpFloat {
  0%   { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
  20%  { opacity: 1; transform: translateX(-50%) translateY(-12px) scale(1.15); }
  100% { opacity: 0; transform: translateX(-50%) translateY(-40px) scale(0.9); }
}
.xp-bar-fill.pulse { animation: barPulse 0.7s ease; }
@keyframes barPulse {
  0%,100% { filter: brightness(1); }
  50%     { filter: brightness(1.5); }
}

/* ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(7,9,18,0.9);
  backdrop-filter: blur(4px);
  display: flex; align-items: center; justify-content: center;
  z-index: 9999;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s;
}
.overlay.show { opacity: 1; pointer-events: all; }

.overlay-box {
  background: var(--surface);
  border: 1px solid var(--border-mid);
  border-radius: 20px;
  padding: 36px 40px;
  text-align: center;
  max-width: 400px; width: 90%;
  position: relative; overflow: hidden;
  transform: scale(0.9) translateY(16px);
  transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.overlay.show .overlay-box { transform: scale(1) translateY(0); }

.overlay-box.hostile { border-color: rgba(239,68,68,0.4); }
.overlay-box.hostile::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }
.overlay-box.friendly { border-color: rgba(34,197,94,0.4); }
.overlay-box.friendly::before { background: linear-gradient(90deg, transparent, var(--green), transparent); }
.overlay-box.story { border-color: var(--border-mid); }
.overlay-box.zone-complete { border-color: rgba(245,158,11,0.4); }
.overlay-box.zone-complete::before { background: linear-gradient(90deg, transparent, var(--gold), transparent); }
.overlay-box.levelup { border-color: var(--purple); box-shadow: 0 0 40px var(--purple-glow); }
.overlay-box.levelup::before { background: linear-gradient(90deg, transparent, var(--purple), transparent); }
.overlay-box::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--border-mid), transparent);
}

.overlay-zone-label {
  font-size: 10px; font-weight: 700; letter-spacing: 0.2em;
  text-transform: uppercase; margin-bottom: 8px; color: var(--text-dim);
}
.overlay-box.hostile .overlay-zone-label { color: var(--red); }
.overlay-box.friendly .overlay-zone-label { color: var(--green); }
.overlay-box.zone-complete .overlay-zone-label { color: var(--gold); }

.overlay-icon { font-size: 44px; margin-bottom: 12px; line-height: 1; }
.overlay-title {
  font-size: 18px; font-weight: 800; color: var(--text);
  margin-bottom: 10px;
}
.overlay-desc {
  font-size: 14px; color: var(--text-mid);
  line-height: 1.65; margin-bottom: 20px;
}
.overlay-choices { display: flex; flex-direction: column; gap: 8px; }
.overlay-btn {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px; font-weight: 600;
  padding: 12px 18px;
  cursor: pointer; transition: all 0.2s; text-align: left; line-height: 1.5;
}
.overlay-btn:hover { border-color: var(--border-mid); background: var(--surface3); }
.overlay-btn.hostile-choice { border-color: rgba(239,68,68,0.3); }
.overlay-btn.hostile-choice:hover { border-color: var(--red); background: rgba(239,68,68,0.08); }
.overlay-btn.friendly-choice { border-color: rgba(34,197,94,0.3); }
.overlay-btn.friendly-choice:hover { border-color: var(--green); background: rgba(34,197,94,0.08); }
.overlay-btn.primary-choice {
  background: linear-gradient(135deg, var(--purple), #5b21b6);
  border-color: var(--purple); color: #fff;
}
.overlay-btn.primary-choice:hover { box-shadow: 0 4px 16px var(--purple-glow); }
.overlay-btn-cost {
  display: block; font-size: 11px; color: var(--text-dim); margin-top: 2px;
}
.overlay-btn-disabled {
  opacity: 0.3; cursor: not-allowed;
  border-color: var(--border) !important; background: transparent !important;
}
.overlay-btn-disabled:hover { background: transparent !important; border-color: var(--border) !important; }

/* Level-up specific */
.levelup-sparkles { font-size: 26px; letter-spacing: 8px; margin-bottom: 8px; }
.levelup-label { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 4px; }
.levelup-num {
  font-family: 'Cinzel', serif; font-size: 64px; color: var(--purple-light);
  line-height: 1; margin: 4px 0 10px;
  text-shadow: 0 0 40px var(--purple-glow);
}
.levelup-rank { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 12px; }
.levelup-msg { font-size: 14px; color: var(--text-mid); line-height: 1.65; margin-bottom: 22px; padding: 0 8px; }

/* Month reset */
.reset-icon { font-size: 40px; margin-bottom: 12px; }
.reset-label { font-size: 10px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 8px; }
.reset-title { font-family: 'Cinzel', serif; font-size: 22px; color: var(--gold-light); margin-bottom: 16px; }
.reset-breakdown {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 14px 16px; margin-bottom: 16px; text-align: left;
}
.reset-row { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-mid); padding: 4px 0; }
.reset-row.highlight { color: var(--gold); font-weight: 700; font-size: 13px; }
.reset-row.highlight span:last-child { color: var(--gold-light); }
.reset-msg { font-size: 13px; color: var(--text-dim); line-height: 1.65; margin-bottom: 20px; }

/* Toast */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(16px);
  background: var(--surface3);
  border: 1px solid var(--border-mid);
  color: var(--text);
  font-size: 13px; font-weight: 500;
  padding: 10px 20px;
  border-radius: 100px;
  opacity: 0; pointer-events: none;
  z-index: 8000; transition: all 0.3s; white-space: nowrap;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Teasers */
.teasers { margin-top: 28px; animation: fadeUp 0.5s 0.3s ease both; }
.teasers-head {
  font-size: 11px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
  margin-bottom: 12px;
  display: flex; align-items: center; gap: 10px;
}
.teasers-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.teaser-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; }
.teaser-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px; padding: 14px;
  opacity: 0.3; filter: saturate(0.2);
  position: relative; transition: opacity 0.2s, filter 0.2s;
}
.teaser-card:hover { opacity: 0.5; filter: saturate(0.4); }
.teaser-lock { position: absolute; top: 10px; right: 12px; font-size: 11px; color: var(--text-dim); }
.teaser-icon { font-size: 20px; margin-bottom: 6px; }
.teaser-name { font-size: 12px; font-weight: 700; color: var(--text-mid); margin-bottom: 3px; }
.teaser-hint { font-size: 11px; color: var(--text-dim); line-height: 1.4; }
.teaser-unlock { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 6px; font-weight: 600; }

/* Animations */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(-6px); }
  to   { opacity: 1; transform: translateX(0); }
}
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-brand">
      <div class="header-icon">‚öî</div>
      <h1>Budget Quest</h1>
    </div>
    <div id="header-auth" class="header-auth" style="display:none;">
      <span class="header-auth-email" id="header-email"></span>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ -->
  <div id="login-screen" style="display:none;">
    <div class="login-hero">
      <div class="login-hero-icon">‚öî</div>
      <div class="login-title">Welcome Back, Hero</div>
      <div class="login-sub">Track your spending. Level up. Build your treasury.</div>
    </div>
    <div class="card" style="max-width:420px;margin:0 auto;">
      <div class="card-accent-top"></div>

      <div class="tab-row">
        <button id="tab-password" class="tab-btn active" onclick="switchLoginTab('password')">Password</button>
        <button id="tab-magic" class="tab-btn" onclick="switchLoginTab('magic')">Magic Link</button>
      </div>

      <!-- Password login -->
      <div id="login-password-panel">
        <div id="login-form-password">
          <div class="form-field">
            <label class="field-label">Email</label>
            <input class="field-input" id="login-email-pw" type="email" placeholder="your@email.com" autocomplete="email">
          </div>
          <div class="form-field">
            <label class="field-label">Password</label>
            <input class="field-input" id="login-password" type="password" placeholder="Password" autocomplete="current-password">
          </div>
          <button class="btn-primary" onclick="signInWithPassword()">Enter the Realm ‚öî</button>
          <div id="login-error-pw" class="login-err"></div>
        </div>
      </div>

      <!-- Magic link login -->
      <div id="login-magic-panel" style="display:none;">
        <div id="login-form-magic">
          <div class="form-field">
            <label class="field-label">Email</label>
            <input class="field-input" id="login-email" type="email" placeholder="your@email.com" autocomplete="email">
          </div>
          <button class="btn-primary" onclick="sendMagicLink()">Send Magic Link ‚úâ</button>
          <div id="login-error" class="login-err"></div>
        </div>
        <div id="login-sent" style="display:none;text-align:center;">
          <div style="font-size:36px;margin-bottom:12px">‚úâÔ∏è</div>
          <div style="font-weight:700;color:var(--purple-light);font-size:16px;margin-bottom:8px;">Magic link sent!</div>
          <div style="color:var(--text-mid);font-size:14px;line-height:1.6;">Check your inbox at <strong id="sent-email" style="color:var(--text)"></strong> and click the link to begin your quest.</div>
          <button onclick="resetLoginForm()" style="margin-top:16px;background:none;border:none;color:var(--text-dim);font-size:12px;cursor:pointer;text-decoration:underline;font-family:inherit;">Use a different email</button>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ -->
  <div id="onboarding" style="display: none;">
    <div class="ob-card">

      <div class="steps-row">
        <div class="step-dot done" id="dot-0"></div>
        <div class="step-line"></div>
        <div class="step-dot active" id="dot-1"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-3"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-4"></div>
      </div>

      <!-- Step 1: Name -->
      <div class="ob-step active" id="step-0">
        <div class="ob-icon">‚öîÔ∏è</div>
        <div class="ob-title">Choose Your Name</div>
        <div class="ob-sub">Every expense you log earns XP. Every level moves you forward on the map. What should the chronicles call you?</div>
        <div class="name-row">
          <input class="hero-name-input" id="hero-name-input" type="text" placeholder="Your hero's name‚Ä¶" maxlength="24" autocomplete="off" value="Timli">
          <button class="name-btn" onclick="goStep(1)">Next ‚Üí</button>
        </div>
      </div>

      <!-- Step 2: Avatar -->
      <div class="ob-step" id="step-1">
        <div class="ob-title">Pick Your Avatar</div>
        <div class="ob-sub">How do you appear in the chronicles?</div>
        <div class="avatar-grid" id="avatar-grid">
          <div class="avatar-opt" data-avatar="üßô" onclick="selectAvatar(this)">üßô</div>
          <div class="avatar-opt" data-avatar="üßù‚Äç‚ôÄÔ∏è" onclick="selectAvatar(this)">üßù‚Äç‚ôÄÔ∏è</div>
          <div class="avatar-opt" data-avatar="üßî" onclick="selectAvatar(this)">üßî</div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep(0)">‚Üê Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep(2)">Pick Your Class ‚Üí</button>
        </div>
      </div>

      <!-- Step 3: Class -->
      <div class="ob-step" id="step-2">
        <div class="ob-title">Choose Your Class</div>
        <div class="ob-sub">Your class is your style ‚Äî all paths lead to the Iron Keep.</div>
        <div class="class-grid" id="class-grid">
          <div class="class-opt" data-class="Mage" onclick="selectClass(this)">
            <div class="class-emoji">üîÆ</div>
            <div class="class-info">
              <div class="class-name">Mage of the Archive</div>
              <div class="class-desc">Knowledge is power. No subscription or hidden fee escapes your eye.</div>
            </div>
            <div class="class-trait">Wisdom</div>
          </div>
          <div class="class-opt" data-class="Ranger" onclick="selectClass(this)">
            <div class="class-emoji">üèπ</div>
            <div class="class-info">
              <div class="class-name">Ranger of the Forest</div>
              <div class="class-desc">Disciplined and consistent. You log daily and never break your streak.</div>
            </div>
            <div class="class-trait">Discipline</div>
          </div>
          <div class="class-opt" data-class="Hunter" onclick="selectClass(this)">
            <div class="class-emoji">üê∫</div>
            <div class="class-info">
              <div class="class-name">Hunter of Surplus</div>
              <div class="class-desc">Every budget you crush is a trophy. Savings are your prey.</div>
            </div>
            <div class="class-trait">Willpower</div>
          </div>
          <div class="class-opt" data-class="Knight" onclick="selectClass(this)">
            <div class="class-emoji">üó°Ô∏è</div>
            <div class="class-info">
              <div class="class-name">Knight of the Keep</div>
              <div class="class-desc">Your budget is your fortress. Overspending shall not pass.</div>
            </div>
            <div class="class-trait">Discipline</div>
          </div>
          <div class="class-opt" data-class="Healer" onclick="selectClass(this)">
            <div class="class-emoji">‚ù§Ô∏è‚Äçü©π</div>
            <div class="class-info">
              <div class="class-name">Healer of Debts</div>
              <div class="class-desc">Patience and recovery are your superpowers. Every setback can be undone.</div>
            </div>
            <div class="class-trait">Wisdom</div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep(1)">‚Üê Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep(3)">The Rules ‚Üí</button>
        </div>
      </div>

      <!-- Step 4: How it works -->
      <div class="ob-step" id="step-3">
        <div class="ob-icon">üó∫Ô∏è</div>
        <div class="ob-title">How It Works</div>
        <div class="ob-sub">Five simple rules for the road ahead.</div>
        <div class="laws-grid">
          <div class="law-card">
            <div class="law-icon">‚öîÔ∏è</div>
            <div class="law-body">
              <div class="law-title">Log expenses ‚Üí earn XP</div>
              <div class="law-plain">Every purchase you record earns experience ‚Äî the amount doesn't matter, the habit does.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">üî•</div>
            <div class="law-body">
              <div class="law-title">Log daily ‚Üí build your streak</div>
              <div class="law-plain">Log at least once a day to grow your streak. Streaks boost XP. Miss a day and you start over.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">üîí</div>
            <div class="law-body">
              <div class="law-title">Stay under budget ‚Üí fill the Vault</div>
              <div class="law-plain">Any budget left unspent at month's end gets sealed in the Iron Vault ‚Äî your real-life savings trophy.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">üó∫Ô∏è</div>
            <div class="law-body">
              <div class="law-title">Level up ‚Üí advance the map</div>
              <div class="law-plain">Each level moves you along a 14-location journey. Earn Road Bonuses to travel faster.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">‚ù§Ô∏è</div>
            <div class="law-body">
              <div class="law-title">Hearts protect you on the road</div>
              <div class="law-plain">Random encounters test your resolve. Spend a heart to brush off a threat, or pay from your Vault. Shrines restore hearts.</div>
            </div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep(2)">‚Üê Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep(4)">Set Your Budget ‚Üí</button>
        </div>
      </div>

      <!-- Step 5: Monthly Budget -->
      <div class="ob-step" id="step-4">
        <div class="ob-icon">üè¶</div>
        <div class="ob-title">Set Your Monthly Budget</div>
        <div class="ob-sub">This becomes your Coin Reserve ‚Äî track your spending against it each month. Unspent gold goes to the Iron Vault.</div>
        <div class="budget-row">
          <span class="budget-prefix">$</span>
          <input class="budget-input" id="budget-input" type="number" min="1" step="1" placeholder="e.g. 2000" autocomplete="off">
          <button class="budget-btn" onclick="beginJourney()">Start Quest ‚öî</button>
        </div>
        <div style="text-align:center;margin-top:12px;font-size:12px;color:var(--text-dim);">You can update this anytime.</div>
        <div class="ob-nav" style="margin-top:16px;">
          <button class="btn-secondary" onclick="goStep(3)">‚Üê Back</button>
        </div>
      </div>

    </div>
  </div><!-- /onboarding -->

  <!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
  <div id="main" style="display: block;">

    <!-- HERO BLOCK -->
    <div class="hero-block">

      <!-- Character Card -->
      <div class="character-card">
        <div class="card-accent-top"></div>
        <div class="char-top">
          <div class="char-avatar" id="char-avatar">üßô</div>
          <div class="char-info">
            <div class="char-name" id="char-name">Hero</div>
            <div class="char-class" id="char-class">Novice</div>
          </div>
          <div class="char-level">
            <div class="level-num" id="level-num">1</div>
            <div class="level-label">Level</div>
          </div>
        </div>

        <!-- XP Bar -->
        <div class="bar-label-row">
          <span class="bar-label-title">‚ú¶ Experience</span>
          <span class="bar-label-count"><strong id="xp-current">0</strong> / <span id="xp-next-val">80</span> XP</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill xp" id="xp-fill" style="width:0%"></div>
        </div>
        <div class="bar-subrow">
          <span class="bar-hint">Earned by logging expenses</span>
          <span class="bar-next" id="xp-next-msg">80 XP to Level 2</span>
        </div>

        <!-- Treasury -->
        <div class="card-divider"><span class="card-divider-label">Treasury</span></div>

        <div class="coin-reserve-section" id="coin-reserve-section">
          <div class="bar-label-row">
            <span class="bar-label-title">‚öú Monthly Budget</span>
            <span class="bar-label-count" style="color:var(--gold-light)"><strong id="coin-current" style="color:var(--gold-light)">0</strong><span style="color:var(--text-dim);font-size:13px;"> / <span id="coin-max">0</span> gold</span></span>
          </div>
          <div class="bar-track" style="height:8px;">
            <div class="bar-fill coin" id="coin-fill" style="width:100%"></div>
          </div>
          <div class="bar-subrow">
            <span class="bar-hint">Depletes as you spend</span>
            <span class="coin-status" id="coin-status"></span>
          </div>

          <!-- Iron Vault -->
          <div class="iron-vault-row">
            <div class="vault-left">
              <div class="vault-icon">üîí</div>
              <div>
                <div class="vault-title">Iron Vault</div>
                <div class="vault-subtitle">Unspent budget sealed here at month's end</div>
              </div>
            </div>
            <div class="vault-amount" id="vault-amount">Empty</div>
          </div>
        </div>

      </div><!-- /character-card -->

      <!-- Map Panel -->
      <div class="map-panel" id="map-section">
        <div class="map-top-bar">
          <div class="map-top-left">
            <span class="map-section-label">‚öî The Journey</span>
            <span class="map-current-loc" id="map-location-name">Hearthstone Village</span>
            <span class="map-zone-tag" id="map-zone-tag">Zone I ‚Äî The Hearthstone Road</span>
          </div>
          <div class="map-right-col">
            <div class="map-hearts">
              <span class="map-heart" id="heart-1">‚ù§Ô∏è</span>
              <span class="map-heart" id="heart-2">‚ù§Ô∏è</span>
              <span class="map-heart" id="heart-3">‚ù§Ô∏è</span>
            </div>
            <div class="map-badges-row">
              <div class="badge-slot locked" id="badge-zone1"><span>üõ°Ô∏è</span><span class="badge-tip">The First Steps</span></div>
              <div class="badge-slot locked" id="badge-zone2"><span>ü™ô</span><span class="badge-tip">Disciplined Traveler</span></div>
              <div class="badge-slot locked" id="badge-zone3"><span>üåø</span><span class="badge-tip">Thornwood Survivor</span></div>
              <div class="badge-slot locked" id="badge-zone4"><span>üîí</span><span class="badge-tip">Keeper of the Iron Vault</span></div>
            </div>
          </div>
        </div>

        <!-- Node map rendered by JS -->
        <div class="map-viewport" id="map-viewport">
          <div class="node-map" id="node-map">
            <svg id="map-svg" xmlns="http://www.w3.org/2000/svg"></svg>
            <div class="node-map-inner" id="node-map-inner"></div>
          </div>
          <div class="map-more-arrow" id="map-more-arrow">
            <span>more ahead</span>
            <span>‚ñº</span>
          </div>
        </div>

        <!-- Road Bonus -->
        <div class="road-bonus-track">
          <span class="road-bonus-label" id="road-bonus-label">Road Bonus ‚Äî log every day this week to move faster</span>
          <div class="road-bonus-pips">
            <div class="road-pip" id="road-pip-1"></div>
            <div class="road-pip" id="road-pip-2"></div>
            <div class="road-pip" id="road-pip-3"></div>
          </div>
        </div>
      </div><!-- /map-panel -->

    </div><!-- /hero-block -->

    <!-- Streak Banner -->
    <div class="streak-banner" id="streak-banner">
      <div class="streak-banner-left">
        <span class="streak-banner-flame" id="streak-banner-flame">üî•</span>
        <div class="streak-banner-text">
          <span class="streak-banner-count" id="streak-count">0</span>
          <span class="streak-banner-label" id="streak-label">day streak ‚Äî begin yours</span>
        </div>
      </div>
      <div class="streak-banner-right" id="streak-banner-right">Start your streak today</div>
    </div>

    <!-- Log Form -->
    <div class="log-section">
      <div class="card-accent-teal"></div>
      <div class="section-head">Log an Expense</div>
      <div class="log-form-grid">
        <div class="form-group">
          <label class="form-label">What did you spend on?</label>
          <input class="form-input" id="desc-input" type="text" placeholder="e.g. Morning coffee" autocomplete="off">
        </div>
        <div class="form-group">
          <label class="form-label">Amount ($)</label>
          <input class="form-input" id="amount-input" type="number" min="0.01" step="0.01" placeholder="0.00">
        </div>
        <div class="log-btn-wrap">
          <label class="form-label" style="visibility:hidden">Log</label>
          <button class="log-btn" id="log-btn" onclick="logExpense()">‚öî Log It</button>
        </div>
      </div>
      <div class="xp-hint">Log ‚Üí earn XP ‚Üí level up ‚Üí advance the map ‚ú¶</div>
    </div>

    <!-- Expense Chronicle -->
    <div class="log-list-wrap">
      <div class="section-head">Expense Chronicle</div>
      <div class="log-list" id="log-list"></div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->

<!-- XP Float -->
<div class="xp-float" id="xp-float"></div>

<!-- Coin Float -->
<div class="coin-float" id="coin-float"></div>

<!-- Month Reset Overlay -->
<div class="overlay" id="reset-overlay">
  <div class="overlay-box" style="border-color:rgba(245,158,11,0.3);">
    <div class="overlay-box" style="all:unset;">
      <div class="reset-icon">üè¶</div>
      <div class="reset-label">New Campaign</div>
      <div class="reset-title">Monthly Reset</div>
      <div class="reset-breakdown" id="reset-breakdown"></div>
      <div class="reset-msg" id="reset-msg">Your treasury has been replenished. The Vault holds your surplus. Spend wisely, hero.</div>
      <button class="overlay-btn primary-choice" onclick="closeReset()" style="width:100%;text-align:center;">March Forward ‚öî</button>
    </div>
  </div>
</div>

<!-- Level Up Overlay -->
<div class="overlay" id="levelup-overlay">
  <div class="overlay-box levelup">
    <div class="levelup-sparkles">‚ú¶ ‚úß ‚ú¶</div>
    <div class="levelup-label">Level Up!</div>
    <div class="levelup-num" id="lu-level">2</div>
    <div class="levelup-rank" id="lu-rank">Apprentice</div>
    <div class="levelup-msg" id="lu-msg">Your discipline grows. The realm takes notice.</div>
    <button class="overlay-btn primary-choice" onclick="closeLevelUp()" style="width:100%;text-align:center;">Continue the Quest ‚ú¶</button>
  </div>
</div>

<!-- Encounter Overlay -->
<div class="overlay" id="encounter-overlay">
  <div class="overlay-box" id="encounter-box">
    <div class="overlay-zone-label" id="encounter-zone">Encounter</div>
    <div class="overlay-icon" id="encounter-icon">‚öîÔ∏è</div>
    <div class="overlay-title" id="encounter-title">Bandits on the Road</div>
    <div class="overlay-desc" id="encounter-desc">A band of cutpurses blocks your path.</div>
    <div class="overlay-choices" id="encounter-choices"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CONSTANTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var SAVE_KEY = 'bq_v2';

// Cumulative XP to reach each level (index = level - 1)
var LEVEL_XP = [0, 80, 200, 370, 600, 900, 1270, 1720, 2260, 3000, 4000];

var CLASS_TITLES = {
  Mage:   ['Novice Archivist','Apprentice Mage','Scroll Keeper','Lore Binder','Elder Mage'],
  Ranger: ['Novice Tracker','Trail Walker','Forest Keeper','Silent Warden','Ranger Lord'],
  Hunter: ['Novice Hunter','Coin Stalker','Surplus Seeker','Thrift Predator','Master Hunter'],
  Knight: ['Novice Guard','Shield Bearer','Budget Warden','Iron Keeper','Knight Commander'],
  Healer: ['Novice Mender','Debt Healer','Wound Closer','Recovery Sage','Grand Healer'],
};

var LEVEL_MSGS = [
  'The realm whispers your name with growing respect.',
  'Your consistency is starting to turn heads.',
  'Ancient powers take note. The disciplined are rare.',
  'Merchants speak of a tracker who cannot be broken.',
  'Guild halls echo with tales of your perseverance.',
  'You\'re building something real. Keep going.',
  'Your ledger has become a weapon. Your restraint, a shield.',
  'You\'ve come further than most heroes ever do.',
  'You approach true mastery. Few reach this far.',
  'The realm is yours to command. You are legend.',
];

var LOG_ICONS = ['üí∞','üõí','üçñ','üß™','‚öîÔ∏è','üìú','üêé','üè∞','üîÆ','üíé','üåø','üéí'];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAP DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var MAP_WAYPOINTS = [
  // Zone 1 ‚Äî The Hearthstone Road (levels 1-3)
  { id: 0,  icon: 'üèòÔ∏è', name: 'Hearthstone\nVillage',  zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'Your journey begins in Hearthstone Village. Log your first expense, earn XP, and hit the road. The Iron Keep awaits.' },
  { id: 1,  icon: 'üåæ', name: 'Harvest\nCrossing',      zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'Harvest Crossing ‚Äî farmers, traders, and three guilds arguing over the same oak tree. You keep moving.' },
  { id: 2,  icon: 'ü™®', name: 'Stonepath\nMill',        zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'Stonepath Mill. The miller takes exact coin only ‚Äî no credit, no exceptions. You respect that.' },
  { id: 'z1', icon: 'üõ°Ô∏è', name: 'Zone Badge',          zone: 'badge1', badge: 'zone1', zoneName: 'The Hearthstone Road',
    zoneComplete: 'You clear the Hearthstone Road. First zone down. It feels smaller looking back than it did walking through it.' },
  // Zone 2 ‚Äî The Merchant's Pass (levels 4-6)
  { id: 3,  icon: 'üè™', name: "Merchant's\nGate",       zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'The Merchant\'s Gate never sleeps. Stalls, deals, and haggling on every corner. Watch your coin purse.' },
  { id: 4,  icon: 'üåâ', name: 'Copperbridge',           zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'Copperbridge ‚Äî the copper plating was sold off years ago. Someone still leaves coins on the memorial plaque.' },
  { id: 5,  icon: '‚õ∫', name: "Trader's\nCamp",         zone: 2, zoneName: "The Merchant's Pass",
    arrival: 'A crossroads camp full of traders swapping stories. Good place to resupply and rest before the Thornwood.' },
  { id: 'z2', icon: 'ü™ô', name: 'Zone Badge',          zone: 'badge2', badge: 'zone2', zoneName: "The Merchant's Pass",
    zoneComplete: "The Merchant's Pass is behind you. You navigated the markets and kept your budget intact. Well played." },
  // Zone 3 ‚Äî The Thornwood (levels 7-9)
  { id: 6,  icon: 'üå≤', name: 'Thornwood\nEdge',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'The Thornwood. Dense, quiet, and known for testing travelers. Keep your streak alive and you\'ll be fine.' },
  { id: 7,  icon: 'üåë', name: 'Darkhollow\nPath',       zone: 3, zoneName: 'The Thornwood',
    arrival: 'Darkhollow Path winds deep into the forest. The road narrows. Your discipline is your compass here.' },
  { id: 8,  icon: 'üå∏', name: 'Wayward\nShrine',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'The Wayward Shrine ‚Äî travelers leave offerings and walk away feeling lighter. You leave one too.' },
  { id: 'z3', icon: 'üåø', name: 'Zone Badge',          zone: 'badge3', badge: 'zone3', zoneName: 'The Thornwood',
    zoneComplete: 'You emerge from the Thornwood. The light on the other side is warmer than you remembered light being.' },
  // Zone 4 ‚Äî The Iron Keep (levels 10+)
  { id: 9,  icon: 'üè∞', name: 'Iron Keep\nGates',       zone: 4, zoneName: 'The Iron Keep',
    arrival: 'The Iron Keep Gates. Gatekeepers who\'ve seen a thousand travelers ‚Äî and can always tell who made it through the Thornwood.' },
  { id: 10, icon: '‚öîÔ∏è', name: 'The Iron\nKeep',         zone: 4, zoneName: 'The Iron Keep',
    arrival: 'You\'ve reached the Iron Keep. Few heroes make it this far. From here, the road ahead is longer and wider than any map shows.' },
  { id: 'z4', icon: 'üîí', name: 'Zone Badge',          zone: 'badge4', badge: 'zone4', zoneName: 'The Iron Keep',
    zoneComplete: 'You\'ve reached the Iron Keep. Your budget discipline has carried you further than most ever go. This is just the beginning.' },
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HOSTILE ENCOUNTERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var HOSTILE_ENCOUNTERS = [
  {
    id: 'bandits',
    icon: 'üó°Ô∏è',
    title: 'Road Bandits',
    zone: 'Ambush',
    desc: 'A crew of bandits steps out of the shadows, eyeing your coin purse. "Toll for the road," the big one says. Your hearts or your Vault ‚Äî your call.',
    choiceA: { label: 'üõ°Ô∏è Block them with a Heart', sub: 'Spend 1 Heart to drive them off' },
    choiceB: { label: 'üí∞ Pay them off from your Vault', sub: 'Lose gold from Iron Vault' },
    vaultCost: 0.12
  },
  {
    id: 'tax',
    icon: 'üìú',
    title: 'Tax Collector',
    zone: 'Official Business',
    desc: 'A collector with a fresh ledger and an outstretched hand. "Irregular levy," he says cheerfully, "very legal." Very annoying.',
    choiceA: { label: 'üõ°Ô∏è Dispute the claim (Heart)', sub: 'Spend 1 Heart ‚Äî he backs down' },
    choiceB: { label: 'üí∞ Just pay and move on', sub: 'Lose gold from Iron Vault' },
    vaultCost: 0.10
  },
  {
    id: 'merchant',
    icon: 'ü™ô',
    title: 'Temptation Merchant',
    zone: 'Marketplace',
    desc: 'A silver-tongued merchant with a cart of "extraordinary bargains." Everything is priced just within reach. Your Vault shudders nervously.',
    choiceA: { label: 'üõ°Ô∏è Walk away (Heart)', sub: 'Spend 1 Heart ‚Äî willpower costs something' },
    choiceB: { label: 'üí∞ Buy something small', sub: 'Lose some Vault gold' },
    vaultCost: 0.08
  },
  {
    id: 'storm',
    icon: '‚õàÔ∏è',
    title: 'Unexpected Storm',
    zone: 'Bad Luck',
    desc: 'Rain, delays, a broken wagon wheel. The road costs you either rest or coin today. Part of the journey.',
    choiceA: { label: 'üõ°Ô∏è Push through (Heart)', sub: 'Spend 1 Heart ‚Äî you make it through tired' },
    choiceB: { label: 'üí∞ Pay for shelter and repairs', sub: 'Lose gold from Iron Vault' },
    vaultCost: 0.09
  },
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FRIENDLY ENCOUNTERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var FRIENDLY_ENCOUNTERS = [
  {
    id: 'shrine',
    icon: 'üå∏',
    title: 'Roadside Shrine',
    zone: 'Discovery',
    desc: 'A small shrine off the path, half-hidden by moss. You pause for a moment. The road feels lighter when you leave.',
    reward: { type: 'heart', amount: 1 },
    rewardDesc: '‚ù§Ô∏è Heart restored'
  },
  {
    id: 'journal',
    icon: 'üìñ',
    title: 'Scout\'s Journal',
    zone: 'Discovery',
    desc: 'Tucked under a milestone stone: a worn journal filled with smart routes and hard-won lessons. Someone left it here for you.',
    reward: { type: 'xp', amount: 55 },
    rewardDesc: '+55 bonus XP'
  },
  {
    id: 'camp',
    icon: 'üèïÔ∏è',
    title: 'Traveler\'s Cache',
    zone: 'Discovery',
    desc: 'A cold camp, recently left in good order. Provisions cached under a flat stone ‚Äî deliberately left for whoever came next. That\'s you.',
    reward: { type: 'vault', amount: 25 },
    rewardDesc: '+25 gold to Iron Vault'
  },
  {
    id: 'elder',
    icon: 'üßô',
    title: 'The Road Elder',
    zone: 'Friendly Encounter',
    desc: 'An old wanderer watches travelers pass. She looks at you for a long moment, nods slowly, like confirming something she already suspected. A blessing follows.',
    reward: { type: 'xp', amount: 30 },
    rewardDesc: '+30 bonus XP ‚Äî the elder\'s blessing'
  },
  {
    id: 'griffon',
    icon: 'ü¶Ö',
    title: 'Griffon Rider\'s Token',
    zone: 'Friendly Encounter',
    desc: 'Guild cloth tied to a roadside branch ‚Äî a waymarker left by someone who passed before you. The road is clear ahead.',
    reward: { type: 'xp', amount: 35 },
    rewardDesc: '+35 bonus XP ‚Äî the road is clear'
  }
];

// ‚îÄ‚îÄ STORY ENCOUNTERS (narrative flavor ‚Äî no mechanical effect) ‚îÄ‚îÄ
var STORY_ENCOUNTERS = {
  z1: [
    {
      id: 'veteran_tab',
      icon: 'üç∫',
      title: 'The Veteran\'s Tab',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'A one-armed soldier at the inn\'s longest table, nursing the same drink all evening. The innkeeper marks the wall each refill. He hasn\'t looked at the tally once.'
    },
    {
      id: 'name_on_board',
      icon: 'üìå',
      title: 'Wanted Notice',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'A fresh bounty notice ‚Äî no portrait, just a description. You passed someone matching it two days ago, moving fast.'
    },
    {
      id: 'cartographer',
      icon: 'üó∫Ô∏è',
      title: 'The Map Seller',
      zone: 'Harvest Crossing',
      minPos: 1,
      desc: 'An old woman selling maps of roads that appear on no official chart. A buyer takes one without haggling and vanishes.'
    },
    {
      id: 'griffon_rider',
      icon: 'ü¶Ö',
      title: 'Grounded Griffon Rider',
      zone: 'Harvest Crossing',
      minPos: 1,
      desc: 'A rider camped under the oak, griffon grounded with a torn wing. She\'s hunting a convoy two days ahead. When you say you haven\'t seen it: "Then it left the road," she says.'
    },
    {
      id: 'the_queue',
      icon: 'ü™ô',
      title: 'The Queue',
      zone: 'Stonepath Mill',
      minPos: 2,
      desc: 'Six travelers at the toll bridge. The fifth man has been two silvers short for twenty minutes. The tollkeeper waits with infinite patience.'
    },
  ],
  z2: [
    {
      id: 'the_exchange',
      icon: 'üèõÔ∏è',
      title: 'The Exchange',
      zone: "Merchant's Gate",
      minPos: 3,
      desc: 'Through a briefly open door: a vast hall of clerks writing in silence under chandeliers that burn too bright. The doors close. The man who exited has already vanished.'
    },
    {
      id: 'dorvain',
      icon: 'üåä',
      title: 'The Man on the Bridge',
      zone: 'Copperbridge',
      minPos: 4,
      desc: '"That\'s Dorvain," the merchant beside you says ‚Äî the way people mention weather. He\'s on the railing, staring at the river, not moving.'
    },
    {
      id: 'wending_rumour',
      icon: 'üî•',
      title: 'Campfire Story',
      zone: "Trader's Camp",
      minPos: 5,
      desc: 'A trader at camp describes something on the Thornwood roads that appears at the edge of firelight and waits. Most are laughing. One man stares into his cup and says nothing.'
    },
  ],
  z3: [
    {
      id: 'ranger_warning',
      icon: 'üèπ',
      title: 'The Ranger\'s Warning',
      zone: 'Thornwood Edge',
      minPos: 6,
      desc: 'A ranger steps from the trees silently. "Don\'t stop for anything that sounds like someone you know." She\'s gone before you can ask what she means.'
    },
    {
      id: 'the_sound',
      icon: 'üëÇ',
      title: 'A Sound from the Trees',
      zone: 'Darkhollow Path',
      minPos: 7,
      desc: 'You hear your name ‚Äî quiet, from off the path, deeper in. You stop walking before you\'ve decided to. Then you start moving again. Faster.'
    },
    {
      id: 'shrine_offering',
      icon: 'üå∏',
      title: 'The Fresh Offering',
      zone: 'Wayward Shrine',
      minPos: 8,
      desc: 'Fresh flowers at the shrine base ‚Äî someone was here within the hour, but there are no footprints. You leave something of your own.'
    },
  ],
  z4: [
    {
      id: 'seren',
      icon: 'üõ°Ô∏è',
      title: 'The Gatekeeper',
      zone: 'Iron Keep Gates',
      minPos: 9,
      desc: '"You came through the Thornwood," the Gatekeeper says ‚Äî not a question. "They always walk differently after."'
    },
    {
      id: 'road_ahead',
      icon: 'üåÖ',
      title: 'The Road Ahead',
      zone: 'The Iron Keep',
      minPos: 10,
      desc: 'At the Keep\'s far gate: another road, longer and wider, leading somewhere your maps don\'t show. "Where does it go?" The Gatekeeper smiles. "Somewhere worth the journey."'
    },
  ]
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var state = {
  name: '',
  avatar: '',
  heroClass: '',
  xp: 0,
  streak: 0,
  lastLogDate: null,
  log: [],
  monthlyBudget: 0,
  coinReserve: 0,
  ironVault: 0,
  currentMonth: '',
  hearts: 3,
  mapPosition: 0,
  badges: [],
  weekLogDays: [],
  weekStart: '',
  roadBonusesThisMonth: 0,
  lastEncounterLog: '',
  pendingEncounter: null,
  seenStoryEncounters: [],
  seenArrivals: [],
  lastMapPosition: -1,
  encounterLogCount: 0,
  lastEncounterAtLog: 0
};

// Temp onboarding picks
var obAvatar = '';
var obClass  = '';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SUPABASE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var SUPABASE_URL = 'https://czolsfnkwqtnkziakclg.supabase.co';
var SUPABASE_KEY = 'sb_publishable_zcYS8yzbinVjqmY1P_RM4w_BjOEExwq';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var currentUserId = null;
var isSigningOut = false;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SAVE / LOAD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function save() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  if (currentUserId) {
    sb.from('profiles')
      .upsert({ user_id: currentUserId, save_data: state, updated_at: new Date().toISOString() },
               { onConflict: 'user_id' })
      .then(function(res) {
        if (res.error) console.warn('Supabase save error:', res.error.message);
      });
  }
}

function load() {
  var raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  try {
    var parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || !parsed) return;
    if (!Array.isArray(parsed.log)) parsed.log = [];
    ['name','avatar','heroClass','xp','streak','lastLogDate','log','monthlyBudget','coinReserve','ironVault','currentMonth','hearts','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition','encounterLogCount','lastEncounterAtLog'].forEach(function(k) {
      if (parsed[k] !== undefined) state[k] = parsed[k];
    });
  } catch(e) { console.warn('Load failed:', e); }
}

async function loadFromSupabase() {
  if (!currentUserId) return;
  try {
    var res = await sb.from('profiles').select('save_data').eq('user_id', currentUserId).single();
    if (res.error || !res.data || !res.data.save_data) return;
    var remote = res.data.save_data;
    if (typeof remote !== 'object') return;
    if (!Array.isArray(remote.log)) remote.log = [];
    ['name','avatar','heroClass','xp','streak','lastLogDate','log','monthlyBudget','coinReserve','ironVault','currentMonth','hearts','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition','encounterLogCount','lastEncounterAtLog'].forEach(function(k) {
      if (remote[k] !== undefined) state[k] = remote[k];
    });
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  } catch(e) { console.warn('Supabase load error:', e); }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  AUTH FUNCTIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchLoginTab(tab) {
  var isPassword = tab === 'password';
  document.getElementById('login-password-panel').style.display = isPassword ? 'block' : 'none';
  document.getElementById('login-magic-panel').style.display   = isPassword ? 'none' : 'block';
  document.getElementById('tab-password').className = 'tab-btn' + (isPassword ? ' active' : '');
  document.getElementById('tab-magic').className    = 'tab-btn' + (!isPassword ? ' active' : '');
}

async function signInWithPassword() {
  var email    = document.getElementById('login-email-pw').value.trim();
  var password = document.getElementById('login-password').value;
  var errEl    = document.getElementById('login-error-pw');
  errEl.style.display = 'none';

  if (!email || !password) {
    errEl.textContent = 'Enter your email and password.';
    errEl.style.display = 'block';
    return;
  }
  var btn = document.querySelector('#login-form-password .btn-primary');
  btn.textContent = 'Entering‚Ä¶';
  btn.disabled = true;

  var res = await sb.auth.signInWithPassword({ email: email, password: password });
  if (res.error) {
    errEl.textContent = res.error.message === 'Invalid login credentials'
      ? 'Wrong email or password. Try again.'
      : res.error.message;
    errEl.style.display = 'block';
    btn.textContent = 'Enter the Realm ‚öî';
    btn.disabled = false;
  }
}

async function sendMagicLink() {
  var email = document.getElementById('login-email').value.trim();
  if (!email || !email.includes('@')) {
    showLoginError('Please enter a valid email address.');
    return;
  }
  var btn = document.querySelector('#login-form-magic .btn-primary');
  btn.textContent = 'Sending‚Ä¶';
  btn.disabled = true;
  var res = await sb.auth.signInWithOtp({ email: email, options: { shouldCreateUser: true } });
  if (res.error) {
    showLoginError(res.error.message);
    btn.textContent = 'Send Magic Link ‚úâ';
    btn.disabled = false;
  } else {
    document.getElementById('sent-email').textContent = email;
    document.getElementById('login-form-magic').style.display = 'none';
    document.getElementById('login-sent').style.display = 'block';
  }
}

function showLoginError(msg) {
  var el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = 'block';
}

function resetLoginForm() {
  document.getElementById('login-form-magic').style.display = 'block';
  document.getElementById('login-sent').style.display = 'none';
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('login-email').value = '';
  var btn = document.querySelector('#login-form-magic .btn-primary');
  btn.textContent = 'Send Magic Link ‚úâ';
  btn.disabled = false;
}

async function signOut() {
  isSigningOut = true;
  try { await sb.auth.signOut(); } catch(e) { console.warn('Sign out error:', e); }
  currentUserId = null;
  localStorage.removeItem(SAVE_KEY);
  Object.assign(state, {
    name:'',avatar:'',heroClass:'',xp:0,streak:0,lastLogDate:null,log:[],
    monthlyBudget:0,coinReserve:0,ironVault:0,currentMonth:'',hearts:3,
    mapPosition:0,badges:[],weekLogDays:[],weekStart:'',roadBonusesThisMonth:0,
    lastEncounterLog:'',pendingEncounter:null,seenStoryEncounters:[],
    seenArrivals:[],lastMapPosition:-1,
    encounterLogCount:0,lastEncounterAtLog:0
  });
  document.getElementById('header-auth').style.display = 'none';
  document.getElementById('main').style.display = 'none';
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('login-screen').style.display = 'block';
  resetLoginForm();
  isSigningOut = false;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initApp() {
  sb.auth.onAuthStateChange(async function(event, session) {
    if (isSigningOut) return;
    if (session && session.user) {
      currentUserId = session.user.id;
      document.getElementById('header-email').textContent = session.user.email;
      document.getElementById('header-auth').style.display = 'flex';
      document.getElementById('login-screen').style.display = 'none';

      await loadFromSupabase();
      if (!state.name) load();

      if (state.hearts === undefined) state.hearts = 3;
      if (!state.badges) state.badges = [];
      if (!state.weekLogDays) state.weekLogDays = [];
      if (state.roadBonusesThisMonth === undefined) state.roadBonusesThisMonth = 0;
      if (!state.lastEncounterLog) state.lastEncounterLog = '';
      if (!state.seenStoryEncounters) state.seenStoryEncounters = [];
      if (!state.seenArrivals) state.seenArrivals = [];
      if (state.lastMapPosition === undefined) state.lastMapPosition = -1;

      checkStreak();
      checkMonthReset();

      if (state.name) {
        document.getElementById('onboarding').style.display = 'none';
        document.getElementById('main').style.display = 'block';
        render();
      } else {
        document.getElementById('onboarding').style.display = 'block';
        document.getElementById('main').style.display = 'none';
      }
    } else {
      currentUserId = null;
      document.getElementById('header-auth').style.display = 'none';
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('main').style.display = 'none';
      document.getElementById('onboarding').style.display = 'none';
    }
  });
}

initApp();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STREAK / DATE HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getToday() { return new Date().toDateString(); }
function getYesterday() {
  var d = new Date(); d.setDate(d.getDate() - 1); return d.toDateString();
}

function checkStreak() {
  var today = getToday();
  var yesterday = getYesterday();
  var last = state.lastLogDate;
  if (!last) return;
  if (last === today) return; // fine
  if (last === yesterday) return; // fine ‚Äî streak intact until end of today
  // More than 1 day gap ‚Äî streak broken
  if (last !== yesterday && last !== today) {
    state.streak = 0;
    save();
  }
}

function markLoggedToday() {
  var today = getToday();
  if (state.lastLogDate === today) return; // already logged today
  var yesterday = getYesterday();
  if (state.lastLogDate === yesterday || state.streak === 0) {
    state.streak = (state.streak || 0) + 1;
  } else if (!state.lastLogDate) {
    state.streak = 1;
  }
  state.lastLogDate = today;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  XP / LEVEL HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getLevelData(xp) {
  var level = 1;
  for (var i = LEVEL_XP.length - 1; i >= 0; i--) {
    if (xp >= LEVEL_XP[i]) { level = i + 1; break; }
  }
  level = Math.min(level, LEVEL_XP.length);
  var xpAtStart = LEVEL_XP[level - 1] || 0;
  var xpAtEnd   = level < LEVEL_XP.length ? LEVEL_XP[level] : LEVEL_XP[LEVEL_XP.length - 1];
  var inLevel   = xp - xpAtStart;
  var needed    = xpAtEnd - xpAtStart;
  var pct       = needed > 0 ? Math.min(100, (inLevel / needed) * 100) : 100;
  var toNext    = Math.max(0, xpAtEnd - xp);
  return { level: level, xpAtEnd: xpAtEnd, pct: pct, toNext: toNext };
}

function getTitle(heroClass, level) {
  var titles = CLASS_TITLES[heroClass] || CLASS_TITLES['Knight'];
  var idx = Math.min(Math.floor((level - 1) / 2), titles.length - 1);
  return titles[idx];
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAP HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getMapPosition() { return state.mapPosition || 0; }

function getCurrentWaypoint() {
  var pos = getMapPosition();
  for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
    if (MAP_WAYPOINTS[i].id === pos) return MAP_WAYPOINTS[i];
  }
  return MAP_WAYPOINTS[0];
}

function advanceMap() {
  var pos = getMapPosition();
  // numeric positions: 0-10
  var maxNumeric = 10;
  if (typeof pos === 'number' && pos < maxNumeric) {
    state.mapPosition = pos + 1;
    state.lastMapPosition = pos;
    save();
    return true;
  }
  return false;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  WEEK ROAD BONUS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWeekStart() {
  var d = new Date();
  var day = d.getDay(); // 0=Sun
  d.setDate(d.getDate() - day);
  return d.toDateString();
}

function checkWeekRoadBonus() {
  var ws = getWeekStart();
  if (state.weekStart !== ws) {
    state.weekStart   = ws;
    state.weekLogDays = [];
  }
  var today = getToday();
  if (state.weekLogDays.indexOf(today) === -1) {
    state.weekLogDays.push(today);
  }
  // 5+ unique days this week ‚Üí road bonus (up to 3 per month)
  if (state.weekLogDays.length >= 5 && (state.roadBonusesThisMonth || 0) < 3) {
    state.roadBonusesThisMonth = (state.roadBonusesThisMonth || 0) + 1;
    state.weekLogDays = []; // reset so they can earn next week
    showToast('üó∫Ô∏è Road Bonus earned! Advancing the map...');
    setTimeout(function() {
      if (advanceMap()) { render(); checkZoneBadge(); checkArrival(); }
    }, 1400);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ARRIVAL POPUPS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkArrival() {
  var pos = getMapPosition();
  if (pos === state.lastMapPosition) return;
  var wp = getCurrentWaypoint();
  if (!wp) return;
  if (!Array.isArray(state.seenArrivals)) state.seenArrivals = [];
  var aid = 'arr_' + wp.id;
  if (state.seenArrivals.indexOf(aid) !== -1) return;
  state.seenArrivals.push(aid);
  save();

  if (wp.zoneComplete) {
    // already handled by checkZoneBadge
    return;
  }
  if (wp.arrival) {
    setTimeout(function() {
      showStoryEncounter('üó∫Ô∏è', wp.name.replace('\n',' '), wp.arrival, 'story');
    }, 600);
  }
}

function showStoryEncounter(icon, title, desc, type) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box story';
  document.getElementById('encounter-zone').textContent  = 'üìç New Location';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = title;
  document.getElementById('encounter-desc').textContent  = desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'Onward ‚öî';
  btn.onclick = function() { document.getElementById('encounter-overlay').classList.remove('show'); };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RANDOM ENCOUNTERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkEncounter(amount) {
  // Cooldown: skip if last encounter was within the last 2 logs
  if (!state.encounterLogCount) state.encounterLogCount = 0;
  state.encounterLogCount++;
  var lastAt = state.lastEncounterAtLog || 0;
  if (state.encounterLogCount - lastAt < 2) return; // minimum 2 logs between encounters

  // 45% chance per eligible expense
  if (Math.random() > 0.45) return;

  // Mark that an encounter fired at this log count
  state.lastEncounterAtLog = state.encounterLogCount;
  save();

  // Check for unseen story encounters first (priority)
  var pos = getMapPosition();
  var zone = pos <= 2 ? 'z1' : pos <= 5 ? 'z2' : pos <= 8 ? 'z3' : 'z4';
  var storyPool = STORY_ENCOUNTERS[zone] || [];
  var available = storyPool.filter(function(e) {
    return e.minPos <= pos && (state.seenStoryEncounters || []).indexOf(e.id) === -1;
  });

  // 60% chance to show a story encounter if one is available
  if (available.length > 0 && Math.random() < 0.6) {
    var enc = available[Math.floor(Math.random() * available.length)];
    if (!state.seenStoryEncounters) state.seenStoryEncounters = [];
    state.seenStoryEncounters.push(enc.id);
    save();
    setTimeout(function() { showStoryEncounterFull(enc); }, 900);
    return;
  }

  // Otherwise hostile (40%) or friendly (60%)
  if (Math.random() < 0.40) {
    var hostile = HOSTILE_ENCOUNTERS[Math.floor(Math.random() * HOSTILE_ENCOUNTERS.length)];
    setTimeout(function() { showEncounter(hostile, true); }, 900);
  } else {
    var friendly = FRIENDLY_ENCOUNTERS[Math.floor(Math.random() * FRIENDLY_ENCOUNTERS.length)];
    setTimeout(function() { showEncounter(friendly, false); }, 900);
  }
}

function showStoryEncounterFull(enc) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box story';
  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'Keep Moving ‚öî';
  btn.onclick = function() { document.getElementById('encounter-overlay').classList.remove('show'); };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

function showEncounter(enc, isHostile) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box ' + (isHostile ? 'hostile' : 'friendly');

  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;

  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';

  if (isHostile) {
    var currentVault = state.ironVault || 0;
    var vaultPenalty = Math.round(currentVault * enc.vaultCost);
    var vaultViable  = vaultPenalty >= 5;

    var btnA = document.createElement('button');
    btnA.className = 'overlay-btn hostile-choice';
    btnA.innerHTML = enc.choiceA.label + '<span class="overlay-btn-cost">' + enc.choiceA.sub + '</span>';
    btnA.onclick = function() { resolveHostile('heart', enc); };

    var btnB = document.createElement('button');
    if (vaultViable) {
      btnB.className = 'overlay-btn';
      btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">Lose ' + vaultPenalty + ' gold from Iron Vault</span>';
      btnB.onclick = function() { resolveHostile('vault', enc); };
    } else {
      btnB.className = 'overlay-btn overlay-btn-disabled';
      btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">Iron Vault is empty ‚Äî build your surplus to unlock this</span>';
      btnB.disabled = true;
    }

    choices.appendChild(btnA);
    choices.appendChild(btnB);
  } else {
    var btn = document.createElement('button');
    btn.className = 'overlay-btn friendly-choice';
    btn.innerHTML = 'Accept the reward<span class="overlay-btn-cost">' + enc.rewardDesc + '</span>';
    btn.onclick = function() { resolveFriendly(enc); };
    choices.appendChild(btn);
  }

  document.getElementById('encounter-overlay').classList.add('show');
}

function resolveHostile(choice, enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  if (choice === 'heart') {
    state.hearts = Math.max(0, (state.hearts || 3) - 1);
    showToast('‚ù§Ô∏è Heart spent ‚Äî the threat is driven back.');
  } else {
    var currentVault = state.ironVault || 0;
    var penalty = Math.round(currentVault * enc.vaultCost);
    if (penalty < 5) {
      state.hearts = Math.max(0, (state.hearts || 3) - 1);
      showToast('‚ù§Ô∏è Vault too empty ‚Äî heart spent instead.');
    } else {
      state.ironVault = Math.max(0, currentVault - penalty);
      showToast('üí∞ ' + penalty + ' gold taken from Iron Vault.');
    }
  }
  save();
  render();
}

function resolveFriendly(enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  if (enc.reward.type === 'xp') {
    state.xp += enc.reward.amount;
    showToast('‚ú® +' + enc.reward.amount + ' bonus XP!');
  } else if (enc.reward.type === 'heart') {
    state.hearts = Math.min(3, (state.hearts || 0) + 1);
    showToast('‚ù§Ô∏è Heart restored!');
  } else if (enc.reward.type === 'vault') {
    state.ironVault = (state.ironVault || 0) + enc.reward.amount;
    showToast('üîí +' + enc.reward.amount + ' gold sealed in Iron Vault!');
  }
  save();
  render();
}

function checkZoneBadge() {
  var pos = getMapPosition();
  var badges = state.badges || [];

  if (pos >= 3 && badges.indexOf('zone1') === -1) {
    badges.push('zone1'); state.badges = badges; save();
    setTimeout(function() {
      showZoneComplete('üõ°Ô∏è', 'The First Steps', 'You clear the Hearthstone Road. First zone down. It feels smaller looking back.');
    }, 800);
  }
  if (pos >= 6 && badges.indexOf('zone2') === -1) {
    badges.push('zone2'); state.badges = badges; save();
    setTimeout(function() {
      showZoneComplete('ü™ô', 'Disciplined Traveler', "The Merchant's Pass is behind you. You navigated the markets and kept your budget intact.");
    }, 800);
  }
  if (pos >= 9 && badges.indexOf('zone3') === -1) {
    badges.push('zone3'); state.badges = badges; save();
    setTimeout(function() {
      showZoneComplete('üåø', 'Thornwood Survivor', 'You emerge from the Thornwood. The light on the other side is warmer than you remembered light being.');
    }, 800);
  }
  if (pos >= 10 && badges.indexOf('zone4') === -1) {
    badges.push('zone4'); state.badges = badges; save();
    setTimeout(function() {
      showZoneComplete('üîí', 'Keeper of the Iron Vault', 'You have reached the Iron Keep. The road ahead is longer and wider than any map shows. You are ready.');
    }, 800);
  }
}

function showZoneComplete(icon, badgeName, narrative) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box zone-complete';
  document.getElementById('encounter-zone').textContent  = '‚ú¶ Zone Complete';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = 'Badge Earned: ' + badgeName;
  document.getElementById('encounter-desc').textContent  = narrative;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'March Forward ‚öî';
  btn.onclick = function() { document.getElementById('encounter-overlay').classList.remove('show'); };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDER MAP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMap() {
  var pos = getMapPosition();
  var wp  = getCurrentWaypoint();

  if (wp) {
    document.getElementById('map-location-name').textContent = wp.name.replace('\n',' ');
    var zoneNums = ['I','II','III','IV'];
    var zoneIdx  = typeof wp.zone === 'number' ? wp.zone - 1 : 0;
    document.getElementById('map-zone-tag').textContent =
      'Zone ' + (zoneNums[zoneIdx] || 'I') + ' ‚Äî ' + (wp.zoneName || '');
  }

  var TOTAL_H   = 820;
  var VIEWPORT_H = 220;

  var NODE_LAYOUT = [
    { id:0,   pct:[50, 4]  },
    { id:1,   pct:[22, 13] },
    { id:2,   pct:[78, 13] },
    { id:'z1',pct:[50, 22] },
    { id:3,   pct:[20, 33] },
    { id:4,   pct:[50, 33] },
    { id:5,   pct:[80, 33] },
    { id:'z2',pct:[50, 43] },
    { id:6,   pct:[22, 55] },
    { id:7,   pct:[78, 55] },
    { id:8,   pct:[50, 63] },
    { id:'z3',pct:[50, 72] },
    { id:9,   pct:[50, 83] },
    { id:10,  pct:[50, 92] },
    { id:'z4',pct:[78, 83] },
  ];

  var CONNECTIONS = [
    [0,1],[0,2],
    [1,'z1'],[2,'z1'],
    ['z1',3],['z1',4],
    [3,4],[4,5],
    [4,'z2'],[5,'z2'],
    ['z2',6],['z2',7],
    [6,8],[7,8],
    [8,'z3'],
    ['z3',9],
    [9,10],[9,'z4'],
  ];

  var container  = document.getElementById('node-map');
  var viewport   = document.getElementById('map-viewport');
  var inner      = document.getElementById('node-map-inner');
  var svg        = document.getElementById('map-svg');
  var moreArrow  = document.getElementById('map-more-arrow');
  if (!container || !inner || !svg || !viewport) return;

  var W = viewport.offsetWidth || 400;
  var H = TOTAL_H;
  container.style.height = H + 'px';
  svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
  svg.style.height = H + 'px';

  var posMap = {};
  NODE_LAYOUT.forEach(function(n) {
    posMap[n.id] = {
      x: Math.round(W * n.pct[0] / 100),
      y: Math.round(H * n.pct[1] / 100)
    };
  });

  // Camera pan
  var currentLayout = null;
  for (var ci = 0; ci < NODE_LAYOUT.length; ci++) {
    if (NODE_LAYOUT[ci].id === pos) { currentLayout = NODE_LAYOUT[ci]; break; }
  }
  var currentNodeY = currentLayout ? Math.round(H * currentLayout.pct[1] / 100) : 0;
  var targetScrollTop = currentNodeY - Math.round(VIEWPORT_H * 0.30);
  targetScrollTop = Math.max(0, Math.min(H - VIEWPORT_H, targetScrollTop));
  container.style.transform = 'translateY(' + (-targetScrollTop) + 'px)';

  var viewportBottom = targetScrollTop + VIEWPORT_H;
  var hasNodesBelow = false;
  NODE_LAYOUT.forEach(function(n) {
    if (typeof n.id === 'number' && n.id > pos) {
      var ny = Math.round(H * n.pct[1] / 100);
      if (ny > viewportBottom - 60) hasNodesBelow = true;
    }
  });
  if (moreArrow) moreArrow.className = 'map-more-arrow' + (hasNodesBelow ? '' : ' hidden');

  // SVG connections
  svg.innerHTML = '';

  function isReached(id) {
    if (typeof id === 'number') return id <= pos;
    var bm = {'z1':3,'z2':6,'z3':9,'z4':10};
    return pos >= (bm[id] || 999);
  }

  // Zone watermarks
  var zoneWatermarks = [
    { text:'HEARTHSTONE', y: 8  },
    { text:"MERCHANT'S PASS", y: 30 },
    { text:'THORNWOOD', y: 52 },
    { text:'IRON KEEP', y: 79 },
  ];
  zoneWatermarks.forEach(function(zw) {
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', '3%');
    t.setAttribute('y', zw.y + '%');
    t.setAttribute('fill', '#1c2033');
    t.setAttribute('font-size', '9');
    t.setAttribute('font-family', 'Plus Jakarta Sans, sans-serif');
    t.setAttribute('font-weight', '800');
    t.setAttribute('letter-spacing', '2');
    t.textContent = zw.text;
    svg.appendChild(t);
  });

  // Zone separator lines
  var zoneSepY = [26, 49, 77];
  zoneSepY.forEach(function(pct) {
    var line = document.createElementNS('http://www.w3.org/2000/svg','line');
    var y = Math.round(H * pct / 100);
    line.setAttribute('x1', '0'); line.setAttribute('y1', y);
    line.setAttribute('x2', W);   line.setAttribute('y2', y);
    line.setAttribute('stroke', '#1c2033');
    line.setAttribute('stroke-width', '1');
    line.setAttribute('stroke-dasharray', '3 8');
    svg.appendChild(line);
  });

  CONNECTIONS.forEach(function(conn) {
    var a = posMap[conn[0]], b = posMap[conn[1]];
    if (!a || !b) return;
    var line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', a.x); line.setAttribute('y1', a.y);
    line.setAttribute('x2', b.x); line.setAttribute('y2', b.y);
    var traveled = isReached(conn[0]) && isReached(conn[1]);
    line.setAttribute('stroke', traveled ? '#5b21b6' : '#1c2033');
    line.setAttribute('stroke-width', traveled ? '2.5' : '1.5');
    if (!traveled) line.setAttribute('stroke-dasharray', '4 6');
    line.setAttribute('stroke-linecap', 'round');
    svg.appendChild(line);
  });

  // Node DOM elements
  inner.innerHTML = '';
  inner.style.height = H + 'px';

  NODE_LAYOUT.forEach(function(layout) {
    var wpData = null;
    for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
      if (MAP_WAYPOINTS[i].id === layout.id) { wpData = MAP_WAYPOINTS[i]; break; }
    }
    if (!wpData) return;

    var isBadge   = typeof layout.id === 'string';
    var isEarned  = isBadge && (state.badges||[]).indexOf(wpData.badge) !== -1;
    var isDone    = !isBadge && layout.id < pos;
    var isCurrent = !isBadge && layout.id === pos;

    var px = posMap[layout.id];

    var wrap = document.createElement('div');
    wrap.className = 'map-node-wrap' + (isCurrent ? ' current' : '');
    wrap.style.left = px.x + 'px';
    wrap.style.top  = px.y + 'px';

    var circle = document.createElement('div');
    var cc = 'map-node-circle';
    if (isBadge) cc += ' badge-node' + (isEarned ? ' earned' : ' ahead');
    else cc += isDone ? ' done' : isCurrent ? ' current' : ' ahead';
    circle.className = cc;
    circle.textContent = wpData.icon;

    var label = document.createElement('div');
    label.className = 'map-node-label';
    label.textContent = isBadge
      ? (isEarned ? '‚òÖ Badge' : '?')
      : wpData.name.replace('\n',' ');

    wrap.appendChild(circle);
    wrap.appendChild(label);
    inner.appendChild(wrap);
  });

  // Road bonus pips
  var bonuses = Math.min(3, state.roadBonusesThisMonth || 0);
  for (var i = 1; i <= 3; i++) {
    var pip = document.getElementById('road-pip-' + i);
    if (pip) pip.className = 'road-pip' + (i <= bonuses ? ' earned' : '');
  }

  // Hearts
  for (var h = 1; h <= 3; h++) {
    var heart = document.getElementById('heart-' + h);
    if (heart) {
      var filled = h <= (state.hearts !== undefined ? state.hearts : 3);
      heart.className = 'map-heart' + (filled ? '' : ' empty');
      heart.textContent = filled ? '‚ù§Ô∏è' : 'üñ§';
    }
  }

  // Badge slots
  ['zone1','zone2','zone3','zone4'].forEach(function(bid) {
    var slot = document.getElementById('badge-' + bid);
    if (!slot) return;
    slot.className = (state.badges||[]).indexOf(bid) !== -1 ? 'badge-slot earned' : 'badge-slot locked';
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCurrentMonth() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
}

function checkMonthReset() {
  var thisMonth = getCurrentMonth();
  if (!state.currentMonth) {
    state.currentMonth = thisMonth;
    if (state.monthlyBudget > 0 && state.coinReserve === 0) {
      state.coinReserve = state.monthlyBudget;
    }
    save();
    return;
  }
  if (state.currentMonth !== thisMonth) {
    var surplus = Math.max(0, state.coinReserve);
    var prevMonth = state.currentMonth;
    state.ironVault += surplus;
    state.coinReserve = state.monthlyBudget;
    state.currentMonth = thisMonth;
    state.roadBonusesThisMonth = 0;
    save();
    if (state.name) { showMonthReset(prevMonth, surplus); }
  }
}

function showMonthReset(prevMonth, surplus) {
  var parts = prevMonth.split('-');
  var monthName = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1)
    .toLocaleString('default', { month: 'long', year: 'numeric' });

  var bd = document.getElementById('reset-breakdown');
  var surplusLine = surplus > 0
    ? '<div class="reset-row highlight"><span>Sealed in Iron Vault</span><span>+' + surplus + ' gold ‚ú¶</span></div>'
    : '<div class="reset-row"><span>Surplus</span><span>None this month</span></div>';

  bd.innerHTML =
    '<div class="reset-row"><span>Campaign</span><span>' + monthName + '</span></div>' +
    '<div class="reset-row"><span>Monthly Budget</span><span>' + state.monthlyBudget + ' gold</span></div>' +
    surplusLine +
    '<div class="reset-row highlight"><span>New Reserve</span><span>' + state.monthlyBudget + ' gold</span></div>' +
    '<div class="reset-row"><span>Iron Vault Total</span><span>' + state.ironVault + ' gold</span></div>';

  var msg = surplus > 0
    ? 'You ended ' + monthName + ' with ' + surplus + ' gold unspent ‚Äî sealed in the Iron Vault. A new treasury awaits.'
    : 'You spent the full budget last month. A fresh reserve awaits. This month, build that surplus.';
  document.getElementById('reset-msg').textContent = msg;
  document.getElementById('reset-overlay').classList.add('show');
}

function closeReset() {
  document.getElementById('reset-overlay').classList.remove('show');
}

function renderCoins() {
  if (!state.monthlyBudget) {
    document.getElementById('coin-reserve-section').style.display = 'none';
    return;
  }
  document.getElementById('coin-reserve-section').style.display = 'block';

  var reserve = Math.max(0, state.coinReserve);
  var budget  = state.monthlyBudget;
  var pct     = Math.min(100, Math.max(0, (reserve / budget) * 100));

  document.getElementById('coin-current').textContent = reserve;
  document.getElementById('coin-max').textContent     = budget;

  var fill = document.getElementById('coin-fill');
  fill.style.width = pct + '%';
  fill.className = 'bar-fill coin';

  var statusEl = document.getElementById('coin-status');
  statusEl.className = 'coin-status';

  if (pct <= 10) {
    fill.classList.add('danger');
    statusEl.classList.add('danger');
    statusEl.textContent = 'Running on fumes ‚Äî spend carefully!';
  } else if (pct <= 30) {
    fill.classList.add('warning');
    statusEl.classList.add('warning');
    statusEl.textContent = 'Getting low ‚Äî watch your spending.';
  } else if (pct >= 90) {
    statusEl.textContent = 'Looking strong ‚Äî great discipline!';
  } else {
    statusEl.textContent = Math.round(pct) + '% of monthly budget remaining.';
  }

  var vaultEl = document.getElementById('vault-amount');
  if (state.ironVault > 0) {
    vaultEl.textContent = '$' + state.ironVault + ' saved';
    vaultEl.className = 'vault-amount';
  } else {
    vaultEl.textContent = 'Empty';
    vaultEl.className = 'vault-amount empty';
  }
}

function render() {
  var ld = getLevelData(state.xp);

  document.getElementById('char-avatar').textContent = state.avatar || 'üõ°Ô∏è';
  document.getElementById('char-name').textContent   = state.name   || '‚Äî';
  document.getElementById('char-class').textContent  = getTitle(state.heroClass, ld.level);
  document.getElementById('level-num').textContent   = ld.level;

  document.getElementById('xp-current').textContent  = state.xp;
  document.getElementById('xp-next-val').textContent = ld.xpAtEnd;
  document.getElementById('xp-fill').style.width     = ld.pct + '%';

  document.getElementById('xp-next-msg').textContent =
    ld.level < LEVEL_XP.length
      ? ld.toNext + ' XP to Level ' + (ld.level + 1)
      : 'Maximum rank achieved!';

  var today      = new Date().toDateString();
  var loggedToday = state.lastLogDate === today;
  var streakCount = state.streak || 0;

  document.getElementById('streak-count').textContent = streakCount;

  var banner  = document.getElementById('streak-banner');
  var flameEl = document.getElementById('streak-banner-flame');
  var countEl = document.getElementById('streak-count');
  var rightEl = document.getElementById('streak-banner-right');

  banner.className = 'streak-banner';
  flameEl.className = 'streak-banner-flame';
  countEl.className = 'streak-banner-count';
  rightEl.className = 'streak-banner-right';

  if (loggedToday) {
    banner.classList.add('alive');
    rightEl.classList.add('logged');
    rightEl.textContent = '‚úì Logged today';
    document.getElementById('streak-label').textContent =
      streakCount > 1 ? 'day streak ‚Äî keep it going!' : 'day streak ‚Äî great start!';
  } else if (streakCount > 0) {
    banner.classList.add('danger');
    rightEl.classList.add('urgent');
    rightEl.textContent = '‚ö† Log today or lose it';
    document.getElementById('streak-label').textContent = 'day streak ‚Äî at risk';
  } else {
    flameEl.classList.add('cold');
    countEl.classList.add('cold');
    rightEl.textContent = 'Start your streak today';
    document.getElementById('streak-label').textContent = 'day streak ‚Äî log to begin';
  }

  renderLog();
  renderCoins();
  renderMap();
  checkZoneBadge();
  checkArrival();
}

function renderLog() {
  var list = document.getElementById('log-list');
  list.innerHTML = '';

  if (!state.log || state.log.length === 0) {
    var empty = document.createElement('div');
    empty.className = 'log-empty';
    empty.textContent = 'No entries yet. Log your first expense above to earn XP!';
    list.appendChild(empty);
    return;
  }

  var items = state.log.slice().reverse().slice(0, 20);
  items.forEach(function(entry) {
    var el = document.createElement('div');
    el.className = 'log-item';
    var amt  = parseFloat(entry.amount).toFixed(2);
    var icon = entry.icon || 'üí∞';
    var meta = entry.ts ? formatDate(entry.ts) : '';
    el.innerHTML =
      '<div class="log-icon">' + icon + '</div>' +
      '<div>' +
        '<div class="log-desc">' + esc(entry.desc) + '</div>' +
        (meta ? '<div class="log-meta">' + meta + '</div>' : '') +
      '</div>' +
      '<div class="log-right">' +
        '<div class="log-amount">$' + amt + '</div>' +
        '<div class="log-xp">+' + entry.xpGained + ' XP</div>' +
      '</div>';
    list.appendChild(el);
  });
}

function formatDate(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ONBOARDING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var currentStep = 0;

function goStep(n) {
  if (n > currentStep) {
    if (currentStep === 0) {
      var name = document.getElementById('hero-name-input').value.trim();
      if (!name) { showToast('Name your hero first.'); return; }
    }
    if (currentStep === 1) {
      if (!obAvatar) { showToast('Choose your avatar first.'); return; }
    }
    if (currentStep === 2) {
      if (!obClass) { showToast('Choose your class first.'); return; }
    }
  }

  document.getElementById('step-' + currentStep).classList.remove('active');
  currentStep = n;
  document.getElementById('step-' + currentStep).classList.add('active');

  for (var i = 0; i <= 4; i++) {
    var dot = document.getElementById('dot-' + i);
    if (!dot) continue;
    dot.className = 'step-dot';
    if (i < currentStep)        dot.classList.add('done');
    else if (i === currentStep) dot.classList.add('active');
  }

  document.getElementById('onboarding').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function selectAvatar(el) {
  document.querySelectorAll('.avatar-opt').forEach(function(a) { a.classList.remove('selected'); });
  el.classList.add('selected');
  obAvatar = el.getAttribute('data-avatar');
}

function selectClass(el) {
  document.querySelectorAll('.class-opt').forEach(function(c) { c.classList.remove('selected'); });
  el.classList.add('selected');
  obClass = el.getAttribute('data-class');
}

function beginJourney() {
  var budget = parseFloat(document.getElementById('budget-input').value);
  if (!budget || budget <= 0) { showToast('Set your monthly budget first.'); return; }
  if (!obClass) { showToast('Choose your class first.'); return; }
  state.name          = document.getElementById('hero-name-input').value.trim();
  state.avatar        = obAvatar || 'üõ°Ô∏è';
  state.heroClass     = obClass;
  state.monthlyBudget = Math.round(budget);
  state.coinReserve   = Math.round(budget);
  state.ironVault     = 0;
  state.currentMonth  = getCurrentMonth();
  state.hearts        = 3;
  state.mapPosition   = 0;
  state.badges        = [];
  state.weekLogDays   = [];
  state.weekStart     = '';
  state.roadBonusesThisMonth = 0;
  save();
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  render();
}

document.getElementById('hero-name-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') goStep(1);
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LOG EXPENSE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function logExpense() {
  var descEl   = document.getElementById('desc-input');
  var amountEl = document.getElementById('amount-input');
  var desc     = descEl.value.trim();
  var amount   = parseFloat(amountEl.value);

  if (!desc)                { showToast('Describe your expense.'); return; }
  if (!amount || amount <= 0) { showToast('Enter a valid amount.'); return; }

  var prevLevel = getLevelData(state.xp).level;

  var streakBonus = Math.min(5, Math.floor((state.streak || 0) / 5));
  var currentLevel = getLevelData(state.xp).level;
  var baseXp = currentLevel <= 3 ? 30 : 15;
  var xpGained = baseXp + streakBonus;

  markLoggedToday();
  state.xp += xpGained;

  var entry = {
    id:       String(Date.now()) + String(Math.floor(Math.random() * 10000)),
    desc:     desc,
    amount:   amount,
    xpGained: xpGained,
    icon:     LOG_ICONS[Math.floor(Math.random() * LOG_ICONS.length)],
    ts:       new Date().toISOString()
  };

  if (!Array.isArray(state.log)) state.log = [];
  state.log.push(entry);

  if (state.monthlyBudget > 0) {
    state.coinReserve = Math.max(0, (state.coinReserve || 0) - amount);
    fireCoinFloat('-' + amount.toFixed(0) + ' gold');
  }

  checkWeekRoadBonus();
  checkEncounter(amount);
  save();
  render();

  descEl.value   = '';
  amountEl.value = '';
  descEl.focus();

  fireXpFloat('+' + xpGained + ' XP');

  var fill = document.getElementById('xp-fill');
  fill.classList.remove('pulse');
  void fill.offsetWidth;
  fill.classList.add('pulse');
  setTimeout(function() { fill.classList.remove('pulse'); }, 800);

  var newLevel = getLevelData(state.xp).level;
  if (newLevel > prevLevel) {
    setTimeout(function() { showLevelUp(newLevel); }, 900);
  }
}

function fireXpFloat(text) {
  var floatEl = document.getElementById('xp-float');
  var track   = document.getElementById('xp-fill');
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

function fireCoinFloat(text) {
  var floatEl = document.getElementById('coin-float');
  var track   = document.getElementById('coin-fill');
  if (!track) return;
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY + rect.height) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LEVEL UP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLevelUp(level) {
  save();
  document.getElementById('lu-level').textContent = level;
  document.getElementById('lu-rank').textContent  = getTitle(state.heroClass, level);
  document.getElementById('lu-msg').textContent   = LEVEL_MSGS[Math.min(level - 2, LEVEL_MSGS.length - 1)];
  document.getElementById('levelup-overlay').classList.add('show');
  renderCoins();
}

function closeLevelUp() {
  document.getElementById('levelup-overlay').classList.remove('show');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TOAST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var toastTimer;
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, 2800);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KEYBOARD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Enter') return;
  var a = document.activeElement;
  if (a && (a.id === 'desc-input' || a.id === 'amount-input')) {
    logExpense();
  }
});
</script>

</body>
</html>
