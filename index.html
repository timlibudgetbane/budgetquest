<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habit Quest</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400;1,600&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>

/* ══════════════════════════════════════════════
   TOKENS
══════════════════════════════════════════════ */
:root {
  --bg:          #0f0d0b;
  --surface:     #161310;
  --surface2:    #1e1a14;
  --surface3:    #252018;

  --border:      #332e22;
  --border-mid:  #4a4230;
  --border-gold: #6b5c34;

  --gold:        #c4a24a;
  --gold-light:  #e2c06a;
  --gold-dim:    #7a6230;
  --gold-glow:   rgba(196,162,74,0.22);

  --xp:          #5b8fcc;
  --xp-dim:      #1c3458;

  --green:       #3a9e6a;
  --red:         #b83c2e;
  --orange:      #d4622a;
  --teal:        #2ab89a;
  --teal-glow:   rgba(42,184,154,0.18);

  --text:        #e6dcc8;
  --text-mid:    #b8a882;
  --text-dim:    #8a7d62;
  --text-dark:   #5a5040;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 18px;
  line-height: 1.5;
  min-height: 100vh;
}

/* Grain */
body::after {
  content: '';
  position: fixed; inset: 0;
  pointer-events: none; z-index: 9999;
  opacity: 0.018;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* ══════════════════════════════════════════════
   APP SHELL
══════════════════════════════════════════════ */
.app {
  max-width: 1080px;
  margin: 0 auto;
  padding: 0 24px 80px;
}

/* ── Header ── */
.header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  padding: 20px 0 16px;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--border);
}
.header-brand { display: flex; align-items: baseline; gap: 12px; }
.header-icon  { display: none; }
.header-sigil {
  font-size: 18px;
  color: var(--gold-dim);
  line-height: 1;
  opacity: 0.7;
  margin-right: 2px;
}
.header h1 {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  color: var(--gold);
  letter-spacing: 0.18em;
  line-height: 1;
}
.header-tagline {
  font-size: 16px;
  color: var(--text-dark);
  font-style: italic;
}
.header-auth {
  display: flex; align-items: center; gap: 10px;
  font-size: 15px; color: var(--text-dark);
}
.header-auth-email { font-style: italic; }
.signout-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-dark);
  padding: 3px 10px; border-radius: 2px;
  cursor: pointer;
  font-family: 'Cinzel', serif;
  font-size: 13px; letter-spacing: 0.08em;
  transition: all 0.2s;
}
.signout-btn:hover { border-color: var(--border-gold); color: var(--text-mid); }

/* ── Two-column layout ── */
.layout {
  display: grid;
  grid-template-columns: 420px 1fr;
  gap: 20px;
  align-items: start;
}
.col-left {
  display: flex;
  flex-direction: column;
  gap: 12px;
  isolation: isolate;  /* prevent child paint escaping column bounds */
  overflow: hidden;    /* hard clip — map canvas translateY stays inside */
}
.col-right {
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-width: 0;
}
@media (max-width: 820px) {
  .layout { grid-template-columns: 1fr; }

}

/* ── Shared inputs ── */
.form-input, .field-input, .hero-name-input, .budget-input {
  background: var(--surface2);
  border: 1px solid var(--border-mid);
  border-radius: 2px;
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 21px;
  padding: 9px 12px;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
.form-input:focus, .field-input:focus,
.hero-name-input:focus, .budget-input:focus { border-color: var(--gold-dim); }
.form-input::placeholder, .field-input::placeholder,
.hero-name-input::placeholder, .budget-input::placeholder { color: var(--text-dark); }

/* ── Shared buttons ── */
.btn-primary {
  width: 100%;
  background: var(--gold-dim);
  border: 1px solid var(--gold-dim);
  border-radius: 2px;
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
  padding: 11px 24px; cursor: pointer; transition: all 0.2s;
}
.btn-primary:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.btn-secondary {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 2px; color: var(--text-dim);
  font-family: 'Cinzel', serif;
  font-size: 14px; letter-spacing: 0.08em;
  padding: 9px 18px; cursor: pointer; transition: all 0.2s;
}
.btn-secondary:hover { border-color: var(--border-gold); color: var(--text-mid); }

/* ── Panel section label ── */
.panel-head {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.panel-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* ══════════════════════════════════════════════
   CHARACTER PANEL (left, top)
══════════════════════════════════════════════ */
.char-panel {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 18px;
  position: relative; overflow: hidden;
}
.char-panel::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}

.char-identity {
  display: flex; align-items: center;
  gap: 12px; margin-bottom: 18px;
}
.char-avatar {
  width: 48px; height: 48px;
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px;
  background: var(--surface2); flex-shrink: 0;
}
.char-name {
  font-family: 'Cinzel', serif;
  font-size: 21px; color: var(--gold);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.char-class { font-size: 16px; color: var(--text-dim); font-style: italic; margin-top: 1px; }
.char-level-badge { margin-left: auto; flex-shrink: 0; text-align: right; }
.level-num {
  font-family: 'Cinzel', serif;
  font-size: 30px; color: var(--gold-light); line-height: 1;
  text-shadow: 0 0 18px var(--gold-glow);
}
.level-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}

/* stat rows */
.stat-block { margin-bottom: 14px; }
.stat-label-row {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-bottom: 5px;
}
.stat-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.14em;
}
.stat-value { font-size: 17px; color: var(--text-dim); }
.stat-value strong { color: var(--xp); font-family: 'Cinzel', serif; font-size: 17px; }
.stat-value.gold-val strong { color: var(--gold); }

.bar-track {
  height: 5px;
  background: var(--surface2);
  border-radius: 100px;
  overflow: hidden;
}
.bar-fill {
  height: 100%; border-radius: 100px;
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1);
  min-width: 0;
}
.bar-fill.xp   { background: linear-gradient(90deg, var(--xp-dim), var(--xp)); }
.bar-fill.coin { background: linear-gradient(90deg, var(--gold-dim), var(--gold)); }
.bar-fill.coin.danger  { background: linear-gradient(90deg, #4a1810, var(--red)); }
.bar-fill.coin.warning { background: linear-gradient(90deg, #4a3010, var(--orange)); }

.stat-sub {
  display: flex; justify-content: space-between;
  margin-top: 3px;
  font-size: 14px; color: var(--text-dark); font-style: italic;
}
.coin-status { font-size: 14px; font-style: italic; }
.coin-status.danger  { color: var(--red); }
.coin-status.warning { color: var(--orange); }

/* Treasury rule */
.rule { height: 1px; background: var(--border); margin: 14px 0 10px; }
.rule-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  text-align: center; margin: -17px 0 12px;
}
.rule-label span {
  background: var(--surface);
  padding: 0 10px;
}

/* Road Gold row */
.vault-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 11px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-left: 2px solid var(--gold-dim);
  border-radius: 2px;
  margin-top: 10px;
}
.vault-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 1px;
}
.vault-sub  { font-size: 15px; color: var(--text-dim); font-style: italic; }
.vault-amount {
  font-family: 'Cinzel', serif;
  font-size: 24px; color: var(--gold);
  text-shadow: 0 0 12px var(--gold-glow);
}
.vault-amount.empty { color: var(--text-dark); font-size: 18px; text-shadow: none; }

/* Floats */
.gold-float, .coin-float, .xp-float {
  position: fixed;
  font-family: 'Cinzel', serif; font-size: 16px;
  pointer-events: none; z-index: 9990; opacity: 0;
}
.gold-float { color: var(--gold); }
.coin-float { color: var(--gold); }
.xp-float   { color: var(--xp); }
.gold-float.pop { animation: floatUp 1.1s ease-out forwards; }
.coin-float.pop { animation: floatDown 1.0s ease-out forwards; }
.xp-float.pop   { animation: floatUp 1.1s ease-out forwards; }
@keyframes floatUp {
  0%   { opacity:1; transform:translateX(-50%) translateY(0) scale(1); }
  15%  { opacity:1; transform:translateX(-50%) translateY(-14px) scale(1.2); }
  100% { opacity:0; transform:translateX(-50%) translateY(-36px) scale(0.9); }
}
@keyframes floatDown {
  0%   { opacity:1; transform:translateX(-50%) translateY(0); }
  100% { opacity:0; transform:translateX(-50%) translateY(20px); }
}
.xp-bar-fill.pulse { animation: barPulse 0.6s ease; }
@keyframes barPulse { 0%,100%{filter:brightness(1)} 50%{filter:brightness(2)} }

/* ══════════════════════════════════════════════
   MAP PANEL (left, below char)
══════════════════════════════════════════════ */
.map-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.map-panel-head {
  padding: 12px 14px 10px;
  display: flex; align-items: flex-start; justify-content: space-between;
}
.map-loc-block { display: flex; flex-direction: column; gap: 1px; }
.map-section-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.16em;
}
.map-current-loc { font-family: 'Cinzel', serif; font-size: 17px; color: var(--gold); }
.map-zone-tag    { font-size: 15px; color: var(--text-dim); font-style: italic; }

.map-right-col  { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
.map-hearts     { display: flex; gap: 3px; }
.map-heart      { font-size: 16px; transition: all 0.3s; }
.map-heart.empty { filter: grayscale(1) opacity(0.2); }

.map-badges-row { display: flex; gap: 4px; }
.badge-slot {
  width: 22px; height: 22px; border-radius: 50%;
  border: 1px solid var(--border); background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; position: relative; cursor: default; transition: all 0.3s;
}
.badge-slot.earned { border-color: var(--gold); box-shadow: 0 0 7px var(--gold-glow); }
.badge-slot.locked { opacity: 0.2; }
.badge-slot .badge-tip {
  display: none; position: absolute;
  bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%);
  background: var(--surface3); border: 1px solid var(--border-mid);
  border-radius: 2px; padding: 3px 7px;
  font-size: 13px; color: var(--text-mid); white-space: nowrap;
  z-index: 100; pointer-events: none;
  font-family: 'Cinzel', serif;
}
.badge-slot:hover .badge-tip { display: block; }

.map-viewport {
  position: relative;
  overflow: hidden;
  border-radius: 4px;
  border: 1px solid var(--border-gold);
}
.node-map {
  position: relative; width: 100%;
}
.node-map svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
.node-map-inner { position: absolute; top: 0; left: 0; width: 100%; }

.map-node-wrap {
  position: absolute; transform: translate(-50%,-50%);
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  cursor: default; z-index: 2;
}
.map-node-circle {
  width: 38px; height: 38px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; transition: all 0.3s;
  border: 1.5px solid var(--border);
  background: rgba(15,13,11,0.85);
  backdrop-filter: blur(2px);
}
.map-node-circle.done   { border-color: var(--gold-dim); opacity: 0.55; background: rgba(122,98,48,0.1); }
.map-node-circle.zone1  { border-color: rgba(180,140,60,0.6); }
.map-node-circle.zone2  { border-color: rgba(180,110,40,0.6); }
.map-node-circle.zone3  { border-color: rgba(60,100,70,0.7); }
.map-node-circle.zone4  { border-color: rgba(120,80,160,0.7); }
.map-node-circle.zone1.current { background: rgba(180,140,60,0.12); box-shadow: 0 0 18px rgba(180,140,60,0.3); }
.map-node-circle.zone2.current { background: rgba(180,110,40,0.12); box-shadow: 0 0 18px rgba(180,110,40,0.3); }
.map-node-circle.zone3.current { background: rgba(60,100,70,0.15); box-shadow: 0 0 18px rgba(60,140,80,0.3); }
.map-node-circle.zone4.current { background: rgba(120,80,160,0.15); box-shadow: 0 0 18px rgba(160,100,220,0.3); }
.map-node-circle.current {
  border-color: var(--gold);
  background: rgba(196,162,74,0.1);
  animation: currentPulse 2.8s ease-in-out infinite;
}
@keyframes currentPulse {
  0%,100% { box-shadow: 0 0 0 3px rgba(196,162,74,0.1), 0 0 12px var(--gold-glow); }
  50%     { box-shadow: 0 0 0 6px rgba(196,162,74,0.04), 0 0 20px var(--gold-glow); }
}
.map-node-circle.ahead  { opacity: 0.2; }
.map-node-circle.badge-node { width: 28px; height: 28px; border-radius: 2px; font-size: 16px; }
.map-node-circle.badge-node.earned { border-color: var(--gold); box-shadow: 0 0 8px var(--gold-glow); }
.map-node-circle.badge-node.ahead  { opacity: 0.15; }

.map-node-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: var(--text-dim);
  text-align: center; white-space: nowrap;
  background: rgba(10,8,6,0.82);
  padding: 2px 6px; border-radius: 2px;
  letter-spacing: 0.04em;
  border: 1px solid rgba(90,70,30,0.3);
}
.map-node-wrap.current .map-node-label {
  color: var(--gold-light);
  border-color: rgba(196,162,74,0.4);
}

.map-more-arrow {
  position: absolute; bottom: 5px; right: 9px;
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.06em;
  display: flex; flex-direction: column; align-items: center; gap: 1px;
  animation: bounceDown 2s ease-in-out infinite;
}
.map-more-arrow.hidden { display: none; }
@keyframes bounceDown { 0%,100%{transform:translateY(0)} 50%{transform:translateY(3px)} }

.road-bonus-track {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 14px;
}
.road-bonus-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.road-bonus-pips { display: flex; gap: 4px; }
.road-pip { width: 12px; height: 4px; border-radius: 100px; background: var(--border); transition: all 0.3s; }
.road-pip.earned { background: var(--teal); box-shadow: 0 0 4px var(--teal-glow); }

/* ══════════════════════════════════════════════
   STREAK (right col, top)
══════════════════════════════════════════════ */
.streak-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 12px 16px;
  display: flex; align-items: center; justify-content: space-between;
  position: relative; overflow: hidden;
  transition: border-color 0.3s;
}
.streak-panel.alive { border-color: rgba(212,98,42,0.3); }
.streak-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--orange), transparent);
  opacity: 0;
}
.streak-panel.alive::before { opacity: 0.45; }
.streak-left  { display: flex; align-items: center; gap: 10px; }
.streak-flame {
  font-size: 22px; line-height: 1;
  filter: drop-shadow(0 0 4px rgba(212,98,42,0.4));
}
.streak-flame.cold { filter: grayscale(0.9); opacity: 0.3; }
.streak-num {
  font-family: 'Cinzel', serif;
  font-size: 26px; color: var(--orange); line-height: 1;
}
.streak-num.cold { color: var(--text-dark); }
.streak-tag { font-size: 17px; color: var(--text-mid); font-style: italic; }
.streak-right {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.08em; text-align: right;
}
.streak-right.logged { color: var(--green); }
.streak-right.urgent { color: var(--orange); animation: urgentPulse 2s ease-in-out infinite; }
@keyframes urgentPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* ══════════════════════════════════════════════
   LOG FORM (right col)
══════════════════════════════════════════════ */
.log-panel {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 18px;
  position: relative; overflow: hidden;
}
.log-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.log-form-grid {
  display: grid;
  grid-template-columns: 1fr 110px auto;
  gap: 10px; align-items: end;
}
@media (max-width: 500px) {
  .log-form-grid { grid-template-columns: 1fr 1fr; }
  .log-btn-wrap  { grid-column: 1 / -1; }
}
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.log-btn {
  background: var(--gold-dim);
  border: 1px solid var(--gold-dim); border-radius: 2px;
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
  padding: 9px 14px; cursor: pointer; white-space: nowrap; width: 100%;
  transition: all 0.18s;
}
.log-btn:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.log-btn.streak-danger {
  border-color: var(--orange);
  box-shadow: 0 0 12px rgba(212,98,42,0.3);
  animation: streakDanger 2s ease-in-out infinite;
}
.log-btn.logged-today {
  border-color: var(--green);
  color: var(--green);
  background: rgba(58,158,106,0.08);
}
@keyframes streakDanger { 0%,100%{box-shadow:0 0 8px rgba(212,98,42,0.3)} 50%{box-shadow:0 0 18px rgba(212,98,42,0.6)} }
.xp-hint { margin-top: 10px; font-size: 15px; color: var(--text-dark); font-style: italic; }

/* ══════════════════════════════════════════════
   LOG LIST (right col)
══════════════════════════════════════════════ */
.log-list-wrap {}
.log-list {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px; overflow: hidden;
}
.log-empty { padding: 28px; text-align: center; color: var(--text-dark); font-size: 17px; font-style: italic; }
.log-item {
  display: grid; grid-template-columns: 22px 1fr auto;
  gap: 10px; align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  animation: slideIn 0.22s ease both;
}
.log-item:last-child { border-bottom: none; }
.log-icon   { font-size: 17px; text-align: center; opacity: 0.65; }
.log-desc   { font-size: 18px; color: var(--text); }
.log-meta   { font-size: 14px; color: var(--text-dark); font-style: italic; }
.log-right  { text-align: right; }
.log-amount { font-family: 'Cinzel', serif; font-size: 17px; color: var(--text-mid); }
.log-xp     { font-size: 14px; color: var(--xp); }

/* section-head alias */
.section-head {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px;
}
.section-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.chronicle-head {
  font-size: 15px;
  color: var(--gold-dim);
  letter-spacing: 0.22em;
  margin-top: 6px;
}
.chronicle-head::after { background: var(--border-gold); }

/* ══════════════════════════════════════════════
   LOGIN
══════════════════════════════════════════════ */
#login-screen { max-width: 400px; margin: 0 auto; }
.login-hero { text-align: center; margin-bottom: 28px; padding-top: 20px; }
.login-hero-icon {
  width: 60px; height: 60px;
  background: var(--surface2);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 28px; margin-bottom: 14px;
}
.login-title { font-family: 'Cinzel', serif; font-size: 22px; color: var(--gold); margin-bottom: 6px; }
.login-sub   { color: var(--text-dim); font-size: 18px; font-style: italic; }
.login-err   { color: var(--red); font-size: 17px; text-align: center; margin-top: 8px; display: none; }
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px; padding: 20px;
  position: relative; overflow: hidden;
}
.card-accent-top, .card-accent-gold, .card-accent-teal {
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.form-field { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; }
.field-label {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.field-input { width: 100%; }

/* ══════════════════════════════════════════════
   ONBOARDING
══════════════════════════════════════════════ */
.ob-card {
  max-width: 540px; margin: 0 auto;
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 36px 32px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s ease both;
}
.ob-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.steps-row {
  display: flex; align-items: center; justify-content: center;
  gap: 6px; margin-bottom: 30px;
}
.step-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--border-mid); transition: all 0.3s; flex-shrink: 0;
}
.step-dot.active { background: var(--gold); width: 18px; border-radius: 2px; box-shadow: 0 0 5px var(--gold-glow); }
.step-dot.done   { background: var(--gold-dim); opacity: 0.5; }
.step-line { width: 14px; height: 1px; background: var(--border); flex-shrink: 0; }
.ob-step { display: none; }
.ob-step.active { display: block; animation: fadeUp 0.3s ease both; }
.ob-icon  { text-align: center; font-size: 42px; margin-bottom: 14px; }
.ob-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold); text-align: center; margin-bottom: 8px; }
.ob-sub {
  color: var(--text-dim); font-size: 18px; font-style: italic;
  text-align: center; line-height: 1.65; margin-bottom: 24px;
  max-width: 400px; margin-left: auto; margin-right: auto;
}
.ob-nav { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }

.name-row { display: flex; max-width: 340px; margin: 0 auto; }
.hero-name-input { border-right: none; border-radius: 2px 0 0 2px; flex: 1; }
.name-btn {
  background: var(--gold-dim); border: 1px solid var(--gold-dim); border-left: none;
  border-radius: 0 2px 2px 0; color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 0.1em;
  padding: 9px 16px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.name-btn:hover { background: var(--gold); color: var(--bg); }

.avatar-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px; justify-content: center;
  margin-bottom: 24px;
}
.avatar-opt {
  border: 1px solid var(--border); border-radius: 3px;
  background: var(--surface2);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 16px 8px 12px;
  cursor: pointer;
  transition: all 0.2s; position: relative; user-select: none;
  gap: 6px;
}
}
.avatar-opt:hover { border-color: var(--border-gold); transform: translateY(-2px); }
.avatar-opt.selected { border-color: var(--gold); box-shadow: 0 0 12px var(--gold-glow); }
.avatar-opt.selected::after {
  content: '✓'; position: absolute; top: 5px; right: 7px;
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--gold);
}
.avatar-opt-icon { font-size: 32px; line-height: 1; }
.avatar-opt-label {
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
}

.class-grid { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }
.class-opt {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 2px; padding: 11px 13px; cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; gap: 12px; user-select: none;
}
.class-opt:hover     { border-color: var(--border-mid); background: var(--surface3); }
.class-opt.selected  { border-color: var(--gold); background: var(--surface3); border-left-width: 3px; }
.class-emoji { font-size: 24px; flex-shrink: 0; width: 30px; text-align: center; }
.class-info  { flex: 1; }
.class-name  { font-family: 'Cinzel', serif; font-size: 16px; color: var(--gold); margin-bottom: 2px; }
.class-desc  { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.45; }
.class-trait {
  font-size: 12px; color: var(--xp);
  text-transform: uppercase; letter-spacing: 0.1em;
  background: rgba(91,143,204,0.1); border: 1px solid rgba(91,143,204,0.2);
  padding: 2px 7px; border-radius: 2px; white-space: nowrap; flex-shrink: 0;
}

.budget-row { display: flex; max-width: 320px; margin: 0 auto; }
.budget-prefix {
  background: var(--surface2); border: 1px solid var(--border-mid); border-right: none;
  border-radius: 2px 0 0 2px; padding: 9px 12px;
  color: var(--gold); font-family: 'Cinzel', serif; font-size: 21px;
  display: flex; align-items: center;
}
.budget-input { border-left: none; border-right: none; border-radius: 0; flex: 1; }
.budget-btn {
  background: var(--gold-dim); border: 1px solid var(--gold-dim); border-left: none;
  border-radius: 0 2px 2px 0; color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 0.1em;
  padding: 9px 16px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.budget-btn:hover { background: var(--gold); color: var(--bg); }

.laws-grid { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }
.law-card {
  display: flex; align-items: flex-start; gap: 12px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 2px; padding: 10px 13px;
}
.law-icon  { font-size: 21px; flex-shrink: 0; width: 24px; text-align: center; margin-top: 2px; opacity: 0.75; }
.law-body  { flex: 1; }
.law-title { font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold-dim); letter-spacing: 0.08em; margin-bottom: 3px; text-transform: uppercase; }
.law-plain { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.55; }

/* ══════════════════════════════════════════════
   OVERLAYS
══════════════════════════════════════════════ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(6,4,2,0.88);
  backdrop-filter: blur(3px);
  display: flex; align-items: center; justify-content: center;
  z-index: 9998; opacity: 0; pointer-events: none;
  transition: opacity 0.28s;
}
.overlay.show { opacity: 1; pointer-events: all; }
.overlay-box {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 28px 32px;
  text-align: center; max-width: 400px; width: 90%;
  position: relative; overflow: hidden;
  transform: scale(0.93) translateY(12px);
  transition: transform 0.32s cubic-bezier(0.34,1.56,0.64,1);
}
.overlay.show .overlay-box { transform: scale(1) translateY(0); }
.overlay-box::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.overlay-box.hostile { border-color: rgba(184,60,46,0.45); }
.overlay-box.hostile::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }
.overlay-box.friendly { border-color: rgba(58,158,106,0.4); }
.overlay-box.friendly::before { background: linear-gradient(90deg, transparent, var(--green), transparent); }
.overlay-box.zone-complete { border-color: rgba(196,162,74,0.45); }
.overlay-box.levelup { border-color: var(--gold-dim); box-shadow: 0 0 40px var(--gold-glow); }
.overlay-box.broken  { border-color: rgba(184,60,46,0.45); }
.overlay-box.broken::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }

.overlay-zone-label {
  font-family: 'Cinzel', serif; font-size: 12px;
  letter-spacing: 0.2em; text-transform: uppercase;
  margin-bottom: 10px; color: var(--text-dark);
}
.overlay-box.hostile  .overlay-zone-label { color: var(--red); }
.overlay-box.friendly .overlay-zone-label { color: var(--green); }
.overlay-box.zone-complete .overlay-zone-label { color: var(--gold); }
.overlay-icon  { font-size: 40px; margin-bottom: 10px; line-height: 1; }
.overlay-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold); margin-bottom: 10px; }
.overlay-desc  { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.7; margin-bottom: 18px; }
.overlay-choices { display: flex; flex-direction: column; gap: 7px; }
.overlay-btn {
  background: var(--surface2); border: 1px solid var(--border-mid);
  border-radius: 2px; color: var(--text);
  font-family: 'Crimson Text', serif; font-size: 18px;
  padding: 11px 16px; cursor: pointer; transition: all 0.18s;
  text-align: left; line-height: 1.5;
}
.overlay-btn:hover { border-color: var(--border-gold); background: var(--surface3); }
.overlay-btn.hostile-choice { border-color: rgba(184,60,46,0.3); }
.overlay-btn.hostile-choice:hover { border-color: var(--red); background: rgba(184,60,46,0.07); }
.overlay-btn.friendly-choice { border-color: rgba(58,158,106,0.3); }
.overlay-btn.friendly-choice:hover { border-color: var(--green); background: rgba(58,158,106,0.07); }
.overlay-btn.primary-choice {
  background: var(--gold-dim); border-color: var(--gold-dim); color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 0.1em; text-align: center;
}
.overlay-btn.primary-choice:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.overlay-btn-cost { display: block; font-size: 15px; color: var(--text-dim); margin-top: 2px; font-style: italic; }
.overlay-btn-disabled { opacity: 0.3; cursor: not-allowed; }
.overlay-btn-disabled:hover { background: var(--surface2) !important; border-color: var(--border-mid) !important; }

.levelup-sparkles { font-size: 22px; letter-spacing: 12px; margin-bottom: 10px; color: var(--gold-dim); }
.levelup-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 4px; }
.levelup-num {
  font-family: 'Cinzel', serif; font-size: 58px; color: var(--gold-light);
  line-height: 1; margin: 4px 0 8px; text-shadow: 0 0 28px var(--gold-glow);
}
.levelup-rank { font-family: 'Cinzel', serif; font-size: 18px; color: var(--gold); margin-bottom: 10px; }
.levelup-msg  { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.7; margin-bottom: 20px; }

.reset-icon  { font-size: 34px; margin-bottom: 10px; }
.reset-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 6px; }
.reset-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold-light); margin-bottom: 14px; }
.reset-breakdown { background: var(--surface2); border: 1px solid var(--border); border-radius: 2px; padding: 11px 13px; margin-bottom: 14px; text-align: left; }
.reset-row { display: flex; justify-content: space-between; font-size: 17px; color: var(--text-dim); padding: 3px 0; }
.reset-row.highlight { color: var(--gold); }
.reset-row.highlight span:last-child { color: var(--gold-light); }
.reset-msg { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.65; margin-bottom: 16px; }
.reset-overlay-box { border-color: rgba(196,162,74,0.35); max-width: 400px; }
.reset-title { font-family: 'Cinzel', serif; font-size: 22px; color: var(--gold); margin-bottom: 16px; text-align: center; }
.reset-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.18em; text-align: center; margin-bottom: 8px; }
.reset-icon { font-size: 32px; text-align: center; margin-bottom: 10px; }

.broken-icon  { font-size: 44px; margin: 6px 0 12px; }
.broken-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--red); margin-bottom: 8px; }
.broken-msg   { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.6; margin-bottom: 16px; }
.broken-gold  { font-family: 'Cinzel', serif; font-size: 24px; color: var(--gold-light); margin-bottom: 4px; }
.broken-cost  { font-size: 15px; color: var(--text-dim); font-style: italic; margin-bottom: 16px; }

/* ══════════════════════════════════════════════
   TOAST
══════════════════════════════════════════════ */
.toast {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%) translateY(14px);
  background: var(--surface2); border: 1px solid var(--border-gold);
  color: var(--text-mid); font-family: 'Crimson Text', serif; font-size: 18px;
  padding: 9px 20px; border-radius: 2px;
  opacity: 0; pointer-events: none; z-index: 8000;
  transition: all 0.26s; white-space: nowrap;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ══════════════════════════════════════════════
   TEASERS
══════════════════════════════════════════════ */
.teasers { }
.teasers-head {
  font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.16em;
  margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
}
.teasers-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.teaser-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px,1fr)); gap: 6px; }
.teaser-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 3px; padding: 12px;
  opacity: 0.28; filter: saturate(0.15); position: relative; transition: all 0.2s;
}
.teaser-card:hover { opacity: 0.44; filter: saturate(0.28); }
.teaser-lock   { position: absolute; top: 8px; right: 10px; font-size: 14px; color: var(--text-dark); }
.teaser-icon   { font-size: 21px; margin-bottom: 4px; }
.teaser-name   { font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-mid); margin-bottom: 2px; }
.teaser-hint   { font-size: 15px; color: var(--text-dim); font-style: italic; line-height: 1.4; }
.teaser-unlock { font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 4px; }

/* ══════════════════════════════════════════════
   WEATHER STRIP (compact, inside char panel)
══════════════════════════════════════════════ */
.weather-card {
  border-radius: 2px;
  padding: 8px 11px;
  position: relative; overflow: hidden;
  transition: border-color 0.5s, background 0.5s;
  border: 1px solid var(--border);
  margin-top: 10px;
}
.weather-card.clear   { border-color: rgba(58,158,106,0.35); background: rgba(58,158,106,0.04); }
.weather-card.partial { border-color: rgba(91,143,204,0.3); }
.weather-card.stormy  { border-color: rgba(212,98,42,0.35); background: rgba(212,98,42,0.03); }
.weather-card.fog     { border-color: rgba(184,60,46,0.4); background: rgba(184,60,46,0.04); }
.weather-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  transition: background 0.5s;
}
.weather-card.clear::before   { background: linear-gradient(90deg, transparent, var(--green), transparent); }
.weather-card.partial::before { background: linear-gradient(90deg, transparent, var(--xp), transparent); }
.weather-card.stormy::before  { background: linear-gradient(90deg, transparent, var(--orange), transparent); }
.weather-card.fog::before     { background: linear-gradient(90deg, transparent, var(--red), transparent); }

.weather-inner { display: flex; align-items: center; gap: 8px; }
.weather-icon  { font-size: 18px; line-height: 1; flex-shrink: 0; }
.weather-body  { flex: 1; min-width: 0; }
.weather-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: var(--gold-dim);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.weather-desc  { font-size: 13px; color: var(--text-dim); font-style: italic; line-height: 1.3; }
.weather-xp-badge {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 2px; padding: 3px 8px;
  white-space: nowrap; flex-shrink: 0;
}
.weather-card.clear   .weather-xp-badge { color: var(--green); border-color: rgba(58,158,106,0.3); background: rgba(58,158,106,0.08); }
.weather-card.stormy  .weather-xp-badge { color: var(--orange); border-color: rgba(212,98,42,0.3); }
.weather-card.fog     .weather-xp-badge { color: var(--red); border-color: rgba(184,60,46,0.3); }

/* ══════════════════════════════════════════════
   LEFT STATS ROW
══════════════════════════════════════════════ */
.left-stats-row {
  display: flex; align-items: stretch;
  margin-top: 12px; gap: 0;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 2px; overflow: hidden;
}
.left-stat-block {
  flex: 1; padding: 10px 12px; display: flex; flex-direction: column; gap: 2px;
}
.left-stat-divider { width: 1px; background: var(--border); flex-shrink: 0; }
.left-stat-label {
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.14em;
}
.left-stat-value { font-size: 18px; }

/* ══════════════════════════════════════════════
   PARTY OVERVIEW PANEL (left col)
══════════════════════════════════════════════ */
.party-overview-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px; padding: 14px 16px;
}
.party-overview-row {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 0; border-bottom: 1px solid var(--border);
}
.party-overview-row:last-child { border-bottom: none; }
.pov-icon {
  width: 32px; height: 32px; border-radius: 3px;
  background: var(--surface2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; flex-shrink: 0;
}
.pov-icon.wounded { border-color: rgba(184,60,46,0.5); animation: woundedPulse 2s ease-in-out infinite; }
.pov-icon.done    { border-color: rgba(58,158,106,0.4); }
.pov-info { flex: 1; min-width: 0; }
.pov-name { font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pov-habit { font-size: 13px; color: var(--text-dim); font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pov-hp-bar-track {
  flex-shrink: 0; width: 60px; height: 5px;
  background: var(--border); border-radius: 100px; overflow: hidden;
}
.pov-hp-bar-fill {
  height: 100%; border-radius: 100px;
  transition: width 0.5s, background 0.3s;
}

/* ══════════════════════════════════════════════
   PARTY SIZE SELECTOR
══════════════════════════════════════════════ */
.party-size-grid {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  gap: 8px; margin-bottom: 6px;
}
.party-size-opt {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 3px; padding: 14px 10px;
  cursor: pointer; transition: all 0.2s;
  text-align: center; user-select: none;
}
.party-size-opt:hover { border-color: var(--border-mid); background: var(--surface3); }
.party-size-opt.selected { border-color: var(--gold); background: var(--surface3); border-left-width: 2px; }
.party-size-num {
  font-family: 'Cinzel', serif; font-size: 30px; color: var(--gold-light);
  line-height: 1; margin-bottom: 4px;
  text-shadow: 0 0 14px var(--gold-glow);
}
.party-size-opt:not(.selected) .party-size-num { color: var(--text-dim); text-shadow: none; }
.party-size-label { font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.1em; }
.party-size-opt:not(.selected) .party-size-label { color: var(--text-dark); }
.party-size-desc { font-size: 14px; color: var(--text-dim); font-style: italic; line-height: 1.4; }

/* Companion progress dots in habit setup step */
.companion-progress {
  display: flex; justify-content: center; gap: 6px; margin-bottom: 14px;
}
.companion-pip {
  width: 28px; height: 4px; border-radius: 100px;
  background: var(--border); transition: all 0.3s;
}
.companion-pip.done    { background: var(--gold-dim); }
.companion-pip.current { background: var(--gold); width: 36px; }

/* Begin party summary */
.begin-party-summary {
  display: flex; flex-direction: column; gap: 8px; margin-top: 14px;
}
.begin-party-row {
  display: flex; align-items: center; gap: 12px;
  background: var(--surface2); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 10px 14px;
  border-left: 3px solid var(--gold-dim);
}
.begin-party-icon { font-size: 24px; flex-shrink: 0; }
.begin-party-name { font-family: 'Cinzel', serif; font-size: 15px; color: var(--gold); margin-bottom: 2px; }
.begin-party-habit { font-size: 15px; color: var(--text-dim); font-style: italic; }

/* ══════════════════════════════════════════════
   ROAD EVENT (post check-in story beat)
══════════════════════════════════════════════ */
.road-event-overlay {
  position: fixed; inset: 0;
  background: rgba(6,4,2,0.85);
  backdrop-filter: blur(3px);
  display: flex; align-items: center; justify-content: center;
  z-index: 9998; opacity: 0; pointer-events: none;
  transition: opacity 0.28s;
}
.road-event-overlay.show { opacity: 1; pointer-events: all; }
.road-event-box {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 28px 32px;
  max-width: 400px; width: 90%; text-align: center;
  transform: scale(0.93) translateY(12px);
  transition: transform 0.32s cubic-bezier(0.34,1.56,0.64,1);
  position: relative; overflow: hidden;
}
.road-event-overlay.show .road-event-box { transform: scale(1) translateY(0); }
.road-event-box::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--teal), transparent);
}
.road-event-zone { font-family: 'Cinzel', serif; font-size: 12px; color: var(--teal); letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 10px; }
.road-event-icon  { font-size: 36px; margin-bottom: 10px; }
.road-event-title { font-family: 'Cinzel', serif; font-size: 19px; color: var(--gold); margin-bottom: 10px; }
.road-event-desc  { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.7; margin-bottom: 18px; }

/* ══════════════════════════════════════════════
   ANIMATIONS
══════════════════════════════════════════════ */
@keyframes fadeUp {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}
@keyframes slideIn {
  from { opacity:0; transform:translateX(-5px); }
  to   { opacity:1; transform:translateX(0); }
}



/* ══════════════════════════════════════════════
   /* budget-hero removed — treasury now lives inside char panel */


/* ══════════════════════════════════════════════
   TREASURY — dominant section inside char panel
══════════════════════════════════════════════ */
.treasury-section {
  background: var(--surface2);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 14px 16px;
  margin-bottom: 12px;
  position: relative;
}
.treasury-head {
  display: flex; align-items: baseline;
  justify-content: space-between;
  margin-bottom: 10px;
}
.treasury-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--gold-dim);
  text-transform: uppercase; letter-spacing: 0.2em;
}
.treasury-status {
  font-size: 15px; color: var(--text-dim); font-style: italic;
}
.treasury-status.danger  { color: var(--red); }
.treasury-status.warning { color: var(--orange); }
.treasury-status.good    { color: var(--green); }

.treasury-numbers {
  display: flex; align-items: baseline;
  gap: 7px; margin-bottom: 12px; flex-wrap: wrap;
}
.treasury-remaining {
  font-family: 'Cinzel', serif;
  font-size: 40px; line-height: 1; color: var(--gold-light);
  text-shadow: 0 0 20px var(--gold-glow);
  transition: color 0.35s;
}
.treasury-remaining.danger  { color: var(--red);    text-shadow: none; }
.treasury-remaining.warning { color: var(--orange); text-shadow: none; }
.treasury-of {
  font-size: 16px; color: var(--text-dark); font-style: italic;
}
.treasury-budget {
  font-family: 'Cinzel', serif;
  font-size: 18px; color: var(--text-dim);
}
.treasury-bar-track {
  height: 6px;
  background: var(--surface3);
  border-radius: 100px; overflow: hidden;
  margin-bottom: 6px;
}
.treasury-bar-fill {
  height: 100%; border-radius: 100px;
  background: linear-gradient(90deg, var(--gold-dim), var(--gold));
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1), background 0.35s;
}
.treasury-bar-fill.danger  { background: linear-gradient(90deg, #4a1810, var(--red)); }
.treasury-bar-fill.warning { background: linear-gradient(90deg, #4a3010, var(--orange)); }
.treasury-sub {
  font-size: 15px; color: var(--text-dark); font-style: italic;
}

/* Char panel rule (between vault and XP) */
.char-rule { height: 1px; background: var(--border); margin: 12px 0; }

/* Remove old rule/rule-label if present */
.rule       { height: 1px; background: var(--border); margin: 14px 0 10px; }
.rule-label { display: none; }


/* ══════════════════════════════════════════════
   LOG PAGINATION
══════════════════════════════════════════════ */
.log-pagination {
  display: flex; align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  border-radius: 0 0 3px 3px;
}
.log-more-btn {
  background: transparent;
  border: 1px solid var(--border-mid);
  border-radius: 2px;
  color: var(--text-dim);
  font-family: 'Cinzel', serif;
  font-size: 13px; letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 6px 14px; cursor: pointer;
  transition: all 0.2s;
}
.log-more-btn:hover { border-color: var(--border-gold); color: var(--text-mid); }
.log-more-btn:disabled {
  opacity: 0.3; cursor: default;
}
.log-pagination-count {
  font-size: 15px; color: var(--text-dark); font-style: italic;
}


/* ── Vault inline (inside treasury) ── */
.vault-inline {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 12px;
  padding: 10px 12px;
  background: rgba(0,0,0,0.25);
  border: 1px solid var(--border-gold);
  border-radius: 2px;
  border-left: 3px solid var(--gold-dim);
}
.vault-inline-left { display: flex; align-items: center; gap: 10px; }
.vault-inline-icon { font-size: 18px; line-height: 1; }
.vault-inline-name {
  font-family: 'Cinzel', serif;
  font-size: 14px; color: var(--gold-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
  margin-bottom: 2px;
}
.vault-inline-hint { font-size: 15px; color: var(--text-dark); font-style: italic; }

/* ── Map hearts label ── */
.map-hearts-block { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.map-hearts-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}

/* ── Dev tools ── */
.dev-tools {
  margin-top: 14px;
  padding: 10px 12px;
  border: 1px dashed var(--border);
  border-radius: 2px;
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
}
.dev-tools-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
  margin-right: 4px;
}
.dev-btn {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 2px;
  color: var(--text-dark);
  font-family: 'Cinzel', serif;
  font-size: 12px; letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 4px 10px; cursor: pointer;
  transition: all 0.2s;
}
.dev-btn:hover { border-color: var(--red); color: var(--red); }

/* ── Treasury over-budget ── */
.treasury-bar-fill.over {
  background: var(--red);
  width: 100% !important;
  opacity: 0.4;
}
.treasury-remaining.over { color: var(--red); }

/* ── Wounded mode ── */
.char-panel.wounded {
  border-color: rgba(184,60,46,0.35);
}
.char-panel.wounded::before {
  background: linear-gradient(90deg, transparent, rgba(184,60,46,0.25), transparent) !important;
  opacity: 1 !important;
}
.recovery-track {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid rgba(184,60,46,0.2);
}
.recovery-track.hidden { display: none; }
.recovery-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: rgba(200,80,60,0.75);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.recovery-pips { display: flex; gap: 5px; }
.recovery-pip {
  width: 18px; height: 4px; border-radius: 100px;
  background: rgba(184,60,46,0.2);
  transition: all 0.3s;
}
.recovery-pip.earned {
  background: rgba(200,80,60,0.7);
  box-shadow: 0 0 5px rgba(200,80,60,0.35);
}


/* ══════════════════════════════════════════════
   BADGE RAIL (char panel)
══════════════════════════════════════════════ */
.badge-rail {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  background: var(--surface2);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}
.badge-rail-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex: 0 0 auto;
}
.badge-connector {
  flex: 1;
  height: 1px;
  background: var(--border);
  margin: 0 4px;
  margin-bottom: 14px;
}
.badge-pip {
  width: 32px; height: 32px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--surface3);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  transition: all 0.35s;
  position: relative;
}
.badge-pip.locked {
  opacity: 0.2;
  filter: grayscale(1);
}
.badge-pip.earned {
  border-color: var(--gold);
  background: rgba(196,162,74,0.1);
  opacity: 1;
  filter: none;
  box-shadow: 0 0 8px var(--gold-glow);
}
.badge-pip.earned::after {
  content: '';
  position: absolute; inset: -3px;
  border-radius: 50%;
  border: 1px solid var(--gold-dim);
  opacity: 0.4;
}
.badge-rail-label {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  white-space: nowrap;
}

/* ══════════════════════════════════════════════
   XP BLOCK — more prominent
══════════════════════════════════════════════ */
.xp-block {
  margin-top: 12px;
}
.xp-label-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 6px;
}
.xp-label {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.14em;
}
.xp-nums {
  font-size: 17px;
  color: var(--text-dim);
}
.xp-nums strong {
  color: var(--xp);
  font-family: 'Cinzel', serif;
  font-size: 22px;
}
.xp-bar-track {
  height: 10px;
  background: var(--surface2);
  border-radius: 100px;
  overflow: hidden;
  border: 1px solid var(--border);
}
.xp-bar-fill {
  height: 100%; border-radius: 100px;
  background: linear-gradient(90deg, var(--xp-dim), var(--xp));
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1);
  min-width: 0;
}
.xp-bar-fill.pulse { animation: barPulse 0.6s ease; }
.xp-sub {
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
  font-size: 15px;
  color: var(--text-dark);
  font-style: italic;
}

.ob-budget-hint {
  text-align: center; margin-top: 10px;
  font-size: 15px; color: var(--text-dark);
  font-style: italic;
}
.streak-right-col { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.streak-best { font-size: 13px; color: var(--text-dark); font-style: italic; }

/* ══════════════════════════════════════════════
   ONBOARDING — habit input + cadence + class grid
══════════════════════════════════════════════ */
.habit-examples {
  display: flex; flex-wrap: wrap; gap: 6px;
  justify-content: center; margin-bottom: 14px;
}
.habit-example-btn {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 100px; color: var(--text-dim);
  font-family: 'Crimson Text', serif; font-size: 16px;
  padding: 5px 14px; cursor: pointer; transition: all 0.2s;
}
.habit-example-btn:hover { border-color: var(--border-gold); color: var(--text-mid); }
.habit-input-row { display: flex; max-width: 420px; margin: 0 auto; }
.habit-input-row .hero-name-input { border-radius: 2px; text-align: center; }

.suggested-class-card {
  display: flex; align-items: center; gap: 14px;
  background: var(--surface2); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 14px 16px; margin-bottom: 4px;
  border-left: 3px solid var(--gold-dim);
}
.suggested-class-icon { font-size: 32px; flex-shrink: 0; }
.suggested-class-name {
  font-family: 'Cinzel', serif; font-size: 18px; color: var(--gold); margin-bottom: 3px;
}
.suggested-class-desc { font-size: 16px; color: var(--text-dim); font-style: italic; margin-bottom: 4px; }
.suggested-class-trait {
  font-size: 12px; color: var(--xp); text-transform: uppercase; letter-spacing: 0.1em;
  background: rgba(91,143,204,0.1); border: 1px solid rgba(91,143,204,0.2);
  padding: 2px 8px; border-radius: 2px; display: inline-block;
}

.cadence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.cadence-opt {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 3px; padding: 14px; cursor: pointer; transition: all 0.2s;
  text-align: center; user-select: none;
}
.cadence-opt:hover { border-color: var(--border-mid); }
.cadence-opt.selected { border-color: var(--gold); background: var(--surface3); }
.cadence-icon { font-size: 24px; margin-bottom: 6px; }
.cadence-label { font-family: 'Cinzel', serif; font-size: 15px; color: var(--gold); margin-bottom: 4px; }
.cadence-desc  { font-size: 15px; color: var(--text-dim); font-style: italic; line-height: 1.4; }

.weekly-target-row {
  display: flex; align-items: center; justify-content: center; gap: 12px;
  padding: 10px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 3px; margin-bottom: 6px;
}
.weekly-target-row.hidden { display: none; }
.weekly-target-label {
  font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.weekly-target-btns { display: flex; gap: 6px; }
.wt-btn {
  background: var(--surface3); border: 1px solid var(--border-mid);
  border-radius: 2px; color: var(--text-dim);
  font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 0.08em;
  padding: 6px 14px; cursor: pointer; transition: all 0.2s;
}
.wt-btn.selected { border-color: var(--gold); color: var(--gold); background: var(--surface3); }
.wt-btn:hover { border-color: var(--border-gold); }

.begin-summary {
  background: var(--surface2); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 14px 16px;
  display: flex; align-items: center; gap: 14px;
  border-left: 3px solid var(--gold-dim);
  margin-top: 10px;
}
.begin-sum-icon { font-size: 32px; flex-shrink: 0; }
.begin-sum-name { font-family: 'Cinzel', serif; font-size: 17px; color: var(--gold); margin-bottom: 3px; }
.begin-sum-habit { font-size: 17px; color: var(--text-dim); font-style: italic; margin-bottom: 3px; }
.begin-sum-cadence { font-size: 15px; color: var(--text-dark); }

.char-card-cadence-tag {
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em; margin-top: 3px;
}
.char-card-weekly-progress {
  display: flex; gap: 4px; margin-top: 5px; align-items: center;
}
.weekly-pip {
  width: 14px; height: 4px; border-radius: 100px;
  background: var(--border); transition: all 0.3s;
}
.weekly-pip.done { background: var(--teal); box-shadow: 0 0 4px var(--teal-glow); }
.weekly-pip-label {
  font-size: 13px; color: var(--text-dark); font-style: italic; margin-left: 4px;
}

/* ══════════════════════════════════════════════
   PARTY PANEL + CHARACTER CARDS
══════════════════════════════════════════════ */
.party-panel {
  background: var(--surface); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 18px;
  position: relative; overflow: hidden;
}
.party-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.party-cards { display: flex; flex-direction: column; gap: 12px; }

.char-card {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 3px; overflow: hidden;
  transition: border-color 0.3s;
}
.char-card.checked-in { border-color: rgba(58,158,106,0.45); }
.char-card.wounded    { border-color: rgba(184,60,46,0.4); }
.char-card.collapsed  { border-color: rgba(184,60,46,0.6); box-shadow: 0 0 12px rgba(184,60,46,0.1); }

/* Card header row: icon | class+habit | hp hearts */
.char-card-top {
  display: grid; grid-template-columns: 52px 1fr auto;
  gap: 12px; align-items: center; padding: 14px 16px 10px;
}
.char-card-avatar {
  width: 52px; height: 52px; border-radius: 3px;
  background: var(--surface3); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; flex-shrink: 0; position: relative;
}
.char-card-avatar.low-hp::after {
  content: ''; position: absolute; inset: 0; border-radius: 3px;
  border: 2px solid rgba(184,60,46,0.6);
  animation: woundedPulse 2s ease-in-out infinite;
}
@keyframes woundedPulse { 0%,100%{opacity:0.5} 50%{opacity:1} }

.char-card-info { min-width: 0; }
.char-card-name {
  font-family: 'Cinzel', serif; font-size: 16px; color: var(--gold);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px;
}
.char-card-habit {
  font-size: 14px; color: var(--text-mid); font-style: italic; line-height: 1.35;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.char-card-streak { font-size: 13px; color: var(--text-dark); margin-top: 2px; }

/* HP hearts — right side of header */
.char-card-hp-hearts {
  flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 3px;
}
.hp-hearts-row { display: flex; gap: 2px; }
.hp-heart { font-size: 14px; line-height: 1; transition: all 0.3s; }
.hp-heart.empty { opacity: 0.2; filter: grayscale(1); }
.hp-hearts-label {
  font-family: 'Cinzel', serif; font-size: 10px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em;
}

/* HP bar (below header, thinner) */
.char-card-hp {
  padding: 0 16px 10px;
}
.char-hp-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 4px;
}
.char-hp-label {
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.char-hp-pips { display: flex; gap: 4px; }
.char-hp-pip {
  width: 20px; height: 6px; border-radius: 100px;
  background: var(--border); transition: all 0.4s;
}
.char-hp-pip.full  { background: var(--green); box-shadow: 0 0 4px rgba(58,158,106,0.4); }
.char-hp-pip.low   { background: var(--orange); }
.char-hp-pip.crit  { background: var(--red); animation: critPip 1.5s ease-in-out infinite; }
@keyframes critPip { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* Check-in button area */
.char-card-action { padding: 0 16px 14px; }
.checkin-btn {
  width: 100%; padding: 10px 14px;
  background: var(--gold-dim); border: 1px solid var(--gold-dim);
  border-radius: 2px; color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 0.1em;
  cursor: pointer; transition: all 0.2s;
}
.checkin-btn:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.checkin-btn.done {
  background: rgba(58,158,106,0.08); border-color: rgba(58,158,106,0.45);
  color: var(--green); cursor: default;
}
.checkin-btn.done:hover { background: rgba(58,158,106,0.08); border-color: rgba(58,158,106,0.45); color: var(--green); }

/* Goblin special — amount input inside card */
.goblin-checkin { display: flex; gap: 6px; }
.goblin-limit-display {
  font-size: 14px; color: var(--text-dark); font-style: italic; margin-bottom: 6px;
}

/* Collapsed state indicator */
.char-card-collapsed-bar {
  display: none; padding: 8px 16px;
  background: rgba(184,60,46,0.06);
  border-top: 1px solid rgba(184,60,46,0.2);
}
.char-card.collapsed .char-card-collapsed-bar { display: block; }
.collapsed-msg { font-size: 15px; color: rgba(184,60,46,0.8); font-style: italic; }

/* Add character button */
.add-char-wrap { margin-top: 10px; }
.add-char-wrap.hidden { display: none; }
.add-char-btn {
  width: 100%; padding: 10px; background: transparent;
  border: 1px dashed var(--border-mid); border-radius: 3px;
  color: var(--text-dark); font-family: 'Cinzel', serif;
  font-size: 13px; letter-spacing: 0.08em; text-transform: uppercase;
  cursor: pointer; transition: all 0.2s;
}
.add-char-btn:hover { border-color: var(--gold-dim); color: var(--text-mid); }

/* Chronicle entry update — show character name not amount */
.log-char-name {
  font-size: 14px; color: var(--text-dark); font-style: italic; margin-top: 1px;
}
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-brand">
      <div class="header-sigil">⚔</div>
      <div>
        <h1>Habit Quest</h1>
        <div class="header-tagline">Your habits are your legend.</div>
      </div>
    </div>
    <div id="header-auth" class="header-auth" style="display:none;">
      <span class="header-auth-email" id="header-email"></span>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- ── LOGIN ── -->
  <div id="login-screen" style="display:none;">
    <div class="login-hero">
      <div class="login-hero-icon">⚔</div>
      <div class="login-title">Welcome Back, Hero</div>
      <div class="login-sub">Build your habits. Level up. Reach the Iron Keep.</div>
    </div>
    <div class="card" style="max-width:420px;margin:0 auto;">
      <div class="card-accent-top"></div>

      <!-- Password login -->
      <div id="login-password-panel">
        <div id="login-form-password">
          <div class="form-field">
            <label class="field-label">Email</label>
            <input class="field-input" id="login-email-pw" type="email" placeholder="your@email.com" autocomplete="email">
          </div>
          <div class="form-field">
            <label class="field-label">Password</label>
            <input class="field-input" id="login-password" type="password" placeholder="Password" autocomplete="current-password">
          </div>
          <button class="btn-primary" onclick="signInWithPassword()">Enter the Realm ⚔</button>
          <div id="login-error-pw" class="login-err"></div>
        </div>
      </div>



    </div>
  </div>

  <!-- ── ONBOARDING ── -->
  <div id="onboarding" style="display: none;">
    <div class="ob-card">

      <div class="steps-row" id="steps-row">
        <div class="step-dot active" id="dot-0"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-1"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-3"></div>
        <div class="step-line"></div>
        <div class="step-dot" id="dot-4"></div>
      </div>

      <!-- Step 0: Party Leader Name -->
      <div class="ob-step active" id="step-0">
        <div class="ob-icon">⚔️</div>
        <div class="ob-title">Name Your Party Leader</div>
        <div class="ob-sub">You lead this party. The champions fight for you. What do they call you on the road?</div>
        <div class="name-row">
          <input class="hero-name-input" id="hero-name-input" type="text" placeholder="Your name…" maxlength="24" autocomplete="off" oninput="onNameInput()">
          <button class="name-btn" id="name-next-btn" onclick="goStep('1-race')" disabled>Onward →</button>
        </div>
      </div>

      <!-- Step 1: Avatar / Race -->
      <div class="ob-step" id="step-1-race">
        <div class="ob-icon">🪞</div>
        <div class="ob-title">Choose Your Form</div>
        <div class="ob-sub">The road ahead is long. Choose the face that will meet it.</div>
        <div class="avatar-grid" id="avatar-grid">
          <div class="avatar-opt selected" data-avatar="🧔" onclick="selectAvatar(this)">
            <div class="avatar-opt-icon">🧔</div>
            <div class="avatar-opt-label">Human</div>
          </div>
          <div class="avatar-opt" data-avatar="🧝" onclick="selectAvatar(this)">
            <div class="avatar-opt-icon">🧝</div>
            <div class="avatar-opt-label">Elf</div>
          </div>
          <div class="avatar-opt" data-avatar="👺" onclick="selectAvatar(this)">
            <div class="avatar-opt-icon">👺</div>
            <div class="avatar-opt-label">Orc</div>
          </div>
          <div class="avatar-opt" data-avatar="🧙" onclick="selectAvatar(this)">
            <div class="avatar-opt-icon">🧙</div>
            <div class="avatar-opt-label">Wizard</div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep(0)">← Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep(2)">Choose Your Champions →</button>
        </div>
      </div>

      <!-- Step 2: Party Size -->
      <div class="ob-step" id="step-2">
        <div class="ob-icon">🗡️</div>
        <div class="ob-title">How Many Champions?</div>
        <div class="ob-sub">Each champion is a habit you want to build. They grow stronger when you show up for them every day.</div>
        <div class="party-size-grid">
          <div class="party-size-opt" data-size="1" onclick="selectPartySize(this, 1)">
            <div class="party-size-num">1</div>
            <div class="party-size-label">Solo</div>
            <div class="party-size-desc">Start focused. One habit, all your attention.</div>
          </div>
          <div class="party-size-opt" data-size="2" onclick="selectPartySize(this, 2)">
            <div class="party-size-num">2</div>
            <div class="party-size-label">Pair</div>
            <div class="party-size-desc">Two commitments. Double the stakes.</div>
          </div>
          <div class="party-size-opt selected" data-size="3" onclick="selectPartySize(this, 3)">
            <div class="party-size-num">3</div>
            <div class="party-size-label">Party</div>
            <div class="party-size-desc">The classic three. Most travelers carry this many.</div>
          </div>
        </div>
        <div class="ob-nav" style="margin-top:18px;">
          <button class="btn-secondary" onclick="goStep('1-race')">← Back</button>
          <button class="btn-primary" style="width:auto;" id="party-size-next-btn" onclick="startCompanionSetup()">Enlist My Champions →</button>
        </div>
      </div>

      <!-- Step 3: Companion habit setup (dynamic, repeats per companion) -->
      <div class="ob-step" id="step-habit">
        <div class="ob-icon" id="companion-setup-icon">🧭</div>
        <div class="ob-title" id="companion-setup-title">First Champion's Quest</div>
        <div class="ob-sub" id="companion-setup-sub">What habit will this champion embody? Name it plainly — when you show up for it, they grow stronger.</div>
        <div class="companion-progress" id="companion-progress">
          <!-- dots showing companion 1 of N -->
        </div>
        <div class="habit-examples" id="habit-examples-dynamic">
          <button class="habit-example-btn" onclick="setHabitExample(this)">Drink more water</button>
          <button class="habit-example-btn" onclick="setHabitExample(this)">Read every day</button>
          <button class="habit-example-btn" onclick="setHabitExample(this)">Exercise regularly</button>
          <button class="habit-example-btn" onclick="setHabitExample(this)">Journal daily</button>
          <button class="habit-example-btn" onclick="setHabitExample(this)">Track spending under $50/day</button>
          <button class="habit-example-btn" onclick="setHabitExample(this)">Meditate</button>
        </div>
        <div class="habit-input-row">
          <input class="hero-name-input" id="habit-input" type="text" placeholder="e.g. Sleep 8 hours every night…" maxlength="60" autocomplete="off" oninput="onHabitInput()">
        </div>
        <div class="ob-nav" style="margin-top:18px;">
          <button class="btn-secondary" id="habit-back-btn" onclick="habitBack()">← Back</button>
          <button class="btn-primary" style="width:auto;" id="habit-next-btn" onclick="goToClassStep()" disabled>Assign Champion →</button>
        </div>
      </div>

      <!-- Step 3b: Cadence -->
      <div class="ob-step" id="step-cadence">
        <div class="ob-icon" id="cadence-setup-icon">📅</div>
        <div class="ob-title">How Often?</div>
        <div class="ob-sub">Set the tempo for this champion. This determines when they lose health if you fall behind.</div>
        <div class="cadence-grid">
          <div class="cadence-opt selected" id="cad-daily" onclick="selectCadence('daily')">
            <div class="cadence-icon">🔁</div>
            <div class="cadence-label">Every Day</div>
            <div class="cadence-desc">Miss a day → lose a heart. Best for habits you can do any day.</div>
          </div>
          <div class="cadence-opt" id="cad-weekly" onclick="selectCadence('weekly')">
            <div class="cadence-icon">📆</div>
            <div class="cadence-label">A Few Times a Week</div>
            <div class="cadence-desc">No daily penalty. Miss your weekly target → lose a heart at week's end.</div>
          </div>
        </div>
        <div class="weekly-target-row hidden" id="weekly-target-row">
          <div class="weekly-target-label">Target days per week</div>
          <div class="weekly-target-btns">
            <button class="wt-btn" data-n="2" onclick="selectWeeklyTarget(this)">2×</button>
            <button class="wt-btn selected" data-n="3" onclick="selectWeeklyTarget(this)">3×</button>
            <button class="wt-btn" data-n="4" onclick="selectWeeklyTarget(this)">4×</button>
            <button class="wt-btn" data-n="5" onclick="selectWeeklyTarget(this)">5×</button>
          </div>
        </div>
        <div class="ob-nav" style="margin-top:18px;">
          <button class="btn-secondary" onclick="goStep('habit')">← Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep('class')">Choose Their Class →</button>
        </div>
      </div>

      <!-- Step 4: Class suggestion -->
      <div class="ob-step" id="step-class">
        <div class="ob-icon" id="ob-suggest-icon">🏹</div>
        <div class="ob-title">Choose Their Class</div>
        <div class="ob-sub" id="ob-suggest-sub">Based on their quest, we suggest this class. Change it if you see it differently.</div>
        <div class="suggested-class-card" id="suggested-class-card">
          <div class="suggested-class-icon" id="sc-icon">🏹</div>
          <div class="suggested-class-body">
            <div class="suggested-class-name" id="sc-name">The Mage</div>
            <div class="suggested-class-desc" id="sc-desc">Daily practice habits — reading, journaling, meditation.</div>
            <div class="suggested-class-trait" id="sc-trait">Discipline & Practice</div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep('cadence')">← Back</button>
          <button class="btn-primary" style="width:auto;" id="confirm-class-btn" onclick="confirmCompanionClass()">This is my champion →</button>
        </div>
      </div>

      <!-- Step 5: Laws -->
      <div class="ob-step" id="step-laws">
        <div class="ob-icon">📜</div>
        <div class="ob-title">The Laws of the Road</div>
        <div class="ob-sub">Five rules that govern every traveler toward the Iron Keep.</div>
        <div class="laws-grid">
          <div class="law-card">
            <div class="law-icon">✦</div>
            <div class="law-body">
              <div class="law-title">Check in → earn XP</div>
              <div class="law-plain">Show up for a habit and your champion earns experience. Daily or weekly — the act of showing up is what counts.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">🔥</div>
            <div class="law-body">
              <div class="law-title">Consistency forges your streak</div>
              <div class="law-plain">Daily champions build day streaks. Weekly champions build week streaks. Both multiply your XP the longer you hold them.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">❤️</div>
            <div class="law-body">
              <div class="law-title">Champions have 5 HP</div>
              <div class="law-plain">Daily champions lose a heart for every missed day. Weekly champions lose a heart if they miss their weekly target. Recovery is earned back one check-in at a time.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">🌦️</div>
            <div class="law-body">
              <div class="law-title">The weather reflects your party</div>
              <div class="law-plain">Check in all your champions and the road clears. Leave them waiting and the skies darken — a reminder, not a punishment.</div>
            </div>
          </div>
          <div class="law-card">
            <div class="law-icon">👝</div>
            <div class="law-body">
              <div class="law-title">Face encounters → spend Road Gold</div>
              <div class="law-plain">Road Gold absorbs hostile encounters on the map. Earn it from friendly ones — and guard it well.</div>
            </div>
          </div>
        </div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep('habit')">← Back</button>
          <button class="btn-primary" style="width:auto;" onclick="goStep('begin')">Begin the Journey →</button>
        </div>
      </div>

      <!-- Step 6: Begin -->
      <div class="ob-step" id="step-begin">
        <div class="ob-icon">🏰</div>
        <div class="ob-title">The Road Awaits</div>
        <div class="ob-sub">Your party is assembled. You set out from Hearthstone Village. The Iron Keep is far — but closer every day you show up.</div>
        <div class="begin-party-summary" id="begin-party-summary"><!-- populated by JS --></div>
        <button class="btn-primary" style="margin-top:20px;" onclick="beginJourney()">Enter the Road ⚔</button>
        <div class="ob-nav" style="margin-top:10px;">
          <button class="btn-secondary" onclick="goStep('laws')">← Back</button>
        </div>
      </div>

    </div>
  </div><!-- /onboarding -->

  <!-- ── MAIN ── -->
  <div id="main" style="display: block;">
    <div class="layout">

      <!-- LEFT COLUMN — traveler panel (with weather strip) -->
      <div class="col-left">
        <div class="char-panel" id="char-panel-main">
          <div class="char-identity">
            <div class="char-avatar" id="char-avatar">🧙</div>
            <div style="flex:1;min-width:0;">
              <div class="char-name" id="char-name">Traveler</div>
              <div class="char-class" id="char-class">Novice</div>
            </div>
            <div class="char-level-badge">
              <div class="level-num" id="level-num">1</div>
              <div class="level-label">Level</div>
            </div>
          </div>

          <div class="xp-block">
            <div class="xp-label-row">
              <span class="xp-label">✦ Experience</span>
              <span class="xp-nums"><strong id="xp-current">0</strong> / <span id="xp-next-val">80</span> xp</span>
            </div>
            <div class="xp-bar-track">
              <div class="xp-bar-fill" id="xp-fill" style="width:0%"></div>
            </div>
            <div class="xp-sub">
              <span id="xp-bonus-msg-hidden" style="display:none;"></span>
              <span id="xp-next-msg">80 XP to Level 2</span>
            </div>
          </div>

          <!-- Road Gold + Streak compact row -->
          <div class="left-stats-row">
            <div class="left-stat-block">
              <div class="left-stat-label">Road Gold</div>
              <div class="left-stat-value" id="vault-amount" style="color:var(--gold);font-family:Cinzel,serif;font-size:20px;">0 💰</div>
            </div>
            <div class="left-stat-divider"></div>
            <div class="left-stat-block">
              <div class="left-stat-label">Streak</div>
              <div class="left-stat-value" style="display:flex;align-items:center;gap:5px;">
                <span id="streak-banner-flame" style="font-size:18px;">🔥</span>
                <span id="streak-count" style="font-family:Cinzel,serif;font-size:22px;color:var(--orange);">0</span>
              </div>
              <div style="font-size:13px;color:var(--text-dark);font-style:italic;" id="streak-banner-right">Start today</div>
            </div>
          </div>

          <!-- Weather strip — compact mood indicator -->
          <div class="weather-card partial" id="weather-card">
            <div class="weather-inner">
              <div class="weather-icon" id="weather-icon">⛅</div>
              <div class="weather-body">
                <div class="weather-label" id="weather-label">The Road Awaits</div>
                <div class="weather-desc" id="weather-desc">Check in to see what lies ahead.</div>
              </div>
              <div class="weather-xp-badge" id="weather-xp-badge" style="display:none;">—</div>
            </div>
          </div>

          <div class="dev-tools" id="dev-tools">
            <span class="dev-tools-label">Dev</span>
            <button class="dev-btn" onclick="devWipeLog()">Wipe</button>
            <button class="dev-btn" onclick="devWipeStreak()">Streak</button>
            <button class="dev-btn" onclick="devWipeLevel()">Level</button>
            <button class="dev-btn" onclick="devRestart()">Restart</button>
            <button class="dev-btn" onclick="devSimMiss()">Miss</button>
          </div>
          <div class="gold-float" id="gold-float"></div>

          <!-- hidden compat stubs -->
          <span id="streak-label" style="display:none;"></span>
          <span id="streak-best" style="display:none;"></span>
          <span id="xp-bonus-msg" style="display:none;"></span>
        </div>

        <!-- hidden compat stubs for party overview -->
        <div id="party-overview-panel" style="display:none;">
          <div id="party-overview-cards"></div>
        </div>

      </div><!-- /col-left -->

      <!-- RIGHT COLUMN — check-in cards + map -->
      <div class="col-right">

        <div class="party-panel">
          <div class="panel-head">Today's Quests</div>
          <div class="party-cards" id="party-cards"></div>
          <div class="add-char-wrap hidden" id="add-char-wrap">
            <button class="add-char-btn" onclick="showAddCharacter()">+ Recruit a new companion</button>
          </div>
        </div>

        <!-- Map panel -->
        <div class="map-panel" id="map-section">
          <div class="map-panel-head">
            <div class="map-loc-block">
              <span class="map-section-label">⚔ The Journey</span>
              <span class="map-current-loc" id="map-location-name">Hearthstone Village</span>
              <span class="map-zone-tag" id="map-zone-tag">Zone I — The Hearthstone Road</span>
            </div>
            <div class="map-right-col">
              <div class="map-hearts-block">
                <div class="map-hearts-label">Road Gold</div>
                <div class="map-hearts" style="font-family:Cinzel,serif;font-size:15px;color:var(--gold);" id="map-gold-display">0 💰</div>
              </div>
            </div>
          </div>
          <div class="badge-rail">
            <div class="badge-rail-item" id="badge-zone1"><div class="badge-pip locked">🛡️</div><div class="badge-rail-label">Zone I</div></div>
            <div class="badge-connector"></div>
            <div class="badge-rail-item" id="badge-zone2"><div class="badge-pip locked">🪙</div><div class="badge-rail-label">Zone II</div></div>
            <div class="badge-connector"></div>
            <div class="badge-rail-item" id="badge-zone3"><div class="badge-pip locked">🌿</div><div class="badge-rail-label">Zone III</div></div>
            <div class="badge-connector"></div>
            <div class="badge-rail-item" id="badge-zone4"><div class="badge-pip locked">🔒</div><div class="badge-rail-label">Iron Keep</div></div>
          </div>
          <div class="map-viewport" id="map-viewport">
            <div class="node-map" id="node-map">
              <svg id="map-svg" xmlns="http://www.w3.org/2000/svg"></svg>
              <div class="node-map-inner" id="node-map-inner"></div>
            </div>
            <div class="map-more-arrow hidden" id="map-more-arrow"><span>more ahead</span><span>▼</span></div>
          </div>
          <div class="road-bonus-track">
            <span class="road-bonus-label" id="road-bonus-label">Road Bonus — check in 5 days this week</span>
            <div class="road-bonus-pips">
              <div class="road-pip" id="road-pip-1"></div>
              <div class="road-pip" id="road-pip-2"></div>
              <div class="road-pip" id="road-pip-3"></div>
            </div>
          </div>
        </div>

      </div><!-- /col-right -->

      <!-- Hidden stubs for JS compat -->
      <div id="log-list" style="display:none;"></div>
      <div id="log-pagination" style="display:none;"></div>
      <span id="log-pagination-count" style="display:none;"></span>
      <button id="log-more-btn" style="display:none;"></button>
      <button id="log-collapse-btn" style="display:none;"></button>
      <span id="streak-banner" style="display:none;"></span>

    </div><!-- /layout -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- XP Float -->
<div class="xp-float" id="xp-float"></div>

<!-- Coin Float -->
<div class="coin-float" id="coin-float"></div>


<!-- Broken / 0-Hearts Overlay -->
<div class="overlay" id="broken-overlay">
  <div class="overlay-box broken" style="max-width:380px;">
    <div class="broken-icon">💀</div>
    <div class="broken-title">Fallen</div>
    <div class="broken-msg">Your champion has fallen — HP at zero. Each check-in restores 1 HP. Keep showing up and they recover, one day at a time.</div>
    <div class="broken-gold" id="broken-gold-display">0 🪙</div>
    <div class="broken-cost">Road Gold balance</div>
    <div id="broken-choices"></div>
  </div>
</div>

<!-- Level Up Overlay -->
<div class="overlay" id="levelup-overlay">
  <div class="overlay-box levelup">
    <div class="levelup-sparkles">✦ ✧ ✦</div>
    <div class="levelup-label">Level Up!</div>
    <div class="levelup-num" id="lu-level">2</div>
    <div class="levelup-rank" id="lu-rank">Apprentice</div>
    <div class="levelup-msg" id="lu-msg">Your discipline grows. The realm takes notice.</div>
    <button class="overlay-btn primary-choice" onclick="closeLevelUp()" style="width:100%;text-align:center;">Continue the Quest ✦</button>
  </div>
</div>

<!-- Encounter Overlay -->
<div class="overlay" id="encounter-overlay">
  <div class="overlay-box" id="encounter-box">
    <div class="overlay-zone-label" id="encounter-zone">Encounter</div>
    <div class="overlay-icon" id="encounter-icon">⚔️</div>
    <div class="overlay-title" id="encounter-title">Bandits on the Road</div>
    <div class="overlay-desc" id="encounter-desc">A band of cutpurses blocks your path.</div>
    <div class="overlay-choices" id="encounter-choices"></div>
  </div>
</div>

<!-- Road Event Overlay (post check-in story beat) -->
<div class="road-event-overlay" id="road-event-overlay">
  <div class="road-event-box">
    <div class="road-event-zone" id="re-zone">✦ The Road</div>
    <div class="road-event-icon" id="re-icon">🌄</div>
    <div class="road-event-title" id="re-title">The Road Speaks</div>
    <div class="road-event-desc" id="re-desc">Something stirs on the path ahead.</div>
    <button class="overlay-btn primary-choice" onclick="closeRoadEvent()" style="width:100%;text-align:center;">Keep Moving ⚔</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ─────────────────────────
//  CONSTANTS
// ─────────────────────────
var SAVE_KEY = 'bq_v2';

// Cumulative XP to reach each level (index = level - 1)
var LEVEL_XP = [0, 80, 200, 370, 600, 900, 1270, 1720, 2260, 3000, 4000];

// ─────────────────────────
//  CLASS DEFINITIONS
// ─────────────────────────
var CLASS_DEFS = {
  Warrior: {
    icon: '\u2694\uFE0F', name: 'The Warrior', trait: 'Strength & Movement',
    desc: 'Physical output habits — exercise, workouts, steps, sport, movement.',
    hpRule: 'standard',
    habitExamples: 'Exercise 30 min / Walk 8,000 steps / Go to the gym / Train'
  },
  Cleric: {
    icon: '\u2764\uFE0F\u200D\uD83E\uDE79', name: 'The Cleric', trait: 'Recovery & Body',
    desc: 'Body and recovery habits — sleep, water, nutrition, health, self-care.',
    hpRule: 'standard',
    habitExamples: 'Sleep 8 hours / Drink water / Eat well / Take medication'
  },
  Mage: {
    icon: '\uD83D\uDD2E', name: 'The Mage', trait: 'Knowledge & Craft',
    desc: 'Learning and creative habits — reading, writing, studying, building, creating.',
    hpRule: 'standard',
    habitExamples: 'Read 20 pages / Study / Journal / Learn a language / Work on a project'
  },
  Rogue: {
    icon: '\uD83D\uDDE1\uFE0F', name: 'The Rogue', trait: 'Discipline & Restraint',
    desc: 'Restraint and mindfulness habits — limits, spending, screen time, things to stop or avoid.',
    hpRule: 'ranger',
    habitExamples: 'Stay under $50/day / No social media before 9am / Meditate / No alcohol'
  }
};

// Keyword → suggested class for smart onboarding
var CLASS_KEYWORDS = {
  Warrior: ['exercise','workout','gym','run','running','walk','steps','lift','yoga','swim','bike','cycling','train','cardio','push','pull','squat','hike','sport','weights','jog','fitnes','movement','active'],
  Cleric:  ['sleep','water','drink','hydrat','medication','medicine','vitamin','rest','recovery','health','eat','diet','nutrition','meal','calori','fast','stretch','posture','skin','nap','body'],
  Mage:    ['read','book','study','learn','language','code','program','write','writing','journal','blog','course','skill','class','project','build','creat','draw','paint','music','instrument','guitar','piano','practice','lesson','research'],
  Rogue:   ['spend','budget','money','dollar','buy','purchase','saving','finance','expense','track','under','cost','price','debt','frugal','allowance','no ','avoid','limit','stop','quit','cut','less','reduce','screen','social media','alcohol','sugar','caffeine','smoking','meditat','mindful','gratitude','focus','phone']
};

// Suggest a class from habit description text
function suggestClass(text) {
  var lower = text.toLowerCase();
  var scores = { Warrior: 0, Cleric: 0, Mage: 0, Rogue: 0 };
  Object.keys(CLASS_KEYWORDS).forEach(function(cls) {
    CLASS_KEYWORDS[cls].forEach(function(kw) {
      if (lower.indexOf(kw) !== -1) scores[cls]++;
    });
  });
  var best = null, bestScore = 0;
  Object.keys(scores).forEach(function(cls) {
    if (scores[cls] > bestScore) { bestScore = scores[cls]; best = cls; }
  });
  return best || 'Mage';
}

var CLASS_TITLES = {
  Warrior: ['Novice Fighter','Sworn Blade','Iron Will','Battle-Hardened','Warlord'],
  Cleric:  ['Novice Mender','Wound Closer','Recovery Sage','Body Keeper','Grand Cleric'],
  Mage:    ['Novice Archivist','Apprentice Mage','Scroll Keeper','Lore Binder','Elder Mage'],
  Rogue:   ['Novice Shadow','Discipline Seeker','Edge Walker','Iron Mind','Master Rogue'],
};

var LEVEL_MSGS = [
  'Level two. Streak intact. The road is just getting started.',
  'Your habit is forming. That is harder than it sounds.',
  'Three levels in and you are still logging. Most people have quit by now.',
  'Merchants are starting to recognise someone who knows their numbers.',
  'Halfway there. Your Road Gold is watching.',
  'You\'re building something real here. Keep going.',
  'Clean logs, intact budget, growing streak. This is what mastery looks like.',
  'You have come further than most travellers ever get. That is not nothing.',
  'Top tier. Your ledger speaks for itself at this point.',
  'Maximum rank. The Iron Keep knows your name.',
];

var LOG_ICONS = ['💰','🛒','🍖','🧪','⚔️','📜','🐎','🏰','🔮','💎','🌿','🎒'];

// ─────────────────────────
//  MAP DATA
// ─────────────────────────
var MAP_WAYPOINTS = [
  // Zone 1 — The Hearthstone Road (levels 1-3)
  { id: 0,  icon: '🏘️', name: 'Hearthstone\nVillage',  zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve arrived at Hearthstone Village. First stop on a long road. Show up for your habit today — that\'s the whole game, and it starts here.' },
  { id: 1,  icon: '🌾', name: 'Harvest\nCrossing',      zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve reached Harvest Crossing. Three guilds are in a six-year dispute over a single oak tree. You check in with your habit and keep walking. Clarity is a competitive advantage.' },
  { id: 2,  icon: '🪨', name: 'Stonepath\nMill',        zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve arrived at Stonepath Mill. The miller here keeps the tightest operation on the road — no shortcuts, no exceptions. You recognize the discipline. It looks a lot like yours.' },
  { id: 'z1', icon: '🛡️', name: 'Zone Badge',          zone: 'badge1', badge: 'zone1', zoneName: 'The Hearthstone Road',
    zoneComplete: 'Hearthstone Road: done. First zone cleared. The habit held. You move on.' },
  // Zone 2 — The Midlands (levels 4-6)
  { id: 3,  icon: '🏪', name: "Merchant's\nGate",       zone: 2, zoneName: 'The Midlands',
    arrival: 'You\'ve arrived at Merchant\'s Gate. Distractions in every direction. Your champion doesn\'t blink. The check-in is already done. On to the next.' },
  { id: 4,  icon: '🌉', name: 'Copperbridge',           zone: 2, zoneName: 'The Midlands',
    arrival: 'You\'ve arrived at Copperbridge. Travelers here always seem to be renegotiating something — plans, intentions, excuses. You\'ve already done yours for the day. That\'s what moves you forward.' },
  { id: 5,  icon: '⛺', name: "Trader's\nCamp",         zone: 2, zoneName: 'The Midlands',
    arrival: 'You\'ve arrived at Trader\'s Camp. Half the people here are heading into the Thornwood. Half just came out. The ones who made it through have a certain quiet look. You\'re starting to recognize it in yourself.' },
  { id: 'z2', icon: '🪙', name: 'Zone Badge',          zone: 'badge2', badge: 'zone2', zoneName: 'The Midlands',
    zoneComplete: 'Midlands cleared. Distraction, detour, temptation — all passed. The road narrows now. Good.' },
  // Zone 3 — The Thornwood (levels 7-9)
  { id: 6,  icon: '🌲', name: 'Thornwood\nEdge',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve entered the Thornwood. It\'s quiet here — the kind that asks something of you. You check in. That\'s the answer.' },
  { id: 7,  icon: '🌑', name: 'Darkhollow\nPath',       zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve reached Darkhollow Path. The road narrows. So does the question: are you still showing up? You are. That\'s enough.' },
  { id: 8,  icon: '🌸', name: 'Wayward\nShrine',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve found the Wayward Shrine. Travelers leave things here — tokens, intentions, days they\'re proud of. You add yours. The road feels lighter.' },
  { id: 'z3', icon: '🌿', name: 'Zone Badge',          zone: 'badge3', badge: 'zone3', zoneName: 'The Thornwood',
    zoneComplete: 'Thornwood cleared. Turns out it\'s just a forest if you keep showing up. You come out the other side.' },
  // Zone 4 — The Iron Keep (levels 10+)
  { id: 9,  icon: '🏰', name: 'Iron Keep\nGates',       zone: 4, zoneName: 'The Iron Keep Approach',
    arrival: 'You\'ve reached the Iron Keep Gates. The gate captain has seen ten thousand travelers. She reads yours in three seconds. A disciplined one — habit clean, party intact. You\'re waved through without a word.' },
  { id: 10, icon: '⚔️', name: 'The Iron\nKeep',         zone: 4, zoneName: 'The Iron Keep Approach',
    arrival: 'You\'ve arrived at the Iron Keep. The full road walked. The quartermaster stamps your record without asking to see it twice. When the new moon comes, the road resets. Your Road Gold carries forward. Your legend does too.' },
  { id: 'z4', icon: '🔒', name: 'Zone Badge',          zone: 'badge4', badge: 'zone4', zoneName: 'The Iron Keep Approach',
    zoneComplete: 'Iron Keep reached. Most people fold somewhere in the Thornwood. Your habit, your streak, your party. That\'s what got you here.' },
];

// ─────────────────────────
//  HOSTILE ENCOUNTERS
// ─────────────────────────
var HOSTILE_ENCOUNTERS = [
  {
    id: 'bandits',
    icon: '🗡️',
    title: 'Road Toll. Unofficial.',
    zone: 'Ambush',
    desc: 'Four figures step into the road with the practiced air of people who have redefined "asking" as a concept. They want something. They haven\'t said what. The road behind you is looking very appealing right now.',
    choiceA: { label: '🛡️ Hold your ground', sub: 'Lose 1 HP — they back off' },
    choiceB: { label: '💰 Pay them off', sub: 'Spend 20 Road Gold — move on intact' },
    goldCost: 20
  },
  {
    id: 'fog',
    icon: '🌫️',
    title: 'The Fog of Habit',
    zone: 'Setback',
    desc: 'A strange heaviness settles over the road — the kind that shows up three weeks in, when the initial momentum has worn off and the habit isn\'t yet automatic. You know this feeling. You\'ve beaten it before.',
    choiceA: { label: '🛡️ Push through it', sub: 'Lose 1 HP — costs something, gains everything' },
    choiceB: { label: '💰 Hire a guide', sub: 'Spend 15 Road Gold — they carry you through the fog' },
    goldCost: 15
  },
  {
    id: 'storm',
    icon: '⛈️',
    title: 'Everything at Once',
    zone: 'Bad Day',
    desc: 'Broken wheel. Wrong turn. Surprise rain. A genuinely difficult day with no clear cause or cure. The road doesn\'t adjust its schedule for hard days — it just keeps going. So do you.',
    choiceA: { label: '🛡️ Push through', sub: 'Lose 1 HP — arrive tired but still moving' },
    choiceB: { label: '💰 Rest and recover', sub: 'Spend 18 Road Gold — a warm inn, no regrets' },
    goldCost: 18
  },
  {
    id: 'temptation',
    icon: '🎲',
    title: 'The Easy Way Out',
    zone: 'Temptation',
    desc: 'There is a shortcut. It looks fine. It\'s probably fine. The locals have a saying about this particular shortcut, but they say it quietly and won\'t quite meet your eyes. Your instincts are saying something. Listen to them.',
    choiceA: { label: '🛡️ Take the long road', sub: 'Lose 1 HP — the right choice always costs something' },
    choiceB: { label: '💰 Pay for a safe crossing', sub: 'Spend 12 Road Gold — not worth finding out' },
    goldCost: 12
  },
  {
    id: 'snare',
    icon: '🕸️',
    title: 'The Interruption',
    zone: 'Disruption',
    desc: 'Something pulled you off track today — an obligation, an emergency, the inescapable demands of being a person who exists. The habit window is closing. There\'s still a chance to make it.',
    choiceA: { label: '🛡️ Find a way', sub: 'Lose 1 HP — harder to check in, but you do it' },
    choiceB: { label: '💰 Buy back your time', sub: 'Spend 16 Road Gold — clear the day, check in properly' },
    goldCost: 16
  },
];

// ─────────────────────────
//  FRIENDLY ENCOUNTERS
// ─────────────────────────
var FRIENDLY_ENCOUNTERS = [
  {
    id: 'shrine',
    icon: '🌸',
    title: 'Roadside Shrine',
    zone: 'Lucky Find',
    desc: 'There\'s a small shrine just off the path. You stop. Thirty seconds of stillness. Whatever was pressing on you before you sat down is somehow smaller when you stand back up. One of your champions recovers a point of HP.',
    reward: { type: 'hp', amount: 1 },
    rewardDesc: '❤️ HP restored to your weakest champion'
  },
  {
    id: 'journal',
    icon: '📖',
    title: 'A Veteran\'s Notes',
    zone: 'Lucky Find',
    desc: 'A battered notebook tucked under a milestone. Someone walked this road before you and wrote down what they learned. No name — just: \'Keep going. It compounds.\' You read the whole thing. Your party earns XP from someone else\'s persistence.',
    reward: { type: 'xp', amount: 55 },
    rewardDesc: '+55 bonus XP'
  },
  {
    id: 'camp',
    icon: '🏕️',
    title: 'Abandoned Camp',
    zone: 'Lucky Find',
    desc: 'An abandoned camp, left in perfect order — fire still warm, everything stowed with care. Under a flat stone: a coin pouch and a note: \'For the next one.\' Your party is the next one.',
    reward: { type: 'gold', amount: 25 },
    rewardDesc: '+25 Road Gold'
  },
  {
    id: 'elder',
    icon: '🧙',
    title: 'The Road Veteran',
    zone: 'Friendly Encounter',
    desc: 'An older traveler watches the road from a stump. Most passers-by get a glance. You get a slow, deliberate nod — the kind that means something. They press a coin into your hand. \'Don\'t skip days.\' That\'s all. It\'s enough.',
    reward: { type: 'gold', amount: 15 },
    rewardDesc: '+15 Road Gold'
  },
  {
    id: 'clear_road',
    icon: '🦅',
    title: 'Clear Road Ahead',
    zone: 'Good News',
    desc: 'Guild cloth tied to a high branch — the all-clear marker. Someone came through before you and left it. Fastest route, no hazards, good conditions. Your party makes strong time. The XP reflects it.',
    reward: { type: 'xp', amount: 35 },
    rewardDesc: '+35 bonus XP'
  },
  {
    id: 'windfall',
    icon: '🤝',
    title: 'Road Windfall',
    zone: 'Friendly Encounter',
    desc: 'A traveling merchant — one of the honest ones — waves you down. She\'s ahead of schedule and has coin to spare. Says it\'s good luck to share it with disciplined travelers. Apparently you qualify.',
    reward: { type: 'gold', amount: 20 },
    rewardDesc: '+20 Road Gold'
  }
];

// ── STORY ENCOUNTERS (NPC flavor — no continuity required) ──
var STORY_ENCOUNTERS = {
  z1: [
    {
      id: 'veteran_habit',
      icon: '🍺',
      title: 'The Sellsword\'s Regret',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'A retired sellsword is sitting at the inn with the expression of someone cataloguing their own poor decisions. \'Thirty years of telling myself I\'d start tomorrow,\' he says. \'Tomorrow has a lot to answer for.\' You check in with your habit that night before you sleep.'
    },
    {
      id: 'posting_board',
      icon: '📜',
      title: 'The Notice Board',
      zone: 'Hearthstone Village',
      minPos: 0,
      desc: 'The guild notice board is covered in intentions — habits people announced and vanished from. Witness to a thousand Day Ones. You walk past it. Yours isn\'t an announcement. It\'s a quiet, daily fact.'
    },
    {
      id: 'cartographer',
      icon: '🗺️',
      title: 'The Cartographer\'s Map',
      zone: 'Harvest Crossing',
      minPos: 1,
      desc: 'A gnome cartographer has set up her cart at the crossroads — the cart is visibly larger on the inside than the outside, which she declines to explain. She shows you the road ahead: long, consistent, no shortcuts worth taking. \'The ones who arrive,\' she says, \'are boring travelers. They just keep going.\''
    },
    {
      id: 'miller_lesson',
      icon: '⚖️',
      title: 'The Miller\'s Standard',
      zone: 'Stonepath Mill',
      minPos: 2,
      desc: 'The miller at Stonepath runs the tightest operation on the road — no exceptions, no "close enough," no rounding. Six travelers ahead of you got turned back for incomplete work. You had done yours. You\'re through in seconds. Excellence is mostly just showing up correctly.'
    },
  ],
  z2: [
    {
      id: 'distraction',
      icon: '🏛️',
      title: 'The Guild of Excellent Intentions',
      zone: "Merchant\'s Gate",
      minPos: 3,
      desc: 'A guild is recruiting travelers to join their cause — it sounds compelling, the pamphlet is very good, and the speaker is genuinely passionate. You have a habit to maintain. You wish them well and keep walking. Enthusiasm is not the same thing as doing.'
    },
    {
      id: 'bridge_story',
      icon: '👻',
      title: 'The Tale of the Bridge',
      zone: 'Copperbridge',
      minPos: 4,
      desc: 'Locals say the old bridge is haunted by a traveler who stopped halfway and never decided whether to go back or forward. You cross at a steady pace without slowing. Some decisions only become hard if you let them.'
    },
    {
      id: 'campfire',
      icon: '🔥',
      title: 'Around the Fire',
      zone: "Trader\'s Camp",
      minPos: 5,
      desc: 'Traders swapping road stories by firelight. A dwarf claims he met someone who made it to the Iron Keep without missing a single day. Nobody believes him. \'Doesn\'t matter if you believe it,\' he says. \'The road is the same either way.\''
    },
  ],
  z3: [
    {
      id: 'sentinel',
      icon: '🏹',
      title: 'The Sentinel\'s Word',
      zone: 'Thornwood Edge',
      minPos: 6,
      desc: 'A Thornwood sentinel drops from a branch and lands in front of you without a sound. \'Keep moving. The forest tests the ones who hesitate.\' She\'s back in the canopy before you can ask what that means. You keep moving. That seems like the answer.'
    },
    {
      id: 'silence',
      icon: '🌲',
      title: 'The Quiet Miles',
      zone: 'Darkhollow Path',
      minPos: 7,
      desc: 'There\'s a stretch of Darkhollow Path where the sound drops away — old druid work, they say, to give travelers space to think straight. You walk it in silence. Your habit feels obvious here. Why it was ever hard to start is less clear.'
    },
    {
      id: 'shrine_offering',
      icon: '🌸',
      title: 'The Road Offering',
      zone: 'Wayward Shrine',
      minPos: 8,
      desc: 'The Wayward Shrine is covered in tokens left by travelers: small objects, folded notes, marks scratched into stone. Someone left a check-in streak tracker beside the road marker. 847 days in, no misses. You add your own mark.'
    },
  ],
  z4: [
    {
      id: 'gate_check',
      icon: '🛡️',
      title: 'The Iron Gate',
      zone: 'Iron Keep Gates',
      minPos: 9,
      desc: 'The gate captain has seen ten thousand travelers. She reads yours in seconds — party intact, habit consistent, streak unbroken. She stamps your writ and steps aside without comment. Here, that\'s as warm as welcomes get.'
    },
    {
      id: 'the_keep',
      icon: '⚔️',
      title: 'The Keep Quartermaster',
      zone: 'The Iron Keep',
      minPos: 10,
      desc: 'The Iron Keep quartermaster is infamous for turning away travelers with broken records. He holds out his hand. You hand over your log without hesitation. He reads it, raises an eyebrow. \'First one today who didn\'t flinch.\' The gate opens.'
    },
  ]
};
// ─────────────────────────
//  STATE
// ─────────────────────────
var state = {
  // Traveler (the player's journey leader)
  name: '',
  avatar: '',
  xp: 0,
  mapPosition: 0,
  badges: [],
  weekLogDays: [],
  weekStart: '',
  roadBonusesThisMonth: 0,
  lastEncounterLog: '',
  bestStreak: 0,
  pendingEncounter: null,
  seenStoryEncounters: [],
  seenArrivals: [],
  lastMapPosition: -1,
  encounterLogCount: 0,
  lastEncounterAtLog: 0,
  ironVault: 0,        // Road Gold
  // Party — array of character objects
  // Each: { id, name, class, habit, cadence, cadenceTarget, hp, streak,
  //         lastCheckIn, checkInsThisWeek, weekStart, log, seenArrivals }
  party: [],
  // Onboarding tracks party slot being created
  activeSlots: 0,
};


// ─────────────────────────
//  SUPABASE
// ─────────────────────────
var SUPABASE_URL = 'https://czolsfnkwqtnkziakclg.supabase.co';
var SUPABASE_KEY = 'sb_publishable_zcYS8yzbinVjqmY1P_RM4w_BjOEExwq';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var currentUserId = null;
var isSigningOut = false;

// ─────────────────────────
//  SAVE / LOAD
// ─────────────────────────
function save() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  if (currentUserId) {
    sb.from('profiles')
      .upsert({ user_id: currentUserId, save_data: state, updated_at: new Date().toISOString() },
               { onConflict: 'user_id' })
      .then(function(res) {
        if (res.error) console.warn('Supabase save error:', res.error.message);
      });
  }
}

function load() {
  var raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  try {
    var parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || !parsed) return;
    if (!Array.isArray(parsed.log)) parsed.log = [];
    ['name','avatar','xp','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition','encounterLogCount','lastEncounterAtLog','bestStreak','ironVault','party','activeSlots'].forEach(function(k) {
      if (parsed[k] !== undefined) state[k] = parsed[k];
    });
  } catch(e) { console.warn('Load failed:', e); }
}

async function loadFromSupabase() {
  if (!currentUserId) return;
  try {
    var res = await sb.from('profiles').select('save_data').eq('user_id', currentUserId).single();
    if (res.error || !res.data || !res.data.save_data) return;
    var remote = res.data.save_data;
    if (typeof remote !== 'object') return;
    if (!Array.isArray(remote.log)) remote.log = [];
    ['name','avatar','xp','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition','encounterLogCount','lastEncounterAtLog','bestStreak','ironVault','party','activeSlots'].forEach(function(k) {
      if (remote[k] !== undefined) state[k] = remote[k];
    });
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  } catch(e) { console.warn('Supabase load error:', e); }
}

// ─────────────────────────
//  AUTH FUNCTIONS
// ─────────────────────────


async function signInWithPassword() {
  var email    = document.getElementById('login-email-pw').value.trim();
  var password = document.getElementById('login-password').value;
  var errEl    = document.getElementById('login-error-pw');
  errEl.style.display = 'none';

  if (!email || !password) {
    errEl.textContent = 'Enter your email and password.';
    errEl.style.display = 'block';
    return;
  }
  var btn = document.querySelector('#login-form-password .btn-primary');
  btn.textContent = 'Entering…';
  btn.disabled = true;

  var res = await sb.auth.signInWithPassword({ email: email, password: password });
  if (res.error) {
    errEl.textContent = res.error.message === 'Invalid login credentials'
      ? 'Wrong email or password. Try again.'
      : res.error.message;
    errEl.style.display = 'block';
    btn.textContent = 'Enter the Realm ⚔';
    btn.disabled = false;
  }
}



function showLoginError(msg) {
  var el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = 'block';
}



async function signOut() {
  isSigningOut = true;
  _appInitDone = false; // allow re-init after next login
  try { await sb.auth.signOut(); } catch(e) { console.warn('Sign out error:', e); }
  currentUserId = null;
  localStorage.removeItem(SAVE_KEY);
  // Reset state
  state.name = ''; state.avatar = ''; state.xp = 0;
  state.mapPosition = 0; state.badges = []; state.weekLogDays = [];
  state.weekStart = ''; state.roadBonusesThisMonth = 0;
  state.lastEncounterLog = ''; state.pendingEncounter = null;
  state.seenStoryEncounters = []; state.seenArrivals = []; state.lastMapPosition = -1;
  state.encounterLogCount = 0; state.lastEncounterAtLog = 0;
  state.bestStreak = 0; state.ironVault = 0; state.party = []; state.activeSlots = 0;
  // Show login
  document.getElementById('header-auth').style.display = 'none';
  document.getElementById('main').style.display = 'none';
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('login-screen').style.display = 'block';
  isSigningOut = false;
}

// ─────────────────────────
//  INIT
// ─────────────────────────
var _appInitDone = false; // guard: only run full init once per page load

async function initApp() {
  sb.auth.onAuthStateChange(async function(event, session) {
    if (isSigningOut) return;
    if (session && session.user) {
      currentUserId = session.user.id;
      document.getElementById('header-email').textContent = session.user.email;
      document.getElementById('header-auth').style.display = 'flex';
      document.getElementById('login-screen').style.display = 'none';

      // Only run the full load sequence once per page load.
      // onAuthStateChange can fire multiple times (INITIAL_SESSION, SIGNED_IN, TOKEN_REFRESHED)
      // Re-running load() each time would reset state mid-session.
      if (_appInitDone) return;
      _appInitDone = true;

      // Load localStorage FIRST — instant, always available
      load();

      // Then overlay Supabase on top — authoritative remote save
      await loadFromSupabase();

      // Defensive defaults for any missing fields
      if (!state.badges)                           state.badges = [];
      if (!state.weekLogDays)                      state.weekLogDays = [];
      if (state.roadBonusesThisMonth === undefined) state.roadBonusesThisMonth = 0;
      if (!state.lastEncounterLog)                 state.lastEncounterLog = '';
      if (!state.seenStoryEncounters)              state.seenStoryEncounters = [];
      if (!state.seenArrivals)                     state.seenArrivals = [];
      if (state.lastMapPosition === undefined)     state.lastMapPosition = -1;
      if (state.bestStreak === undefined)          state.bestStreak = 0;
      if (state.ironVault === undefined)           state.ironVault = 0;
      if (!state.party)                            state.party = [];
      if (state.activeSlots === undefined)         state.activeSlots = 0;
      // Check for missed check-ins on open (HP decay)
      checkMissedCheckIns();
      // NOTE: defensive — ensure each party member has required fields

      checkStreak();

      if (state.avatar && state.name && state.party && state.party.length > 0) {
        document.getElementById('onboarding').style.display = 'none';
        document.getElementById('main').style.display = 'block';
        render();
      } else {
        document.getElementById('onboarding').style.display = 'block';
        document.getElementById('main').style.display = 'none';
      }
    } else {
      currentUserId = null;
      document.getElementById('header-auth').style.display = 'none';
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('main').style.display = 'none';
      document.getElementById('onboarding').style.display = 'none';
    }
  });
}

initApp();

// ─────────────────────────
//  STREAK / DATE HELPERS
// ─────────────────────────
function getToday() { return new Date().toDateString(); }
function getYesterday() {
  var d = new Date(); d.setDate(d.getDate() - 1); return d.toDateString();
}




// ─────────────────────────
//  WOUNDED MODE
// ─────────────────────────





// ─────────────────────────
//  ONBOARDING STATE
// ─────────────────────────
var obAvatar     = '🧔';  // Human pre-selected
var obPartySize  = 3;          // how many companions they're setting up
var obCompanionIdx = 0;        // which companion we're currently setting up (0-based)
var obCompanions = [];         // array of {habit, class, cadence, weekTarget}
var obCurrentHabit   = '';
var obCurrentClass   = '';
var obCurrentCadence = 'daily';
var obCurrentWeekTarget = 3;
var obSuggest    = '';

// goStep now accepts string IDs for named steps
function goStep(n) {
  document.querySelectorAll('.ob-step').forEach(function(el) { el.classList.remove('active'); });
  var stepId;
  if (typeof n === 'string') {
    // named steps: '1-race', 'habit', 'cadence', 'class', 'laws', 'begin'
    stepId = 'step-' + n;
  } else {
    stepId = 'step-' + n;
  }
  var target = document.getElementById(stepId);
  if (target) target.classList.add('active');

  // Update progress dots — map all steps to 0-4
  var dotMap = { '0': 0, '1-race': 1, '2': 2, 'habit': 3, 'cadence': 3, 'class': 3, 'laws': 4, 'begin': 4 };
  var dotKey = typeof n === 'number' ? String(n) : n;
  var dotN = dotMap[dotKey] !== undefined ? dotMap[dotKey] : -1;
  for (var i = 0; i <= 4; i++) {
    var dot = document.getElementById('dot-' + i);
    if (!dot) continue;
    dot.className = 'step-dot';
    if (dotN >= 0) {
      if (i < dotN) dot.classList.add('done');
      else if (i === dotN) dot.classList.add('active');
    }
  }

  // Step-specific setup
  if (stepId === 'step-habit') updateCompanionHabitStep();
  if (stepId === 'step-class') setupSuggestedClass();
  if (stepId === 'step-begin') buildBeginPartySummary();
}

function onNameInput() {
  var val = document.getElementById('hero-name-input').value.trim();
  var btn = document.getElementById('name-next-btn');
  if (btn) btn.disabled = val.length < 1;
}

function selectAvatar(el) {
  document.querySelectorAll('.avatar-opt').forEach(function(o) { o.classList.remove('selected'); });
  el.classList.add('selected');
  obAvatar = el.dataset.avatar;
}

function selectPartySize(el, size) {
  document.querySelectorAll('.party-size-opt').forEach(function(o) { o.classList.remove('selected'); });
  el.classList.add('selected');
  obPartySize = size;
}

function startCompanionSetup() {
  obCompanions = [];
  obCompanionIdx = 0;
  obCurrentHabit = '';
  obCurrentClass = '';
  obCurrentCadence = 'daily';
  obCurrentWeekTarget = 3;
  var inp = document.getElementById('habit-input');
  if (inp) inp.value = '';
  var btn = document.getElementById('habit-next-btn');
  if (btn) btn.disabled = true;
  goStep('habit');
}

function updateCompanionHabitStep() {
  var idx = obCompanionIdx;
  var ordinals = ['First','Second','Third'];
  var ord = ordinals[idx] || ('Champion ' + (idx+1));
  document.getElementById('companion-setup-title').textContent = ord + ' Champion\'s Quest';
  var icons = ['⚔️','🔮','🗡️'];
  document.getElementById('companion-setup-icon').textContent = icons[idx] || '⚔️';

  // Progress pips
  var prog = document.getElementById('companion-progress');
  prog.innerHTML = '';
  for (var i = 0; i < obPartySize; i++) {
    var pip = document.createElement('div');
    pip.className = 'companion-pip' + (i < idx ? ' done' : i === idx ? ' current' : '');
    prog.appendChild(pip);
  }

  // Restore habit if already set for this companion
  var inp = document.getElementById('habit-input');
  if (inp) {
    var existing = obCompanions[idx] ? obCompanions[idx].habit : '';
    inp.value = existing || '';
    obCurrentHabit = existing || '';
    var btn = document.getElementById('habit-next-btn');
    if (btn) btn.disabled = !obCurrentHabit || obCurrentHabit.length < 3;
  }
}

function habitBack() {
  if (obCompanionIdx === 0) {
    goStep(2); // back to party size
  } else {
    obCompanionIdx--;
    goStep('habit');
  }
}

function onHabitInput() {
  var val = document.getElementById('habit-input').value.trim();
  obCurrentHabit = val;
  var btn = document.getElementById('habit-next-btn');
  if (btn) btn.disabled = val.length < 3;
}

function setHabitExample(el) {
  var inp = document.getElementById('habit-input');
  if (inp) { inp.value = el.textContent; obCurrentHabit = el.textContent; }
  var btn = document.getElementById('habit-next-btn');
  if (btn) btn.disabled = false;
}

function goToClassStep() {
  // Reset cadence UI to reflect current state before showing the step
  var dailyEl  = document.getElementById('cad-daily');
  var weeklyEl = document.getElementById('cad-weekly');
  var wr       = document.getElementById('weekly-target-row');
  if (dailyEl)  dailyEl.classList.toggle('selected',  obCurrentCadence === 'daily');
  if (weeklyEl) weeklyEl.classList.toggle('selected', obCurrentCadence === 'weekly');
  if (wr)       wr.classList.toggle('hidden', obCurrentCadence !== 'weekly');
  goStep('cadence');
}

function setupSuggestedClass() {
  obSuggest = suggestClass(obCurrentHabit);
  obCurrentClass = obSuggest;
  var def = CLASS_DEFS[obSuggest];
  if (!def) return;
  document.getElementById('ob-suggest-icon').textContent = def.icon;
  document.getElementById('sc-icon').textContent    = def.icon;
  document.getElementById('sc-name').textContent    = def.name;
  document.getElementById('sc-desc').textContent    = def.desc;
  document.getElementById('sc-trait').textContent   = def.trait;
}

function confirmCompanionClass() {
  if (!obCurrentClass) obCurrentClass = obSuggest || 'Mage';
  // Save this companion
  obCompanions[obCompanionIdx] = {
    habit: obCurrentHabit,
    class: obCurrentClass,
    cadence: obCurrentCadence,
    weekTarget: obCurrentWeekTarget
  };
  obCompanionIdx++;
  if (obCompanionIdx < obPartySize) {
    // More companions to set up — reset all fields
    obCurrentHabit   = '';
    obCurrentClass   = '';
    obCurrentCadence = 'daily';
    obCurrentWeekTarget = 3;
    var inp = document.getElementById('habit-input');
    if (inp) inp.value = '';
    goStep('habit');
  } else {
    // All done — go to laws
    goStep('laws');
  }
}

// Legacy confirmClass alias
function confirmClass() { confirmCompanionClass(); }

function selectCadence(type) {
  obCurrentCadence = type;
  document.getElementById('cad-daily') && document.getElementById('cad-daily').classList.toggle('selected', type === 'daily');
  document.getElementById('cad-weekly') && document.getElementById('cad-weekly').classList.toggle('selected', type === 'weekly');
  var wr = document.getElementById('weekly-target-row');
  if (wr) wr.classList.toggle('hidden', type !== 'weekly');
}

function selectWeeklyTarget(btn) {
  document.querySelectorAll('.wt-btn').forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
  obCurrentWeekTarget = parseInt(btn.dataset.n, 10);
}

function buildBeginPartySummary() {
  var wrap = document.getElementById('begin-party-summary');
  if (!wrap) return;
  wrap.innerHTML = '';
  obCompanions.forEach(function(c) {
    var def = CLASS_DEFS[c.class] || CLASS_DEFS['Mage'];
    var cadenceStr = c.cadence === 'weekly'
      ? (c.weekTarget || 3) + '\u00D7 per week'
      : 'Daily';
    var row = document.createElement('div');
    row.className = 'begin-party-row';
    row.innerHTML =
      '<div class="begin-party-icon">' + def.icon + '</div>' +
      '<div style="flex:1;min-width:0;">' +
        '<div class="begin-party-name">' + def.name + '</div>' +
        '<div class="begin-party-habit">' + esc(c.habit) + '</div>' +
        '<div style="font-size:13px;color:var(--text-dark);margin-top:3px;font-family:Cinzel,serif;text-transform:uppercase;letter-spacing:0.08em;">' + cadenceStr + '</div>' +
      '</div>';
    wrap.appendChild(row);
  });
}

function beginJourney() {
  var nameEl = document.getElementById('hero-name-input');
  var name   = nameEl ? nameEl.value.trim() : '';
  if (!name) { goStep(0); return; }
  if (!obCompanions.length) { goStep('habit'); return; }
  if (!obAvatar) obAvatar = '🧔';

  state.name   = name;
  state.avatar = obAvatar;
  state.xp     = 0;
  state.mapPosition  = 0;
  state.lastMapPosition = -1;
  state.badges = [];
  state.weekLogDays  = [];
  state.weekStart    = '';
  state.roadBonusesThisMonth = 0;
  state.lastEncounterLog = '';
  state.seenStoryEncounters = [];
  state.seenArrivals = [];
  state.encounterLogCount = 0;
  state.lastEncounterAtLog = 0;
  state.ironVault = 0;
  state.bestStreak = 0;
  state.party = [];
  state.activeSlots = 0;

  obCompanions.forEach(function(c) {
    var char = createCharacter(c.habit, c.class, c.cadence, c.weekTarget);
    state.party.push(char);
  });
  state.activeSlots = state.party.length;

  save();
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  render();
  showToast('The road awaits, ' + state.name + '. Your party is assembled.');
}

// ─────────────────────────
//  PARTY MANAGEMENT
// ─────────────────────────
function createCharacter(habit, cls, cadence, weekTarget) {
  return {
    id:          Date.now() + Math.floor(Math.random() * 10000),
    habit:       habit,
    class:       cls,
    cadence:     cadence || 'daily',      // 'daily' | 'weekly'
    weekTarget:  weekTarget || 3,
    hp:          5,
    streak:      0,
    bestStreak:  0,
    lastCheckIn: null,
    checkInsThisWeek: 0,
    weekStart:   '',
    log:         [],
    collapsed:   false   // HP = 0
  };
}

// ─────────────────────────
//  HP RULES
// ─────────────────────────
function getHpRule(cls) {
  return (CLASS_DEFS[cls] || {}).hpRule || 'standard';
}

function applyMiss(char) {
  // Called when a character misses a day (or, for weekly, misses the weekly target)
  var rule = getHpRule(char.class);
  // Streak break
  var hadStreak = char.streak > 0;
  if (char.cadence === 'daily') char.streak = 0;
  // HP loss
  var hpLoss = 1;
  if (rule === 'ranger' && hadStreak) hpLoss = 2; // Rangers feel streak breaks harder
  char.hp = Math.max(0, (char.hp || 0) - hpLoss);
  char.collapsed = (char.hp <= 0);
}

function applyCheckIn(char) {
  char.hp = Math.min(5, (char.hp || 0) + 1);
  char.collapsed = false;
  // Streak
  var today     = new Date().toDateString();
  var yesterday = (function() { var d = new Date(); d.setDate(d.getDate()-1); return d.toDateString(); })();
  if (char.cadence === 'daily') {
    if (char.lastCheckIn === yesterday || char.lastCheckIn === null && char.streak === 0) {
      char.streak = (char.streak || 0) + 1;
    } else if (char.lastCheckIn !== today) {
      char.streak = 1; // restart
    }
  } else {
    // Weekly: increment streak only when weekly target is hit
    var ws = getWeekStart();
    if (char.weekStart !== ws) {
      char.weekStart = ws; char.checkInsThisWeek = 0;
    }
    char.checkInsThisWeek = (char.checkInsThisWeek || 0) + 1;
    if (char.checkInsThisWeek >= char.weekTarget) char.streak = (char.streak || 0) + 1;
  }
  if (char.streak > (char.bestStreak || 0)) char.bestStreak = char.streak;
  char.lastCheckIn = today;
}

// Called on app open — check each character for missed days and apply HP decay
function checkMissedCheckIns() {
  if (!state.party || !state.party.length) return;
  var today     = new Date().toDateString();
  var yesterday = (function() { var d = new Date(); d.setDate(d.getDate()-1); return d.toDateString(); })();
  state.party.forEach(function(char) {
    if (!char.lastCheckIn) return; // never checked in — no penalty yet
    if (char.lastCheckIn === today) return; // already checked in today
    if (char.cadence === 'daily') {
      // Missed yesterday and potentially more — apply one miss per missed day
      // Simple: if last check-in was not yesterday, they missed at least one day
      if (char.lastCheckIn !== yesterday) {
        applyMiss(char);
      }
    } else {
      // Weekly cadence: check at week boundary
      var ws = getWeekStart();
      if (char.weekStart && char.weekStart !== ws) {
        // New week — did they hit target last week?
        if ((char.checkInsThisWeek || 0) < char.weekTarget) {
          applyMiss(char);
        }
        char.weekStart = ws;
        char.checkInsThisWeek = 0;
      }
    }
  });
  save();
}

// ─────────────────────────
//  CHECK-IN ACTION
// ─────────────────────────
function checkIn(charId) {
  var char = state.party.filter(function(c) { return c.id === charId; })[0];
  if (!char) return;
  var today = new Date().toDateString();
  if (char.lastCheckIn === today) return; // already done

  var prevLevel = getLevelData(state.xp).level;

  // Weather XP multiplier (BEFORE this check-in changes the weather)
  // weather is atmospheric only — no XP modifier

  // Base XP + streak bonus
  var streakBonus = Math.min(30, (char.streak || 0) * 5);
  var baseXp = getLevelData(state.xp).level <= 3 ? 20 : 15;
  var xpRaw = baseXp + streakBonus;

  // Party bonus: all characters will be checked in after this one
  var allDone = state.party.every(function(c) {
    return c.lastCheckIn === today || c.id === charId;
  });
  if (state.party.length > 1 && allDone) xpRaw += 15;

  // Apply weather multiplier
  var xpGained = Math.max(1, Math.round(xpRaw));

  applyCheckIn(char);

  // Party HP loss: any OTHER companions not checked in today lose 1 HP (they feel neglected)
  // Only applies if at least one person was already checked in (not first of the day)
  // Actually: we apply miss-due-to-party only at midnight check via checkMissedCheckIns.
  // For real-time: after ALL check-ins done, no action. The pressure is that missing = HP decay tomorrow.

  // Add to log
  var def = CLASS_DEFS[char.class] || {};
  char.log = char.log || [];
  char.log.push({
    id:       String(Date.now()),
    charId:   char.id,
    charClass: char.class,
    charIcon:  def.icon || '✦',
    habit:    char.habit,
    xpGained: xpGained,
    ts:       new Date().toISOString()
  });

  state.xp += xpGained;

  // Update best streak
  var primary = state.party[0];
  if (primary && primary.streak > (state.bestStreak || 0)) {
    state.bestStreak = primary.streak;
  }

  checkWeekRoadBonus();
  save();
  render();

  fireXpFloat('+' + xpGained + ' XP');
  var fill = document.getElementById('xp-fill');
  if (fill) {
    fill.classList.remove('pulse');
    void fill.offsetWidth;
    fill.classList.add('pulse');
    setTimeout(function() { fill.classList.remove('pulse'); }, 800);
  }

  var newLevel = getLevelData(state.xp).level;
  if (newLevel > prevLevel) {
    showLevelUp(newLevel);
  } else {
    // Fire road event or encounter after check-in
    checkEncounter(0);
  }
}

// ─────────────────────────
//  STREAK HELPERS (global — uses primary party member)
// ─────────────────────────
function getGlobalStreak() {
  if (!state.party || !state.party.length) return 0;
  // Use the primary (first) character's streak as the global streak
  return state.party[0].streak || 0;
}

function hasLoggedToday() {
  if (!state.party || !state.party.length) return false;
  var today = new Date().toDateString();
  // Logged today if ANY party member checked in
  return state.party.some(function(c) { return c.lastCheckIn === today; });
}

function checkStreak() {
  // Streak is now per-character — this is a no-op kept for compatibility
}

function markLoggedToday() {
  // No-op — handled by checkIn
}

// ─────────────────────────
//  RENDER PARTY CARDS
// ─────────────────────────
function renderParty() {
  var container = document.getElementById('party-cards');
  if (!container) return;
  container.innerHTML = '';
  var today = new Date().toDateString();

  (state.party || []).forEach(function(char) {
    var def         = CLASS_DEFS[char.class] || CLASS_DEFS['Mage'];
    var checkedIn   = char.lastCheckIn === today;
    var hp          = char.hp || 0;
    var isCollapsed = char.collapsed || hp <= 0;
    var isWounded   = !isCollapsed && hp <= 2;
    var streak      = char.streak || 0;

    var card = document.createElement('div');
    card.className = 'char-card' +
      (checkedIn   ? ' checked-in' : '') +
      (isWounded   ? ' wounded'    : '') +
      (isCollapsed ? ' collapsed'  : '');

    // ── Top row: class icon | class name + habit | HP hearts
    var topRow = document.createElement('div');
    topRow.className = 'char-card-top';

    var avatarDiv = document.createElement('div');
    avatarDiv.className = 'char-card-avatar' + (hp <= 2 ? ' low-hp' : '');
    avatarDiv.textContent = def.icon;

    var infoDiv = document.createElement('div');
    infoDiv.className = 'char-card-info';

    var cadenceTag = '';
    if (char.cadence === 'weekly') {
      var doneThisWeek = char.checkInsThisWeek || 0;
      var target = char.weekTarget || 3;
      cadenceTag = '<div class="char-card-weekly-progress">';
      for (var p = 0; p < target; p++) {
        cadenceTag += '<div class="weekly-pip' + (p < doneThisWeek ? ' done' : '') + '"></div>';
      }
      cadenceTag += '<span class="weekly-pip-label">' + doneThisWeek + '/' + target + ' this week</span></div>';
      if (streak > 0) {
        cadenceTag += '<div class="char-card-streak">🔥 ' + streak + ' week streak</div>';
      }
    } else {
      cadenceTag = streak > 0
        ? '<div class="char-card-streak">🔥 ' + streak + ' day streak</div>'
        : '';
    }

    infoDiv.innerHTML =
      '<div class="char-card-name">' + def.name + '</div>' +
      '<div class="char-card-habit">' + esc(char.habit || '') + '</div>' +
      cadenceTag;

    // HP hearts — 5 hearts, filled based on hp
    var heartsDiv = document.createElement('div');
    heartsDiv.className = 'char-card-hp-hearts';
    var heartsRow = document.createElement('div');
    heartsRow.className = 'hp-hearts-row';
    for (var h = 1; h <= 5; h++) {
      var heart = document.createElement('span');
      heart.className = 'hp-heart' + (h > hp ? ' empty' : '');
      heart.textContent = '❤️';
      heartsRow.appendChild(heart);
    }
    var heartsLabel = document.createElement('div');
    heartsLabel.className = 'hp-hearts-label';
    heartsLabel.textContent = hp + '/5 HP';
    heartsDiv.appendChild(heartsRow);
    heartsDiv.appendChild(heartsLabel);

    topRow.appendChild(avatarDiv);
    topRow.appendChild(infoDiv);
    topRow.appendChild(heartsDiv);
    card.appendChild(topRow);

    // ── Collapsed banner
    if (isCollapsed) {
      var collapsedBar = document.createElement('div');
      collapsedBar.className = 'char-card-collapsed-bar';
      collapsedBar.innerHTML = '<div class="collapsed-msg">💀 ' + def.name + ' has fallen. Check in to begin recovery.</div>';
      card.appendChild(collapsedBar);
    }

    // ── Action area
    var actionDiv = document.createElement('div');
    actionDiv.className = 'char-card-action';

    if (checkedIn) {
      var doneBtn = document.createElement('button');
      doneBtn.className = 'checkin-btn done';
      if (char.cadence === 'weekly') {
        var doneW2 = char.checkInsThisWeek || 0;
        var targW2 = char.weekTarget || 3;
        doneBtn.textContent = doneW2 >= targW2
          ? '✓ Weekly target hit!'
          : '✓ Logged today (' + doneW2 + '/' + targW2 + ' this week)';
      } else {
        doneBtn.textContent = '✓ Done for today';
      }
      actionDiv.appendChild(doneBtn);
    } else {
      var btn = document.createElement('button');
      btn.className = 'checkin-btn';
      if (isCollapsed) {
        btn.style.borderColor = 'rgba(184,60,46,0.5)';
        btn.textContent = '🩸 Check in to recover — ' + esc(char.habit);
      } else if (char.cadence === 'weekly') {
        var doneW = char.checkInsThisWeek || 0;
        var targW = char.weekTarget || 3;
        btn.textContent = '⚔ Check In (' + doneW + '/' + targW + ' this week)';
      } else {
        btn.textContent = '⚔ Check In — ' + esc(char.habit);
      }
      btn.onclick = (function(cid) { return function() { checkIn(cid); }; })(char.id);
      actionDiv.appendChild(btn);
    }

    card.appendChild(actionDiv);
    container.appendChild(card);
  });
}

// ─────────────────────────
//  RENDER LOG (chronicle of check-ins)
// ─────────────────────────
var LOG_PAGE_SIZE = 3;
var logVisibleCount = LOG_PAGE_SIZE;

function renderLog() {
  logVisibleCount = LOG_PAGE_SIZE;
  renderLogPage();
}

function showMoreLog() {
  logVisibleCount += LOG_PAGE_SIZE;
  renderLogPage();
}

function collapseLog() {
  logVisibleCount = LOG_PAGE_SIZE;
  renderLogPage();
  var wrap = document.querySelector('.log-list-wrap');
  if (wrap) wrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderLogPage() {
  var list = document.getElementById('log-list');
  if (!list) return;
  list.innerHTML = '';

  // Flatten all party logs into one sorted list
  var allItems = [];
  (state.party || []).forEach(function(char) {
    (char.log || []).forEach(function(entry) {
      allItems.push(entry);
    });
  });
  allItems.sort(function(a, b) {
    return new Date(b.ts) - new Date(a.ts);
  });

  if (!allItems.length) {
    var empty = document.createElement('div');
    empty.className = 'log-empty';
    empty.textContent = 'No check-ins yet. Complete your first habit above to earn XP!';
    list.appendChild(empty);
    document.getElementById('log-pagination').style.display = 'none';
    return;
  }

  var visible = allItems.slice(0, logVisibleCount);
  var total   = allItems.length;
  var showing = Math.min(logVisibleCount, total);

  visible.forEach(function(entry) {
    var el = document.createElement('div');
    el.className = 'log-item';
    var meta = entry.ts ? formatDate(entry.ts) : '';
    el.innerHTML =
      '<div class="log-icon">' + (entry.charIcon || '✦') + '</div>' +
      '<div>' +
        '<div class="log-desc">' + esc(entry.habit || 'Check-in') + '</div>' +
        (meta ? '<div class="log-meta">' + meta + '</div>' : '') +
      '</div>' +
      '<div class="log-right">' +
        '<div class="log-xp" style="font-size:16px;">+' + entry.xpGained + ' XP</div>' +
      '</div>';
    list.appendChild(el);
  });

  var pagEl     = document.getElementById('log-pagination');
  var moreBtn   = document.getElementById('log-more-btn');
  var countEl   = document.getElementById('log-pagination-count');
  var colBtn    = document.getElementById('log-collapse-btn');
  var hasMore   = showing < total;

  pagEl.style.display = 'flex';
  countEl.textContent = showing + ' of ' + total + ' entries';
  moreBtn.disabled    = !hasMore;
  moreBtn.textContent = hasMore ? 'Show more ▾' : 'All shown';
  if (colBtn) colBtn.style.display = logVisibleCount > LOG_PAGE_SIZE ? 'block' : 'none';
}

// ─────────────────────────
//  DEV TOOLS (updated)
// ─────────────────────────
function devWipeLog() {
  state.party.forEach(function(c) { c.log = []; c.lastCheckIn = null; });
  save(); render();
  showToast('Check-ins wiped.');
}

function devWipeStreak() {
  state.party.forEach(function(c) { c.streak = 0; });
  save(); render();
  showToast('Streaks reset.');
}

function devWipeLevel() {
  state.xp = 0;
  save(); render();
  showToast('Level reset to 1.');
}

function devRestart() {
  state.name = ''; state.avatar = ''; state.party = [];
  state.xp = 0; state.mapPosition = 0; state.ironVault = 0;
  state.badges = []; state.bestStreak = 0;
  localStorage.removeItem(SAVE_KEY);
  document.getElementById('main').style.display = 'none';
  document.getElementById('onboarding').style.display = 'block';
  obCompanions = []; obCompanionIdx = 0; obPartySize = 3;
  goStep(0);
  save();
}

function devSimMiss() {
  // Simulate a missed day on first character
  if (state.party && state.party.length > 0) {
    var char = state.party[0];
    char.lastCheckIn = null; // clear so miss applies
    applyMiss(char);
    save(); render();
    showToast('Miss simulated: ' + char.class + ' lost HP.');
  }
}

// ─────────────────────────
//  ADD CHARACTER (party slot unlock)
// ─────────────────────────
// Max slots by level
function getMaxSlots() {
  var level = getLevelData(state.xp).level;
  if (level >= 10) return 5;
  if (level >= 7)  return 4;
  if (level >= 4)  return 3; // zone II completion also triggers but use level for now
  if (level >= 2)  return 2;
  return 1;
}

function showAddCharacter() {
  // For now: prompt via a simple two-step overlay
  // We'll reuse the onboarding fields in a modal - TODO: full modal
  showToast('Add character coming soon — unlock by leveling up!');
}

// ─────────────────────────
//  WEATHER SYSTEM
// ─────────────────────────
var WEATHER_STATES = {
  clear:   { icon: '☀️',  label: 'Clear Skies',       desc: 'Your whole party is moving. The road opens ahead.',      cls: 'clear'   },
  partial: { icon: '⛅',  label: 'Partly Cloudy',      desc: 'Some of your champions are still waiting on you.',       cls: 'partial' },
  stormy:  { icon: '🌩️', label: 'Gathering Storms',   desc: 'Most of your party hasn\'t moved. The road grows dark.',  cls: 'stormy'  },
  fog:     { icon: '🌫️', label: 'Fog of Doubt',       desc: 'No one has checked in. The path ahead is invisible.',    cls: 'fog'     },
  dawn:    { icon: '🌄',  label: 'The Road Awaits',    desc: 'A new day. Check in to see what lies ahead.',            cls: 'partial' }
};

function getWeatherState() {
  if (!state.party || !state.party.length) return WEATHER_STATES.dawn;
  var today = new Date().toDateString();
  var total = state.party.length;
  var checkedIn = state.party.filter(function(c) { return c.lastCheckIn === today; }).length;
  if (total === 0) return WEATHER_STATES.dawn;
  if (checkedIn === 0) return WEATHER_STATES.fog;
  if (checkedIn === total) return WEATHER_STATES.clear;
  if (checkedIn >= total - 1) return WEATHER_STATES.partial;
  return WEATHER_STATES.stormy;
}

function renderWeather() {
  var card = document.getElementById('weather-card');
  if (!card) return;
  var w = getWeatherState();
  card.className = 'weather-card ' + w.cls;
  var iconEl  = document.getElementById('weather-icon');
  var labelEl = document.getElementById('weather-label');
  var descEl  = document.getElementById('weather-desc');
  if (iconEl)  iconEl.textContent  = w.icon;
  if (labelEl) labelEl.textContent = w.label;
  if (descEl)  descEl.textContent  = w.desc;
}

// ─────────────────────────
//  PARTY OVERVIEW
// ─────────────────────────
function renderPartyOverview() {
  var container = document.getElementById('party-overview-cards');
  if (!container) return;
  container.innerHTML = '';
  var today = new Date().toDateString();
  (state.party || []).forEach(function(char) {
    var def = CLASS_DEFS[char.class] || CLASS_DEFS['Mage'];
    var checkedIn = char.lastCheckIn === today;
    var hp = char.hp || 0;
    var isWounded = hp <= 2 && hp > 0;
    var isCollapsed = hp <= 0;
    var hpPct = (hp / 5) * 100;
    var hpColor = hp >= 4 ? 'var(--green)' : hp >= 3 ? 'var(--teal)' : hp >= 2 ? 'var(--orange)' : 'var(--red)';

    var row = document.createElement('div');
    row.className = 'party-overview-row';

    var iconDiv = document.createElement('div');
    iconDiv.className = 'pov-icon' + (isWounded || isCollapsed ? ' wounded' : checkedIn ? ' done' : '');
    iconDiv.textContent = def.icon;

    var infoDiv = document.createElement('div');
    infoDiv.className = 'pov-info';
    infoDiv.innerHTML =
      '<div class="pov-name">' + def.name + '</div>' +
      '<div class="pov-habit">' + esc(char.habit || '') + '</div>';

    var hpBar = document.createElement('div');
    hpBar.className = 'pov-hp-bar-track';
    hpBar.innerHTML = '<div class="pov-hp-bar-fill" style="width:' + hpPct + '%;background:' + hpColor + ';"></div>';

    row.appendChild(iconDiv);
    row.appendChild(infoDiv);
    row.appendChild(hpBar);
    container.appendChild(row);
  });
}

// ─────────────────────────
//  RENDER (main render)
// ─────────────────────────
function render() {
  var ld = getLevelData(state.xp);

  var avatarRaceMap = {'🧔':'Human','🧝':'Elf','👺':'Orc','🧙':'Wizard'};
  document.getElementById('char-avatar').textContent = state.avatar || '🧔';
  document.getElementById('char-name').textContent   = state.name   || 'Traveler';

  var primaryChar = (state.party && state.party[0]) || null;
  var heroClass   = primaryChar ? primaryChar.class : 'Mage';
  var raceLabel = (avatarRaceMap[state.avatar] || 'Traveler') + ' · ' + getTitle(heroClass, ld.level);
  document.getElementById('char-class').textContent  = raceLabel;
  document.getElementById('level-num').textContent   = ld.level;

  document.getElementById('xp-current').textContent  = state.xp;
  document.getElementById('xp-next-val').textContent = ld.xpAtEnd;
  document.getElementById('xp-fill').style.width     = ld.pct + '%';
  document.getElementById('xp-next-msg').textContent =
    ld.level < LEVEL_XP.length
      ? ld.toNext + ' XP to Level ' + (ld.level + 1)
      : 'Maximum rank achieved!';

  // Road Gold
  var vaultEl = document.getElementById('vault-amount');
  if (vaultEl) {
    var g = state.ironVault || 0;
    vaultEl.textContent = g + ' 💰';
  }
  var mapGold = document.getElementById('map-gold-display');
  if (mapGold) mapGold.textContent = (state.ironVault || 0) + ' 💰';

  // Streak (primary character)
  var streakCount = getGlobalStreak();
  var loggedToday = hasLoggedToday();
  var today = new Date().toDateString();

  var flameEl = document.getElementById('streak-banner-flame');
  var countEl = document.getElementById('streak-count');
  var rightEl = document.getElementById('streak-banner-right');

  if (flameEl) flameEl.style.filter = streakCount > 0 ? '' : 'grayscale(0.9)';
  if (countEl) {
    countEl.textContent = streakCount;
    countEl.style.color = streakCount > 0 ? 'var(--orange)' : 'var(--text-dark)';
  }
  if (rightEl) {
    if (loggedToday) {
      rightEl.textContent = streakCount + ' day' + (streakCount !== 1 ? 's' : '') + ' 🔥';
      rightEl.style.color = 'var(--green)';
    } else if (streakCount > 0) {
      rightEl.textContent = '⚠ At risk';
      rightEl.style.color = 'var(--orange)';
    } else {
      rightEl.textContent = 'Start today';
      rightEl.style.color = '';
    }
  }

  // XP bonus msg (hidden element for compat)
  var bonusMsg = document.getElementById('xp-bonus-msg');
  if (bonusMsg) {
    var streakBonus = Math.min(30, streakCount * 5);
    bonusMsg.textContent = streakBonus > 0 && loggedToday
      ? '🔥 Streak bonus active'
      : 'Check in to earn XP';
  }

  renderWeather();
  renderPartyOverview();
  renderParty();
  renderLog();
  renderMap();
  checkZoneBadge();

  // Add character slot
  var addWrap = document.getElementById('add-char-wrap');
  if (addWrap) {
    var maxSlots = getMaxSlots();
    var hasSlot  = maxSlots > (state.party || []).length;
    addWrap.classList.toggle('hidden', !hasSlot || (state.party || []).length === 0);
  }

  // Badge slots
  ['zone1','zone2','zone3','zone4'].forEach(function(bid) {
    var el = document.getElementById('badge-' + bid);
    if (!el) return;
    var pip = el.querySelector('.badge-pip');
    if (pip) pip.className = (state.badges||[]).indexOf(bid) !== -1 ? 'badge-pip earned' : 'badge-pip locked';
  });

  // Road bonus pips
  var daysLogged = (state.weekLogDays || []).length;
  var bonuses    = Math.min(3, state.roadBonusesThisMonth || 0);
  for (var i = 1; i <= 3; i++) {
    var pip2 = document.getElementById('road-pip-' + i);
    if (pip2) pip2.className = 'road-pip' + (i <= bonuses ? ' earned' : '');
  }
  var rbLabel = document.getElementById('road-bonus-label');
  if (rbLabel) {
    var daysNeeded = Math.max(0, 5 - daysLogged);
    if (bonuses >= 3) {
      rbLabel.textContent = '✦ All Road Bonuses earned this month';
    } else if (daysNeeded === 0) {
      rbLabel.textContent = '✦ Road Bonus earned — advancing the map!';
    } else if (daysLogged === 0) {
      rbLabel.textContent = 'Road Bonus — check in 5 days this week to advance early';
    } else {
      rbLabel.textContent = daysNeeded + ' more day' + (daysNeeded===1?'':'s') + ' this week for a Road Bonus';
    }
  }

  checkArrival();
}


// ─────────────────────────
//  XP / LEVEL HELPERS
// ─────────────────────────
function getLevelData(xp) {
  var level = 1;
  for (var i = LEVEL_XP.length - 1; i >= 0; i--) {
    if (xp >= LEVEL_XP[i]) { level = i + 1; break; }
  }
  level = Math.min(level, LEVEL_XP.length);
  var xpAtStart = LEVEL_XP[level - 1] || 0;
  var xpAtEnd   = level < LEVEL_XP.length ? LEVEL_XP[level] : LEVEL_XP[LEVEL_XP.length - 1];
  var inLevel   = xp - xpAtStart;
  var needed    = xpAtEnd - xpAtStart;
  var pct       = needed > 0 ? Math.min(100, (inLevel / needed) * 100) : 100;
  var toNext    = Math.max(0, xpAtEnd - xp);
  return { level: level, xpAtEnd: xpAtEnd, pct: pct, toNext: toNext };
}

function getTitle(heroClass, level) {
  var titles = CLASS_TITLES[heroClass] || CLASS_TITLES['Mage'];
  var idx = Math.min(Math.floor((level - 1) / 2), titles.length - 1);
  return titles[idx];
}

// ─────────────────────────
//  MAP HELPERS
// ─────────────────────────
function getMapPosition() { return state.mapPosition || 0; }

function getCurrentWaypoint() {
  var pos = getMapPosition();
  for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
    if (MAP_WAYPOINTS[i].id === pos) return MAP_WAYPOINTS[i];
  }
  return MAP_WAYPOINTS[0];
}

function advanceMap() {
  var pos = getMapPosition();
  // numeric positions: 0-10
  var maxNumeric = 10;
  if (typeof pos === 'number' && pos < maxNumeric) {
    state.mapPosition = pos + 1;
    state.lastMapPosition = pos;
    save();
    return true;
  }
  return false;
}

// ─────────────────────────
//  WEEK ROAD BONUS
// ─────────────────────────
function checkMonthReset() {
  // Monthly reset: just track month, no budget reset needed
  // Map position and XP carry forward
  // Party check-in logs can optionally be trimmed
}

function getCurrentMonth() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
}

function getWeekStart() {
  var d = new Date();
  var day = d.getDay(); // 0=Sun
  d.setDate(d.getDate() - day);
  return d.toDateString();
}

function checkWeekRoadBonus() {
  var ws = getWeekStart();
  if (state.weekStart !== ws) {
    state.weekStart   = ws;
    state.weekLogDays = [];
  }
  var today = getToday();
  if (state.weekLogDays.indexOf(today) === -1) {
    state.weekLogDays.push(today);
  }
  // 5+ unique days this week → road bonus (up to 3 per month)
  if (state.weekLogDays.length >= 5 && (state.roadBonusesThisMonth || 0) < 3) {
    state.roadBonusesThisMonth = (state.roadBonusesThisMonth || 0) + 1;
    state.weekLogDays = []; // reset so they can earn next week
    showToast('🗺️ Road Bonus earned! Advancing the map...');
    setTimeout(function() {
      if (advanceMap()) { render(); checkZoneBadge(); checkArrival(); }
    }, 1400);
  }
}

// ─────────────────────────
//  ARRIVAL POPUPS
// ─────────────────────────

// ─────────────────────────
//  ARRIVAL GOLD GIFT
// ─────────────────────────
function arrivalGoldAmount(pos) {
  if (pos <= 2) return 12;
  if (pos <= 5) return 10;
  if (pos <= 8) return 8;
  return 6;
}

function giftArrivalGold(pos) {
  var amount = arrivalGoldAmount(pos);
  state.ironVault = (state.ironVault || 0) + amount;
  save();
  render();
  setTimeout(function() {
    fireGoldFloat('+' + amount + ' 💰');
    showToast('💰 +' + amount + ' gold — the road provides.');
  }, 300);
}
function checkArrival() {
  var pos = getMapPosition();
  if (pos === state.lastMapPosition) return;
  var wp = getCurrentWaypoint();
  if (!wp) return;
  if (!Array.isArray(state.seenArrivals)) state.seenArrivals = [];
  var aid = 'arr_' + wp.id;
  if (state.seenArrivals.indexOf(aid) !== -1) return;
  state.seenArrivals.push(aid);
  save();

  if (wp.zoneComplete) {
    // already handled by checkZoneBadge
    return;
  }
  if (wp.arrival) {
    var _pos = pos; // capture for closure
    queueOverlay(function() { showStoryEncounter(wp.icon || '📍', wp.name.replace('\n',' '), wp.arrival, 'story', _pos); });
  }
}

function showStoryEncounter(icon, title, desc, type, goldPos) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box story';
  document.getElementById('encounter-zone').textContent  = '✦ New Location Reached';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = title;
  document.getElementById('encounter-desc').textContent  = desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  // Show gold reward on the button so player knows it's coming
  var goldAmt = (goldPos !== undefined) ? arrivalGoldAmount(goldPos) : 0;
  btn.innerHTML = goldAmt > 0
    ? 'Onward ⚔ <span class="overlay-btn-cost">+' + goldAmt + ' 💰 road gold</span>'
    : 'Onward ⚔';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    if (goldPos !== undefined) giftArrivalGold(goldPos);
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}


// ─────────────────────────
//  BROKEN (0 HEARTS)
// ─────────────────────────
var REVIVE_COST = 30; // gold cost to revive with 3 hearts
var XP_PENALTY  = 50; // xp lost if reviving broke

function checkBroken() {
  if ((state.hearts || 0) <= 0) {
    queueOverlay(function() { showBroken(); });
  }
}

function showBroken() {
  var gold = state.ironVault || 0;
  document.getElementById('broken-gold-display').textContent = gold + ' 💰';

  var choices = document.getElementById('broken-choices');
  choices.innerHTML = '';

  if (gold >= REVIVE_COST) {
    var btnA = document.createElement('button');
    btnA.className = 'overlay-btn hostile-choice';
    btnA.style.width = '100%'; btnA.style.textAlign = 'center';
    btnA.innerHTML = '🪙 Spend ' + REVIVE_COST + ' 💰 to revive<span class="overlay-btn-cost">Hearts restored to full — road continues</span>';
    btnA.onclick = function() { resolveRevive('gold'); };
    choices.appendChild(btnA);
  }

  var btnB = document.createElement('button');
  btnB.className = 'overlay-btn';
  btnB.style.width = '100%'; btnB.style.textAlign = 'center';
  btnB.innerHTML = '💀 Carry on broke<span class="overlay-btn-cost">Lose ' + XP_PENALTY + ' XP — hearts restored, Road Gold untouched</span>';
  btnB.onclick = function() { resolveRevive('xp'); };
  choices.appendChild(btnB);

  document.getElementById('broken-overlay').classList.add('show');
}

function resolveRevive(method) {
  document.getElementById('broken-overlay').classList.remove('show');
  overlayDismissed();
  state.hearts = 3;
  if (method === 'gold') {
    state.ironVault = Math.max(0, (state.ironVault || 0) - REVIVE_COST);
    showToast('💰 ' + REVIVE_COST + ' gold spent — back on your feet.');
    fireGoldFloat('-' + REVIVE_COST + ' 💰');
  } else {
    state.xp = Math.max(0, (state.xp || 0) - XP_PENALTY);
    showToast('💀 Carried on broke — ' + XP_PENALTY + ' XP lost. Hearts restored.');
  }
  save();
  render();
}

// ─────────────────────────
//  OVERLAY QUEUE
// ─────────────────────────
var _overlayQueue = [];
var _overlayActive = false;

function queueOverlay(fn) {
  _overlayQueue.push(fn);
  _drainQueue();
}

function _drainQueue() {
  if (_overlayActive || _overlayQueue.length === 0) return;
  _overlayActive = true;
  var next = _overlayQueue.shift();
  next();
}

// Call this at the END of every overlay dismiss handler
function overlayDismissed() {
  _overlayActive = false;
  // Small gap so the transition plays out before next one appears
  setTimeout(_drainQueue, 350);
}

// ─────────────────────────
//  RANDOM ENCOUNTERS
// ─────────────────────────
function checkEncounter(amount) { amount = amount || 0;
  // Cooldown: skip if last encounter was within the last 2 logs
  if (!state.encounterLogCount) state.encounterLogCount = 0;
  state.encounterLogCount++;
  var lastAt = state.lastEncounterAtLog || 0;
  if (state.encounterLogCount - lastAt < 1) {
    maybeShowRoadEvent();
    return;
  }

  // 45% chance per eligible log for a combat/friendly encounter
  if (Math.random() > 0.55) {
    maybeShowRoadEvent();
    return;
  }

  // Mark that an encounter fired at this log count
  state.lastEncounterAtLog = state.encounterLogCount;
  save();

  // Check for unseen story encounters first (priority)
  var pos = getMapPosition();
  var zone = pos <= 2 ? 'z1' : pos <= 5 ? 'z2' : pos <= 8 ? 'z3' : 'z4';
  var storyPool = STORY_ENCOUNTERS[zone] || [];
  var available = storyPool.filter(function(e) {
    return e.minPos <= pos && (state.seenStoryEncounters || []).indexOf(e.id) === -1;
  });

  if (available.length > 0 && Math.random() < 0.75) {
    var enc = available[Math.floor(Math.random() * available.length)];
    if (!state.seenStoryEncounters) state.seenStoryEncounters = [];
    state.seenStoryEncounters.push(enc.id);
    save();
    queueOverlay(function() { showStoryEncounterFull(enc); });
    return;
  }

  // Otherwise hostile (40%) or friendly (60%)
  if (Math.random() < 0.40) {
    var hostile = HOSTILE_ENCOUNTERS[Math.floor(Math.random() * HOSTILE_ENCOUNTERS.length)];
    queueOverlay(function() { showEncounter(hostile, true); });
  } else {
    var friendly = FRIENDLY_ENCOUNTERS[Math.floor(Math.random() * FRIENDLY_ENCOUNTERS.length)];
    queueOverlay(function() { showEncounter(friendly, false); });
  }
}

function showStoryEncounterFull(enc) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box story';
  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'Keep Moving ⚔';
  btn.onclick = function() { document.getElementById('encounter-overlay').classList.remove('show'); overlayDismissed(); };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

function showEncounter(enc, isHostile) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box ' + (isHostile ? 'hostile' : 'friendly');

  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;

  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';

  if (isHostile) {
    var btnA = document.createElement('button');
    btnA.className = 'overlay-btn hostile-choice';
    btnA.innerHTML = enc.choiceA.label + '<span class="overlay-btn-cost">' + enc.choiceA.sub + '</span>';
    btnA.onclick = function() { resolveHostile('heart', enc); };

    var btnB = document.createElement('button');
    var goldCost = enc.goldCost || 0;
    var hasGold  = (state.ironVault || 0) >= goldCost;
    if (hasGold) {
      btnB.className = 'overlay-btn';
      btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">' + enc.choiceB.sub + ' (' + (state.ironVault || 0) + ' 💰 available)</span>';
      btnB.onclick = function() { resolveHostile('gold', enc); };
    } else {
      btnB.className = 'overlay-btn overlay-btn-disabled';
      btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">Need ' + goldCost + ' 🪙 Road Gold — you have ' + (state.ironVault || 0) + '</span>';
      btnB.disabled = true;
    }

    choices.appendChild(btnA);
    choices.appendChild(btnB);
  } else {
    var btn = document.createElement('button');
    btn.className = 'overlay-btn friendly-choice';
    btn.innerHTML = 'Accept the reward<span class="overlay-btn-cost">' + enc.rewardDesc + '</span>';
    btn.onclick = function() { resolveFriendly(enc); };
    choices.appendChild(btn);
  }

  document.getElementById('encounter-overlay').classList.add('show');
}

function resolveHostile(choice, enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  overlayDismissed();
  if (choice === 'heart') {
    state.hearts = Math.max(0, (state.hearts || 3) - 1);
    showToast('❤️ Heart spent — the threat is driven back.');
  } else if (choice === 'gold') {
    var cost = enc.goldCost || 0;
    state.ironVault = Math.max(0, (state.ironVault || 0) - cost);
    showToast('💰 ' + cost + ' gold spent — problem solved.');
    fireGoldFloat('-' + cost + ' 💰');
  }
  save();
  render();
  checkBroken();
}

function resolveFriendly(enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  overlayDismissed();
  if (enc.reward.type === 'xp') {
    state.xp += enc.reward.amount;
    showToast('✨ +' + enc.reward.amount + ' bonus XP!');
  } else if (enc.reward.type === 'heart') {
    state.hearts = Math.min(3, (state.hearts || 0) + 1);
    showToast('❤️ Heart restored!');
  } else if (enc.reward.type === 'gold') {
    state.ironVault = (state.ironVault || 0) + enc.reward.amount;
    showToast('💰 +' + enc.reward.amount + ' Road Gold earned!');
    fireGoldFloat('+' + enc.reward.amount + ' 💰');
  }
  save();
  render();
}

function checkZoneBadge() {
  var pos = getMapPosition();
  var badges = state.badges || [];

  if (pos >= 3 && badges.indexOf('zone1') === -1) {
    badges.push('zone1'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🛡️', 'The First Steps', 'You clear the Hearthstone Road. First zone down. It feels smaller looking back.'); });
  }
  if (pos >= 6 && badges.indexOf('zone2') === -1) {
    badges.push('zone2'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🪙', 'Disciplined Traveler', "The Merchant's Pass is behind you. You navigated the markets and kept your budget intact."); });
  }
  if (pos >= 9 && badges.indexOf('zone3') === -1) {
    badges.push('zone3'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🌿', 'Thornwood Survivor', 'Thornwood cleared. Turns out it\'s just a forest if you keep logging. You come out the other side intact.'); });
  }
  if (pos >= 10 && badges.indexOf('zone4') === -1) {
    badges.push('zone4'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🔒', 'Keeper of the Road', 'You have reached the Iron Keep. The road ahead is longer and wider than any map shows. You are ready.'); });
  }
}

function showZoneComplete(icon, badgeName, narrative) {
  var ZONE_GOLD = 25;
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box zone-complete';
  document.getElementById('encounter-zone').textContent  = '✦ Zone Complete';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = 'Badge Earned: ' + badgeName;
  document.getElementById('encounter-desc').textContent  = narrative;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'March Forward ⚔ <span class="overlay-btn-cost">+' + ZONE_GOLD + ' 💰 zone bonus</span>';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    state.ironVault = (state.ironVault || 0) + ZONE_GOLD;
    save(); render();
    setTimeout(function() {
      fireGoldFloat('+' + ZONE_GOLD + ' 💰');
      showToast('💰 +' + ZONE_GOLD + ' gold — zone cleared!');
    }, 300);
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

// ─────────────────────────
//  RENDER MAP
// ─────────────────────────
function renderMap() {
  var pos = getMapPosition();
  var wp  = getCurrentWaypoint();

  if (wp) {
    document.getElementById('map-location-name').textContent = wp.name.replace('\n',' ');
    var zoneNums = ['I','II','III','IV'];
    var zoneIdx  = typeof wp.zone === 'number' ? wp.zone - 1 : 0;
    document.getElementById('map-zone-tag').textContent =
      'Zone ' + (zoneNums[zoneIdx] || 'I') + ' — ' + (wp.zoneName || '');
  }

  // ── MAP DIMENSIONS — full height, no scroll ─────────────────────────
  var W_base = (document.getElementById('map-viewport') || {}).offsetWidth || 340;
  var W = W_base;
  var H = Math.round(W * 2.1); // tall portrait — like a real map
  H = Math.max(460, Math.min(H, 620));

  // Pure linear zig-zag — always forward, no badge spurs
  var NODE_LAYOUT = [
    { id:0,  pct:[50,  4] },   // Hearthstone Village — center top
    { id:1,  pct:[72, 13] },   // Harvest Crossing — right
    { id:2,  pct:[30, 22] },   // Stonepath Mill — left
    { id:3,  pct:[68, 33] },   // Merchant's Gate — right
    { id:4,  pct:[32, 43] },   // Copperbridge — left
    { id:5,  pct:[65, 53] },   // Trader's Camp — right
    { id:6,  pct:[35, 63] },   // Thornwood Edge — left
    { id:7,  pct:[68, 72] },   // Darkhollow Path — right
    { id:8,  pct:[38, 81] },   // Wayward Shrine — left
    { id:9,  pct:[62, 90] },   // Iron Keep Gates — right
    { id:10, pct:[50, 97] },   // The Iron Keep — center bottom
  ];

  // Single continuous road — always forward
  var CONNECTIONS = [
    [0,1],[1,2],[2,3],[3,4],[4,5],[5,6],[6,7],[7,8],[8,9],[9,10],
  ];

  var container  = document.getElementById('node-map');
  var viewport   = document.getElementById('map-viewport');
  var inner      = document.getElementById('node-map-inner');
  var svg        = document.getElementById('map-svg');
  var moreArrow  = document.getElementById('map-more-arrow');
  if (!container || !inner || !svg || !viewport) return;

  container.style.height = H + 'px';
  viewport.style.height  = H + 'px'; // full height — no clipping
  svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
  svg.style.height = H + 'px';
  svg.style.width  = '100%';

  var posMap = {};
  NODE_LAYOUT.forEach(function(n) {
    posMap[n.id] = {
      x: Math.round(W * n.pct[0] / 100),
      y: Math.round(H * n.pct[1] / 100)
    };
  });

  // No camera pan needed — full map visible
  container.style.transform = 'none';
  if (moreArrow) moreArrow.className = 'map-more-arrow hidden';

  function isReached(id) {
    if (typeof id === 'number') return id <= pos;
    var bm = {'z1':3,'z2':6,'z3':9,'z4':10};
    return pos >= (bm[id] || 999);
  }

  // ── SVG DEFS — parchment filter + terrain symbols ──────────────────
  svg.innerHTML = '';

  var defs = document.createElementNS('http://www.w3.org/2000/svg','defs');

  // Parchment noise filter
  defs.innerHTML = [
    '<filter id="road-blur"><feGaussianBlur stdDeviation="0.8"/></filter>',
    '<radialGradient id="vignette" cx="50%" cy="50%" r="60%">',
    '<stop offset="0%" stop-color="transparent"/>',
    '<stop offset="100%" stop-color="rgba(8,6,4,0.55)"/>',
    '</radialGradient>',
    '<radialGradient id="zone1-bg" cx="50%" cy="20%" r="55%">',
    '<stop offset="0%" stop-color="#2a1f0a" stop-opacity="0.9"/>',
    '<stop offset="100%" stop-color="#1a1208" stop-opacity="0.9"/>',
    '</radialGradient>',
    '<radialGradient id="zone2-bg" cx="50%" cy="50%" r="55%">',
    '<stop offset="0%" stop-color="#251608" stop-opacity="0.9"/>',
    '<stop offset="100%" stop-color="#1a1005" stop-opacity="0.9"/>',
    '</radialGradient>',
    '<radialGradient id="zone3-bg" cx="50%" cy="50%" r="55%">',
    '<stop offset="0%" stop-color="#0a1a0e" stop-opacity="0.92"/>',
    '<stop offset="100%" stop-color="#060d08" stop-opacity="0.92"/>',
    '</radialGradient>',
    '<radialGradient id="zone4-bg" cx="50%" cy="80%" r="55%">',
    '<stop offset="0%" stop-color="#140a22" stop-opacity="0.94"/>',
    '<stop offset="100%" stop-color="#0a0614" stop-opacity="0.94"/>',
    '</radialGradient>'
  ].join('');
  svg.appendChild(defs);

  // ── ZONE BACKGROUNDS ────────────────────────────────────────────────
  var zoneBands = [
    { y1: 0,  y2: 24, fill: 'url(#zone1-bg)' },
    { y1: 24, y2: 46, fill: 'url(#zone2-bg)' },
    { y1: 46, y2: 75, fill: 'url(#zone3-bg)' },
    { y1: 75, y2: 100, fill: 'url(#zone4-bg)' },
  ];
  zoneBands.forEach(function(zb) {
    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', '0');
    r.setAttribute('y', Math.round(H * zb.y1/100) + '');
    r.setAttribute('width', W + '');
    r.setAttribute('height', Math.round(H * (zb.y2-zb.y1)/100) + '');
    r.setAttribute('fill', zb.fill);
    svg.appendChild(r);
  });

  // ── SUBTLE TEXTURE OVERLAY — crosshatch pattern ──────────────────────
  // Use a tiny SVG pattern for aged-parchment feel (no filter = no pixelation)
  var patDef = document.createElementNS('http://www.w3.org/2000/svg','pattern');
  patDef.setAttribute('id','hatch'); patDef.setAttribute('width','6');
  patDef.setAttribute('height','6'); patDef.setAttribute('patternUnits','userSpaceOnUse');
  var pl = document.createElementNS('http://www.w3.org/2000/svg','path');
  pl.setAttribute('d','M0,6 L6,0 M-1,1 L1,-1 M5,7 L7,5');
  pl.setAttribute('stroke','rgba(180,140,60,0.04)'); pl.setAttribute('stroke-width','0.5');
  patDef.appendChild(pl);
  defs.appendChild(patDef);
  var texRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
  texRect.setAttribute('x','0'); texRect.setAttribute('y','0');
  texRect.setAttribute('width',W+''); texRect.setAttribute('height',H+'');
  texRect.setAttribute('fill','url(#hatch)');
  svg.appendChild(texRect);

  // ── ZONE SEPARATOR RULES ────────────────────────────────────────────
  var sepPcts = [24, 46, 75];
  sepPcts.forEach(function(pct) {
    var y = Math.round(H * pct/100);
    // Decorative rule — double line with gap
    [-1,1].forEach(function(offset) {
      var l = document.createElementNS('http://www.w3.org/2000/svg','line');
      l.setAttribute('x1','8'); l.setAttribute('y1', y+offset+'');
      l.setAttribute('x2', W-8+''); l.setAttribute('y2', y+offset+'');
      l.setAttribute('stroke','rgba(196,162,74,0.18)');
      l.setAttribute('stroke-width','0.5');
      svg.appendChild(l);
    });
    // Center ornament
    var diamond = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    var cx = Math.round(W/2), cy = y;
    diamond.setAttribute('points', cx+','+( cy-4)+' '+(cx+4)+','+cy+' '+cx+','+(cy+4)+' '+(cx-4)+','+cy);
    diamond.setAttribute('fill','rgba(196,162,74,0.35)');
    svg.appendChild(diamond);
  });

  // ── ZONE NAME LABELS ────────────────────────────────────────────────
  var zoneLabels = [
    { text:'Hearthstone Road', pct: 3,  anchor:'start', x: 10 },
    { text:"Merchant's Pass",  pct: 26, anchor:'start', x: 10 },
    { text:'The Thornwood',    pct: 48, anchor:'start', x: 10 },
    { text:'The Iron Keep',    pct: 77, anchor:'start', x: 10 },
  ];
  zoneLabels.forEach(function(zl) {
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', zl.x+'');
    t.setAttribute('y', Math.round(H * zl.pct/100) + 14 + '');
    t.setAttribute('fill','rgba(196,162,74,0.55)');
    t.setAttribute('font-size','11');
    t.setAttribute('font-family',"'Cinzel', serif");
    t.setAttribute('font-weight','700');
    t.setAttribute('letter-spacing','2.5');
    t.setAttribute('text-anchor', zl.anchor);
    t.textContent = zl.text.toUpperCase();
    svg.appendChild(t);
  });

  // ── LotR-STYLE CARTOGRAPHIC ILLUSTRATIONS ──────────────────────────

  function svgEl(tag, attrs) {
    var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (var k in attrs) el.setAttribute(k, attrs[k]);
    svg.appendChild(el);
    return el;
  }

  function line(x1,y1,x2,y2,stroke,sw,opacity) {
    svgEl('line',{x1:x1,y1:y1,x2:x2,y2:y2,stroke:stroke,'stroke-width':sw||1,opacity:opacity||1,'stroke-linecap':'round'});
  }

  // LotR-style tree: trunk + radiating branch strokes (top-down cartographic symbol)
  function cartTree(cx, cy, sz, op) {
    var col = 'rgba(45,75,40,'+op+')';
    // trunk
    line(cx, cy+sz*0.3, cx, cy-sz*0.1, col, sz*0.18);
    // canopy circle
    svgEl('circle',{cx:cx,cy:cy-sz*0.15,r:sz*0.55,fill:'rgba(35,65,32,'+(op*0.7)+')',stroke:col,'stroke-width':sz*0.12});
    // radiating lines from canopy center
    for (var a=0; a<6; a++) {
      var ang = (a/6)*Math.PI*2;
      var r1=sz*0.1, r2=sz*0.52;
      line(cx+Math.cos(ang)*r1, cy-sz*0.15+Math.sin(ang)*r1,
           cx+Math.cos(ang)*r2, cy-sz*0.15+Math.sin(ang)*r2,
           'rgba(55,90,48,'+(op*0.6)+')', sz*0.08);
    }
  }

  function treeLine(x1,y1,x2,y2,count,sz,op) {
    for (var i=0; i<count; i++) {
      var t = i/(Math.max(count-1,1));
      cartTree(x1+(x2-x1)*t, y1+(y2-y1)*t, sz, op);
    }
  }

  // LotR hill: overlapping stippled mound with contour lines
  function hill(cx, cy, rx, ry, op) {
    var col = 'rgba(110,90,60,'+op+')';
    var col2 = 'rgba(80,65,42,'+(op*0.7)+')';
    // Base ellipse
    svgEl('ellipse',{cx:cx,cy:cy,rx:rx,ry:ry*0.6,fill:'rgba(90,72,48,'+(op*0.35)+')',stroke:col,'stroke-width':0.8});
    // Contour lines — 3 progressively smaller arcs drawn as paths
    for (var t=1; t<=3; t++) {
      var scale = 1 - t*0.22;
      var yo = -ry*0.12*t;
      var path = svgEl('path',{
        d:'M '+(cx-rx*scale)+','+(cy+yo)+' Q '+cx+','+(cy-ry*scale*0.9+yo)+' '+(cx+rx*scale)+','+(cy+yo),
        fill:'none', stroke:col2, 'stroke-width':0.7, opacity:op*0.8
      });
    }
    // Stipple dots on the mound
    for (var d=0; d<8; d++) {
      var ang = (d/8)*Math.PI;
      var dx = Math.cos(ang)*rx*0.55, dy = -Math.abs(Math.sin(ang))*ry*0.45;
      svgEl('circle',{cx:cx+dx,cy:cy+dy,r:0.8,fill:col,opacity:op*0.9});
      svgEl('circle',{cx:cx-dx*0.5,cy:cy+dy*0.7,r:0.6,fill:col,opacity:op*0.7});
    }
  }

  // Keep/fortress symbol: cross-shaped fortification
  function castle(cx, cy, sz, op) {
    var col = 'rgba(130,105,70,'+op+')';
    var col2 = 'rgba(90,70,45,'+(op*0.8)+')';
    // Main keep body
    svgEl('rect',{x:cx-sz*0.35,y:cy-sz*0.7,width:sz*0.7,height:sz*0.9,fill:'rgba(100,80,55,'+(op*0.5)+')',stroke:col,'stroke-width':0.8});
    // Tower left
    svgEl('rect',{x:cx-sz*0.6,y:cy-sz*0.5,width:sz*0.28,height:sz*0.7,fill:'rgba(110,88,58,'+(op*0.4)+')',stroke:col,'stroke-width':0.7});
    // Tower right
    svgEl('rect',{x:cx+sz*0.32,y:cy-sz*0.5,width:sz*0.28,height:sz*0.7,fill:'rgba(110,88,58,'+(op*0.4)+')',stroke:col,'stroke-width':0.7});
    // Battlement notches — main keep
    for (var b=0; b<4; b++) {
      var bx = cx - sz*0.28 + b*sz*0.18;
      svgEl('rect',{x:bx,y:cy-sz*0.82,width:sz*0.1,height:sz*0.15,fill:col});
    }
    // Battlement notches — left tower
    svgEl('rect',{x:cx-sz*0.57,y:cy-sz*0.62,width:sz*0.08,height:sz*0.13,fill:col});
    svgEl('rect',{x:cx-sz*0.42,y:cy-sz*0.62,width:sz*0.08,height:sz*0.13,fill:col});
    // Gate arch
    svgEl('path',{d:'M '+(cx-sz*0.12)+','+(cy+sz*0.2)+' Q '+cx+','+(cy-sz*0.05)+' '+(cx+sz*0.12)+','+(cy+sz*0.2),
      fill:'rgba(20,14,8,'+(op*1.5)+')',stroke:col2,'stroke-width':0.5});
    // Cross window
    line(cx, cy-sz*0.45, cx, cy-sz*0.15, col2, sz*0.07, op);
    line(cx-sz*0.12, cy-sz*0.32, cx+sz*0.12, cy-sz*0.32, col2, sz*0.07, op);
  }

  // Compass rose — bottom right corner
  function compass(cx, cy, sz) {
    var col = 'rgba(196,162,74,0.55)';
    var colFaint = 'rgba(196,162,74,0.25)';
    // Cardinal spokes
    var dirs = [[0,-1],[1,0],[0,1],[-1,0]];
    dirs.forEach(function(d) {
      line(cx+d[0]*sz*0.25, cy+d[1]*sz*0.25, cx+d[0]*sz, cy+d[1]*sz, col, 0.8);
    });
    // Intercardinal spokes (shorter)
    [[1,-1],[1,1],[-1,1],[-1,-1]].forEach(function(d) {
      var n = Math.sqrt(2);
      line(cx+d[0]/n*sz*0.2, cy+d[1]/n*sz*0.2, cx+d[0]/n*sz*0.7, cy+d[1]/n*sz*0.7, colFaint, 0.6);
    });
    // N arrow tip (diamond)
    svgEl('polygon',{
      points: cx+','+(cy-sz)+' '+(cx-sz*0.15)+','+(cy-sz*0.55)+' '+cx+','+(cy-sz*0.2)+' '+(cx+sz*0.15)+','+(cy-sz*0.55),
      fill:col
    });
    // Center dot
    svgEl('circle',{cx:cx,cy:cy,r:sz*0.12,fill:col});
    // N label
    var t = svgEl('text',{x:cx,y:cy-sz*1.15,'text-anchor':'middle',fill:col,'font-size':sz*0.55,'font-family':"'Cinzel',serif",'font-weight':'700'});
    t.textContent = 'N';
  }

  // ── PLACE ILLUSTRATIONS ──────────────────────────────────────────────

  // Zone 1 — Hearthstone Road: rolling hills flanking the path
  var z1y = Math.round(H * 0.10);
  hill(Math.round(W*0.12), z1y+5, 22, 14, 0.55);
  hill(Math.round(W*0.22), z1y+12, 18, 11, 0.4);
  hill(Math.round(W*0.85), z1y+5,  22, 14, 0.55);
  hill(Math.round(W*0.75), z1y+12, 18, 11, 0.4);
  // Smaller hills mid-zone
  hill(Math.round(W*0.10), Math.round(H*0.18), 14, 9, 0.35);
  hill(Math.round(W*0.88), Math.round(H*0.18), 14, 9, 0.35);

  // Zone 2 — Merchant's Pass: sparse trees, merchant camp suggestion
  treeLine(Math.round(W*0.08), Math.round(H*0.30), Math.round(W*0.08), Math.round(H*0.42), 4, 7, 0.45);
  treeLine(Math.round(W*0.92), Math.round(H*0.30), Math.round(W*0.92), Math.round(H*0.42), 4, 7, 0.45);

  // Zone 3 — Thornwood: dense forest both sides
  treeLine(Math.round(W*0.06), Math.round(H*0.50), Math.round(W*0.10), Math.round(H*0.72), 6, 8, 0.55);
  treeLine(Math.round(W*0.14), Math.round(H*0.52), Math.round(W*0.10), Math.round(H*0.70), 4, 6, 0.38);
  treeLine(Math.round(W*0.90), Math.round(H*0.50), Math.round(W*0.88), Math.round(H*0.72), 6, 8, 0.55);
  treeLine(Math.round(W*0.82), Math.round(H*0.52), Math.round(W*0.86), Math.round(H*0.70), 4, 6, 0.38);
  // Extra tree depth
  treeLine(Math.round(W*0.06), Math.round(H*0.60), Math.round(W*0.12), Math.round(H*0.65), 3, 5, 0.28);
  treeLine(Math.round(W*0.88), Math.round(H*0.60), Math.round(W*0.94), Math.round(H*0.65), 3, 5, 0.28);

  // Zone 4 — Iron Keep: castle illustration center-top of zone
  castle(Math.round(W*0.50), Math.round(H*0.83), 20, 0.65);
  // Flanking towers (smaller)
  castle(Math.round(W*0.15), Math.round(H*0.87), 12, 0.45);
  castle(Math.round(W*0.85), Math.round(H*0.87), 12, 0.45);

  // Compass rose — bottom-right
  compass(W - 28, H - 28, 16);

  // ── ROAD CONNECTIONS — curved bezier paths ──────────────────────────
  function makePath(a, b) {
    // Gentle S-curve between two points
    var dx = b.x - a.x, dy = b.y - a.y;
    var mx1 = a.x + dx*0.25 + dy*0.08;
    var my1 = a.y + dy*0.4  - dx*0.05;
    var mx2 = b.x - dx*0.25 + dy*0.08;
    var my2 = b.y - dy*0.4  - dx*0.05;
    return 'M '+a.x+' '+a.y+' C '+mx1+' '+my1+', '+mx2+' '+my2+', '+b.x+' '+b.y;
  }

  CONNECTIONS.forEach(function(conn) {
    var a = posMap[conn[0]], b = posMap[conn[1]];
    if (!a || !b) return;
    var traveled = isReached(conn[0]) && isReached(conn[1]);

    // Road shadow (depth)
    var shadow = document.createElementNS('http://www.w3.org/2000/svg','path');
    shadow.setAttribute('d', makePath(a,b));
    shadow.setAttribute('stroke','rgba(0,0,0,0.5)');
    shadow.setAttribute('stroke-width', traveled ? '5' : '3.5');
    shadow.setAttribute('fill','none');
    shadow.setAttribute('stroke-linecap','round');
    svg.appendChild(shadow);

    // Road body
    var path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', makePath(a,b));
    if (traveled) {
      path.setAttribute('stroke','rgba(196,162,74,0.7)');
      path.setAttribute('stroke-width','2.5');
    } else {
      path.setAttribute('stroke','rgba(90,75,50,0.3)');
      path.setAttribute('stroke-width','1.8');
      path.setAttribute('stroke-dasharray','5 7');
    }
    path.setAttribute('fill','none');
    path.setAttribute('stroke-linecap','round');
    svg.appendChild(path);
  });

  // Vignette overlay
  var vig = document.createElementNS('http://www.w3.org/2000/svg','rect');
  vig.setAttribute('x','0'); vig.setAttribute('y','0');
  vig.setAttribute('width',W+''); vig.setAttribute('height',H+'');
  vig.setAttribute('fill','url(#vignette)');
  vig.setAttribute('pointer-events','none');
  svg.appendChild(vig);

  // ── NODE DOM ELEMENTS ───────────────────────────────────────────────
  inner.innerHTML = '';
  inner.style.height = H + 'px';

  NODE_LAYOUT.forEach(function(layout) {
    var wpData = null;
    for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
      if (MAP_WAYPOINTS[i].id === layout.id) { wpData = MAP_WAYPOINTS[i]; break; }
    }
    if (!wpData) return;

    // Skip badge nodes — they're celebrated via overlay, not shown on map
    if (typeof layout.id === 'string') return;

    var isDone    = layout.id < pos;
    var isCurrent = layout.id === pos;

    var px = posMap[layout.id];

    var wrap = document.createElement('div');
    wrap.className = 'map-node-wrap' + (isCurrent ? ' current' : '');
    wrap.style.left = px.x + 'px';
    wrap.style.top  = px.y + 'px';

    var circle = document.createElement('div');
    var zoneClass = typeof wpData.zone === 'number' ? ' zone' + wpData.zone : '';
    var cc = 'map-node-circle' + zoneClass;
    cc += isDone ? ' done' : isCurrent ? ' current' : ' ahead';
    circle.className = cc;
    circle.textContent = wpData.icon;

    var label = document.createElement('div');
    label.className = 'map-node-label';
    label.textContent = wpData.name.replace('\n',' ');

    wrap.appendChild(circle);
    wrap.appendChild(label);
    inner.appendChild(wrap);
  });

  // Road bonus pips
  var bonuses = Math.min(3, state.roadBonusesThisMonth || 0);
  for (var i = 1; i <= 3; i++) {
    var pip = document.getElementById('road-pip-' + i);
    if (pip) pip.className = 'road-pip' + (i <= bonuses ? ' earned' : '');
  }
  // Road bonus countdown label
  var rbLabel = document.getElementById('road-bonus-label');
  if (rbLabel) {
    var daysLogged = (state.weekLogDays || []).length;
    var daysNeeded = Math.max(0, 5 - daysLogged);
    if (bonuses >= 3) {
      rbLabel.textContent = '✦ All Road Bonuses earned this month';
    } else if (daysNeeded === 0) {
      rbLabel.textContent = '✦ Road Bonus earned — advancing the map!';
    } else if (daysLogged === 0) {
      rbLabel.textContent = 'Road Bonus — log 5 days this week to advance early';
    } else {
      rbLabel.textContent = daysNeeded + ' more day' + (daysNeeded === 1 ? '' : 's') + ' this week for a Road Bonus';
    }
  }

  // Road Gold in map header
  var mapGoldEl = document.getElementById('map-gold-display');
  if (mapGoldEl) mapGoldEl.textContent = (state.ironVault || 0) + ' 💰';

  // Badge slots
  ['zone1','zone2','zone3','zone4'].forEach(function(bid) {
    var el = document.getElementById('badge-' + bid);
    if (!el) return;
    var pip = el.querySelector('.badge-pip');
    if (pip) pip.className = (state.badges||[]).indexOf(bid) !== -1 ? 'badge-pip earned' : 'badge-pip locked';
  });
}

// ─────────────────────────
//  RENDER
// ─────────────────────────
function getCurrentMonth() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
}









function formatDate(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─────────────────────────
//  ONBOARDING
// ─────────────────────────
var currentStep = 0;






// ─────────────────────────
//  LOG EXPENSE
// ─────────────────────────

function fireGoldFloat(text) {
  var floatEl = document.getElementById('gold-float');
  if (!floatEl) return;
  var track = document.getElementById('vault-amount');
  if (!track) return;
  var rect = track.getBoundingClientRect();
  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top + window.scrollY) + 'px';
  floatEl.textContent = text;
  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

function fireXpFloat(text) {
  var floatEl = document.getElementById('xp-float');
  var track   = document.getElementById('xp-fill');
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

function fireCoinFloat(text) {
  var floatEl = document.getElementById('coin-float');
  var track   = document.getElementById('coin-fill');
  if (!track) return;
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY + rect.height) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

// ─────────────────────────
//  LEVEL UP
// ─────────────────────────
// ─────────────────────────
//  ROAD EVENTS (post check-in story beats)
// ─────────────────────────
var ROAD_EVENTS = [
  { zone: '✦ The Road', icon: '🌅', title: 'Morning Light', desc: 'The road is quiet this early. Just you and the habit. You check in, and the day opens up a little.' },
  { zone: '✦ The Road', icon: '🐦', title: 'A Familiar Sound', desc: 'A bird calls from somewhere in the trees. You note it and keep moving. Small things become landmarks when you walk the same road long enough.' },
  { zone: '✦ Fellow Travelers', icon: '🧭', title: 'Passing Company', desc: 'A traveler nods at you from across the road. They don\'t stop. Neither do you. There\'s a kind of solidarity in that.' },
  { zone: '✦ The Road', icon: '🌿', title: 'The Habit Holds', desc: 'Day after day, the same motion. It starts to feel different from the inside — less like effort, more like nature.' },
  { zone: '✦ Rest Stop', icon: '🪨', title: 'A Moment on the Stone', desc: 'You pause at a roadside marker. Behind you, a chain of days you actually kept. That\'s not nothing.' },
  { zone: '✦ The Road', icon: '🌙', title: 'End of the Day', desc: 'You checked in. The day closes with that small act in it. It always matters more than it feels like it does.' },
  { zone: '✦ Roadside Inn', icon: '🏠', title: 'Word of You', desc: 'An innkeeper says she\'s heard a traveler has been consistent on this stretch of road for a while. You realize she means you.' },
  { zone: '✦ The Road', icon: '⚔️', title: 'The Streak Holds', desc: 'You showed up again. Another day where it was easier not to, and you did anyway. The road remembers.' },
  { zone: '✦ The Road', icon: '🌦️', title: 'Weather Changes', desc: 'The sky shifted. You barely noticed — you were already moving. Habits have a way of making uncertainty smaller.' },
  { zone: '✦ Crossroads', icon: '🗺️', title: 'You Could Turn Back', desc: 'Every day there\'s a version of you that doesn\'t check in. Today you weren\'t that version.' },
  { zone: '✦ The Road', icon: '🔥', title: 'The Streak Grows', desc: 'Momentum is a strange thing. You barely notice it building. Then one day you realize you\'d be surprised if you stopped.' },
  { zone: '✦ Thornwood Edge', icon: '🌲', title: 'Into the Dark', desc: 'The trees close in a little here. But you know the way. You\'ve been walking it long enough.' },
];

var _lastRoadEventIdx = -1;

function getNextRoadEvent() {
  var idx;
  var maxTries = 5;
  do {
    idx = Math.floor(Math.random() * ROAD_EVENTS.length);
    maxTries--;
  } while (idx === _lastRoadEventIdx && maxTries > 0);
  _lastRoadEventIdx = idx;
  return ROAD_EVENTS[idx];
}

function showRoadEvent(evt) {
  var overlay = document.getElementById('road-event-overlay');
  if (!overlay) return;
  document.getElementById('re-zone').textContent  = evt.zone;
  document.getElementById('re-icon').textContent  = evt.icon;
  document.getElementById('re-title').textContent = evt.title;
  document.getElementById('re-desc').textContent  = evt.desc;
  overlay.classList.add('show');
}

function closeRoadEvent() {
  var overlay = document.getElementById('road-event-overlay');
  if (overlay) overlay.classList.remove('show');
  overlayDismissed();
}

function maybeShowRoadEvent() {
  // 60% chance to show a road event after check-in (if no encounter is queued)
  if (Math.random() < 0.60) {
    var evt = getNextRoadEvent();
    queueOverlay(function() { showRoadEvent(evt); });
  }
}

function showLevelUp(level) {
  save();
  var heroClass = (state.party && state.party[0]) ? state.party[0].class : 'Mage';
  document.getElementById('lu-level').textContent = level;
  document.getElementById('lu-rank').textContent  = getTitle(heroClass, level);
  document.getElementById('lu-msg').textContent   = LEVEL_MSGS[Math.min(level - 2, LEVEL_MSGS.length - 1)];
  document.getElementById('levelup-overlay').classList.add('show');
}

function closeLevelUp() {
  document.getElementById('levelup-overlay').classList.remove('show');
  // Level-up advances the map — progress is earned
  if (advanceMap()) {
    render();
    checkZoneBadge();
    setTimeout(function() { checkArrival(); }, 400);
  } else {
    render();
    checkZoneBadge();
    setTimeout(function() { checkArrival(); }, 400);
  }
  overlayDismissed();
}

// ─────────────────────────
//  TOAST
// ─────────────────────────
var toastTimer;
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, 2800);
}

// ─────────────────────────
//  KEYBOARD
// ─────────────────────────
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Enter') return;
  var a = document.activeElement;
  if (a && a.id === 'hero-name-input') {
    var btn = document.getElementById('name-next-btn');
    if (btn && !btn.disabled) goStep('1-race');
  } else if (a && a.id === 'habit-input') {
    var btn2 = document.getElementById('habit-next-btn');
    if (btn2 && !btn2.disabled) goToClassStep();
  }
});

// (old dev tools body removed)
</script>

</body>
</html>
