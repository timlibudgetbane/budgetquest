<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habit Forge</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400;1,600&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>

/* ══════════════════════════════════════════════
   TOKENS
══════════════════════════════════════════════ */
:root {
  --bg:          #0f0d0b;
  --surface:     #161310;
  --surface2:    #1e1a14;
  --surface3:    #252018;

  --border:      #332e22;
  --border-mid:  #4a4230;
  --border-gold: #6b5c34;

  --gold:        #c4a24a;
  --gold-light:  #e2c06a;
  --gold-dim:    #7a6230;
  --gold-glow:   rgba(196,162,74,0.22);

  --xp:          #5b8fcc;
  --xp-dim:      #1c3458;

  --green:       #3a9e6a;
  --red:         #b83c2e;
  --orange:      #d4622a;
  --teal:        #2ab89a;
  --teal-glow:   rgba(42,184,154,0.18);

  --text:        #e6dcc8;
  --text-mid:    #b8a882;
  --text-dim:    #8a7d62;
  --text-dark:   #5a5040;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 18px;
  line-height: 1.5;
  min-height: 100vh;
}

/* ── Cohort Traveler Markers ── */
.map-traveler-row {
  position: absolute;
  top: -22px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: flex-start;
  gap: 4px;
  pointer-events: none;
  z-index: 10;
}
.map-traveler-dot {
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: var(--gold-dim);
  border: 1px solid rgba(196,162,74,0.6);
  box-shadow: 0 0 5px rgba(196,162,74,0.4);
  flex-shrink: 0;
}
.map-traveler-avatar {
  font-size: 16px;
  line-height: 1;
  filter: drop-shadow(0 0 4px rgba(196,162,74,0.6));
}
.map-traveler-name {
  font-family: 'Cinzel', serif;
  font-size: 8px;
  color: var(--gold-dim);
  white-space: nowrap;
  letter-spacing: 0.04em;
  text-shadow: 0 1px 3px rgba(0,0,0,0.9);
  line-height: 1;
  margin-top: 1px;
}
.map-traveler-entry {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

/* Grain */
body::after {
}

/* ══════════════════════════════════════════════
   APP SHELL
══════════════════════════════════════════════ */
.app {
  max-width: 1080px;
  margin: 0 auto;
  padding: 0 24px 80px;
}

/* ── Header ── */
.header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  padding: 20px 0 16px;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--border);
}
.header-brand { display: flex; align-items: baseline; gap: 12px; }
.header-icon  { display: none; }
.header-sigil {
  font-size: 18px;
  color: var(--gold-dim);
  line-height: 1;
  opacity: 0.7;
  margin-right: 2px;
}
.header h1 {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  color: var(--gold);
  letter-spacing: 0.18em;
  line-height: 1;
}
.header-tagline {
  font-size: 16px;
  color: var(--text-dark);
  font-style: italic;
}
.header-auth {
  display: flex; align-items: center; gap: 10px;
  font-size: 15px; color: var(--text-dark);
}
.header-auth-email { font-style: italic; }
.signout-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-dark);
  padding: 3px 10px; border-radius: 2px;
  cursor: pointer;
  font-family: 'Cinzel', serif;
  font-size: 13px; letter-spacing: 0.08em;
  transition: all 0.2s;
}
.signout-btn:hover { border-color: var(--border-gold); color: var(--text-mid); }

/* ── Two-column layout ── */
.layout {
  display: grid;
  grid-template-columns: 420px 1fr;
  gap: 20px;
  align-items: start;
}
.col-left {
  display: flex;
  flex-direction: column;
  gap: 12px;
  isolation: isolate;  /* prevent child paint escaping column bounds */
  overflow: hidden;    /* hard clip — map canvas translateY stays inside */
}
.col-right {
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-width: 0;
}
@media (max-width: 820px) {
  .layout { grid-template-columns: 1fr; }

}

/* ── Shared inputs ── */
.form-input, .field-input, .hero-name-input, .budget-input {
  background: var(--surface2);
  border: 1px solid var(--border-mid);
  border-radius: 2px;
  color: var(--text);
  font-family: 'Crimson Text', serif;
  font-size: 21px;
  padding: 9px 12px;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
.form-input:focus, .field-input:focus,
.hero-name-input:focus, .budget-input:focus { border-color: var(--gold-dim); }
.form-input::placeholder, .field-input::placeholder,
.hero-name-input::placeholder, .budget-input::placeholder { color: var(--text-dark); }

/* ── Shared buttons ── */
.btn-primary {
  width: 100%;
  background: var(--gold-dim);
  border: 1px solid var(--gold-dim);
  border-radius: 2px;
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
  padding: 11px 24px; cursor: pointer; transition: all 0.2s;
}
.btn-primary:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.btn-secondary {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 2px; color: var(--text-dim);
  font-family: 'Cinzel', serif;
  font-size: 14px; letter-spacing: 0.08em;
  padding: 9px 18px; cursor: pointer; transition: all 0.2s;
}
.btn-secondary:hover { border-color: var(--border-gold); color: var(--text-mid); }

/* ── Panel section label ── */
.panel-head {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.panel-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* ══════════════════════════════════════════════
   CHARACTER PANEL (left, top)
══════════════════════════════════════════════ */
.char-panel {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 18px;
  position: relative; overflow: hidden;
}
.char-panel::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}

.char-identity {
  display: flex; align-items: center;
  gap: 12px; margin-bottom: 18px;
}
.char-avatar {
  width: 48px; height: 48px;
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px;
  background: var(--surface2); flex-shrink: 0;
}
.char-name {
  font-family: 'Cinzel', serif;
  font-size: 21px; color: var(--gold);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.char-class { font-size: 16px; color: var(--text-dim); font-style: italic; margin-top: 1px; }
.char-level-badge { margin-left: auto; flex-shrink: 0; text-align: right; cursor: pointer; user-select: none; position: relative; }
.dev-trigger {
  position: absolute; top: -6px; right: -6px;
  font-size: 10px; opacity: 0; cursor: pointer;
  transition: opacity 0.2s;
  line-height: 1;
}
.char-level-badge:hover .dev-trigger { opacity: 0.5; }
.dev-trigger:hover { opacity: 1 !important; }
.level-num {
  font-family: 'Cinzel', serif;
  font-size: 30px; color: var(--gold-light); line-height: 1;
  text-shadow: 0 0 18px var(--gold-glow);
}
.level-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}

/* stat rows */
.stat-block { margin-bottom: 14px; }
.stat-label-row {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-bottom: 5px;
}
.stat-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.14em;
}
.stat-value { font-size: 17px; color: var(--text-dim); }
.stat-value strong { color: var(--xp); font-family: 'Cinzel', serif; font-size: 17px; }
.stat-value.gold-val strong { color: var(--gold); }

.bar-track {
  height: 5px;
  background: var(--surface2);
  border-radius: 100px;
  overflow: hidden;
}
.bar-fill {
  height: 100%; border-radius: 100px;
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1);
  min-width: 0;
}
.bar-fill.xp   { background: linear-gradient(90deg, var(--xp-dim), var(--xp)); }
.bar-fill.coin { background: linear-gradient(90deg, var(--gold-dim), var(--gold)); }
.bar-fill.coin.danger  { background: linear-gradient(90deg, #4a1810, var(--red)); }
.bar-fill.coin.warning { background: linear-gradient(90deg, #4a3010, var(--orange)); }

.stat-sub {
  display: flex; justify-content: space-between;
  margin-top: 3px;
  font-size: 14px; color: var(--text-dark); font-style: italic;
}
.coin-status { font-size: 14px; font-style: italic; }
.coin-status.danger  { color: var(--red); }
.coin-status.warning { color: var(--orange); }

/* Treasury rule */
.rule { height: 1px; background: var(--border); margin: 14px 0 10px; }
.rule-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  text-align: center; margin: -17px 0 12px;
}
.rule-label span {
  background: var(--surface);
  padding: 0 10px;
}

/* Road Gold row */
.vault-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 11px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-left: 2px solid var(--gold-dim);
  border-radius: 2px;
  margin-top: 10px;
}
.vault-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 1px;
}
.vault-sub  { font-size: 15px; color: var(--text-dim); font-style: italic; }
.vault-amount {
  font-family: 'Cinzel', serif;
  font-size: 24px; color: var(--gold);
  text-shadow: 0 0 12px var(--gold-glow);
}
.vault-amount.empty { color: var(--text-dark); font-size: 18px; text-shadow: none; }

/* Floats */
.gold-float, .coin-float, .xp-float {
  position: fixed;
  font-family: 'Cinzel', serif; font-size: 16px;
  pointer-events: none; z-index: 9990; opacity: 0;
}
.gold-float { color: var(--gold); }
.coin-float { color: var(--gold); }
.xp-float   { color: var(--xp); }
.gold-float.pop { animation: floatUp 1.1s ease-out forwards; }
.coin-float.pop { animation: floatDown 1.0s ease-out forwards; }
.xp-float.pop   { animation: floatUp 1.1s ease-out forwards; }
@keyframes floatUp {
  0%   { opacity:1; transform:translateX(-50%) translateY(0) scale(1); }
  15%  { opacity:1; transform:translateX(-50%) translateY(-14px) scale(1.2); }
  100% { opacity:0; transform:translateX(-50%) translateY(-36px) scale(0.9); }
}
@keyframes floatDown {
  0%   { opacity:1; transform:translateX(-50%) translateY(0); }
  100% { opacity:0; transform:translateX(-50%) translateY(20px); }
}
.xp-bar-fill.pulse { animation: barPulse 0.6s ease; }
@keyframes barPulse { 0%,100%{filter:brightness(1)} 50%{filter:brightness(2)} }

/* ══════════════════════════════════════════════
   MAP PANEL (left, below char)
══════════════════════════════════════════════ */
.map-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.map-panel-head {
  padding: 12px 14px 10px;
  display: flex; align-items: flex-start; justify-content: space-between;
}
.map-loc-block { display: flex; flex-direction: column; gap: 1px; }
.map-section-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.16em;
}
.map-current-loc { font-family: 'Cinzel', serif; font-size: 17px; color: var(--gold); }
.map-zone-tag    { font-size: 15px; color: var(--text-dim); font-style: italic; }

.map-right-col  { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
.map-hearts     { display: flex; gap: 3px; }
.map-heart      { font-size: 16px; transition: all 0.3s; }
.map-heart.empty { filter: grayscale(1) opacity(0.2); }

.map-badges-row { display: flex; gap: 4px; }
.badge-slot {
  width: 22px; height: 22px; border-radius: 50%;
  border: 1px solid var(--border); background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; position: relative; cursor: default; transition: all 0.3s;
}
.badge-slot.earned { border-color: var(--gold); box-shadow: 0 0 7px var(--gold-glow); }
.badge-slot.locked { opacity: 0.2; }
.badge-slot .badge-tip {
  display: none; position: absolute;
  bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%);
  background: var(--surface3); border: 1px solid var(--border-mid);
  border-radius: 2px; padding: 3px 7px;
  font-size: 13px; color: var(--text-mid); white-space: nowrap;
  z-index: 100; pointer-events: none;
  font-family: 'Cinzel', serif;
}
.badge-slot:hover .badge-tip { display: block; }

.map-viewport {
  position: relative;
  overflow: hidden;
  border-radius: 4px;
  border: 1px solid var(--border-gold);
}
.node-map {
  position: relative; width: 100%;
}
.node-map svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
.node-map-inner { position: absolute; top: 0; left: 0; width: 100%; }

.map-node-wrap {
  position: absolute; transform: translate(-50%,-50%);
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  cursor: default; z-index: 2;
}
.map-node-circle {
  width: 38px; height: 38px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; transition: all 0.3s;
  border: 1.5px solid var(--border);
  background: rgba(15,13,11,0.85);
  backdrop-filter: blur(2px);
}
.map-node-circle.done   { border-color: var(--gold-dim); opacity: 0.55; background: rgba(122,98,48,0.1); }
.map-node-circle.zone1  { border-color: rgba(180,140,60,0.6); }
.map-node-circle.zone2  { border-color: rgba(180,110,40,0.6); }
.map-node-circle.zone3  { border-color: rgba(60,100,70,0.7); }
.map-node-circle.zone4  { border-color: rgba(120,80,160,0.7); }
.map-node-circle.zone1.current { background: rgba(180,140,60,0.12); box-shadow: 0 0 18px rgba(180,140,60,0.3); }
.map-node-circle.zone2.current { background: rgba(180,110,40,0.12); box-shadow: 0 0 18px rgba(180,110,40,0.3); }
.map-node-circle.zone3.current { background: rgba(60,100,70,0.15); box-shadow: 0 0 18px rgba(60,140,80,0.3); }
.map-node-circle.zone4.current { background: rgba(120,80,160,0.15); box-shadow: 0 0 18px rgba(160,100,220,0.3); }
.map-node-circle.current {
  border-color: var(--gold);
  background: rgba(196,162,74,0.1);
  animation: currentPulse 2.8s ease-in-out infinite;
}
@keyframes currentPulse {
  0%,100% { box-shadow: 0 0 0 3px rgba(196,162,74,0.1), 0 0 12px var(--gold-glow); }
  50%     { box-shadow: 0 0 0 6px rgba(196,162,74,0.04), 0 0 20px var(--gold-glow); }
}
.map-node-circle.ahead  { opacity: 0.2; }
.map-node-circle.badge-node { width: 28px; height: 28px; border-radius: 2px; font-size: 16px; }
.map-node-circle.badge-node.earned { border-color: var(--gold); box-shadow: 0 0 8px var(--gold-glow); }
.map-node-circle.badge-node.ahead  { opacity: 0.15; }

.map-node-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: var(--text-dim);
  text-align: center; white-space: nowrap;
  background: rgba(10,8,6,0.82);
  padding: 2px 6px; border-radius: 2px;
  letter-spacing: 0.04em;
  border: 1px solid rgba(90,70,30,0.3);
}
.map-node-wrap.current .map-node-label {
  color: var(--gold-light);
  border-color: rgba(196,162,74,0.4);
}

.map-more-arrow {
  position: absolute; bottom: 5px; right: 9px;
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.06em;
  display: flex; flex-direction: column; align-items: center; gap: 1px;
  animation: bounceDown 2s ease-in-out infinite;
}
.map-more-arrow.hidden { display: none; }
@keyframes bounceDown { 0%,100%{transform:translateY(0)} 50%{transform:translateY(3px)} }

.road-bonus-track {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 14px;
}
.road-bonus-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.road-bonus-pips { display: flex; gap: 4px; }
.road-pip { width: 12px; height: 4px; border-radius: 100px; background: var(--border); transition: all 0.3s; }
.road-pip.earned { background: var(--teal); box-shadow: 0 0 4px var(--teal-glow); }

/* ══════════════════════════════════════════════
   STREAK (right col, top)
══════════════════════════════════════════════ */
.streak-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 12px 16px;
  display: flex; align-items: center; justify-content: space-between;
  position: relative; overflow: hidden;
  transition: border-color 0.3s;
}
.streak-panel.alive { border-color: rgba(212,98,42,0.3); }
.streak-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--orange), transparent);
  opacity: 0;
}
.streak-panel.alive::before { opacity: 0.45; }
.streak-left  { display: flex; align-items: center; gap: 10px; }
.streak-flame {
  font-size: 22px; line-height: 1;
  filter: drop-shadow(0 0 4px rgba(212,98,42,0.4));
}
.streak-flame.cold { filter: grayscale(0.9); opacity: 0.3; }
.streak-num {
  font-family: 'Cinzel', serif;
  font-size: 26px; color: var(--orange); line-height: 1;
}
.streak-num.cold { color: var(--text-dark); }
.streak-tag { font-size: 17px; color: var(--text-mid); font-style: italic; }
.streak-right {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.08em; text-align: right;
}
.streak-right.logged { color: var(--green); }
.streak-right.urgent { color: var(--orange); animation: urgentPulse 2s ease-in-out infinite; }
@keyframes urgentPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* ══════════════════════════════════════════════
   LOG FORM (right col)
══════════════════════════════════════════════ */
.log-panel {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 18px;
  position: relative; overflow: hidden;
}
.log-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.log-form-grid {
  display: grid;
  grid-template-columns: 1fr 110px auto;
  gap: 10px; align-items: end;
}
@media (max-width: 500px) {
  .log-form-grid { grid-template-columns: 1fr 1fr; }
  .log-btn-wrap  { grid-column: 1 / -1; }
}
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.log-btn {
  background: var(--gold-dim);
  border: 1px solid var(--gold-dim); border-radius: 2px;
  color: var(--gold-light);
  font-family: 'Cinzel', serif;
  font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
  padding: 9px 14px; cursor: pointer; white-space: nowrap; width: 100%;
  transition: all 0.18s;
}
.log-btn:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.log-btn.streak-danger {
  border-color: var(--orange);
  box-shadow: 0 0 12px rgba(212,98,42,0.3);
  animation: streakDanger 2s ease-in-out infinite;
}
.log-btn.logged-today {
  border-color: var(--green);
  color: var(--green);
  background: rgba(58,158,106,0.08);
}
@keyframes streakDanger { 0%,100%{box-shadow:0 0 8px rgba(212,98,42,0.3)} 50%{box-shadow:0 0 18px rgba(212,98,42,0.6)} }
.xp-hint { margin-top: 10px; font-size: 15px; color: var(--text-dark); font-style: italic; }

/* ══════════════════════════════════════════════
   LOG LIST (right col)
══════════════════════════════════════════════ */
.log-list-wrap {}
.log-list {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px; overflow: hidden;
}
.log-empty { padding: 28px; text-align: center; color: var(--text-dark); font-size: 17px; font-style: italic; }
.log-item {
  display: grid; grid-template-columns: 22px 1fr auto;
  gap: 10px; align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  animation: slideIn 0.22s ease both;
}
.log-item:last-child { border-bottom: none; }
.log-icon   { font-size: 17px; text-align: center; opacity: 0.65; }
.log-desc   { font-size: 18px; color: var(--text); }
.log-meta   { font-size: 14px; color: var(--text-dark); font-style: italic; }
.log-right  { text-align: right; }
.log-amount { font-family: 'Cinzel', serif; font-size: 17px; color: var(--text-mid); }
.log-xp     { font-size: 14px; color: var(--xp); }

/* section-head alias */
.section-head {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px;
}
.section-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.chronicle-head {
  font-size: 15px;
  color: var(--gold-dim);
  letter-spacing: 0.22em;
  margin-top: 6px;
}
.chronicle-head::after { background: var(--border-gold); }

/* ══════════════════════════════════════════════
   LOGIN
══════════════════════════════════════════════ */
#login-screen { max-width: 400px; margin: 0 auto; }
.login-hero { text-align: center; margin-bottom: 28px; padding-top: 20px; }
.login-hero-icon {
  width: 60px; height: 60px;
  background: var(--surface2);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 28px; margin-bottom: 14px;
}
.login-title { font-family: 'Cinzel', serif; font-size: 22px; color: var(--gold); margin-bottom: 6px; }
.login-sub   { color: var(--text-dim); font-size: 18px; font-style: italic; }
.login-err   { color: var(--red); font-size: 17px; text-align: center; margin-top: 8px; display: none; }
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px; padding: 20px;
  position: relative; overflow: hidden;
}
.card-accent-top, .card-accent-gold, .card-accent-teal {
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.form-field { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; }
.field-label {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.field-input { width: 100%; }

/* ══════════════════════════════════════════════
   ONBOARDING
══════════════════════════════════════════════ */
.ob-card {
  max-width: 540px; margin: 0 auto;
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 36px 32px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s ease both;
}
.ob-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.steps-row {
  display: flex; align-items: center; justify-content: center;
  gap: 6px; margin-bottom: 30px;
}
.step-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--border-mid); transition: all 0.3s; flex-shrink: 0;
}
.step-dot.active { background: var(--gold); width: 18px; border-radius: 2px; box-shadow: 0 0 5px var(--gold-glow); }
.step-dot.done   { background: var(--gold-dim); opacity: 0.5; }
.step-line { width: 14px; height: 1px; background: var(--border); flex-shrink: 0; }
.ob-step { display: none; }
.ob-step.active { display: block; animation: fadeUp 0.3s ease both; }
.ob-icon  { text-align: center; font-size: 42px; margin-bottom: 14px; }
.ob-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold); text-align: center; margin-bottom: 8px; }
.ob-sub {
  color: var(--text-dim); font-size: 18px; font-style: italic;
  text-align: center; line-height: 1.65; margin-bottom: 24px;
  max-width: 400px; margin-left: auto; margin-right: auto;
}
.ob-nav { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }

.name-row { display: flex; max-width: 340px; margin: 0 auto; }
.hero-name-input { border-right: none; border-radius: 2px 0 0 2px; flex: 1; }
.name-btn {
  background: var(--gold-dim); border: 1px solid var(--gold-dim); border-left: none;
  border-radius: 0 2px 2px 0; color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 0.1em;
  padding: 9px 16px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.name-btn:hover { background: var(--gold); color: var(--bg); }

.avatar-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px; justify-content: center;
  margin-bottom: 24px;
}
.avatar-opt {
  border: 1px solid var(--border); border-radius: 3px;
  background: var(--surface2);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 16px 8px 12px;
  cursor: pointer;
  transition: all 0.2s; position: relative; user-select: none;
  gap: 6px;
}
}
.avatar-opt:hover { border-color: var(--border-gold); transform: translateY(-2px); }
.avatar-opt.selected { border-color: var(--gold); box-shadow: 0 0 12px var(--gold-glow); }
.avatar-opt.selected::after {
  content: '✓'; position: absolute; top: 5px; right: 7px;
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--gold);
}
.avatar-opt-icon { font-size: 32px; line-height: 1; }
.avatar-opt-label {
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
}

.class-grid { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }
.class-opt {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 2px; padding: 11px 13px; cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; gap: 12px; user-select: none;
}
.class-opt:hover     { border-color: var(--border-mid); background: var(--surface3); }
.class-opt.selected  { border-color: var(--gold); background: var(--surface3); border-left-width: 3px; }
.class-emoji { font-size: 24px; flex-shrink: 0; width: 30px; text-align: center; }
.class-info  { flex: 1; }
.class-name  { font-family: 'Cinzel', serif; font-size: 16px; color: var(--gold); margin-bottom: 2px; }
.class-desc  { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.45; }
.class-trait {
  font-size: 12px; color: var(--xp);
  text-transform: uppercase; letter-spacing: 0.1em;
  background: rgba(91,143,204,0.1); border: 1px solid rgba(91,143,204,0.2);
  padding: 2px 7px; border-radius: 2px; white-space: nowrap; flex-shrink: 0;
}

.budget-row { display: flex; max-width: 320px; margin: 0 auto; }
.budget-prefix {
  background: var(--surface2); border: 1px solid var(--border-mid); border-right: none;
  border-radius: 2px 0 0 2px; padding: 9px 12px;
  color: var(--gold); font-family: 'Cinzel', serif; font-size: 21px;
  display: flex; align-items: center;
}
.budget-input { border-left: none; border-right: none; border-radius: 0; flex: 1; }
.budget-btn {
  background: var(--gold-dim); border: 1px solid var(--gold-dim); border-left: none;
  border-radius: 0 2px 2px 0; color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 0.1em;
  padding: 9px 16px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.budget-btn:hover { background: var(--gold); color: var(--bg); }

.laws-grid { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }
.law-card {
  display: flex; align-items: flex-start; gap: 12px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 2px; padding: 10px 13px;
}
.law-icon  { font-size: 21px; flex-shrink: 0; width: 24px; text-align: center; margin-top: 2px; opacity: 0.75; }
.law-body  { flex: 1; }
.law-title { font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold-dim); letter-spacing: 0.08em; margin-bottom: 3px; text-transform: uppercase; }
.law-plain { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.55; }

/* ══════════════════════════════════════════════
   OVERLAYS
══════════════════════════════════════════════ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(6,4,2,0.88);
  backdrop-filter: blur(3px);
  display: flex; align-items: center; justify-content: center;
  z-index: 9998; opacity: 0; pointer-events: none;
  transition: opacity 0.28s;
}
.overlay.show { opacity: 1; pointer-events: all; }
.overlay-box {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 28px 32px;
  text-align: center; max-width: 400px; width: 90%;
  position: relative; overflow: hidden;
  transform: scale(0.93) translateY(12px);
  transition: transform 0.32s cubic-bezier(0.34,1.56,0.64,1);
}
.overlay.show .overlay-box { transform: scale(1) translateY(0); }
.overlay-box::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.overlay-box.hostile { border-color: rgba(184,60,46,0.45); }
.overlay-box.hostile::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }
.overlay-box.friendly { border-color: rgba(58,158,106,0.4); }
.overlay-box.friendly::before { background: linear-gradient(90deg, transparent, var(--green), transparent); }
.overlay-box.zone-complete { border-color: rgba(196,162,74,0.45); }
.overlay-box.levelup { border-color: var(--gold-dim); box-shadow: 0 0 40px var(--gold-glow); }
.overlay-box.broken  { border-color: rgba(184,60,46,0.45); }
.overlay-box.broken::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }

.overlay-zone-label {
  font-family: 'Cinzel', serif; font-size: 12px;
  letter-spacing: 0.2em; text-transform: uppercase;
  margin-bottom: 10px; color: var(--text-dark);
}
.overlay-box.hostile  .overlay-zone-label { color: var(--red); }
.overlay-box.friendly .overlay-zone-label { color: var(--green); }
.overlay-box.zone-complete .overlay-zone-label { color: var(--gold); }
.overlay-icon  { font-size: 40px; margin-bottom: 10px; line-height: 1; }
.overlay-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold); margin-bottom: 10px; }
.overlay-desc  { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.7; margin-bottom: 18px; }
.overlay-choices { display: flex; flex-direction: column; gap: 7px; }
.overlay-btn {
  background: var(--surface2); border: 1px solid var(--border-mid);
  border-radius: 2px; color: var(--text);
  font-family: 'Crimson Text', serif; font-size: 18px;
  padding: 11px 16px; cursor: pointer; transition: all 0.18s;
  text-align: left; line-height: 1.5;
}
.overlay-btn:hover { border-color: var(--border-gold); background: var(--surface3); }
.overlay-btn.hostile-choice { border-color: rgba(184,60,46,0.3); }
.overlay-btn.hostile-choice:hover { border-color: var(--red); background: rgba(184,60,46,0.07); }
.overlay-btn.friendly-choice { border-color: rgba(58,158,106,0.3); }
.overlay-btn.friendly-choice:hover { border-color: var(--green); background: rgba(58,158,106,0.07); }
.overlay-btn.primary-choice {
  background: var(--gold-dim); border-color: var(--gold-dim); color: var(--gold-light);
  font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 0.1em; text-align: center;
}
.overlay-btn.primary-choice:hover { background: var(--gold); border-color: var(--gold); color: var(--bg); }
.overlay-btn-cost { display: block; font-size: 15px; color: var(--text-dim); margin-top: 2px; font-style: italic; }
.overlay-btn-disabled { opacity: 0.3; cursor: not-allowed; }
.overlay-btn-disabled:hover { background: var(--surface2) !important; border-color: var(--border-mid) !important; }

.levelup-sparkles { font-size: 22px; letter-spacing: 12px; margin-bottom: 10px; color: var(--gold-dim); }
.levelup-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 4px; }
.levelup-num {
  font-family: 'Cinzel', serif; font-size: 58px; color: var(--gold-light);
  line-height: 1; margin: 4px 0 8px; text-shadow: 0 0 28px var(--gold-glow);
}
.levelup-rank { font-family: 'Cinzel', serif; font-size: 18px; color: var(--gold); margin-bottom: 10px; }
.levelup-msg  { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.7; margin-bottom: 20px; }

.reset-icon  { font-size: 34px; margin-bottom: 10px; }
.reset-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 6px; }
.reset-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--gold-light); margin-bottom: 14px; }
.reset-breakdown { background: var(--surface2); border: 1px solid var(--border); border-radius: 2px; padding: 11px 13px; margin-bottom: 14px; text-align: left; }
.reset-row { display: flex; justify-content: space-between; font-size: 17px; color: var(--text-dim); padding: 3px 0; }
.reset-row.highlight { color: var(--gold); }
.reset-row.highlight span:last-child { color: var(--gold-light); }
.reset-msg { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.65; margin-bottom: 16px; }
.reset-overlay-box { border-color: rgba(196,162,74,0.35); max-width: 400px; }
.reset-title { font-family: 'Cinzel', serif; font-size: 22px; color: var(--gold); margin-bottom: 16px; text-align: center; }
.reset-label { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.18em; text-align: center; margin-bottom: 8px; }
.reset-icon { font-size: 32px; text-align: center; margin-bottom: 10px; }

.broken-icon  { font-size: 44px; margin: 6px 0 12px; }
.broken-title { font-family: 'Cinzel', serif; font-size: 21px; color: var(--red); margin-bottom: 8px; }
.broken-msg   { font-size: 18px; color: var(--text-dim); font-style: italic; line-height: 1.6; margin-bottom: 16px; }
.broken-gold  { font-family: 'Cinzel', serif; font-size: 24px; color: var(--gold-light); margin-bottom: 4px; }
.broken-cost  { font-size: 15px; color: var(--text-dim); font-style: italic; margin-bottom: 16px; }

/* ══════════════════════════════════════════════
   TOAST
══════════════════════════════════════════════ */
.toast {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%) translateY(14px);
  background: var(--surface2); border: 1px solid var(--border-gold);
  color: var(--text-mid); font-family: 'Crimson Text', serif; font-size: 17px;
  font-style: italic;
  padding: 10px 22px; border-radius: 2px;
  opacity: 0; pointer-events: none; z-index: 8000;
  transition: all 0.26s; white-space: normal;
  max-width: min(460px, 90vw); text-align: center; line-height: 1.45;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ══════════════════════════════════════════════
   TEASERS
══════════════════════════════════════════════ */
.teasers { }
.teasers-head {
  font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.16em;
  margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
}
.teasers-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.teaser-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px,1fr)); gap: 6px; }
.teaser-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 3px; padding: 12px;
  opacity: 0.28; filter: saturate(0.15); position: relative; transition: all 0.2s;
}
.teaser-card:hover { opacity: 0.44; filter: saturate(0.28); }
.teaser-lock   { position: absolute; top: 8px; right: 10px; font-size: 14px; color: var(--text-dark); }
.teaser-icon   { font-size: 21px; margin-bottom: 4px; }
.teaser-name   { font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-mid); margin-bottom: 2px; }
.teaser-hint   { font-size: 15px; color: var(--text-dim); font-style: italic; line-height: 1.4; }
.teaser-unlock { font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 4px; }

/* ── Miss Overlay ── */
#miss-overlay {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  z-index: 99999;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}
#miss-overlay.show {
  opacity: 1;
  pointer-events: all;
}
.miss-box {
  position: relative;
  background: var(--surface);
  border: 2px solid rgba(184,60,46,0.6);
  border-radius: 12px;
  padding: 32px 40px;
  text-align: center;
  max-width: 320px; width: 90%;
  box-shadow: 0 0 60px rgba(184,60,46,0.2), 0 0 120px rgba(184,60,46,0.05);
  transform: scale(0.7);
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  z-index: 1;
}
.miss-box::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--red), transparent);
  border-radius: 12px 12px 0 0;
}
#miss-overlay.show .miss-box {
  transform: scale(1);
}
#miss-icon {
  font-size: 48px;
  display: block;
  margin-bottom: 8px;
  animation: missShake 0.5s ease 0.1s both;
}
@keyframes missShake {
  0%   { transform: scale(0.6) rotate(-8deg); opacity: 0.4; }
  40%  { transform: scale(1.05) rotate(4deg); opacity: 1; }
  65%  { transform: scale(0.97) rotate(-2deg); }
  100% { transform: scale(1) rotate(0deg); }
}
#miss-name {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.18em;
  margin-bottom: 8px;
}
#miss-hp {
  font-family: 'Cinzel', serif;
  font-size: 34px; color: var(--red);
  text-shadow: 0 0 20px rgba(184,60,46,0.5);
  line-height: 1;
  margin-bottom: 10px;
  animation: cc-xp-pop 0.35s cubic-bezier(0.34,1.56,0.64,1) 0.18s both;
}
#miss-msg {
  font-size: 16px; color: var(--text-dim); font-style: italic;
  line-height: 1.5; margin-bottom: 12px;
}
#miss-hearts {
  display: flex; justify-content: center; gap: 4px;
  font-size: 18px; min-height: 22px;
}

/* Actions row containing both circles */
.char-card-actions {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  margin-left: 4px;
}

/* ══════════════════════════════════════════════
   WEATHER STRIP (compact, inside char panel)
══════════════════════════════════════════════ */
.weather-card {
  border-radius: 2px;
  padding: 8px 11px;
  position: relative; overflow: hidden;
  transition: border-color 0.5s, background 0.5s;
  border: 1px solid var(--border);
  margin-top: 10px;
}
.weather-card.clear   { border-color: rgba(58,158,106,0.35); background: rgba(58,158,106,0.04); }
.weather-card.partial { border-color: rgba(91,143,204,0.3); }
.weather-card.stormy  { border-color: rgba(212,98,42,0.35); background: rgba(212,98,42,0.03); }
.weather-card.fog     { border-color: rgba(184,60,46,0.4); background: rgba(184,60,46,0.04); }
.weather-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  transition: background 0.5s;
}
.weather-card.clear::before   { background: linear-gradient(90deg, transparent, var(--green), transparent); }
.weather-card.partial::before { background: linear-gradient(90deg, transparent, var(--xp), transparent); }
.weather-card.stormy::before  { background: linear-gradient(90deg, transparent, var(--orange), transparent); }
.weather-card.fog::before     { background: linear-gradient(90deg, transparent, var(--red), transparent); }

.weather-inner { display: flex; align-items: center; gap: 8px; }
.weather-icon  { font-size: 18px; line-height: 1; flex-shrink: 0; }
.weather-body  { flex: 1; min-width: 0; }
.weather-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: var(--gold-dim);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.weather-desc  { font-size: 13px; color: var(--text-dim); font-style: italic; line-height: 1.3; }
.weather-xp-badge {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dark);
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 2px; padding: 3px 8px;
  white-space: nowrap; flex-shrink: 0;
}
.weather-card.clear   .weather-xp-badge { color: var(--green); border-color: rgba(58,158,106,0.3); background: rgba(58,158,106,0.08); }
.weather-card.stormy  .weather-xp-badge { color: var(--orange); border-color: rgba(212,98,42,0.3); }
.weather-card.fog     .weather-xp-badge { color: var(--red); border-color: rgba(184,60,46,0.3); }

/* ══════════════════════════════════════════════
   LEFT STATS ROW
══════════════════════════════════════════════ */
.left-stats-row {
  display: flex; align-items: stretch;
  margin-top: 12px; gap: 0;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 2px; overflow: hidden;
}
.left-stat-block {
  flex: 1; padding: 10px 12px; display: flex; flex-direction: column; gap: 2px;
}
.left-stat-divider { width: 1px; background: var(--border); flex-shrink: 0; }
.left-stat-label {
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.14em;
}
.left-stat-value { font-size: 18px; }

/* ══════════════════════════════════════════════
   PARTY OVERVIEW PANEL (left col)
══════════════════════════════════════════════ */
.party-overview-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px; padding: 14px 16px;
}
.party-overview-row {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 0; border-bottom: 1px solid var(--border);
}
.party-overview-row:last-child { border-bottom: none; }
.pov-icon {
  width: 32px; height: 32px; border-radius: 3px;
  background: var(--surface2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; flex-shrink: 0;
}
.pov-icon.wounded { border-color: rgba(184,60,46,0.5); animation: woundedPulse 2s ease-in-out infinite; }
.pov-icon.done    { border-color: rgba(58,158,106,0.4); }
.pov-info { flex: 1; min-width: 0; }
.pov-name { font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pov-habit { font-size: 13px; color: var(--text-dim); font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pov-hp-bar-track {
  flex-shrink: 0; width: 60px; height: 5px;
  background: var(--border); border-radius: 100px; overflow: hidden;
}
.pov-hp-bar-fill {
  height: 100%; border-radius: 100px;
  transition: width 0.5s, background 0.3s;
}

/* ══════════════════════════════════════════════
   PARTY SIZE SELECTOR
══════════════════════════════════════════════ */
.party-size-grid {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  gap: 8px; margin-bottom: 6px;
}
.party-size-opt {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 3px; padding: 14px 10px;
  cursor: pointer; transition: all 0.2s;
  text-align: center; user-select: none;
}
.party-size-opt:hover { border-color: var(--border-mid); background: var(--surface3); }
.party-size-opt.selected { border-color: var(--gold); background: var(--surface3); border-left-width: 2px; }
.party-size-num {
  font-family: 'Cinzel', serif; font-size: 30px; color: var(--gold-light);
  line-height: 1; margin-bottom: 4px;
  text-shadow: 0 0 14px var(--gold-glow);
}
.party-size-opt:not(.selected) .party-size-num { color: var(--text-dim); text-shadow: none; }
.party-size-label { font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.1em; }
.party-size-opt:not(.selected) .party-size-label { color: var(--text-dark); }
.party-size-desc { font-size: 14px; color: var(--text-dim); font-style: italic; line-height: 1.4; }

/* Companion progress dots in habit setup step */
.companion-progress {
  display: flex; justify-content: center; gap: 6px; margin-bottom: 14px;
}
.companion-pip {
  width: 28px; height: 4px; border-radius: 100px;
  background: var(--border); transition: all 0.3s;
}
.companion-pip.done    { background: var(--gold-dim); }
.companion-pip.current { background: var(--gold); width: 36px; }

/* Begin party summary */
.begin-party-summary {
  display: flex; flex-direction: column; gap: 8px; margin-top: 14px;
}
.begin-party-row {
  display: flex; align-items: center; gap: 12px;
  background: var(--surface2); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 10px 14px;
  border-left: 3px solid var(--gold-dim);
}
.begin-party-icon { font-size: 24px; flex-shrink: 0; }
.begin-party-name { font-family: 'Cinzel', serif; font-size: 15px; color: var(--gold); margin-bottom: 2px; }
.begin-party-habit { font-size: 15px; color: var(--text-dim); font-style: italic; }

/* ══════════════════════════════════════════════
   ROAD EVENT (post check-in story beat)
══════════════════════════════════════════════ */
.road-event-overlay {
  position: fixed; inset: 0;
  background: rgba(6,4,2,0.85);
  backdrop-filter: blur(3px);
  display: flex; align-items: center; justify-content: center;
  z-index: 9998; opacity: 0; pointer-events: none;
  transition: opacity 0.28s;
}
.road-event-overlay.show { opacity: 1; pointer-events: all; }
.road-event-box {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 28px 32px;
  max-width: 400px; width: 90%; text-align: center;
  transform: scale(0.93) translateY(12px);
  transition: transform 0.32s cubic-bezier(0.34,1.56,0.64,1);
  position: relative; overflow: hidden;
}
.road-event-overlay.show .road-event-box { transform: scale(1) translateY(0); }
.road-event-box::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--teal), transparent);
}
.road-event-zone { font-family: 'Cinzel', serif; font-size: 12px; color: var(--teal); letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 10px; }
.road-event-icon  { font-size: 36px; margin-bottom: 10px; }
.road-event-title { font-family: 'Cinzel', serif; font-size: 19px; color: var(--gold); margin-bottom: 10px; }
.road-event-desc  { font-size: 17px; color: var(--text-dim); font-style: italic; line-height: 1.7; margin-bottom: 18px; }


/* ══════════════════════════════════════════════
   EPIC CHECK-IN CELEBRATION OVERLAY
══════════════════════════════════════════════ */
#checkin-celebration {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  z-index: 99999;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}
#checkin-celebration.show {
  opacity: 1;
  pointer-events: all;
}
.cc-backdrop {
  position: absolute; inset: 0;
  background: rgba(6,4,2,0.7);
  backdrop-filter: blur(4px);
}
.cc-box {
  position: relative;
  background: var(--surface);
  border: 2px solid var(--gold);
  border-radius: 12px;
  padding: 32px 40px;
  text-align: center;
  max-width: 340px; width: 90%;
  box-shadow: 0 0 60px var(--gold-glow), 0 0 120px rgba(196,162,74,0.1);
  transform: scale(0.7);
  transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
  z-index: 1;
}
#checkin-celebration.show .cc-box {
  transform: scale(1);
}
.cc-box::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  border-radius: 12px 12px 0 0;
}
#cc-icon {
  font-size: 56px;
  display: block;
  margin-bottom: 8px;
  animation: cc-bounce 0.5s cubic-bezier(0.34,1.56,0.64,1) 0.1s both;
}
@keyframes cc-bounce {
  from { transform: scale(0) rotate(-15deg); }
  to   { transform: scale(1) rotate(0deg); }
}
#cc-name {
  font-family: 'Cinzel', serif;
  font-size: 13px; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.18em;
  margin-bottom: 10px;
}
#cc-xp {
  font-family: 'Cinzel', serif;
  font-size: 36px; color: var(--xp);
  text-shadow: 0 0 20px rgba(91,143,204,0.6);
  line-height: 1;
  margin-bottom: 10px;
  animation: cc-xp-pop 0.4s cubic-bezier(0.34,1.56,0.64,1) 0.2s both;
}
@keyframes cc-xp-pop {
  from { transform: scale(0.5); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}
#cc-msg {
  font-size: 16px; color: var(--text-mid); font-style: italic;
  line-height: 1.5; margin-bottom: 10px;
}
#cc-streak {
  font-family: 'Cinzel', serif;
  font-size: 14px; color: var(--orange);
  background: rgba(212,98,42,0.1);
  border: 1px solid rgba(212,98,42,0.3);
  border-radius: 20px; padding: 4px 14px;
  display: inline-block;
  animation: cc-streak-pop 0.4s ease 0.35s both;
}
@keyframes cc-streak-pop {
  from { transform: scale(0.8); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}
#cc-confetti {
  position: absolute; top: 50%; left: 50%;
  width: 0; height: 0;
  pointer-events: none;
}
.cc-particle {
  position: absolute;
  font-size: 20px;
  transform: translate(-50%,-50%);
  animation: cc-burst var(--d, 0.8s) ease-out var(--delay, 0s) both;
}
@keyframes cc-burst {
  0%   { transform: translate(-50%,-50%) rotate(0deg) scale(1); opacity: 1; }
  80%  { opacity: 1; }
  100% {
    transform: translate(
      calc(-50% + cos(var(--angle)) * var(--dist)),
      calc(-50% + sin(var(--angle)) * var(--dist))
    ) rotate(360deg) scale(0.3);
    opacity: 0;
  }
}
/* Progress bar in onboarding */
.ob-progress-bar {
  width: 100%; height: 4px;
  background: var(--border);
  border-radius: 100px;
  margin-bottom: 28px;
  overflow: hidden;
}
.ob-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold-dim), var(--gold));
  border-radius: 100px;
  transition: width 0.4s cubic-bezier(0.4,0,0.2,1);
}


@keyframes fadeUp {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}
@keyframes slideIn {
  from { opacity:0; transform:translateX(-5px); }
  to   { opacity:1; transform:translateX(0); }
}



/* ══════════════════════════════════════════════
   /* budget-hero removed — treasury now lives inside char panel */


/* ══════════════════════════════════════════════
   TREASURY — dominant section inside char panel
══════════════════════════════════════════════ */
.treasury-section {
  background: var(--surface2);
  border: 1px solid var(--border-gold);
  border-radius: 3px;
  padding: 14px 16px;
  margin-bottom: 12px;
  position: relative;
}
.treasury-head {
  display: flex; align-items: baseline;
  justify-content: space-between;
  margin-bottom: 10px;
}
.treasury-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--gold-dim);
  text-transform: uppercase; letter-spacing: 0.2em;
}
.treasury-status {
  font-size: 15px; color: var(--text-dim); font-style: italic;
}
.treasury-status.danger  { color: var(--red); }
.treasury-status.warning { color: var(--orange); }
.treasury-status.good    { color: var(--green); }

.treasury-numbers {
  display: flex; align-items: baseline;
  gap: 7px; margin-bottom: 12px; flex-wrap: wrap;
}
.treasury-remaining {
  font-family: 'Cinzel', serif;
  font-size: 40px; line-height: 1; color: var(--gold-light);
  text-shadow: 0 0 20px var(--gold-glow);
  transition: color 0.35s;
}
.treasury-remaining.danger  { color: var(--red);    text-shadow: none; }
.treasury-remaining.warning { color: var(--orange); text-shadow: none; }
.treasury-of {
  font-size: 16px; color: var(--text-dark); font-style: italic;
}
.treasury-budget {
  font-family: 'Cinzel', serif;
  font-size: 18px; color: var(--text-dim);
}
.treasury-bar-track {
  height: 6px;
  background: var(--surface3);
  border-radius: 100px; overflow: hidden;
  margin-bottom: 6px;
}
.treasury-bar-fill {
  height: 100%; border-radius: 100px;
  background: linear-gradient(90deg, var(--gold-dim), var(--gold));
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1), background 0.35s;
}
.treasury-bar-fill.danger  { background: linear-gradient(90deg, #4a1810, var(--red)); }
.treasury-bar-fill.warning { background: linear-gradient(90deg, #4a3010, var(--orange)); }
.treasury-sub {
  font-size: 15px; color: var(--text-dark); font-style: italic;
}


/* Weather icon animation */
.weather-icon {
  font-size: 28px;
  line-height: 1;
  animation: weatherFloat 3s ease-in-out infinite;
}
@keyframes weatherFloat {
  0%, 100% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-3px) scale(1.05); }
}
.weather-card.fog .weather-icon { animation: weatherSway 4s ease-in-out infinite; }
@keyframes weatherSway {
  0%, 100% { transform: translateX(0) scale(1); opacity: 0.7; }
  50% { transform: translateX(4px) scale(1.02); opacity: 1; }
}



/* Remove old rule/rule-label if present */
.rule       { height: 1px; background: var(--border); margin: 14px 0 10px; }
.rule-label { display: none; }


/* ══════════════════════════════════════════════
   LOG PAGINATION
══════════════════════════════════════════════ */
.log-pagination {
  display: flex; align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  border-radius: 0 0 3px 3px;
}
.log-more-btn {
  background: transparent;
  border: 1px solid var(--border-mid);
  border-radius: 2px;
  color: var(--text-dim);
  font-family: 'Cinzel', serif;
  font-size: 13px; letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 6px 14px; cursor: pointer;
  transition: all 0.2s;
}
.log-more-btn:hover { border-color: var(--border-gold); color: var(--text-mid); }
.log-more-btn:disabled {
  opacity: 0.3; cursor: default;
}
.log-pagination-count {
  font-size: 15px; color: var(--text-dark); font-style: italic;
}


/* ── Vault inline (inside treasury) ── */
.vault-inline {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 12px;
  padding: 10px 12px;
  background: rgba(0,0,0,0.25);
  border: 1px solid var(--border-gold);
  border-radius: 2px;
  border-left: 3px solid var(--gold-dim);
}
.vault-inline-left { display: flex; align-items: center; gap: 10px; }
.vault-inline-icon { font-size: 18px; line-height: 1; }
.vault-inline-name {
  font-family: 'Cinzel', serif;
  font-size: 14px; color: var(--gold-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
  margin-bottom: 2px;
}
.vault-inline-hint { font-size: 15px; color: var(--text-dark); font-style: italic; }

/* ── Map hearts label ── */
.map-hearts-block { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.map-hearts-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
}

/* ── Dev tools ── */
.dev-tools {
  margin-top: 14px;
  padding: 10px 12px;
  border: 1px dashed var(--border);
  border-radius: 2px;
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
}
.dev-tools-label {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.12em;
  margin-right: 4px;
}
.dev-btn {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 2px;
  color: var(--text-dark);
  font-family: 'Cinzel', serif;
  font-size: 12px; letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 4px 10px; cursor: pointer;
  transition: all 0.2s;
}
.dev-btn:hover { border-color: var(--red); color: var(--red); }

/* ── Treasury over-budget ── */
.treasury-bar-fill.over {
  background: var(--red);
  width: 100% !important;
  opacity: 0.4;
}
.treasury-remaining.over { color: var(--red); }

/* ── Wounded mode ── */
.char-panel.wounded {
  border-color: rgba(184,60,46,0.35);
}
.char-panel.wounded::before {
  background: linear-gradient(90deg, transparent, rgba(184,60,46,0.25), transparent) !important;
  opacity: 1 !important;
}
.recovery-track {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid rgba(184,60,46,0.2);
}
.recovery-track.hidden { display: none; }
.recovery-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: rgba(200,80,60,0.75);
  text-transform: uppercase; letter-spacing: 0.12em;
}
.recovery-pips { display: flex; gap: 5px; }
.recovery-pip {
  width: 18px; height: 4px; border-radius: 100px;
  background: rgba(184,60,46,0.2);
  transition: all 0.3s;
}
.recovery-pip.earned {
  background: rgba(200,80,60,0.7);
  box-shadow: 0 0 5px rgba(200,80,60,0.35);
}


/* ══════════════════════════════════════════════
   BADGE RAIL (left column journey progress)
══════════════════════════════════════════════ */
.badge-rail-section {
  margin: 12px -18px 0;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  background: var(--surface2);
  padding: 10px 18px 10px;
}
.badge-rail-heading {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.14em;
  margin-bottom: 10px;
}
.badge-rail {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.badge-rail-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex: 1;
  min-width: 0;
}
.badge-connector {
  flex: 1;
  height: 1px;
  background: var(--border);
  margin: 0 4px;
  margin-bottom: 14px;
}
.badge-pip {
  width: 32px; height: 32px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--surface3);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  transition: all 0.35s;
  position: relative;
}
.badge-pip.locked {
  opacity: 0.2;
  filter: grayscale(1);
}
.badge-pip.earned {
  border-color: var(--gold);
  background: rgba(196,162,74,0.1);
  opacity: 1;
  filter: none;
  box-shadow: 0 0 8px var(--gold-glow);
}
.badge-pip.earned::after {
  content: '';
  position: absolute; inset: -3px;
  border-radius: 50%;
  border: 1px solid var(--gold-dim);
  opacity: 0.4;
}
.badge-rail-label {
  font-family: 'Cinzel', serif;
  font-size: 9px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  white-space: normal;
  text-align: center;
  max-width: 52px;
  line-height: 1.3;
}

/* ══════════════════════════════════════════════
   XP BLOCK — more prominent
══════════════════════════════════════════════ */
.xp-block {
  margin-top: 12px;
}
.xp-label-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 6px;
}
.xp-label {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.14em;
}
.xp-nums {
  font-size: 17px;
  color: var(--text-dim);
}
.xp-nums strong {
  color: var(--xp);
  font-family: 'Cinzel', serif;
  font-size: 22px;
}
.xp-bar-track {
  height: 10px;
  background: var(--surface2);
  border-radius: 100px;
  overflow: hidden;
  border: 1px solid var(--border);
}
.xp-bar-fill {
  height: 100%; border-radius: 100px;
  background: linear-gradient(90deg, var(--xp-dim), var(--xp));
  transition: width 0.85s cubic-bezier(0.4,0,0.2,1);
  min-width: 0;
}
.xp-bar-fill.pulse { animation: barPulse 0.6s ease; }
.xp-sub {
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
  font-size: 15px;
  color: var(--text-dark);
  font-style: italic;
}

.ob-budget-hint {
  text-align: center; margin-top: 10px;
  font-size: 15px; color: var(--text-dark);
  font-style: italic;
}
.streak-right-col { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.streak-best { font-size: 13px; color: var(--text-dark); font-style: italic; }

/* ══════════════════════════════════════════════
   ONBOARDING — habit input + cadence + class grid
══════════════════════════════════════════════ */
.habit-examples {
  display: flex; flex-wrap: wrap; gap: 6px;
  justify-content: center; margin-bottom: 14px;
}
/* Inline habit examples — prose style */
.habit-examples-text {
  font-family: 'Crimson Text', serif;
  font-size: 16px; color: var(--text-dim); font-style: italic;
  line-height: 1.8; text-align: center;
  margin: 4px 0 14px; padding: 0 12px;
}
.habit-ex-label {
  color: var(--text-dark); font-style: normal;
  font-family: 'Cinzel', serif; font-size: 12px;
  text-transform: uppercase; letter-spacing: 0.1em;
  margin-right: 4px;
}
.habit-ex-sep { color: var(--text-dark); margin: 0 1px; }
.habit-ex-item {
  color: var(--text-mid); cursor: pointer;
  border-bottom: 1px dotted var(--border-mid);
  transition: color 0.15s, border-color 0.15s;
  padding-bottom: 1px;
}
.habit-ex-item:hover { color: var(--gold-light); border-color: var(--gold-dim); }
.habit-example-btn {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 100px; color: var(--text-dim);
  font-family: 'Crimson Text', serif; font-size: 16px;
  padding: 5px 14px; cursor: pointer; transition: all 0.2s;
}
.habit-example-btn:hover { border-color: var(--border-gold); color: var(--text-mid); }
.habit-example-btn.selected { border-color: var(--gold); color: var(--gold-light); background: var(--gold-glow); }
.habit-input-row { display: flex; max-width: 420px; margin: 0 auto; }
.habit-input-row .hero-name-input { border-radius: 2px; text-align: center; }

/* Two-touch clarify box — kept for compat but hidden */
.habit-clarify-box { display: none; }

/* ── Sentence Expander ── */
.habit-expander {
  margin: 6px 0 8px;
  animation: expanderIn 0.22s cubic-bezier(0.4,0,0.2,1);
}
@keyframes expanderIn {
  from { opacity: 0; transform: translateY(-8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.habit-expander-back {
  background: none; border: none;
  color: var(--text-dark); font-size: 13px; font-style: italic;
  cursor: pointer; padding: 0 0 10px; letter-spacing: 0.02em;
  transition: color 0.15s;
}
.habit-expander-back:hover { color: var(--text-mid); }

/* Class conflict notice */
.class-conflict-notice {
  background: rgba(196,162,74,0.07);
  border: 1px solid rgba(196,162,74,0.2);
  border-radius: 4px;
  padding: 8px 12px;
  margin-bottom: 10px;
  font-size: 14px;
  color: var(--text-dim);
  font-style: italic;
  line-height: 1.5;
}
/* Class swap row — pick any available champion */
.class-swap-row {
  display: flex; flex-wrap: wrap; gap: 7px;
  margin: 10px 0 4px; justify-content: center;
}
.class-swap-btn {
  display: flex; flex-direction: column; align-items: center;
  gap: 3px; padding: 6px 8px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 4px; cursor: pointer; transition: all 0.15s;
  min-width: 52px; opacity: 0.55;
}
.class-swap-btn:hover  { border-color: var(--gold-dim); opacity: 1; }
.class-swap-btn.selected { border-color: var(--gold); background: rgba(196,162,74,0.08); opacity: 1; }
.class-swap-btn.taken  { opacity: 0.18; cursor: not-allowed; pointer-events: none; }
.class-swap-icon  { font-size: 18px; line-height: 1; }
.class-swap-label {
  font-family: 'Cinzel', serif; font-size: 9px;
  color: var(--text-dark); text-transform: uppercase;
  letter-spacing: 0.06em; text-align: center; line-height: 1.2;
}

/* The sentence with inline blank */
.habit-sentence {
  display: flex; align-items: center; flex-wrap: wrap; gap: 6px;
  font-family: 'Crimson Text', serif;
  font-size: 22px; color: var(--text);
  font-style: italic; line-height: 1.5;
  padding: 10px 0 6px;
}
.hs-before, .hs-after { color: var(--text-mid); }
.hs-blank-wrap {
  display: inline-flex; align-items: center;
  border-bottom: 2px solid var(--gold);
  padding-bottom: 2px; min-width: 80px;
}
.hs-input {
  background: transparent; border: none; outline: none;
  color: var(--gold-light);
  font-family: 'Crimson Text', serif;
  font-size: 22px; font-style: italic; font-weight: 600;
  width: 100%; min-width: 60px; max-width: 180px;
  text-align: center; padding: 0 4px;
  caret-color: var(--gold);
}
.hs-input::placeholder { color: var(--gold-dim); opacity: 0.6; }

/* Quick-pick chips */
.hs-chips {
  display: flex; flex-wrap: wrap; gap: 7px;
  margin: 8px 0 4px;
}
.hs-chip {
  background: var(--surface3);
  border: 1px solid var(--border-mid);
  border-radius: 100px;
  color: var(--text-mid);
  font-family: 'Crimson Text', serif;
  font-size: 15px; padding: 4px 14px;
  cursor: pointer; transition: all 0.15s;
  user-select: none;
}
.hs-chip:hover  { border-color: var(--gold); color: var(--gold-light); }
.hs-chip.active { border-color: var(--gold); background: var(--gold-glow); color: var(--gold-light); }
.hs-or {
  font-size: 13px; color: var(--text-dark); font-style: italic;
  margin-top: 4px;
}

/* ── Inline Cadence Chooser ── */
.habit-cadence-inline {
  margin-top: 18px; padding-top: 16px;
  border-top: 1px solid var(--border);
  animation: expanderIn 0.2s ease;
}
.hci-label {
  font-family: 'Cinzel', serif;
  font-size: 11px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em;
  margin-bottom: 10px;
}
.hci-opts {
  display: flex; gap: 8px; margin-bottom: 10px;
}
.hci-opt {
  flex: 1; display: flex; align-items: center; gap: 8px;
  padding: 10px 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer; transition: all 0.15s;
  user-select: none;
}
.hci-opt:hover { border-color: var(--border-mid); }
.hci-opt.selected {
  border-color: var(--gold);
  background: var(--surface3);
}
.hci-icon { font-size: 18px; flex-shrink: 0; }
.hci-name {
  font-family: 'Crimson Text', serif;
  font-size: 16px; color: var(--text-mid);
  line-height: 1.2;
}
.hci-opt.selected .hci-name { color: var(--gold-light); }
.hci-weekly-row {
  display: flex; align-items: center; gap: 10px;
  padding: 6px 0;
}
.hci-weekly-row.hidden { display: none; }
.hci-weekly-label {
  font-family: 'Cinzel', serif; font-size: 11px;
  color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.08em;
  flex-shrink: 0;
}
.hci-weekly-btns { display: flex; gap: 6px; }

.suggested-class-card {
  display: flex; align-items: flex-start; gap: 14px;
  background: var(--surface2); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 14px 16px; margin-bottom: 4px;
  border-left: 3px solid var(--gold-dim);
}
.suggested-class-icon { font-size: 32px; flex-shrink: 0; margin-top: 2px; }
.suggested-class-name {
  font-family: 'Cinzel', serif; font-size: 18px; color: var(--gold); margin-bottom: 1px;
}
.sc-persona-name {
  font-family: 'Cinzel', serif; font-size: 20px; color: var(--gold);
  letter-spacing: 0.03em; margin-bottom: 2px;
}
.suggested-class-name {
  font-size: 13px; color: var(--text-dark); text-transform: uppercase;
  letter-spacing: 0.12em; font-family: 'Cinzel', serif; margin-bottom: 6px;
}
.suggested-class-desc { font-size: 14px; color: var(--text-dim); font-style: italic; margin-bottom: 4px; }
.suggested-class-trait {
  font-size: 12px; color: var(--xp); text-transform: uppercase; letter-spacing: 0.1em;
  background: rgba(91,143,204,0.1); border: 1px solid rgba(91,143,204,0.2);
  padding: 2px 8px; border-radius: 2px; display: inline-block; margin-bottom: 8px;
}
.sc-lore {
  font-size: 13px; color: var(--text-mid); font-style: italic; line-height: 1.55;
  border-top: 1px solid var(--border); padding-top: 8px; margin-top: 4px;
}

/* Champion card persona name */
.char-card-persona {
  font-family: 'Cinzel', serif; font-size: 14px; color: var(--gold);
  letter-spacing: 0.02em; margin-bottom: 1px;
}
/* Persona as primary title — larger and bold */
.char-card-persona-main {
  font-family: 'Cinzel', serif; font-size: 15px; color: var(--gold-light);
  letter-spacing: 0.04em; margin-bottom: 2px; line-height: 1.2;
}
.char-card-class-tag {
  font-size: 11px; color: var(--text-dark); text-transform: uppercase;
  letter-spacing: 0.08em; font-family: 'Cinzel', serif;
  margin-bottom: 3px; line-height: 1.2;
}
/* Lore tooltip */
.char-card-lore-btn {
  font-size: 11px; color: var(--text-dark); cursor: pointer;
  background: none; border: none; padding: 0; font-style: italic;
  text-decoration: underline dotted; margin-top: 3px; display: inline-block;
}
.char-card-lore-panel {
  display: none; font-size: 12px; color: var(--text-mid); font-style: italic;
  line-height: 1.5; padding: 8px 16px 2px; border-top: 1px solid var(--border);
  animation: fadeIn 0.2s ease;
}
.char-card-lore-panel.open { display: block; }

/* Flavor text on done button */
.checkin-flavor {
  display: block; font-size: 12px; color: var(--text-dark);
  font-style: italic; margin-top: 3px; font-family: serif;
  line-height: 1.4; letter-spacing: 0;
}

/* Check-in particle burst */
@keyframes particlePop {
  0%   { transform: translate(var(--px), var(--py)) scale(1); opacity: 1; }
  100% { transform: translate(calc(var(--px) * 3), calc(var(--py) * 3)) scale(0); opacity: 0; }
}
.checkin-particle {
  position: fixed; pointer-events: none; z-index: 9999;
  font-size: 14px; animation: particlePop 0.7s ease-out forwards;
}

.cadence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.cadence-opt {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 3px; padding: 14px; cursor: pointer; transition: all 0.2s;
  text-align: center; user-select: none;
}
.cadence-opt:hover { border-color: var(--border-mid); }
.cadence-opt.selected { border-color: var(--gold); background: var(--surface3); }
.cadence-icon { font-size: 24px; margin-bottom: 6px; }
.cadence-label { font-family: 'Cinzel', serif; font-size: 15px; color: var(--gold); margin-bottom: 4px; }
.cadence-desc  { font-size: 15px; color: var(--text-dim); font-style: italic; line-height: 1.4; }

.weekly-target-row {
  display: flex; align-items: center; justify-content: center; gap: 12px;
  padding: 10px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 3px; margin-bottom: 6px;
}
.weekly-target-row.hidden { display: none; }
.weekly-target-label {
  font-family: 'Cinzel', serif; font-size: 13px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.weekly-target-btns { display: flex; gap: 6px; }
.wt-btn {
  background: var(--surface3); border: 1px solid var(--border-mid);
  border-radius: 2px; color: var(--text-dim);
  font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 0.08em;
  padding: 6px 14px; cursor: pointer; transition: all 0.2s;
}
.wt-btn.selected { border-color: var(--gold); color: var(--gold); background: var(--surface3); }
.wt-btn:hover { border-color: var(--border-gold); }

.begin-summary {
  background: var(--surface2); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 14px 16px;
  display: flex; align-items: center; gap: 14px;
  border-left: 3px solid var(--gold-dim);
  margin-top: 10px;
}
.begin-sum-icon { font-size: 32px; flex-shrink: 0; }
.begin-sum-name { font-family: 'Cinzel', serif; font-size: 17px; color: var(--gold); margin-bottom: 3px; }
.begin-sum-habit { font-size: 17px; color: var(--text-dim); font-style: italic; margin-bottom: 3px; }
.begin-sum-cadence { font-size: 15px; color: var(--text-dark); }

.char-card-cadence-tag {
  font-family: 'Cinzel', serif; font-size: 11px; color: var(--text-dark);
  text-transform: uppercase; letter-spacing: 0.1em; margin-top: 3px;
}
.char-card-weekly-progress {
  display: flex; gap: 4px; margin-top: 5px; align-items: center;
}
.weekly-pip {
  width: 18px; height: 6px; border-radius: 100px;
  background: var(--border); transition: all 0.3s;
}
.weekly-pip.done { background: var(--teal); box-shadow: 0 0 5px var(--teal-glow); }
.weekly-pip-label {
  font-size: 13px; color: var(--text-dark); font-style: italic; margin-left: 4px;
}

/* ══════════════════════════════════════════════
   PARTY PANEL + CHARACTER CARDS — REDESIGNED
══════════════════════════════════════════════ */
.party-panel {
  background: var(--surface); border: 1px solid var(--border-gold);
  border-radius: 3px; padding: 18px;
  position: relative; overflow: hidden;
}
.party-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}
.party-cards { display: flex; flex-direction: column; gap: 10px; }

.char-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  display: flex; align-items: stretch;
  overflow: hidden;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.char-card:not(.checked-in):not(.collapsed):not(.wounded) { cursor: pointer; }
.char-card:not(.checked-in):not(.collapsed):not(.wounded):hover {
  border-color: var(--border-gold);
  box-shadow: 0 2px 10px rgba(196,162,74,0.07);
}
.char-card.checked-in { border-color: rgba(58,158,106,0.35); background: rgba(58,158,106,0.02); }
.char-card.wounded    { border-color: rgba(184,60,46,0.35); }
.char-card.collapsed  { border-color: rgba(184,60,46,0.5); box-shadow: 0 0 10px rgba(184,60,46,0.08); cursor: pointer; flex-wrap: wrap; }
.char-card-collapsed-bar {
  flex-basis: 100%; /* force to its own row */
  padding: 5px 14px 8px 20px;
  background: rgba(184,60,46,0.05);
  border-top: 1px solid rgba(184,60,46,0.15);
}
/* Left accent bar */
.char-card-accent {
  width: 4px; flex-shrink: 0;
  background: var(--gold-dim);
  transition: background 0.3s;
}
.char-card.checked-in .char-card-accent { background: var(--green); }
.char-card.wounded    .char-card-accent { background: var(--orange); }
.char-card.collapsed  .char-card-accent { background: var(--red); }

/* Card body */
.char-card-body {
  flex: 1; display: flex; align-items: center;
  gap: 12px; padding: 13px 14px 11px;
  min-width: 0;
}

/* Class icon */
.char-card-avatar {
  width: 40px; height: 40px; flex-shrink: 0;
  border-radius: 8px;
  background: var(--surface3);
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  transition: all 0.3s;
}
.char-card-avatar.low-hp { border-color: rgba(184,60,46,0.5); }
.char-card.checked-in .char-card-avatar { border-color: rgba(58,158,106,0.4); }

/* Info block */
.char-card-info { flex: 1; min-width: 0; }

.char-card-persona-main {
  font-family: 'Cinzel', serif;
  font-size: 12px; color: var(--gold);
  letter-spacing: 0.04em; line-height: 1.2;
  margin-bottom: 1px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.char-card.checked-in .char-card-persona-main { color: var(--green); opacity: 0.8; }

.char-card-habit {
  font-size: 17px; color: var(--text);
  font-style: italic; line-height: 1.25;
  margin-bottom: 6px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.char-card.checked-in .char-card-habit {
  color: var(--text-dim);
  opacity: 0.7;
}

/* Streak dots row */
.char-card-dots {
  display: flex; align-items: center; gap: 4px;
}
.streak-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--border);
  transition: all 0.3s;
}
.streak-dot.filled { background: var(--orange); }
.streak-dot.today  { background: var(--green); box-shadow: 0 0 4px rgba(58,158,106,0.5); }
.streak-label-mini {
  font-size: 11px; color: var(--text-dark); font-style: italic;
  margin-left: 2px;
}

/* Weekly pips */
.char-card-weekly-progress {
  display: flex; gap: 4px; align-items: center;
}
.weekly-pip {
  width: 16px; height: 4px; border-radius: 100px;
  background: var(--border); transition: all 0.3s;
}
.weekly-pip.done { background: var(--teal); box-shadow: 0 0 5px var(--teal-glow); }
.weekly-pip-label {
  font-size: 11px; color: var(--text-dark); font-style: italic; margin-left: 4px;
}
/* Weekly urgency states */
.weekly-urgency-label {
  font-size: 11px; font-style: italic; margin-left: 2px;
  font-family: 'Crimson Text', serif;
}
.weekly-urgency-label.urgent {
  color: var(--red);
}
.weekly-urgency-label.at-risk {
  color: var(--orange);
}
.weekly-urgency-label.done {
  color: var(--teal);
}
.char-card-weekly-progress.weekly-urgency-impossible .weekly-pip:not(.done) {
  background: rgba(184,60,46,0.3);
}
.char-card-weekly-progress.weekly-urgency-at_risk .weekly-pip:not(.done) {
  background: rgba(200,130,50,0.4);
  animation: pipPulse 1.8s ease-in-out infinite;
}
@keyframes pipPulse {
  0%, 100% { opacity: 0.5; }
  50%       { opacity: 1; }
}
.char-card-streak { font-size: 12px; color: var(--orange); }

/* Miss today button */
.char-miss-btn {
  display: inline-block; margin-top: 5px;
  background: none; border: none; padding: 0;
  font-size: 12px; color: var(--text-dark);
  font-style: italic; cursor: pointer;
  opacity: 0.6; transition: opacity 0.15s, color 0.15s;
  font-family: 'Crimson Text', serif;
  text-decoration: underline dotted;
}
.char-miss-btn:hover { opacity: 1; color: var(--red); }
.char-missed-label {
  display: inline-block; margin-top: 5px;
  font-size: 12px; color: var(--red);
  font-style: italic; opacity: 0.7;
  font-family: 'Crimson Text', serif;
}

/* HP hearts */
.char-card-hp-hearts { flex-shrink: 0; }
.hp-hearts-row { display: flex; gap: 2px; }
.hp-heart { font-size: 13px; transition: all 0.3s; line-height: 1; }
.hp-heart.empty { opacity: 0.15; filter: grayscale(1); }

/* Check circle — always shows ✓ dimly; fills on hover; green when done */
.char-card-check {
  flex-shrink: 0;
  width: 42px; height: 42px; border-radius: 50%;
  border: 2px solid var(--border-mid);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  color: rgba(196,162,74,0.22);
  transition: all 0.2s;
  cursor: default;
  background: transparent;
  user-select: none;
}
/* Hover only when genuinely actionable */
.char-card:not(.checked-in):not(.collapsed):not(.missed-today) .char-card-check:not(.locked-out):hover {
  border-color: var(--gold);
  background: rgba(196,162,74,0.08);
  color: var(--gold-dim);
  cursor: pointer;
}
/* Done — green, inert */
.char-card.checked-in .char-card-check {
  border-color: var(--green);
  background: rgba(58,158,106,0.12);
  color: var(--green);
  cursor: default;
}
/* Collapsed — red ↺ */
.char-card.collapsed .char-card-check {
  border-color: rgba(184,60,46,0.5);
  color: var(--red);
  cursor: pointer;
}
/* Locked out after miss — faded, no pointer, no hover */
.char-card.missed-today .char-card-check,
.char-card-check.locked-out {
  border-color: var(--border);
  color: rgba(196,162,74,0.07);
  opacity: 0.35;
  cursor: not-allowed;
  pointer-events: none;
}

/* Miss circle */
.char-miss-circle {
  width: 42px; height: 42px; border-radius: 50%;
  border: 2px solid rgba(184,60,46,0.25);
  background: none;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  color: rgba(184,60,46,0.3);
  transition: all 0.2s;
  cursor: pointer;
  flex-shrink: 0;
  user-select: none;
}
.char-miss-circle:hover {
  border-color: var(--red);
  color: var(--red);
  background: rgba(184,60,46,0.07);
}
/* Missed — locked red, no hover */
.char-miss-circle.missed,
.char-miss-circle:disabled {
  border-color: rgba(184,60,46,0.5);
  color: var(--red);
  background: rgba(184,60,46,0.06);
  opacity: 0.65;
  cursor: default;
  pointer-events: none;
}
/* Checked-in — fade the miss circle out completely */
.char-card.checked-in .char-miss-circle {
  opacity: 0.12;
  pointer-events: none;
  border-color: var(--border);
  color: var(--border-mid);
}
@keyframes checkBounce {
  0%   { transform: scale(1); }
  35%  { transform: scale(1.28); }
  65%  { transform: scale(0.88); }
  100% { transform: scale(1); }
}
.char-card-check.just-checked { animation: checkBounce 0.38s ease; }

@keyframes cardCheckin {
  0%   { box-shadow: 0 0 0 0 rgba(58,158,106,0); }
  35%  { box-shadow: 0 0 0 5px rgba(58,158,106,0.18); }
  100% { box-shadow: none; }
}
.char-card.checkin-flash { animation: cardCheckin 0.5s ease-out forwards; }

/* Collapsed bar */
.collapsed-msg {
  font-size: 13px; color: rgba(184,60,46,0.8); font-style: italic;
}
.recovery-indicator {
  display: inline-block; font-size: 11px; color: var(--orange);
  font-style: italic; margin-top: 3px; opacity: 0.85;
}

/* Flavor text — inline below habit on done */
.checkin-flavor {
  display: block; font-size: 12px; color: var(--text-dark);
  font-style: italic; margin-top: 2px; font-family: serif;
  line-height: 1.4;
}

.map-player-marker {
  position: absolute; top: -22px; left: 50%;
  transform: translateX(-50%);
  font-size: 18px; line-height: 1;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));
  animation: playerBob 2s ease-in-out infinite;
  z-index: 10;
}
@keyframes playerBob {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50%       { transform: translateX(-50%) translateY(-3px); }
}
.add-char-wrap { margin-top: 10px; }
.add-char-wrap.hidden { display: none; }
.add-char-btn {
  width: 100%; padding: 10px; background: transparent;
  border: 1px dashed var(--border-mid); border-radius: 3px;
  color: var(--text-dark); font-family: 'Cinzel', serif;
  font-size: 13px; letter-spacing: 0.08em; text-transform: uppercase;
  cursor: pointer; transition: all 0.2s;
}
.add-char-btn:hover { border-color: var(--gold-dim); color: var(--text-mid); }

/* Chronicle entry update — show character name not amount */
.log-char-name {
  font-size: 14px; color: var(--text-dark); font-style: italic; margin-top: 1px;
}

/* Check-in done flavor text */
.checkin-flavor {
  display: block;
  font-size: 12px; color: var(--green); font-style: italic;
  margin-top: 4px; opacity: 0.8; letter-spacing: 0;
  font-family: 'Crimson Text', serif; white-space: normal;
  overflow: hidden; text-overflow: ellipsis;
}
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-brand">
      <div class="header-sigil">⚔</div>
      <div>
        <h1>Habit Forge</h1>
        <div class="header-tagline">Forge the habit. Become the legend.</div>
      </div>
    </div>
    <div id="header-auth" class="header-auth" style="display:none;">
      <span class="header-auth-email" id="header-email"></span>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- ── LOGIN ── -->
  <div id="login-screen" style="display:none;">
    <div class="login-hero">
      <div class="login-hero-icon">⚔</div>
      <div class="login-title">Welcome Back, Hero</div>
      <div class="login-sub">Your champions are waiting.</div>
    </div>
    <div class="card" style="max-width:420px;margin:0 auto;">
      <div class="card-accent-top"></div>

      <!-- Password login -->
      <div id="login-password-panel">
        <div id="login-form-password">
          <div class="form-field">
            <label class="field-label">Email</label>
            <input class="field-input" id="login-email-pw" type="email" placeholder="your@email.com" autocomplete="email">
          </div>
          <div class="form-field">
            <label class="field-label">Password</label>
            <input class="field-input" id="login-password" type="password" placeholder="Password" autocomplete="current-password">
          </div>
          <button class="btn-primary" onclick="signInWithPassword()">Enter the Realm ⚔</button>
          <div id="login-error-pw" class="login-err"></div>
        </div>
      </div>



    </div>
  </div>

  <!-- ── ONBOARDING ── -->
  <div id="onboarding" style="display: none;">
    <div class="ob-card">

      <!-- Progress bar (replaces step dots) -->
      <div class="ob-progress-bar">
        <div class="ob-progress-fill" id="ob-progress-fill" style="width:0%"></div>
      </div>

      <!-- Step 0: Name + Avatar (merged) -->
      <div class="ob-step active" id="step-0">
        <div class="ob-icon">⚔️</div>
        <div class="ob-title">Begin Your Forge</div>
        <div class="ob-sub">Who sets out on this road?</div>
        <div class="name-row" style="margin-bottom:18px;">
          <input class="hero-name-input" id="hero-name-input" type="text" placeholder="Your name…" maxlength="24" autocomplete="off" oninput="onNameInput()">
          <button class="name-btn" id="name-next-btn" onclick="goStep('2')" disabled>Onward →</button>
        </div>
        <div style="font-family:'Cinzel',serif;font-size:12px;color:var(--text-dark);text-transform:uppercase;letter-spacing:0.16em;margin-bottom:10px;">Choose Your Form</div>
        <div class="avatar-grid" id="avatar-grid">
          <div class="avatar-opt selected" data-avatar="🧔" onclick="selectAvatar(this)">
            <div class="avatar-opt-icon">🧔</div>
            <div class="avatar-opt-label">Human</div>
          </div>
          <div class="avatar-opt" data-avatar="🧝" onclick="selectAvatar(this)">
            <div class="avatar-opt-icon">🧝</div>
            <div class="avatar-opt-label">Elf</div>
          </div>
          <div class="avatar-opt" data-avatar="👺" onclick="selectAvatar(this)">
            <div class="avatar-opt-icon">👺</div>
            <div class="avatar-opt-label">Orc</div>
          </div>
          <div class="avatar-opt" data-avatar="🧙" onclick="selectAvatar(this)">
            <div class="avatar-opt-icon">🧙</div>
            <div class="avatar-opt-label">Wizard</div>
          </div>
        </div>
      </div>

      <!-- Step 1-race: REMOVED (merged into step 0) — kept as hidden stub for JS compat -->
      <div class="ob-step" id="step-1-race" style="display:none;"></div>

      <!-- Step 2: Party Size -->
      <div class="ob-step" id="step-2">
        <div class="ob-icon">🗡️</div>
        <div class="ob-title">Assemble Your Party</div>
        <div class="ob-sub">Each champion holds one habit. How many will you commit to?</div>
        <div class="party-size-grid">
          <div class="party-size-opt" data-size="1" onclick="selectPartySize(this, 1)">
            <div class="party-size-num">1</div>
            <div class="party-size-label">Solo</div>
            <div class="party-size-desc">One habit, all your focus.</div>
          </div>
          <div class="party-size-opt" data-size="2" onclick="selectPartySize(this, 2)">
            <div class="party-size-num">2</div>
            <div class="party-size-label">Pair</div>
            <div class="party-size-desc">Two habits. Double the stakes.</div>
          </div>
          <div class="party-size-opt" data-size="3" onclick="selectPartySize(this, 3)">
            <div class="party-size-num">3</div>
            <div class="party-size-label">Party</div>
            <div class="party-size-desc">Three commitments. Full party.</div>
          </div>
        </div>
        <div class="ob-nav" style="margin-top:18px;">
          <button class="btn-secondary" onclick="goStep(0)">← Back</button>
          <button class="btn-primary" style="width:auto;" id="party-size-next-btn" onclick="startCompanionSetup()">Enlist My Champions →</button>
        </div>
      </div>

      <!-- Step 3: Companion habit setup (dynamic, repeats per companion) -->
      <div class="ob-step" id="step-habit">
        <div class="ob-icon" id="companion-setup-icon">🧭</div>
        <div class="ob-title" id="companion-setup-title">First Champion's Forge</div>
        <div class="ob-sub" id="companion-setup-sub">What will this champion hold you to?</div>
        <div class="companion-progress" id="companion-progress"></div>

        <!-- Phase 1: suggestion prose + free input -->
        <div id="habit-phase-1">
          <div class="habit-examples-text" id="habit-examples-dynamic">
            <span class="habit-ex-label">e.g.</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('sleep')">More sleep</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('eat')">Eat healthier</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('workout')">Work out more</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('read')">Read daily</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('water')">Drink more water</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('meditate')">Meditate</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('journal')">Journal</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('sugar')">Cut sugar</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('walk')">Walk more</span><span class="habit-ex-sep">,</span>
            <span class="habit-ex-item" onclick="selectHabitSuggestion('spend')">Spend less</span>…
          </div>
          <div class="habit-input-row" id="habit-input-row">
            <input class="hero-name-input" id="habit-input" type="text"
              placeholder="Or describe your own habit…" maxlength="60"
              autocomplete="off" oninput="onHabitInput()">
          </div>
        </div>

        <!-- Phase 2: inline sentence expander (hidden until suggestion tapped) -->
        <div id="habit-phase-2" class="habit-expander" style="display:none;">
          <button class="habit-expander-back" onclick="backToHabitPhase1()">← change habit</button>
          <div class="habit-sentence">
            <span class="hs-before" id="hs-before">I want to sleep</span>
            <span class="hs-blank-wrap">
              <input class="hs-input" id="hs-input" type="text" maxlength="30"
                autocomplete="off" oninput="onSentenceInput()" />
            </span>
            <span class="hs-after" id="hs-after">hours per night</span>
          </div>
          <div class="hs-chips" id="hs-chips">
            <!-- populated by JS -->
          </div>
          <div class="hs-or" id="hs-or-label">or type your own amount above</div>
        </div>

        <!-- Inline cadence — shown once habit has a value -->
        <div class="habit-cadence-inline" id="habit-cadence-inline" style="display:none;">
          <div class="hci-label">How often?</div>
          <div class="hci-opts">
            <div class="hci-opt selected" id="hci-daily" onclick="selectCadenceInline('daily')">
              <span class="hci-icon">🔁</span>
              <span class="hci-name">Every day</span>
            </div>
            <div class="hci-opt" id="hci-weekly" onclick="selectCadenceInline('weekly')">
              <span class="hci-icon">📆</span>
              <span class="hci-name">A few times a week</span>
            </div>
          </div>
          <div class="hci-weekly-row hidden" id="hci-weekly-row">
            <span class="hci-weekly-label">Target:</span>
            <div class="hci-weekly-btns">
              <button class="wt-btn" data-n="2" onclick="selectWeeklyTargetInline(this)">2×</button>
              <button class="wt-btn selected" data-n="3" onclick="selectWeeklyTargetInline(this)">3×</button>
              <button class="wt-btn" data-n="4" onclick="selectWeeklyTargetInline(this)">4×</button>
              <button class="wt-btn" data-n="5" onclick="selectWeeklyTargetInline(this)">5×</button>
            </div>
          </div>
        </div>

        <div class="ob-nav" style="margin-top:18px;">
          <button class="btn-secondary" id="habit-back-btn" onclick="habitBack()">← Back</button>
          <button class="btn-primary" style="width:auto;" id="habit-next-btn" onclick="goToClassStep()" disabled>Assign Champion →</button>
        </div>
      </div>

      <!-- Step 4: Class suggestion -->
      <div class="ob-step" id="step-class">
        <div class="ob-icon" id="ob-suggest-icon">🏹</div>
        <div class="ob-title">Your Champion Answers</div>
        <div class="ob-sub" id="ob-suggest-sub">Based on your habit, here's who joins your party.</div>
        <!-- Conflict notice — shown when best class is already taken -->
        <div class="class-conflict-notice" id="class-conflict-notice" style="display:none;">
          <span id="class-conflict-msg"></span>
        </div>
        <div class="suggested-class-card" id="suggested-class-card">
          <div class="suggested-class-icon" id="sc-icon">🏹</div>
          <div class="suggested-class-body">
            <div class="sc-persona-name" id="sc-persona-name">Corvin the Lorebound</div>
            <div class="suggested-class-name" id="sc-name">The Mage</div>
            <div class="suggested-class-trait" id="sc-trait">Knowledge & Craft</div>
            <div class="sc-lore" id="sc-lore"></div>
            <div class="suggested-class-desc" id="sc-desc" style="margin-top:8px;"></div>
          </div>
        </div>
        <!-- Class swap row — always shown, lets user pick any available class -->
        <div class="class-swap-row" id="class-swap-row"></div>
        <div class="ob-nav">
          <button class="btn-secondary" onclick="goStep('habit')">← Back</button>
          <button class="btn-primary" style="width:auto;" id="confirm-class-btn" onclick="confirmCompanionClass()">This is my champion →</button>
        </div>
      </div>

      <!-- Step 5: Laws REMOVED — replaced by Begin with inline rules summary -->

      <!-- Step begin: Begin -->
      <div class="ob-step" id="step-begin">
        <div class="ob-icon">🏰</div>
        <div class="ob-title">The Iron Keep Awaits</div>
        <div class="ob-sub">Your party is assembled. The road runs from Hearthstone Village to the Iron Keep — and its gates open only for those whose records speak for themselves.</div>
        <div class="begin-party-summary" id="begin-party-summary"><!-- populated by JS --></div>
        <div style="margin-top:16px;padding:14px 16px;background:var(--surface2);border:1px solid var(--border-gold);border-radius:3px;font-size:15px;color:var(--text-mid);line-height:1.8;font-style:italic;">
          "The Keep's quartermaster has turned away a thousand travelers with good intentions. What he reads is the log — not the plan."
        </div>
        <div style="margin-top:12px;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:3px;font-size:14px;color:var(--text-dim);line-height:1.7;">
          <span style="font-family:'Cinzel',serif;font-size:12px;color:var(--text-dark);text-transform:uppercase;letter-spacing:0.14em;">How the road works</span><br>
          ✦ Check in daily → earn XP &amp; advance toward the Keep<br>
          ❤️ Champions have 5 HP — missed days cost them<br>
          💰 Earn Road Gold from encounters — spend it to survive hostile ones<br>
          🔒 The Iron Keep Registry records every traveler who arrives
        </div>
        <button class="btn-primary" style="margin-top:20px;" onclick="beginJourney()">Enter the Road ⚔</button>
        <div class="ob-nav" style="margin-top:10px;">
          <button class="btn-secondary" onclick="goStep('class')">← Back</button>
        </div>
      </div>

      <!-- Hidden compat stub for Laws step -->
      <div class="ob-step" id="step-laws" style="display:none;"></div>

    </div>
  </div><!-- /onboarding -->

  <!-- ── MAIN ── -->
  <div id="main" style="display: block;">
    <div class="layout">

      <!-- LEFT COLUMN — traveler panel (with weather strip) -->
      <div class="col-left">
        <div class="char-panel" id="char-panel-main">
          <div class="char-identity">
            <div class="char-avatar" id="char-avatar">🧙</div>
            <div style="flex:1;min-width:0;">
              <div class="char-name" id="char-name">Traveler</div>
              <div class="char-class" id="char-class">Novice</div>
            </div>
            <div class="char-level-badge" id="level-badge">
              <div class="level-num" id="level-num">1</div>
              <div class="level-label">Level</div>
              <div class="dev-trigger" onclick="var dt=document.getElementById('dev-tools');dt.style.display=dt.style.display==='none'?'flex':'none';" title="Dev tools">🔧</div>
            </div>
          </div>

          <div class="xp-block">
            <div class="xp-label-row">
              <span class="xp-label">✦ Experience</span>
              <span class="xp-nums"><strong id="xp-current">0</strong> / <span id="xp-next-val">80</span> xp</span>
            </div>
            <div class="xp-bar-track">
              <div class="xp-bar-fill" id="xp-fill" style="width:0%"></div>
            </div>
            <div class="xp-sub">
              <span id="xp-bonus-msg-hidden" style="display:none;"></span>
              <span id="xp-next-msg">80 XP to Level 2</span>
            </div>
          </div>

          <!-- Road Gold + Streak compact row -->
          <div class="left-stats-row">
            <div class="left-stat-block">
              <div class="left-stat-label">Road Gold <span onclick="showToast('Road Gold absorbs hostile encounters on the road. Earn it from friendly ones, and spend it wisely — it\'s your shield against bad days.')" style="cursor:pointer;opacity:0.5;font-size:11px;">(?)</span></div>
              <div class="left-stat-value" id="vault-amount" style="color:var(--gold);font-family:Cinzel,serif;font-size:20px;">0 💰</div>
              <div style="font-size:11px;color:var(--text-dark);font-style:italic;margin-top:2px;">Spent on hostile encounters</div>
            </div>
            <div class="left-stat-divider"></div>
            <div class="left-stat-block">
              <div class="left-stat-label">Streak</div>
              <div class="left-stat-value" style="display:flex;align-items:center;gap:5px;">
                <span id="streak-banner-flame" style="font-size:18px;">🔥</span>
                <span id="streak-count" style="font-family:Cinzel,serif;font-size:22px;color:var(--orange);">0</span>
              </div>
              <div style="font-size:13px;color:var(--text-dark);font-style:italic;" id="streak-banner-right">Start today</div>
            </div>
          </div>

          <!-- Weather strip — compact mood indicator -->
          <div class="weather-card partial" id="weather-card">
            <div class="weather-inner">
              <div class="weather-icon" id="weather-icon">⛅</div>
              <div class="weather-body">
                <div class="weather-label" id="weather-label">The Road Awaits</div>
                <div class="weather-desc" id="weather-desc">Check in to see what lies ahead.</div>
              </div>
              <div class="weather-xp-badge" id="weather-xp-badge" style="display:none;">—</div>
            </div>
          </div>

          <!-- Journey progress — zone badges -->
          <div class="badge-rail-section">
            <div class="badge-rail-heading">✦ Places Discovered</div>
            <div class="badge-rail">
              <div class="badge-rail-item" id="badge-zone1"><div class="badge-pip locked">🛡️</div><div class="badge-rail-label">Hearthstone</div></div>
              <div class="badge-connector"></div>
              <div class="badge-rail-item" id="badge-zone2"><div class="badge-pip locked">🪙</div><div class="badge-rail-label">Merchant's Pass</div></div>
              <div class="badge-connector"></div>
              <div class="badge-rail-item" id="badge-zone3"><div class="badge-pip locked">🌿</div><div class="badge-rail-label">Thornwood</div></div>
              <div class="badge-connector"></div>
              <div class="badge-rail-item" id="badge-zone4"><div class="badge-pip locked">🔒</div><div class="badge-rail-label">The Iron Keep</div></div>
            </div>
          </div>

          <div class="dev-tools" id="dev-tools" style="display:none;">
            <span class="dev-tools-label" onclick="document.getElementById('dev-tools').style.display='none'" style="cursor:pointer;" title="Close">Dev ✕</span>
            <button class="dev-btn" onclick="devWipeLog()">Wipe</button>
            <button class="dev-btn" onclick="devWipeStreak()">Streak</button>
            <button class="dev-btn" onclick="devWipeLevel()">Level</button>
            <button class="dev-btn" onclick="devRestart()">Restart</button>
            <button class="dev-btn" onclick="devSimMiss()">Miss</button>
            <button class="dev-btn" onclick="devOrcPatrol()">Orc</button>
            <button class="dev-btn" onclick="devGrimjaw()">Grimjaw</button>
            <button class="dev-btn" onclick="devHostile()">Hostile</button>
          </div>
          <div class="gold-float" id="gold-float"></div>

          <!-- hidden compat stubs -->
          <span id="streak-label" style="display:none;"></span>
          <span id="streak-best" style="display:none;"></span>
          <span id="xp-bonus-msg" style="display:none;"></span>
        </div>

        <!-- hidden compat stubs for party overview -->
        <div id="party-overview-panel" style="display:none;">
          <div id="party-overview-cards"></div>
        </div>

      </div><!-- /col-left -->

      <!-- RIGHT COLUMN — check-in cards + map -->
      <div class="col-right">

        <div class="party-panel">
          <div class="panel-head">Your Companions</div>
          <div class="party-cards" id="party-cards"></div>
          <div class="add-char-wrap hidden" id="add-char-wrap">
            <button class="add-char-btn" onclick="showAddCharacter()">+ Recruit a new companion</button>
          </div>
        </div>

        <!-- Map panel -->
        <div class="map-panel" id="map-section">
          <div class="map-panel-head">
            <div class="map-loc-block">
              <span class="map-section-label">⚔ The Journey</span>
              <span class="map-current-loc" id="map-location-name">Hearthstone Village</span>
              <span class="map-zone-tag" id="map-zone-tag">Hearthstone Road</span>
            </div>
          </div>
          <span id="map-gold-display" style="display:none;"></span>
          <div class="road-bonus-track">
            <span class="road-bonus-label" id="road-bonus-label">Road Bonus — check in 5 days this week</span>
            <div class="road-bonus-pips">
              <div class="road-pip" id="road-pip-1"></div>
              <div class="road-pip" id="road-pip-2"></div>
              <div class="road-pip" id="road-pip-3"></div>
            </div>
          </div>
          <div class="map-viewport" id="map-viewport">
            <div class="node-map" id="node-map">
              <svg id="map-svg" xmlns="http://www.w3.org/2000/svg"></svg>
              <div class="node-map-inner" id="node-map-inner"></div>
            </div>
            <div class="map-more-arrow hidden" id="map-more-arrow"><span>more ahead</span><span>▼</span></div>
          </div>
        </div>

      </div><!-- /col-right -->

      <!-- Hidden stubs for JS compat -->
      <div id="log-list" style="display:none;"></div>
      <div id="log-pagination" style="display:none;"></div>
      <span id="log-pagination-count" style="display:none;"></span>
      <button id="log-more-btn" style="display:none;"></button>
      <button id="log-collapse-btn" style="display:none;"></button>
      <span id="streak-banner" style="display:none;"></span>

    </div><!-- /layout -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- XP Float -->
<div class="xp-float" id="xp-float"></div>

<!-- Coin Float -->
<div class="coin-float" id="coin-float"></div>


<!-- Broken / 0-Hearts Overlay -->
<div class="overlay" id="broken-overlay">
  <div class="overlay-box broken" style="max-width:380px;">
    <div class="broken-icon">🔥</div>
    <div class="broken-title">Camped</div>
    <div class="broken-msg">Your champion is resting. Every veteran has camped here. Each check-in restores 1 HP — keep showing up and they're back on the road, one day at a time.</div>
    <div class="broken-gold" id="broken-gold-display">0 🪙</div>
    <div class="broken-cost">Road Gold balance</div>
    <div id="broken-choices"></div>
  </div>
</div>

<!-- Level Up Overlay -->
<div class="overlay" id="levelup-overlay">
  <div class="overlay-box levelup">
    <div class="levelup-sparkles">✦ ✧ ✦</div>
    <div class="levelup-label">Level Up!</div>
    <div class="levelup-num" id="lu-level">2</div>
    <div class="levelup-rank" id="lu-rank">Apprentice</div>
    <div class="levelup-msg" id="lu-msg">Your discipline grows. The realm takes notice.</div>
    <button class="overlay-btn primary-choice" onclick="closeLevelUp()" style="width:100%;text-align:center;">Continue the Quest ✦</button>
  </div>
</div>

<!-- Encounter Overlay -->
<div class="overlay" id="encounter-overlay">
  <div class="overlay-box" id="encounter-box">
    <div class="overlay-zone-label" id="encounter-zone">Encounter</div>
    <div class="overlay-icon" id="encounter-icon">⚔️</div>
    <div class="overlay-title" id="encounter-title">Bandits on the Road</div>
    <div class="overlay-desc" id="encounter-desc">A band of cutpurses blocks your path.</div>
    <div class="overlay-choices" id="encounter-choices"></div>
  </div>
</div>

<!-- Epic Check-in Celebration Overlay -->
<div id="checkin-celebration" onclick="closeCheckinCelebration()">
  <div class="cc-backdrop"></div>
  <div class="cc-box">
    <div id="cc-confetti"></div>
    <span id="cc-icon">⚔️</span>
    <div id="cc-name">Champion</div>
    <div id="cc-xp">+20 XP</div>
    <div id="cc-msg">Quest complete!</div>
    <div id="cc-streak" style="display:none;">🔥 1 day streak!</div>
  </div>
</div>

<!-- Miss overlay — somber counterpart to celebration -->
<div id="miss-overlay" onclick="closeMissOverlay()">
  <div class="cc-backdrop"></div>
  <div class="miss-box">
    <span id="miss-icon">⚔️</span>
    <div id="miss-name">Champion</div>
    <div id="miss-hp">−1 HP</div>
    <div id="miss-msg">They'll carry it tomorrow.</div>
    <div id="miss-hearts"></div>
  </div>
</div>

<!-- Road Event Overlay (post check-in story beat) -->
<div class="road-event-overlay" id="road-event-overlay">
  <div class="road-event-box">
    <div class="road-event-zone" id="re-zone">✦ The Road</div>
    <div class="road-event-icon" id="re-icon">🌄</div>
    <div class="road-event-title" id="re-title">The Road Speaks</div>
    <div class="road-event-desc" id="re-desc">Something stirs on the path ahead.</div>
    <button class="overlay-btn primary-choice" onclick="closeRoadEvent()" style="width:100%;text-align:center;">Keep Moving ⚔</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ─────────────────────────
//  CONSTANTS
// ─────────────────────────
var SAVE_KEY = 'bq_v2';

// Cumulative XP to reach each level (index = level - 1)
var LEVEL_XP = [0, 80, 200, 370, 600, 900, 1270, 1720, 2260, 3000, 4000];

// ─────────────────────────
//  CLASS DEFINITIONS
// ─────────────────────────
var CLASS_DEFS = {
  Warrior: {
    icon: '⚔️', name: 'The Warrior', trait: 'Strength & Movement',
    gender: 'male',
    desc: 'Physical output habits — exercise, workouts, steps, sport, movement.',
    hpRule: 'standard',
    habitExamples: 'Exercise 30 min / Walk 8,000 steps / Go to the gym / Train',
    personaName: 'Aldric the Unyielding',
    portrait: '🗡️',
    lore: 'Aldric hasn\'t missed a training session in nine years. He doesn\'t track it. There\'s no streak counter in his world — just the fact of showing up, repeated until it\'s the only way he knows to begin a day.',
    checkInFlavor: [
      'Aldric was here. That\'s the whole story.',
      'The Unyielding earns the name again today.',
      'Another session. Aldric doesn\'t count victories — only the work itself.',
      'Movement logged. The road recognizes consistent travelers.',
      'Aldric drives forward. The body remembers what the mind forgets.'
    ],
    altPersona: {
      personaName: 'Vael Brokenchain',
      gender: 'female',
      lore: 'Vael trained her way out of a body that once held her back. She doesn\'t talk about it much — the work speaks louder. She shows up because she knows exactly what not showing up costs. She priced it once, years ago. She hasn\'t forgotten the number.',
      checkInFlavor: [
        'Vael moved today. That\'s not nothing — that\'s everything.',
        'The chain doesn\'t hold her. It never did, once she decided.',
        'Another session in the books. Vael built this one rep at a time.',
        'Brokenchain earns the name again. Forward.',
        'Vael was here. The body got what it needed.'
      ]
    }
  },
  Cleric: {
    icon: '❤️‍🩹', name: 'The Cleric', trait: 'Recovery & Body Care',
    gender: 'female',
    desc: 'Body and recovery habits — sleep, water, nutrition, hydration, self-care.',
    hpRule: 'standard',
    habitExamples: 'Drink water / Sleep 8 hours / Eat well / Take medication / Skincare',
    personaName: 'Casciel the Wellkeeper',
    portrait: '🌿',
    lore: 'Casciel tends to what others ignore — the body\'s quiet requests. Sleep. Water. Rest. She says the well only runs dry when no one tends it. She has never let hers run dry.',
    checkInFlavor: [
      'Casciel tends the well. The body is thanking you right now.',
      'Recovery logged. Casciel keeps the foundation solid.',
      'The Wellkeeper marks another day of care.',
      'Small habits, deep roots. Casciel understands this.',
      'Your body got what it needed today. Casciel approves.'
    ],
    altPersona: {
      personaName: 'Oswin the Steadfast',
      gender: 'male',
      lore: 'Oswin treats the body like infrastructure — something that fails quietly, over time, without any single dramatic moment of neglect. He does maintenance the way a careful engineer does: not because anything is wrong, but because things stay working when you don\'t wait for them to break.',
      checkInFlavor: [
        'Oswin maintains the foundation. Nothing dramatic — just solid.',
        'The Steadfast logs another day of care. Infrastructure holds.',
        'Recovery marked. Oswin knows it\'s the invisible work that matters most.',
        'The body was tended. Oswin checks it off without ceremony.',
        'Steadfast by name, steadfast by habit. Another day kept.'
      ]
    }
  },
  Mage: {
    icon: '🔮', name: 'The Mage', trait: 'Knowledge & Learning',
    gender: 'male',
    desc: 'Learning and reading habits — books, study, courses, research.',
    hpRule: 'standard',
    habitExamples: 'Read 20 pages / Study / Take a course / Research / Learn a language',
    personaName: 'Corvin the Lorebound',
    portrait: '📖',
    lore: 'Corvin has read every book in the Hearthstone archive — twice. He doesn\'t read to finish. He reads because the mind, untended, goes quiet in all the wrong ways. He keeps his loud.',
    checkInFlavor: [
      'Corvin opens the tome. Another page turned on the long road to mastery.',
      'The Lorebound adds to his archive. Every session compounds.',
      'Knowledge logged. Corvin reminds you: this is how it\'s built.',
      'One more session. Corvin has been counting since the beginning.',
      'The mind was fed today. Corvin marks it in the ledger.'
    ],
    altPersona: {
      personaName: 'Lirien of the Long Study',
      gender: 'female',
      lore: 'Lirien doesn\'t read widely — she reads deeply. One subject at a time, until she knows it from the inside. She says breadth is a map and depth is the territory. She prefers the territory. Her current study has been running for two years. She\'s not close to done. She\'s not in a hurry.',
      checkInFlavor: [
        'Lirien goes deeper. One more layer understood.',
        'The Long Study continues. Lirien marks the session without fanfare.',
        'Another hour in the territory. Lirien knows the map isn\'t the thing.',
        'Knowledge logged. Lirien has been building this for a long time.',
        'Depth over speed. Lirien holds the line on that, every day.'
      ]
    }
  },
  Rogue: {
    icon: '🗡️', name: 'The Rogue', trait: 'Discipline & Restraint',
    gender: 'female',
    desc: 'Restraint and limits — spending, screen time, alcohol, things to reduce or stop.',
    hpRule: 'ranger',
    habitExamples: 'Track spending / No social media before 9am / No alcohol / Cut sugar',
    personaName: 'Thessaly Ironledger',
    portrait: '⚖️',
    lore: 'Thessaly tracks everything. Every coin, every impulse, every moment of friction between want and wisdom. She doesn\'t deprive herself — she decides deliberately. There\'s a difference, and she lives it.',
    checkInFlavor: [
      'Thessaly holds the line. Discipline is just a decision made early.',
      'The Ironledger records another clean day. The numbers don\'t lie.',
      'Restraint logged. Thessaly knows what you gave up today.',
      'Another day, another choice made well. Thessaly nods.',
      'The edge held. Thessaly has seen what happens when it doesn\'t.'
    ],
    altPersona: {
      personaName: 'Cade Halfmeasure',
      gender: 'male',
      lore: 'The name was a joke, once — given by people who watched him commit to things halfway. He kept the name after he stopped being that person. Wears it like a warning to himself. Cade knows exactly what half-measures cost; he paid the price for years and has the receipts. He doesn\'t do them anymore.',
      checkInFlavor: [
        'Cade held. No half-measures — not anymore.',
        'The line was there. Cade didn\'t cross it. That\'s the whole win.',
        'Restraint logged. Cade knows what the alternative looks like.',
        'Another clean day. Cade marks it and moves on.',
        'Full measure, every time. Cade earned the right to say that.'
      ]
    }
  },
  Scribe: {
    icon: '✍️', name: 'The Scribe', trait: 'Writing & Creative Work',
    gender: 'male',
    desc: 'Creative and writing habits — journaling, writing, drawing, music, building.',
    hpRule: 'standard',
    habitExamples: 'Journal daily / Write 500 words / Draw / Practice music / Work on a project',
    personaName: 'Morwen of the Open Tome',
    portrait: '📜',
    lore: 'Morwen writes everything down. Not because memory fades — it does — but because the act of writing is itself the thinking. He has filled sixty-three journals and started sixty-four. The blank page is not a threat. It\'s an invitation.',
    checkInFlavor: [
      'Morwen puts pen to page. The work accumulates.',
      'Another entry. Morwen knows every finished thing begins this way.',
      'The Scribe marks another session. Small outputs build large archives.',
      'Written. Morwen nods. That\'s how it\'s done.',
      'Creative work logged. The page was blank. Now it isn\'t.'
    ],
    altPersona: {
      personaName: 'Wren Inkhollow',
      gender: 'female',
      lore: 'Wren writes less than most scribes — and means more. She keeps one journal at a time, fills it slowly, chooses every word. She says output without attention is just noise. What she puts down is quiet and precise and has a way of lasting. She hasn\'t deleted a sentence in three years. She hasn\'t needed to.',
      checkInFlavor: [
        'Wren chose her words today. Every one of them counted.',
        'Inkhollow marks another session. Spare and deliberate.',
        'The work was done. Wren closed the page.',
        'Creative output logged. Wren makes sure it earns its space.',
        'Another entry from Wren. Less than most — means more than most.'
      ]
    }
  },
  Ranger: {
    icon: '🏹', name: 'The Ranger', trait: 'Outdoor & Active Life',
    gender: 'male',
    desc: 'Outdoor and active habits — hiking, cycling, swimming, sports, steps outside.',
    hpRule: 'standard',
    habitExamples: 'Hike / Cycle / Swim / Walk outdoors / Play a sport',
    personaName: 'Soren of the Still Hours',
    portrait: '🌿',
    lore: 'Soren has walked every trail within a day\'s ride of Hearthstone Village — some of them in the dark. He doesn\'t log for the distance. He logs because the day that starts outside is a different day. He has tested this theory for years.',
    checkInFlavor: [
      'Soren moves through the world. Another day of being in it.',
      'Outside and logged. Soren knows the best miles aren\'t planned.',
      'The trail was there. Soren showed up. That\'s the whole equation.',
      'Another session in the open air. Soren marks it without fanfare.',
      'Out and back. Soren notes it and looks for tomorrow\'s route.'
    ],
    altPersona: {
      personaName: 'Mira of the Long Threshold',
      gender: 'female',
      lore: 'Mira steps outside every day the way some people drink water — because without it, something essential goes wrong and she can feel exactly where. She discovered this the hard way during a long winter indoors. The threshold is what she crosses. Everything after it is better. She has not stopped testing this.',
      checkInFlavor: [
        'Mira crossed the threshold. Everything after it was better.',
        'Outside logged. Mira knows what skipping this costs.',
        'The Long Threshold, crossed again. Mira marks it.',
        'Out and moving. Mira has no other way to start a day right.',
        'Another session in the open. Mira needed this. Now she has it.'
      ]
    }
  },
  Monk: {
    icon: '🧘', name: 'The Monk', trait: 'Mindfulness & Mental Health',
    gender: 'male',
    desc: 'Mindfulness and mental habits — meditation, gratitude, therapy, breathing, focus.',
    hpRule: 'standard',
    habitExamples: 'Meditate / Practice gratitude / Therapy session / Breathwork / Digital detox',
    personaName: 'Auryn of the Breathless Peak',
    portrait: '☁️',
    lore: 'Auryn walked to the Breathless Peak once, at twenty-two, looking for an answer. He found silence instead. Turned out that was the answer. He has been practicing quiet ever since — not emptiness, but a particular kind of attentive stillness that most people mistake for calm.',
    checkInFlavor: [
      'Auryn sat still. That took more than it sounds.',
      'The mind was tended. Auryn logs it without ceremony.',
      'Presence logged. Auryn knows the practice is in showing up, not arriving.',
      'Another session. Auryn has stopped counting the benefits — they are simply there.',
      'Mindfulness marked. The road is quieter for it.'
    ],
    altPersona: {
      personaName: 'Sera of the Quiet Ledge',
      gender: 'female',
      lore: 'Sera found her ledge — a particular rocky outcrop, ten minutes from where she lives — and made a decision to return to it. Not for enlightenment. For maintenance. The world is loud; the ledge is not. She goes because the person who skips it is visibly worse. She has the data. She keeps the practice.',
      checkInFlavor: [
        'Sera found her quiet. Another day it was there when she went looking.',
        'The Quiet Ledge, visited again. Sera marks it.',
        'Mindfulness logged. Sera goes because skipping has a cost she can feel.',
        'Present and marked. Sera takes the stillness and uses it.',
        'Another session. Sera knows the math on this. It always adds up.'
      ]
    }
  },
  Alchemist: {
    icon: '🧪', name: 'The Alchemist', trait: 'Nutrition & Transformation',
    gender: 'male',
    desc: 'Nutrition habits — what you put in, treated as inputs to a formula. Eating clean, meal prep, cutting processed food, fasting, supplements.',
    hpRule: 'standard',
    habitExamples: 'Eat clean / Meal prep / Cut processed food / Fast / Take supplements',
    personaName: 'Draven Saltwick',
    portrait: '🧪',
    lore: "Draven doesn't think of food as comfort or pleasure — he thinks of it as inputs. Every ingredient is a variable. Every meal is an experiment. He has been running the same experiment for years with the same hypothesis: that what you put in determines what comes out. The results keep confirming it.",
    checkInFlavor: [
      'Draven logged the inputs. The formula holds.',
      'Another day of controlled variables. Draven marks it.',
      'What goes in matters. Saltwick has tested this extensively.',
      'The Alchemist tends the formula. No shortcuts, no substitutions.',
      "Inputs logged. Draven doesn't celebrate — he just checks the outcome."
    ],
    altPersona: {
      personaName: 'Nessa the Formwright',
      gender: 'female',
      lore: "Nessa approaches nutrition the way a craftsperson approaches a material — with patience, specificity, and deep respect for what happens when you get it right. She doesn't follow formulas; she builds them. Every adjustment she's ever made has been deliberate. Her body is a long-running project. She has no plans to stop refining it.",
      checkInFlavor: [
        'Nessa tended the formula. Another deliberate day.',
        'The Formwright refines. Nothing accidental in her kitchen.',
        'Inputs logged with intention. Nessa marks the craft.',
        'Another session of building something better. Nessa approves.',
        'Transformation is a long project. Nessa is not in a hurry.'
      ]
    }
  }
};

// Resolve the effective persona for a character (primary or alt)
function getPersona(char) {
  var def = CLASS_DEFS[char.class];
  if (!def) return {};
  if (char.useAlt && def.altPersona) {
    return Object.assign({}, def, def.altPersona);
  }
  return def;
}
var CLASS_KEYWORDS = {
  Warrior:   ['exercise','workout','work out','gym','run','running','steps','lift','lifting','yoga','swim','train','training','cardio','push','pull','squat','sport','weights','jog','fitnes','movement','active','strength','conditioning','crossfit','hiit','pilates','cycling class','spin','rowing','bootcamp'],
  Cleric:    ['sleep','water','drink','hydrat','medication','medicine','rest','recovery','skincare','nap','body','posture','stretch','self-care','skin routine','bedtime','wind down','morning routine'],
  Mage:      ['read','book','study','learn','language','course','skill','lesson','research','science','history','khan','duolingo','knowledge','chapter','library','educate','podcast','audiobook'],
  Rogue:     ['spend','budget','money','dollar','buy','purchase','saving','finance','expense','track spending','under $','cost','price','debt','frugal','allowance','avoid','limit','stop','quit','cut back','less','reduce','screen','social media','alcohol','sugar','caffeine','smoking','phone','no '],
  Scribe:    ['write','writing','journal','blog','project','build','creat','draw','paint','music','instrument','guitar','piano','practice','compose','sketch','poem','fiction','craft','code','program'],
  Ranger:    ['hike','bike','cycling','cycle','walk','outdoor','nature','trail','kayak','climb','paddle','row','trek','wander','outside','fresh air','steps outside'],
  Monk:      ['meditat','mindful','gratitude','focus','breathe','breathing','breathwork','therapy','calm','anxiet','stress','intention','awareness','reflect','digital detox','phone detox','presence','journaling','mental'],
  Alchemist: ['eat','meal','prep','cook','cooking','recipe','food','nutrition','macro','calori','fast','fasting','supplement','vitamin','probiotic','diet','vegan','protein','clean eating','grocery','intermittent','whole food','plant','nutrient']
};

// Suggest a class from habit description text
// Priority order matters when scores tie — listed first wins ties
var CLASS_PRIORITY = ['Warrior','Alchemist','Monk','Rogue','Mage','Scribe','Ranger','Cleric'];

// Direct key → class override for sentence expander habits
// Bypasses keyword scan so composed sentences can't mismatch
var HABIT_KEY_CLASS = {
  sleep:    'Cleric',
  eat:      'Alchemist',
  workout:  'Warrior',
  read:     'Mage',
  water:    'Cleric',
  meditate: 'Monk',
  journal:  'Scribe',
  sugar:    'Rogue',
  walk:     'Ranger',
  spend:    'Rogue'
};

function suggestClass(text) {
  var lower = text.toLowerCase();
  var scores = {};
  Object.keys(CLASS_KEYWORDS).forEach(function(cls) { scores[cls] = 0; });
  Object.keys(CLASS_KEYWORDS).forEach(function(cls) {
    CLASS_KEYWORDS[cls].forEach(function(kw) {
      if (lower.indexOf(kw) !== -1) scores[cls]++;
    });
  });
  var best = null, bestScore = 0;
  CLASS_PRIORITY.forEach(function(cls) {
    if (scores[cls] > bestScore) { bestScore = scores[cls]; best = cls; }
  });
  return best || 'Mage';
}

// Player rank titles — based on level, independent of any champion class
// Arc: solo wanderer → earns companions → leads → commands → becomes legend
var PLAYER_TITLES = [
  'Wanderer',         // 1
  'Traveler',         // 2
  'Traveler',         // 3
  'Pathfinder',       // 4
  'Pathfinder',       // 5
  'Road Veteran',     // 6
  'Road Veteran',     // 7
  'Party Leader',     // 8
  'Party Leader',     // 9
  'Commander',        // 10
  'Commander',        // 11
  'Warden',           // 12
  'Warden',           // 13
  'Lord of the Road', // 14
  'Lord of the Road', // 15
  'High Keeper',      // 16
  'High Keeper',      // 17
  'Archlord',         // 18
  'Archlord',         // 19
  'Legend of the Road' // 20
];

function getPlayerTitle(level) {
  var idx = Math.max(0, Math.min(level - 1, PLAYER_TITLES.length - 1));
  return PLAYER_TITLES[idx];
}

var CLASS_TITLES = {
  Warrior:   ['Novice Fighter','Sworn Blade','Iron Will','Battle-Hardened','Warlord'],
  Cleric:    ['Novice Mender','Wound Closer','Recovery Sage','Body Keeper','Grand Cleric'],
  Mage:      ['Novice Archivist','Apprentice Mage','Scroll Keeper','Lore Binder','Elder Mage'],
  Rogue:     ['Novice Shadow','Discipline Seeker','Edge Walker','Iron Mind','Master Rogue'],
  Scribe:    ['Novice Quill','Apprentice Scribe','Story Keeper','Ink Binder','Lore Master'],
  Ranger:    ['Trail Novice','Path Walker','Wilderness Scout','Road Veteran','Trailbreaker'],
  Monk:      ['Still Novice','Quiet Seeker','Breath Walker','Inner Sage','Tranquil Master'],
  Alchemist: ['Kitchen Novice','Prep Scholar','Formula Keeper','Nourish Sage','Grand Alchemist'],
};

var LEVEL_MSGS = [
  'Level two. Streak intact. The road is just getting started.',
  'Your habit is forming. That is harder than it sounds.',
  'Three levels in and you are still logging. Most people have quit by now.',
  'Merchants are starting to recognise someone who knows their numbers.',
  'Halfway there. Your Road Gold is watching.',
  'You\'re building something real here. Keep going.',
  'Clean logs, intact budget, growing streak. This is what mastery looks like.',
  'You have come further than most travellers ever get. That is not nothing.',
  'Top tier. Your ledger speaks for itself at this point.',
  'Maximum rank. The Iron Keep knows your name.',
];

var LOG_ICONS = ['💰','🛒','🍖','🧪','⚔️','📜','🐎','🏰','🔮','💎','🌿','🎒'];

// ─────────────────────────
//  MAP DATA
// ─────────────────────────
var MAP_WAYPOINTS = [
  // Zone 1 — The Hearthstone Road (levels 1-3)
  { id: 0,  icon: '🏘️', name: 'Hearthstone\nVillage',  zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve arrived at Hearthstone Village. First stop on a long road. Show up for your habit today — that\'s the whole game, and it starts here.' },
  { id: 1,  icon: '🌾', name: 'Harvest\nCrossing',      zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve reached Harvest Crossing. Three guilds are in a six-year dispute over a single oak tree. You check in with your habit and keep walking. Clarity is a competitive advantage.' },
  { id: 2,  icon: '🪨', name: 'Stonepath\nMill',        zone: 1, zoneName: 'The Hearthstone Road',
    arrival: 'You\'ve arrived at Stonepath Mill. The miller here keeps the tightest operation on the road — no shortcuts, no exceptions. You recognize the discipline. It looks a lot like yours.' },
  { id: 'z1', icon: '🛡️', name: 'Zone Badge',          zone: 'badge1', badge: 'zone1', zoneName: 'The Hearthstone Road',
    zoneComplete: 'Hearthstone Road: done. First zone cleared. The habit held. You move on.' },
  // Zone 2 — The Midlands (levels 4-6)
  { id: 3,  icon: '🏪', name: "Merchant's\nGate",       zone: 2, zoneName: "Merchant's Pass",
    arrival: 'You\'ve arrived at Merchant\'s Gate. Distractions in every direction. Your champion doesn\'t blink. The check-in is already done. On to the next.' },
  { id: 4,  icon: '🌉', name: 'Copperbridge',           zone: 2, zoneName: "Merchant's Pass",
    arrival: 'You\'ve arrived at Copperbridge. Travelers here always seem to be renegotiating something — plans, intentions, excuses. You\'ve already done yours for the day. That\'s what moves you forward.' },
  { id: 5,  icon: '⛺', name: "Trader's\nCamp",         zone: 2, zoneName: "Merchant's Pass",
    arrival: 'You\'ve arrived at Trader\'s Camp. Half the people here are heading into the Thornwood. Half just came out. The ones who made it through have a certain quiet look. You\'re starting to recognize it in yourself.' },
  { id: 'z2', icon: '🪙', name: 'Zone Badge',          zone: 'badge2', badge: 'zone2', zoneName: "Merchant's Pass",
    zoneComplete: "Merchant's Pass cleared. Distraction, detour, temptation — all passed. The road narrows now. Good." },
  // Zone 3 — The Thornwood (levels 7-9)
  { id: 6,  icon: '🌲', name: 'Thornwood\nEdge',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve entered the Thornwood. It\'s quiet here — the kind that asks something of you. You check in. That\'s the answer.' },
  { id: 7,  icon: '🌑', name: 'Darkhollow\nPath',       zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve reached Darkhollow Path. The road narrows. So does the question: are you still showing up? You are. That\'s enough.' },
  { id: 8,  icon: '🌸', name: 'Wayward\nShrine',        zone: 3, zoneName: 'The Thornwood',
    arrival: 'You\'ve found the Wayward Shrine. Travelers leave things here — tokens, intentions, days they\'re proud of. You add yours. The road feels lighter.' },
  { id: 'z3', icon: '🌿', name: 'Zone Badge',          zone: 'badge3', badge: 'zone3', zoneName: 'The Thornwood',
    zoneComplete: 'Thornwood cleared. Turns out it\'s just a forest if you keep showing up. You come out the other side.' },
  // Zone 4 — The Iron Keep (levels 10+)
  { id: 9,  icon: '🏰', name: 'Iron Keep\nGates',       zone: 4, zoneName: 'The Iron Keep Approach',
    arrival: 'The gate captain has seen ten thousand travelers. She reads yours in three seconds — habit clean, record intact, party still standing. She steps aside without a word. No fanfare. The gates were always going to open for someone like you.' },
  { id: 10, icon: '⚔️', name: 'The Iron\nKeep',         zone: 4, zoneName: 'The Iron Keep Approach',
    arrival: 'You\'ve arrived. The full road walked. The quartermaster stamps your record without asking to see it twice — he already knows what it says. When the new moon comes, the road resets. Your Road Gold carries forward. Your name stays in the Register. Your legend does too.' },
  { id: 'z4', icon: '🔒', name: 'Zone Badge',          zone: 'badge4', badge: 'zone4', zoneName: 'The Iron Keep Approach',
    zoneComplete: 'Iron Keep reached. Most people fold somewhere in the Thornwood. Your habit, your streak, your party. That\'s what got you here.' },
];

// ─────────────────────────
//  HOSTILE ENCOUNTERS
// ─────────────────────────
var HOSTILE_ENCOUNTERS = [
  {
    id: 'bandits',
    icon: '🗡️', title: 'Road Toll. Unofficial.',
    zone: 'Ambush',
    desc: 'Four figures step into the road with the practiced air of people who have redefined "asking" as a concept. They want something. The road behind you is looking very appealing right now.',
    choiceA: { label: '🛡️ Hold your ground', sub: 'Lose 1 HP — they back off, but it costs' },
    choiceB: { label: '💰 Pay them off', sub: 'Spend 20 Road Gold — move on intact' },
    choiceC: { label: '🔥 Your streak speaks for you', sub: 'Requires 7-day streak — they know a disciplined party when they see one', minStreak: 7 },
    goldCost: 20
  },
  {
    id: 'fog',
    icon: '☁️', title: 'The Fog of Habit',
    zone: 'Setback',
    desc: 'A strange heaviness settles over the road — the kind that shows up three weeks in, when the initial momentum has worn off and the habit isn\'t yet automatic. You know this feeling. You\'ve beaten it before.',
    choiceA: { label: '🛡️ Push through it', sub: 'Lose 1 HP — costs something, gains everything' },
    choiceB: { label: '💰 Hire a guide', sub: 'Spend 15 Road Gold — they carry you through the fog' },
    choiceC: { label: '🔥 You\'ve been here before', sub: 'Requires 14-day streak — muscle memory takes over', minStreak: 14 },
    goldCost: 15
  },
  {
    id: 'storm',
    icon: '⛈️', title: 'Everything at Once',
    zone: 'Bad Day',
    desc: 'Broken wheel. Wrong turn. Surprise rain. A genuinely difficult day with no clear cause or cure. The road doesn\'t adjust its schedule for hard days — it just keeps going.',
    choiceA: { label: '🛡️ Push through', sub: 'Lose 1 HP — arrive tired but still moving' },
    choiceB: { label: '💰 Rest and recover', sub: 'Spend 18 Road Gold — a warm inn, no regrets' },
    choiceC: { label: '🔥 Hard days don\'t move you', sub: 'Requires 21-day streak — the party has seen worse', minStreak: 21 },
    goldCost: 18
  },
  {
    id: 'temptation',
    icon: '🎲', title: 'The Easy Way Out',
    zone: 'Temptation',
    desc: 'There is a shortcut. It looks fine. It\'s probably fine. The locals have a saying about this particular shortcut, but they say it quietly and won\'t quite meet your eyes.',
    choiceA: { label: '🛡️ Take the long road', sub: 'Lose 1 HP — the right choice always costs something' },
    choiceB: { label: '💰 Pay for safe passage', sub: 'Spend 12 Road Gold — not worth finding out' },
    choiceC: { label: '🔥 You don\'t take shortcuts', sub: 'Requires 5-day streak — the habit proves it', minStreak: 5 },
    goldCost: 12
  },
  {
    id: 'snare',
    icon: '🕸️', title: 'The Interruption',
    zone: 'Disruption',
    desc: 'Something pulled you off track today — an obligation, an emergency, the inescapable demands of being a person who exists. The habit window is closing. There\'s still a chance to make it.',
    choiceA: { label: '🛡️ Find a way', sub: 'Lose 1 HP — harder to check in, but you do it' },
    choiceB: { label: '💰 Buy back your time', sub: 'Spend 16 Road Gold — clear the day, check in properly' },
    choiceC: { label: '🔥 The habit is non-negotiable', sub: 'Requires 10-day streak — the party reroutes without losing a step', minStreak: 10 },
    goldCost: 16
  },
  {
    id: 'the_doubter',
    icon: '🗣️', title: 'The Voice of Reason',
    zone: 'Doubt',
    desc: 'A well-meaning traveler pulls you aside. "Is this really worth it?" she asks. "Every day? You\'re allowed to take a break." She means well. The road does not care what she means.',
    choiceA: { label: '🛡️ Explain it to her', sub: 'Lose 1 HP — takes more out of you than it should' },
    choiceB: { label: '💰 Buy her a drink and leave', sub: 'Spend 10 Road Gold — polite, efficient, done' },
    choiceC: { label: '🔥 Show her the log', sub: 'Requires 7-day streak — the record answers better than words', minStreak: 7 },
    goldCost: 10
  },
];

// ─────────────────────────
//  FRIENDLY ENCOUNTERS
// ─────────────────────────
var FRIENDLY_ENCOUNTERS = [
  {
    id: 'shrine',
    icon: '🌸',
    title: 'Roadside Shrine',
    zone: 'Lucky Find',
    desc: 'There\'s a small shrine just off the path. You stop. Thirty seconds of stillness. Whatever was pressing on you before you sat down is somehow smaller when you stand back up. One of your champions recovers a point of HP.',
    reward: { type: 'hp', amount: 1 },
    rewardDesc: '❤️ HP restored to your weakest champion'
  },
  {
    id: 'journal',
    icon: '📖',
    title: 'A Veteran\'s Notes',
    zone: 'Lucky Find',
    desc: 'A battered notebook tucked under a milestone. Someone walked this road before you and wrote down what they learned. No name — just: \'Keep going. It compounds.\' You read the whole thing. Your party earns XP from someone else\'s persistence.',
    reward: { type: 'xp', amount: 55 },
    rewardDesc: '+55 bonus XP'
  },
  {
    id: 'camp',
    icon: '🏕️',
    title: 'Abandoned Camp',
    zone: 'Lucky Find',
    desc: 'An abandoned camp, left in perfect order — fire still warm, everything stowed with care. Under a flat stone: a coin pouch and a note: \'For the next one.\' Your party is the next one.',
    reward: { type: 'gold', amount: 25 },
    rewardDesc: '+25 Road Gold'
  },
  {
    id: 'elder',
    icon: '🧙',
    title: 'The Road Veteran',
    zone: 'Friendly Encounter',
    desc: 'An older traveler watches the road from a stump. Most passers-by get a glance. You get a slow, deliberate nod — the kind that means something. They press a coin into your hand. \'Don\'t skip days.\' That\'s all. It\'s enough.',
    reward: { type: 'gold', amount: 15 },
    rewardDesc: '+15 Road Gold'
  },
  {
    id: 'clear_road',
    icon: '🦅',
    title: 'Clear Road Ahead',
    zone: 'Good News',
    desc: 'Guild cloth tied to a high branch — the all-clear marker. Someone came through before you and left it. Fastest route, no hazards, good conditions. Your party makes strong time. The XP reflects it.',
    reward: { type: 'xp', amount: 35 },
    rewardDesc: '+35 bonus XP'
  },
  {
    id: 'windfall',
    icon: '🤝',
    title: 'Road Windfall',
    zone: 'Friendly Encounter',
    desc: 'A traveling merchant — one of the honest ones — waves you down. She\'s ahead of schedule and has coin to spare. Says it\'s good luck to share it with disciplined travelers. Apparently you qualify.',
    reward: { type: 'gold', amount: 20 },
    rewardDesc: '+20 Road Gold'
  }
];

// ── STORY ENCOUNTERS (NPC flavor — no continuity required) ──
var STORY_ENCOUNTERS = {
  z1: [
    {
      id: 'veteran_habit',
      icon: '🍺', title: 'The Sellsword\'s Regret',
      zone: 'Hearthstone Village', minPos: 0,
      desc: 'A retired sellsword is sitting at the inn with the expression of someone cataloguing their own poor decisions. "Thirty years of telling myself I\'d start tomorrow," he says. "Tomorrow has a lot to answer for." You check in with your habit that night before you sleep.'
    },
    {
      id: 'posting_board',
      icon: '📜', title: 'The Notice Board',
      zone: 'Hearthstone Village', minPos: 0,
      desc: 'The guild notice board is covered in intentions — habits people announced and then vanished from. Witness to a thousand Day Ones. You walk past it. Yours isn\'t an announcement. It\'s a quiet, daily fact.'
    },
    {
      id: 'the_early_riser',
      icon: '🌄', title: 'The Baker\'s Hours',
      zone: 'Hearthstone Village', minPos: 0,
      desc: 'The baker at the end of the lane has been up since before dawn every day for thirty-one years. You ask her how. "I stopped deciding," she says. "It\'s just what happens next." That\'s what you\'re building.'
    },
    {
      id: 'cartographer',
      icon: '🗺️', title: 'The Cartographer\'s Map',
      zone: 'Harvest Crossing', minPos: 1,
      desc: 'A gnome cartographer has set up her cart at the crossroads. She shows you the road ahead: long, consistent, no shortcuts worth taking. "The ones who arrive," she says, "are boring travelers. They just keep going." She stamps your map.'
    },
    {
      id: 'miller_lesson',
      icon: '⚖️', title: 'The Miller\'s Standard',
      zone: 'Stonepath Mill', minPos: 2,
      desc: 'The miller at Stonepath runs the tightest operation on the road — no exceptions, no close enough. Six travelers ahead of you got turned back for incomplete work. You had done yours. You\'re through in seconds. Excellence is mostly just showing up correctly.'
    },
    {
      id: 'the_dropout',
      icon: '🚶', title: 'Heading Back',
      zone: 'Harvest Crossing', minPos: 1,
      desc: 'A traveler passes you going the other direction. Gear still clean, boots barely worn. "Decided it\'s not for me," he says, unprompted, the way people do when they need the excuse to land somewhere. You nod and keep going. The road only moves one direction.'
    },
  ],
  z2: [
    {
      id: 'distraction',
      icon: '🏛️', title: 'The Guild of Excellent Intentions',
      zone: "Merchant's Gate", minPos: 3,
      desc: 'A guild is recruiting travelers to join their cause — the pamphlet is very good and the speaker is genuinely passionate. You have a habit to maintain. You wish them well and keep walking. Enthusiasm is not the same thing as doing.'
    },
    {
      id: 'bridge_story',
      icon: '👻', title: 'The Tale of the Bridge',
      zone: 'Copperbridge', minPos: 4,
      desc: 'Locals say the old bridge is haunted by a traveler who stopped halfway and never decided whether to go back or forward. You cross at a steady pace without slowing. Some decisions only become hard if you let them.'
    },
    {
      id: 'campfire',
      icon: '🔥', title: 'Around the Fire',
      zone: "Trader's Camp", minPos: 5,
      desc: 'Traders swapping road stories by firelight. A dwarf claims he met someone who made it to the Iron Keep without missing a single day. Nobody believes him. "Doesn\'t matter if you believe it," he says. "The road is the same either way."'
    },
    {
      id: 'the_merchant_math',
      icon: '🪙', title: 'The Merchant\'s Ledger',
      zone: "Merchant's Gate", minPos: 3,
      desc: 'A merchant shows you her ledger unprompted — forty years of small daily actions, compounded. "People see the outcome and think it\'s talent," she says. "It\'s arithmetic." She closes the book and goes back to work.'
    },
    {
      id: 'abandoned_camp',
      icon: '⛺', title: 'Cleared Out',
      zone: "Trader's Camp", minPos: 5,
      desc: 'An empty camp just off the road — gear gone, fire cold, the organized kind of abandoned. Someone started this journey and chose not to finish it. No judgment. It just makes you more certain about your own direction.'
    },
    {
      id: 'the_rival',
      icon: '🏃', title: 'Someone Running',
      zone: 'Copperbridge', minPos: 4,
      desc: 'A traveler overtakes you at a run, clearly trying to make up lost ground in a hurry. You\'ve seen this pattern. Three days of intensity after a week of nothing. They\'ll be resting again by sundown. Slow is fast on a long road.'
    },
  ],
  z3: [
    {
      id: 'sentinel',
      icon: '🏹', title: 'The Sentinel\'s Word',
      zone: 'Thornwood Edge', minPos: 6,
      desc: 'A Thornwood sentinel drops from a branch and lands without a sound. "Keep moving. The forest tests the ones who hesitate." She\'s back in the canopy before you can ask what that means. You keep moving. That seems like the answer.'
    },
    {
      id: 'silence',
      icon: '🌲', title: 'The Quiet Miles',
      zone: 'Darkhollow Path', minPos: 7,
      desc: 'There\'s a stretch of Darkhollow Path where the sound drops away — old druid work, they say, to give travelers space to think straight. You walk it in silence. Your habit feels obvious here. Why it was ever hard to start is less clear.'
    },
    {
      id: 'shrine_offering',
      icon: '🌸', title: 'The Road Offering',
      zone: 'Wayward Shrine', minPos: 8,
      desc: 'The Wayward Shrine is covered in tokens left by travelers: small objects, folded notes, marks scratched into stone. Someone left a check-in log beside the road marker. 847 days, no gaps. You add your own mark.'
    },
    {
      id: 'thornwood_elder',
      icon: '🧝', title: 'The Thornwood Elder',
      zone: 'Thornwood Edge', minPos: 6,
      desc: 'An elven elder is sitting in the roots of a very large tree doing nothing visibly useful. "The ones who rush through here regret it," she says. "The ones who check in every day don\'t." She closes her eyes again. You take the advice at face value.'
    },
    {
      id: 'the_long_dark',
      icon: '🌑', title: 'The Hard Week',
      zone: 'Darkhollow Path', minPos: 7,
      desc: 'Someone has carved a single word into a Darkhollow milestone: ANYWAY. No signature, no explanation. You know exactly what it means. You\'ve had those days. You came through them. You\'re still on the road.'
    },
    {
      id: 'trail_marker',
      icon: '🪶', title: 'The Ranger\'s Message',
      zone: 'Wayward Shrine', minPos: 8,
      desc: 'A ranger\'s trail marker: three notches, worn smooth. Means the path has been walked this way for a very long time. Some travelers made it. Some didn\'t. The marker doesn\'t specify which ones. Neither does the road. Only you get to decide.'
    },
  ],
  z4: [
    {
      id: 'gate_check',
      icon: '🛡️', title: 'The Iron Gate',
      zone: 'Iron Keep Gates', minPos: 9,
      desc: 'The gate captain has seen ten thousand travelers. She reads yours in seconds — party intact, habit consistent, streak unbroken. She stamps your writ and steps aside without comment. Here, that\'s as warm as welcomes get.'
    },
    {
      id: 'the_keep',
      icon: '⚔️', title: 'The Keep Quartermaster',
      zone: 'The Iron Keep', minPos: 10,
      desc: 'The Iron Keep quartermaster is infamous for turning away travelers with broken records. He holds out his hand. You hand over your log without hesitation. He reads it, raises an eyebrow. "First one today who didn\'t flinch." The gate opens.'
    },
    {
      id: 'keep_archive',
      icon: '📚', title: 'The Record Room',
      zone: 'The Iron Keep', minPos: 10,
      desc: 'The Keep\'s record room holds the logs of every traveler who\'s made it here. Thousands of them. All different habits, different party sizes, different roads taken. One thing in common: they showed up. Every day. Until they were here.'
    },
    {
      id: 'keep_wall',
      icon: '🏰', title: 'View from the Wall',
      zone: 'Iron Keep Gates', minPos: 9,
      desc: 'From the Keep\'s outer wall you can see the full road back — Thornwood, Merchant\'s Pass, Hearthstone Road. All of it. You walked that. Every step, every check-in, every day you didn\'t feel like it. It looks different from up here.'
    },
    {
      id: 'the_resident',
      icon: '🧔', title: 'The Long Resident',
      zone: 'The Iron Keep', minPos: 10,
      desc: 'A traveler who arrived years ago and never left. "Why go back?" he says. "The road is the road. The habit is the habit. The Keep is just what happens when you don\'t stop." He offers you a seat. You take it. You\'ve earned it.'
    },
    {
      id: 'next_road',
      icon: '🌅', title: 'The Road Continues',
      zone: 'Iron Keep Gates', minPos: 9,
      desc: 'There\'s a gate on the far side of the Keep facing a road you haven\'t seen yet. The map just calls it "beyond." The gate captain sees you looking. "Most people who get here ask about that road," she says. "None of them are surprised to find it." Neither are you.'
    },
  ]
};
// ─────────────────────────
//  STATE
// ─────────────────────────
var state = {
  // Traveler (the player's journey leader)
  name: '',
  avatar: '',
  xp: 0,
  mapPosition: 0,
  badges: [],
  weekLogDays: [],
  weekStart: '',
  roadBonusesThisMonth: 0,
  lastEncounterLog: '',
  bestStreak: 0,
  pendingEncounter: null,
  seenStoryEncounters: [],
  seenArrivals: [],
  lastMapPosition: -1,
  encounterLogCount: 0,
  lastEncounterAtLog: 0,
  ironVault: 0,        // Road Gold
  firstRun: false,     // welcome encounter flag
  // Party — array of character objects
  // Each: { id, name, class, habit, cadence, cadenceTarget, hp, streak,
  //         lastCheckIn, checkInsThisWeek, weekStart, log, seenArrivals }
  party: [],
  // Onboarding tracks party slot being created
  activeSlots: 0,
};


// ─────────────────────────
//  SUPABASE
// ─────────────────────────
var SUPABASE_URL = 'https://czolsfnkwqtnkziakclg.supabase.co';
var SUPABASE_KEY = 'sb_publishable_zcYS8yzbinVjqmY1P_RM4w_BjOEExwq';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var currentUserId = null;
var isSigningOut = false;

// ─────────────────────────
//  SAVE / LOAD
// ─────────────────────────
function save() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  if (currentUserId) {
    sb.from('profiles')
      .upsert({
        user_id: currentUserId,
        save_data: state,
        updated_at: new Date().toISOString(),
        map_position: state.mapPosition || 0,
        traveler_name: state.name || 'Traveler',
        traveler_avatar: state.avatar || '🧔',
        cohort_id: getCurrentCohortId()
      }, { onConflict: 'user_id' })
      .then(function(res) {
        if (res.error) console.warn('Supabase save error:', res.error.message);
      });
  }
}

function load() {
  var raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  try {
    var parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || !parsed) return;
    if (!Array.isArray(parsed.log)) parsed.log = [];
    ['name','avatar','xp','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition','encounterLogCount','lastEncounterAtLog','bestStreak','ironVault','firstRun','party','activeSlots','cohortId'].forEach(function(k) {
      if (parsed[k] !== undefined) state[k] = parsed[k];
    });
  } catch(e) { console.warn('Load failed:', e); }
}

async function loadFromSupabase() {
  if (!currentUserId) return;
  try {
    var res = await sb.from('profiles').select('save_data').eq('user_id', currentUserId).single();
    if (res.error || !res.data || !res.data.save_data) return;
    var remote = res.data.save_data;
    if (typeof remote !== 'object') return;
    if (!Array.isArray(remote.log)) remote.log = [];
    ['name','avatar','xp','mapPosition','badges','weekLogDays','weekStart','roadBonusesThisMonth','lastEncounterLog','pendingEncounter','seenStoryEncounters','seenArrivals','lastMapPosition','encounterLogCount','lastEncounterAtLog','bestStreak','ironVault','firstRun','party','activeSlots','cohortId'].forEach(function(k) {
      if (remote[k] !== undefined) state[k] = remote[k];
    });
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  } catch(e) { console.warn('Supabase load error:', e); }
}

// ─────────────────────────
//  AUTH FUNCTIONS
// ─────────────────────────


async function signInWithPassword() {
  var email    = document.getElementById('login-email-pw').value.trim();
  var password = document.getElementById('login-password').value;
  var errEl    = document.getElementById('login-error-pw');
  errEl.style.display = 'none';

  if (!email || !password) {
    errEl.textContent = 'Enter your email and password.';
    errEl.style.display = 'block';
    return;
  }
  var btn = document.querySelector('#login-form-password .btn-primary');
  btn.textContent = 'Entering…';
  btn.disabled = true;

  var res = await sb.auth.signInWithPassword({ email: email, password: password });
  if (res.error) {
    errEl.textContent = res.error.message === 'Invalid login credentials'
      ? 'Wrong email or password. Try again.'
      : res.error.message;
    errEl.style.display = 'block';
    btn.textContent = 'Enter the Realm ⚔';
    btn.disabled = false;
  }
}



function showLoginError(msg) {
  var el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = 'block';
}



async function signOut() {
  isSigningOut = true;
  _appInitDone = false;
  currentUserId = null;
  localStorage.removeItem(SAVE_KEY);
  // Reset state immediately — don't await SDK which may be lock-blocked
  state.name = ''; state.avatar = ''; state.xp = 0;
  state.mapPosition = 0; state.badges = []; state.weekLogDays = [];
  state.weekStart = ''; state.roadBonusesThisMonth = 0;
  state.lastEncounterLog = ''; state.pendingEncounter = null;
  state.seenStoryEncounters = []; state.seenArrivals = []; state.lastMapPosition = -1;
  state.encounterLogCount = 0; state.lastEncounterAtLog = 0;
  state.bestStreak = 0; state.ironVault = 0; state.party = []; state.activeSlots = 0;
  cohortTravelers = [];
  // Show login immediately
  document.getElementById('header-auth').style.display = 'none';
  document.getElementById('main').style.display = 'none';
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('login-screen').style.display = 'block';
  isSigningOut = false;
  // Fire-and-forget — don't block UI on this
  try { sb.auth.signOut(); } catch(e) { console.warn('Sign out error:', e); }
}

// ─────────────────────────
//  SHARED ROAD — COHORT TRAVELERS
// ─────────────────────────

// In-memory store of other travelers in the same cohort
// Shape: [{ traveler_name, map_position, last_active, user_id }]
var cohortTravelers = [];

// Always compute the current cohort window dynamically so all active users
// land in the same bucket regardless of when they originally signed up.
function getCurrentCohortId() {
  var now = new Date();
  var startOfYear = new Date(now.getFullYear(), 0, 1);
  var weekNum = Math.ceil(((now - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
  var cohortPeriod = Math.floor(weekNum / 2);
  return now.getFullYear() + '-C' + String(cohortPeriod).padStart(2, '0');
}

async function loadCohortTravelers() {
  if (!currentUserId) {
    console.log('[SharedRoad] skipped — no userId');
    return;
  }
  try {
    var cohortId = getCurrentCohortId();
    var cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - 14);

    console.log('[SharedRoad] querying cohort', cohortId);

    // Use direct REST fetch to avoid Supabase SDK auth lock contention
    var cutoffStr = cutoff.toISOString();
    var url = SUPABASE_URL + '/rest/v1/profiles' +
      '?select=user_id,traveler_name,traveler_avatar,map_position,updated_at' +
      '&cohort_id=eq.' + encodeURIComponent(cohortId) +
      '&user_id=neq.' + encodeURIComponent(currentUserId) +
      '&updated_at=gte.' + encodeURIComponent(cutoffStr) +
      '&order=map_position.asc&limit=20';

    var res = await fetch(url, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json'
      }
    });

    if (!res.ok) {
      console.warn('[SharedRoad] fetch error:', res.status, await res.text());
      cohortTravelers = [];
      return;
    }

    var data = await res.json();
    console.log('[SharedRoad] found', data.length, 'travelers:', data);
    cohortTravelers = data;
    renderMap();
  } catch(e) {
    cohortTravelers = [];
    console.warn('[SharedRoad] loadCohortTravelers failed:', e);
  }
}

// ─────────────────────────
//  INIT
// ─────────────────────────
var _appInitDone = false; // guard: only run full init once per page load

async function initApp() {
  sb.auth.onAuthStateChange(async function(event, session) {
    if (isSigningOut) return;
    if (session && session.user) {
      currentUserId = session.user.id;
      document.getElementById('header-email').textContent = session.user.email;
      document.getElementById('header-auth').style.display = 'flex';
      document.getElementById('login-screen').style.display = 'none';

      // Only run the full load sequence once per page load.
      // onAuthStateChange can fire multiple times (INITIAL_SESSION, SIGNED_IN, TOKEN_REFRESHED)
      // Re-running load() each time would reset state mid-session.
      if (_appInitDone) return;
      _appInitDone = true;

      // Load localStorage FIRST — instant, always available
      load();

      // Then overlay Supabase on top — authoritative remote save
      await loadFromSupabase();

      // Defensive defaults for any missing fields
      if (!state.badges)                           state.badges = [];
      if (!state.weekLogDays)                      state.weekLogDays = [];
      if (state.roadBonusesThisMonth === undefined) state.roadBonusesThisMonth = 0;
      if (!state.lastEncounterLog)                 state.lastEncounterLog = '';
      if (!state.seenStoryEncounters)              state.seenStoryEncounters = [];
      if (!state.seenArrivals)                     state.seenArrivals = [];
      if (state.lastMapPosition === undefined)     state.lastMapPosition = -1;
      if (state.bestStreak === undefined)          state.bestStreak = 0;
      if (state.ironVault === undefined)           state.ironVault = 0;
      if (!state.party)                            state.party = [];
      if (state.activeSlots === undefined)         state.activeSlots = 0;

      // Check for missed check-ins on open (HP decay)
      checkMissedCheckIns();
      checkStreak();

      if (state.avatar && state.name && state.party && state.party.length > 0) {
        document.getElementById('onboarding').style.display = 'none';
        document.getElementById('main').style.display = 'block';
        render();
        // Load cohort travelers after render — non-blocking, re-renders map when done
        loadCohortTravelers();
      } else {
        document.getElementById('onboarding').style.display = 'block';
        document.getElementById('main').style.display = 'none';
      }
    } else {
      currentUserId = null;
      cohortTravelers = [];
      document.getElementById('header-auth').style.display = 'none';
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('main').style.display = 'none';
      document.getElementById('onboarding').style.display = 'none';
    }
  });
}

initApp();

// ─────────────────────────
//  STREAK / DATE HELPERS
// ─────────────────────────
function getToday() { return new Date().toDateString(); }
function getYesterday() {
  var d = new Date(); d.setDate(d.getDate() - 1); return d.toDateString();
}




// ─────────────────────────
//  WOUNDED MODE
// ─────────────────────────





// ─────────────────────────
//  ONBOARDING STATE
// ─────────────────────────
var obAvatar     = '🧔';  // Human pre-selected
var obPartySize  = 3;          // how many companions they're setting up

// Sync party size visual on load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.party-size-opt').forEach(function(o) {
    o.classList.toggle('selected', parseInt(o.dataset.size) === obPartySize);
  });
});
var obCompanionIdx = 0;        // which companion we're currently setting up (0-based)
var obCompanions = [];         // array of {habit, class, cadence, weekTarget}
var obCurrentHabit   = '';
var obCurrentClass   = '';
var obCurrentUseAlt  = false;
var obCurrentCadence = 'daily';
var obCurrentWeekTarget = 3;
var obSuggest    = '';

// goStep now accepts string IDs for named steps
function goStep(n) {
  document.querySelectorAll('.ob-step').forEach(function(el) {
    if (el.style.display !== 'none') el.classList.remove('active');
  });
  var stepId;
  if (typeof n === 'string') {
    stepId = 'step-' + n;
  } else {
    stepId = 'step-' + n;
  }
  var target = document.getElementById(stepId);
  if (target) { target.style.display = ''; target.classList.add('active'); }

  // Progress bar — 4 meaningful stages: identity (0→20%), party (→40%), habits (→75%), begin (→100%)
  var pctMap = { '0': 5, '2': 30, 'habit': 55, 'cadence': 62, 'class': 70, 'laws': 85, 'begin': 95 };
  // '1-race' is now hidden/merged — map it to 0 for compat
  var dotKey = typeof n === 'number' ? String(n) : n;
  if (dotKey === '1-race') dotKey = '0';
  var pct = pctMap[dotKey] !== undefined ? pctMap[dotKey] : 50;
  var fill = document.getElementById('ob-progress-fill');
  if (fill) fill.style.width = pct + '%';

  // Step-specific setup
  if (stepId === 'step-2') {
    document.querySelectorAll('.party-size-opt').forEach(function(o) {
      o.classList.toggle('selected', parseInt(o.dataset.size) === obPartySize);
    });
  }
  if (stepId === 'step-habit') updateCompanionHabitStep();
  if (stepId === 'step-class') setupSuggestedClass();
  if (stepId === 'step-begin') buildBeginPartySummary();
}

function onNameInput() {
  var val = document.getElementById('hero-name-input').value.trim();
  var btn = document.getElementById('name-next-btn');
  if (btn) btn.disabled = val.length < 1;
}

function selectAvatar(el) {
  document.querySelectorAll('.avatar-opt').forEach(function(o) { o.classList.remove('selected'); });
  el.classList.add('selected');
  obAvatar = el.dataset.avatar;
}

function selectPartySize(el, size) {
  document.querySelectorAll('.party-size-opt').forEach(function(o) { o.classList.remove('selected'); });
  el.classList.add('selected');
  obPartySize = size;
}

function startCompanionSetup() {
  obCompanions = [];
  obCompanionIdx = 0;
  obCurrentHabit = '';
  obCurrentClass = '';
  obCurrentUseAlt = false;
  obCurrentWeekTarget = 3;
  _currentSuggestionKey = '';
  var inp = document.getElementById('habit-input');
  if (inp) inp.value = '';
  var p1 = document.getElementById('habit-phase-1');
  var p2 = document.getElementById('habit-phase-2');
  if (p1) p1.style.display = 'block';
  if (p2) p2.style.display = 'none';
  var btn = document.getElementById('habit-next-btn');
  if (btn) btn.disabled = true;
  goStep('habit');
}

function updateCompanionHabitStep() {
  var idx = obCompanionIdx;
  var ordinals = ['First','Second','Third'];
  var ord = ordinals[idx] || ('Champion ' + (idx+1));
  document.getElementById('companion-setup-title').textContent = ord + ' Champion\'s Quest';
  var icons = ['⚔️','🔮','🗡️'];
  document.getElementById('companion-setup-icon').textContent = icons[idx] || '⚔️';

  // Progress pips
  var prog = document.getElementById('companion-progress');
  prog.innerHTML = '';
  for (var i = 0; i < obPartySize; i++) {
    var pip = document.createElement('div');
    pip.className = 'companion-pip' + (i < idx ? ' done' : i === idx ? ' current' : '');
    prog.appendChild(pip);
  }

  // Restore habit if already set for this companion
  var inp = document.getElementById('habit-input');
  if (inp) {
    var existing = obCompanions[idx] ? obCompanions[idx].habit : '';
    inp.value = existing || '';
    obCurrentHabit = existing || '';
    var btn = document.getElementById('habit-next-btn');
    if (btn) btn.disabled = !obCurrentHabit || obCurrentHabit.length < 3;
  }

  // Always start in phase 1 (suggestion list + free input)
  var p1 = document.getElementById('habit-phase-1');
  var p2 = document.getElementById('habit-phase-2');
  if (p1) p1.style.display = 'block';
  if (p2) p2.style.display = 'none';
  _currentSuggestionKey = '';

  // Reset cadence inline
  var cad = document.getElementById('habit-cadence-inline');
  if (cad) cad.style.display = obCurrentHabit && obCurrentHabit.length >= 3 ? 'block' : 'none';
  selectCadenceInline(obCurrentCadence || 'daily');
}

function habitBack() {
  if (obCompanionIdx === 0) {
    goStep(2); // back to party size
  } else {
    obCompanionIdx--;
    goStep('habit');
  }
}

function onHabitInput() {
  var val = document.getElementById('habit-input').value.trim();
  obCurrentHabit = val;
  var btn = document.getElementById('habit-next-btn');
  if (btn) btn.disabled = val.length < 3;
  if (val.length >= 3) showHabitCadenceInline();
}

// ─────────────────────────
//  HABIT SENTENCE EXPANDER
// ─────────────────────────
// Tailored templates per suggestion key
var HABIT_TEMPLATES = {
  sleep:   { before: 'I want to sleep',        blank: '8',    after: 'hours per night',          chips: ['6','7','8','9'],                                           orLabel: 'or type your own duration above' },
  eat:     { before: 'I want to eat',          blank: '',     after: 'every day',                 chips: ['clean','no junk food','home-cooked meals','mostly plants'], orLabel: 'or pick your own item above' },
  workout: { before: 'I want to work out for', blank: '30',   after: 'minutes per session',       chips: ['20','30','45','60'],                                       orLabel: 'or type your own duration above' },
  read:    { before: 'I want to read',         blank: '20',   after: 'pages per day',             chips: ['10','20','30 min','1 chapter'],                            orLabel: 'or type your own amount above' },
  water:   { before: 'I want to drink',        blank: '64',   after: 'oz of water per day',       chips: ['48','64','80','100'],                                      orLabel: 'or type your own amount above' },
  meditate:{ before: 'I want to meditate for', blank: '10',   after: 'minutes each day',          chips: ['5','10','15','20'],                                        orLabel: 'or type your own duration above' },
  journal: { before: 'I want to journal for',  blank: '10',   after: 'minutes every day',         chips: ['5','10','1 page','open-ended'],                            orLabel: 'or type your own duration above' },
  sugar:   { before: 'I want to cut',          blank: '',     after: 'from my diet',              chips: ['added sugar','desserts','soda','processed food'],          orLabel: 'or pick your own item above' },
  walk:    { before: 'I want to walk',         blank: '8,000', after: 'steps per day',            chips: ['5,000','8,000','10,000','30 min outside'],                 orLabel: 'or type your own amount above' },
  spend:   { before: 'I want to spend under',  blank: '$50',  after: 'per day',                   chips: ['$20','$30','$50','$100'],                                  orLabel: 'or type your own amount above' },
  _generic:{ before: 'I want to commit to',    blank: '',     after: 'consistently',              chips: [],                                                         orLabel: 'or describe your own goal above' }
};

var _currentSuggestionKey = '';

function selectHabitSuggestion(key) {
  var tpl = HABIT_TEMPLATES[key] || HABIT_TEMPLATES['_generic'];
  _currentSuggestionKey = key;

  // Populate sentence parts
  document.getElementById('hs-before').textContent = tpl.before;
  document.getElementById('hs-after').textContent  = tpl.after;
  var hsInput = document.getElementById('hs-input');
  hsInput.value       = '';
  hsInput.placeholder = tpl.blank;

  // Build chips
  var chipsEl = document.getElementById('hs-chips');
  chipsEl.innerHTML = '';
  tpl.chips.forEach(function(chip) {
    var btn = document.createElement('button');
    btn.className = 'hs-chip';
    btn.textContent = chip;
    btn.type = 'button';
    btn.onclick = function() {
      // Deactivate others, activate this
      chipsEl.querySelectorAll('.hs-chip').forEach(function(c) { c.classList.remove('active'); });
      btn.classList.add('active');
      hsInput.value = chip;
      _buildFinalHabit();
    };
    chipsEl.appendChild(btn);
  });

  // Set the "or …" label
  var orEl = document.getElementById('hs-or-label');
  if (orEl) orEl.textContent = tpl.orLabel || 'or type your own above';
  document.getElementById('habit-phase-1').style.display = 'none';
  var p2 = document.getElementById('habit-phase-2');
  p2.style.display = 'block';

  // Pre-select first chip if it exists
  if (tpl.chips.length) {
    var firstChip = chipsEl.querySelector('.hs-chip');
    firstChip.classList.add('active');
    hsInput.value = tpl.chips[0];
    _buildFinalHabit();
  }

  setTimeout(function() { hsInput.focus(); }, 50);
}

function onSentenceInput() {
  // Deactivate chips if user typed manually
  var chipsEl = document.getElementById('hs-chips');
  chipsEl.querySelectorAll('.hs-chip').forEach(function(c) { c.classList.remove('active'); });
  _buildFinalHabit();
}

function _buildFinalHabit() {
  var tpl    = HABIT_TEMPLATES[_currentSuggestionKey] || HABIT_TEMPLATES['_generic'];
  var detail = (document.getElementById('hs-input').value || '').trim();
  var combined;
  if (detail) {
    combined = tpl.before + ' ' + detail + ' ' + tpl.after;
    // Clean up double spaces
    combined = combined.replace(/\s+/g,' ').trim();
  } else {
    // Use just the base phrase if no detail yet
    combined = (tpl.before + ' ' + tpl.after).replace(/\s+/g,' ').trim();
  }
  // Mirror into the hidden habit-input so existing logic works
  var hiddenInp = document.getElementById('habit-input');
  if (hiddenInp) hiddenInp.value = combined;
  obCurrentHabit = combined;
  var nxt = document.getElementById('habit-next-btn');
  if (nxt) nxt.disabled = combined.length < 5;
  if (combined.length >= 5) showHabitCadenceInline();
}

function backToHabitPhase1() {
  document.getElementById('habit-phase-2').style.display = 'none';
  document.getElementById('habit-phase-1').style.display = 'block';
  _currentSuggestionKey = '';
  var hiddenInp = document.getElementById('habit-input');
  if (hiddenInp) hiddenInp.value = '';
  obCurrentHabit = '';
  obCurrentCadence = 'daily';
  obCurrentWeekTarget = 3;
  // Hide cadence and reset it to daily
  var cad = document.getElementById('habit-cadence-inline');
  if (cad) cad.style.display = 'none';
  selectCadenceInline('daily');
  var nxt = document.getElementById('habit-next-btn');
  if (nxt) nxt.disabled = true;
}

// These are kept for compatibility but do nothing new
function triggerHabitClarify() {}
function confirmHabitClarify() {}
function dismissHabitClarify() {}

function fillHabitFromExample(el) {
  var inp = document.getElementById('habit-input');
  if (inp) {
    inp.value = el.textContent;
    obCurrentHabit = el.textContent;
    inp.focus();
    inp.setSelectionRange(inp.value.length, inp.value.length);
  }
  var btn = document.getElementById('habit-next-btn');
  if (btn) btn.disabled = false;
}

function setHabitExample(el) {
  var inp = document.getElementById('habit-input');
  if (inp) { inp.value = el.textContent; obCurrentHabit = el.textContent; }
  var btn = document.getElementById('habit-next-btn');
  if (btn) btn.disabled = false;
}

function goToClassStep() {
  goStep('class');
}

function selectCadenceInline(type) {
  obCurrentCadence = type;
  var daily  = document.getElementById('hci-daily');
  var weekly = document.getElementById('hci-weekly');
  var wr     = document.getElementById('hci-weekly-row');
  if (daily)  daily.classList.toggle('selected',  type === 'daily');
  if (weekly) weekly.classList.toggle('selected', type === 'weekly');
  if (wr)     wr.classList.toggle('hidden', type !== 'weekly');
  // Keep old selectors in sync for compat
  var cadDaily  = document.getElementById('cad-daily');
  var cadWeekly = document.getElementById('cad-weekly');
  if (cadDaily)  cadDaily.classList.toggle('selected',  type === 'daily');
  if (cadWeekly) cadWeekly.classList.toggle('selected', type === 'weekly');
}

function selectWeeklyTargetInline(btn) {
  // Target all wt-btn inside the inline row only
  var row = document.getElementById('hci-weekly-row');
  if (row) row.querySelectorAll('.wt-btn').forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
  obCurrentWeekTarget = parseInt(btn.dataset.n, 10);
}

function showHabitCadenceInline() {
  var el = document.getElementById('habit-cadence-inline');
  if (el && el.style.display === 'none') {
    el.style.display = 'block';
    el.style.animation = 'expanderIn 0.2s ease';
  }
}

function setupSuggestedClass() {
  // Best match from habit text / key map
  var directClass = _currentSuggestionKey ? HABIT_KEY_CLASS[_currentSuggestionKey] : null;
  var chosenClass = directClass || suggestClass(obCurrentHabit);

  // Check if primary persona of this class is already taken
  var takenPersonas = obCompanions.slice(0, obCompanionIdx).map(function(c) {
    return c.class + (c.useAlt ? ':alt' : ':primary');
  });
  var primaryKey = chosenClass + ':primary';
  var useAlt = takenPersonas.indexOf(primaryKey) !== -1;

  obSuggest      = chosenClass;
  obCurrentClass = chosenClass;
  obCurrentUseAlt = useAlt;

  // Get effective persona
  var def = CLASS_DEFS[chosenClass];
  if (!def) return;
  var persona = (useAlt && def.altPersona) ? def.altPersona : def;
  var personaName = persona.personaName || def.personaName;
  var lore = persona.lore || def.lore;
  var subText = useAlt
    ? def.personaName + ' already walks with you. A second ' + def.name + ' answers the call.'
    : 'Based on your habit, here\'s who joins your party.';

  document.getElementById('ob-suggest-icon').textContent    = def.icon;
  document.getElementById('sc-icon').textContent            = def.icon;
  document.getElementById('sc-name').textContent            = def.name;
  document.getElementById('sc-persona-name').textContent    = personaName;
  document.getElementById('sc-desc').textContent            = def.desc;
  document.getElementById('sc-trait').textContent           = def.trait;
  document.getElementById('sc-lore').textContent            = lore || '';

  var subEl = document.getElementById('ob-suggest-sub');
  if (subEl) subEl.textContent = subText;

  // Hide leftover conflict UI
  var noticeEl = document.getElementById('class-conflict-notice');
  if (noticeEl) noticeEl.style.display = 'none';
  var swapRow = document.getElementById('class-swap-row');
  if (swapRow) swapRow.innerHTML = '';
}

function buildClassSwapRow(takenClasses, selectedClass) {
  var row = document.getElementById('class-swap-row');
  if (!row) return;
  row.innerHTML = '';

  CLASS_PRIORITY.forEach(function(cls) {
    var def = CLASS_DEFS[cls];
    if (!def) return;
    var btn = document.createElement('button');
    var isTaken    = takenClasses.indexOf(cls) !== -1;
    var isSelected = cls === selectedClass;
    btn.className  = 'class-swap-btn' + (isSelected ? ' selected' : '') + (isTaken ? ' taken' : '');
    btn.title      = isTaken ? (def.personaName || def.name) + ' is already in your party' : 'Choose ' + (def.personaName || def.name);
    btn.innerHTML  = '<span class="class-swap-icon">' + def.icon + '</span>' +
                     '<span class="class-swap-label">' + (def.personaName ? def.personaName.split(' ')[0] : cls) + '</span>';
    if (!isTaken) {
      btn.onclick = (function(c) { return function() { swapClass(c); }; })(cls);
    }
    row.appendChild(btn);
  });
}

function swapClass(cls) {
  obCurrentClass = cls;
  var def = CLASS_DEFS[cls];
  if (!def) return;
  // Update card
  document.getElementById('ob-suggest-icon').textContent = def.icon;
  document.getElementById('sc-icon').textContent         = def.icon;
  document.getElementById('sc-name').textContent         = def.name;
  document.getElementById('sc-persona-name').textContent = def.personaName || '';
  document.getElementById('sc-desc').textContent         = def.desc;
  document.getElementById('sc-trait').textContent        = def.trait;
  document.getElementById('sc-lore').textContent         = def.lore || '';
  // Update swap row selection
  document.querySelectorAll('.class-swap-btn').forEach(function(btn) {
    btn.classList.toggle('selected', btn.title.indexOf(def.personaName || def.name) !== -1 || btn.querySelector('.class-swap-icon').textContent === def.icon);
  });
  // Recheck conflict notice
  var takenClasses = obCompanions.slice(0, obCompanionIdx).map(function(c) { return c.class; });
  var noticeEl = document.getElementById('class-conflict-notice');
  if (noticeEl) noticeEl.style.display = 'none';
}

function confirmCompanionClass() {
  if (!obCurrentClass) obCurrentClass = obSuggest || 'Mage';
  // Save this companion
  obCompanions[obCompanionIdx] = {
    habit: obCurrentHabit,
    class: obCurrentClass,
    useAlt: obCurrentUseAlt,
    cadence: obCurrentCadence,
    weekTarget: obCurrentWeekTarget
  };
  obCompanionIdx++;
  if (obCompanionIdx < obPartySize) {
    // More companions to set up — reset all fields
    obCurrentHabit   = '';
    obCurrentClass   = '';
    obCurrentUseAlt  = false;
    obCurrentCadence = 'daily';
    obCurrentWeekTarget = 3;
    var inp = document.getElementById('habit-input');
    if (inp) inp.value = '';
    goStep('habit');
  } else {
    // All done — skip laws, go straight to begin
    goStep('begin');
  }
}

// Legacy confirmClass alias
function confirmClass() { confirmCompanionClass(); }

function selectCadence(type) {
  obCurrentCadence = type;
  document.getElementById('cad-daily') && document.getElementById('cad-daily').classList.toggle('selected', type === 'daily');
  document.getElementById('cad-weekly') && document.getElementById('cad-weekly').classList.toggle('selected', type === 'weekly');
  var wr = document.getElementById('weekly-target-row');
  if (wr) wr.classList.toggle('hidden', type !== 'weekly');
}

function selectWeeklyTarget(btn) {
  document.querySelectorAll('.wt-btn').forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
  obCurrentWeekTarget = parseInt(btn.dataset.n, 10);
}

function buildBeginPartySummary() {
  var wrap = document.getElementById('begin-party-summary');
  if (!wrap) return;
  wrap.innerHTML = '';
  obCompanions.forEach(function(c) {
    var baseDef = CLASS_DEFS[c.class] || CLASS_DEFS['Mage'];
    var persona = (c.useAlt && baseDef.altPersona) ? Object.assign({}, baseDef, baseDef.altPersona) : baseDef;
    var cadenceStr = c.cadence === 'weekly'
      ? (c.weekTarget || 3) + '\u00D7 per week'
      : 'Daily';
    var row = document.createElement('div');
    row.className = 'begin-party-row';
    row.innerHTML =
      '<div class="begin-party-icon">' + baseDef.icon + '</div>' +
      '<div style="flex:1;min-width:0;">' +
        '<div class="begin-party-name">' + esc(persona.personaName || baseDef.name) + '</div>' +
        '<div style="font-size:12px;color:var(--text-dark);font-family:Cinzel,serif;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:2px;">' + baseDef.name + '</div>' +
        '<div class="begin-party-habit">' + esc(c.habit) + '</div>' +
        '<div style="font-size:13px;color:var(--text-dark);margin-top:3px;font-family:Cinzel,serif;text-transform:uppercase;letter-spacing:0.08em;">' + cadenceStr + '</div>' +
      '</div>';
    wrap.appendChild(row);
  });
}

function beginJourney() {
  var nameEl = document.getElementById('hero-name-input');
  var name   = nameEl ? nameEl.value.trim() : '';
  if (!name) { goStep(0); return; }
  if (!obCompanions.length) { goStep('habit'); return; }
  if (!obAvatar) obAvatar = '🧔';

  // Assign cohort based on the current two-week window
  // Format: YYYY-WW where WW is the two-week period number (week / 2)
  var now = new Date();
  var startOfYear = new Date(now.getFullYear(), 0, 1);
  var weekNum = Math.ceil(((now - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
  var cohortPeriod = Math.floor(weekNum / 2);
  var cohortId = now.getFullYear() + '-C' + String(cohortPeriod).padStart(2, '0');

  state.name   = name;
  state.avatar = obAvatar;
  state.xp     = 0;
  state.mapPosition  = 0;
  state.lastMapPosition = -1;
  state.badges = [];
  state.weekLogDays  = [];
  state.weekStart    = '';
  state.roadBonusesThisMonth = 0;
  state.lastEncounterLog = '';
  state.seenStoryEncounters = [];
  state.seenArrivals = [];
  state.encounterLogCount = 0;
  state.lastEncounterAtLog = 0;
  state.ironVault = 0;
  state.bestStreak = 0;
  state.party = [];
  state.activeSlots = 0;
  state.cohortId = cohortId;

  obCompanions.forEach(function(c) {
    var char = createCharacter(c.habit, c.class, c.cadence, c.weekTarget, c.useAlt);
    state.party.push(char);
  });
  state.activeSlots = state.party.length;

  save();
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  state.firstRun = true;
  save();
  render();
  showToast('The road awaits, ' + state.name + '. Your party is assembled.');
}

// ─────────────────────────
//  PARTY MANAGEMENT
// ─────────────────────────
function createCharacter(habit, cls, cadence, weekTarget, useAlt) {
  return {
    id:          Date.now() + Math.floor(Math.random() * 10000),
    habit:       habit,
    class:       cls,
    useAlt:      !!useAlt,
    cadence:     cadence || 'daily',
    weekTarget:  weekTarget || 3,
    hp:          5,
    streak:      0,
    bestStreak:  0,
    lastCheckIn: null,
    missedToday: null,
    checkInsThisWeek: 0,
    weekStart:   '',
    log:         [],
    collapsed:   false
  };
}

// ─────────────────────────
//  HP RULES
// ─────────────────────────
function getHpRule(cls) {
  return (CLASS_DEFS[cls] || {}).hpRule || 'standard';
}

function applyMiss(char) {
  // Called when a character misses a day (or, for weekly, misses the weekly target)
  var rule = getHpRule(char.class);
  // Streak break
  var hadStreak = char.streak > 0;
  if (char.cadence === 'daily') char.streak = 0;
  // HP loss
  var hpLoss = 1;
  if (rule === 'ranger' && hadStreak) hpLoss = 2; // Rangers feel streak breaks harder
  char.hp = Math.max(0, (char.hp || 0) - hpLoss);
  char.collapsed = (char.hp <= 0);
}

function applyCheckIn(char) {
  char.hp = Math.min(5, (char.hp || 0) + 1);
  char.collapsed = false;
  // Streak
  var today     = new Date().toDateString();
  var yesterday = (function() { var d = new Date(); d.setDate(d.getDate()-1); return d.toDateString(); })();
  if (char.cadence === 'daily') {
    if (char.lastCheckIn === yesterday || char.lastCheckIn === null && char.streak === 0) {
      char.streak = (char.streak || 0) + 1;
    } else if (char.lastCheckIn !== today) {
      char.streak = 1; // restart
    }
  } else {
    // Weekly: increment streak only when weekly target is hit
    var ws = getWeekStart();
    if (char.weekStart !== ws) {
      char.weekStart = ws; char.checkInsThisWeek = 0;
    }
    char.checkInsThisWeek = (char.checkInsThisWeek || 0) + 1;
    if (char.checkInsThisWeek >= char.weekTarget) char.streak = (char.streak || 0) + 1;
  }
  if (char.streak > (char.bestStreak || 0)) char.bestStreak = char.streak;
  char.lastCheckIn = today;
}

// Called on app open — check each character for missed days and apply HP decay
function checkMissedCheckIns() {
  if (!state.party || !state.party.length) return;
  var today     = new Date().toDateString();
  var yesterday = (function() { var d = new Date(); d.setDate(d.getDate()-1); return d.toDateString(); })();
  var orcTriggered = false;
  state.party.forEach(function(char) {
    if (!char.lastCheckIn) return; // never checked in — no penalty yet
    if (char.lastCheckIn === today) return; // already checked in today
    if (char.cadence === 'daily') {
      // Missed yesterday and potentially more — apply one miss per missed day
      // Simple: if last check-in was not yesterday, they missed at least one day
      if (char.lastCheckIn !== yesterday) {
        applyMiss(char);
        // Orc trigger — fire once per session at most
        if (!orcTriggered && !state.orcTriggeredToday) {
          orcTriggered = true;
          checkOrcTrigger(char);
        }
      }
    } else {
      // Weekly cadence: check at week boundary
      var ws = getWeekStart();
      if (char.weekStart && char.weekStart !== ws) {
        // New week — did they hit target last week?
        if ((char.checkInsThisWeek || 0) < char.weekTarget) {
          applyMiss(char);
        }
        char.weekStart = ws;
        char.checkInsThisWeek = 0;
      }
    }
  });
  // Reset daily orc trigger flag
  if (state.orcTriggeredDate !== today) {
    state.orcTriggeredToday = false;
    state.orcTriggeredDate = today;
  }
  if (orcTriggered) { state.orcTriggeredToday = true; }
  save();
}

// ─────────────────────────
//  CHECK-IN ACTION
// ─────────────────────────
function checkIn(charId) {
  var char = state.party.filter(function(c) { return c.id === charId; })[0];
  if (!char) return;
  var today = new Date().toDateString();
  if (char.lastCheckIn === today) return; // already checked in

  // Collapsed chars CAN check in for recovery — bypass the missedToday guard
  // Non-collapsed chars cannot check in if already marked missed
  var isCollapsed = char.collapsed || (char.hp || 0) <= 0;
  if (!isCollapsed && char.missedToday === today) return;

  var prevLevel = getLevelData(state.xp).level;

  // Base XP + streak bonus
  var streakBonus = Math.min(30, (char.streak || 0) * 5);
  var baseXp = getLevelData(state.xp).level <= 3 ? 20 : 15;
  var xpRaw = baseXp + streakBonus;

  // Party bonus: all characters will be checked in after this one
  var allDone = state.party.every(function(c) {
    return c.lastCheckIn === today || c.id === charId;
  });
  if (state.party.length > 1 && allDone) xpRaw += 15;

  // Recovery penalty: collapsed chars earn 50% XP for next 3 check-ins
  var recoveryPenalty = false;
  if (isCollapsed) {
    char.recoveryDaysLeft = 3; // start/reset recovery window
    recoveryPenalty = true;
  } else if ((char.recoveryDaysLeft || 0) > 0) {
    recoveryPenalty = true;
    char.recoveryDaysLeft = char.recoveryDaysLeft - 1;
  }
  if (recoveryPenalty) xpRaw = Math.max(5, Math.floor(xpRaw * 0.5));

  var xpGained = Math.max(1, Math.round(xpRaw));

  var def = getPersona(char);

  applyCheckIn(char);

  // Add to log
  char.log = char.log || [];
  char.log.push({
    id:        String(Date.now()),
    charId:    char.id,
    charClass: char.class,
    charIcon:  def.icon || '✦',
    habit:     char.habit,
    xpGained:  xpGained,
    recovery:  recoveryPenalty,
    ts:        new Date().toISOString()
  });

  state.xp += xpGained;

  // Update best streak
  var primary = state.party[0];
  if (primary && primary.streak > (state.bestStreak || 0)) {
    state.bestStreak = primary.streak;
  }

  checkWeekRoadBonus();
  
  // ── QUEST MILESTONE CHECK ──
  checkQuestMilestone(char, def);
  
  save();
  render();

  // ── EPIC CELEBRATION ──
  showCheckinCelebration(char, def, xpGained, recoveryPenalty);

  // Queue follow-on events AFTER celebration ends
  var newLevel = getLevelData(state.xp).level;
  if (newLevel > prevLevel) {
    _afterCelebrationFn = function() { queueOverlay(function() { showLevelUp(newLevel); }); };
  } else if (state.firstRun) {
    state.firstRun = false;
    save();
    _afterCelebrationFn = function() { showWelcomeEncounter(); };
  } else {
    _afterCelebrationFn = function() { checkEncounter(0); };
  }
}

var MISS_FLAVOR = {
  Warrior:   ["The body didn't move today. Aldric knows the cost.", "Missed. The weights stayed cold. Tomorrow they won't.", "A day without the work. Aldric feels it already."],
  Cleric:    ["The body needed rest, but not this kind.", "Casciel faltered. The well needs tending again tomorrow.", "Missed. The rhythm breaks quietly before it breaks loudly."],
  Mage:      ["The pages stayed closed. Corvin marks the gap.", "No study today. The knowledge waits — it's patient, but so is regret.", "Skipped. The lore doesn't chase you."],
  Rogue:     ["The discipline slipped. Thessaly notes it without excuses.", "Missed. The old habits are still there, watching.", "One day off the edge. Thessaly has been here before."],
  Scribe:    ["The pen didn't move. The blank page wins today.", "No words. The Scribe marks the silence.", "Skipped. The work doesn't write itself."],
  Ranger:    ["The trail went unworn today.", "Missed. The road was there. You weren't.", "Off the path. One day. Reorient tomorrow."],
  Monk:      ["The stillness wasn't chosen today — it was defaulted into.", "No practice. The noise won today.", "Missed. The mind goes where it's pointed."],
  Alchemist: ["The formula broke. One unchecked variable.", "Inputs skipped. Draven doesn't pretend otherwise.", "Missed. The experiment notes it."]
};

function markMiss(charId) {
  var char = state.party.filter(function(c) { return c.id === charId; })[0];
  if (!char) return;
  var today = new Date().toDateString();
  if (char.lastCheckIn === today) return;
  if (char.missedToday === today) return; // already marked

  char.missedToday = today;

  // Break streak on daily habits
  if (char.cadence === 'daily') char.streak = 0;

  // HP loss
  var prevHp = char.hp || 0;
  char.hp = Math.max(0, prevHp - 1);
  char.collapsed = (char.hp <= 0);

  save();

  // Show the somber overlay
  showMissOverlay(char);
}
function showMissOverlay(char) {
  var def = getPersona(char);
  var overlay = document.getElementById('miss-overlay');
  if (!overlay) { render(); renderParty(); return; }

  // Set content
  document.getElementById('miss-icon').textContent = def.icon || '💀';
  document.getElementById('miss-name').textContent = (def.personaName || def.name || 'Champion').toUpperCase();

  var hpLeft = char.hp || 0;
  var hpText = char.collapsed ? 'Fallen' : '−1 HP';
  document.getElementById('miss-hp').textContent = hpText;
  document.getElementById('miss-hp').style.color = char.collapsed ? 'var(--red)' : 'var(--red)';

  // Flavor line — class-specific
  var flavors = MISS_FLAVOR[char.class] || ["Missed. Mark it and come back."];
  document.getElementById('miss-msg').textContent = flavors[Math.floor(Math.random() * flavors.length)];

  // Hearts row — show remaining HP
  var heartsEl = document.getElementById('miss-hearts');
  heartsEl.innerHTML = '';
  for (var i = 1; i <= 5; i++) {
    var h = document.createElement('span');
    h.textContent = i <= hpLeft ? '❤️' : '🖤';
    // Animate the heart that just broke
    if (i === hpLeft + 1) h.style.animation = 'missShake 0.4s ease 0.3s both';
    heartsEl.appendChild(h);
  }

  overlay.classList.add('show');

  clearTimeout(window._missTimer);
  window._missTimer = setTimeout(function() {
    closeMissOverlay();
  }, 3000);
}

function closeMissOverlay() {
  var overlay = document.getElementById('miss-overlay');
  if (overlay) overlay.classList.remove('show');
  render();
  renderParty();
  // If collapsed, queue the fallen overlay
  (state.party || []).forEach(function(c) {
    if (c.collapsed && c.missedToday === new Date().toDateString()) {
      queueOverlay(function() { showBroken(); });
    }
  });
}
var QUEST_MILESTONES = [5, 10, 21, 30, 50, 100];

function checkQuestMilestone(char, def) {
  var streak = char.streak || 0;
  if (QUEST_MILESTONES.indexOf(streak) === -1) return;

  var rewards = {
    5:   { xp: 50,  gold: 0,  msg: '5-day streak!',   flavor: '5 days in a row. The habit is becoming automatic.' },
    10:  { xp: 75,  gold: 15, msg: '10-day streak!',   flavor: '10 consecutive days. That\'s a real pattern now.' },
    21:  { xp: 100, gold: 25, msg: '21-day milestone!', flavor: '21 days. The science says habits form here. You already knew.' },
    30:  { xp: 150, gold: 35, msg: '30-day milestone!', flavor: 'One full month. No excuses, no gaps, no shortcuts.' },
    50:  { xp: 200, gold: 50, msg: '50-day streak!',    flavor: '50 days. You\'re in the top 1% of starters now.' },
    100: { xp: 300, gold: 75, msg: '100 DAYS!',         flavor: '100 consecutive days. Legendary. The road will remember this.' },
  };

  var r = rewards[streak];
  if (!r) return;

  // Apply bonus
  state.xp = (state.xp || 0) + r.xp;
  if (r.gold > 0) state.ironVault = (state.ironVault || 0) + r.gold;

  // Mark so we don't repeat
  if (!state.questMilestonesShown) state.questMilestonesShown = [];
  var key = char.id + '_' + streak;
  if (state.questMilestonesShown.indexOf(key) !== -1) return;
  state.questMilestonesShown.push(key);

  // Show quest complete overlay
  queueOverlay(function() { showQuestComplete(char, def, streak, r); });
}

function showQuestComplete(char, def, streak, r) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box friendly';
  document.getElementById('encounter-zone').textContent  = '⚔ Quest Complete';
  document.getElementById('encounter-icon').textContent  = def.icon || '✨';
  document.getElementById('encounter-title').textContent = (def.personaName || def.name) + ' — ' + r.msg;
  document.getElementById('encounter-desc').textContent  = r.flavor + (r.gold > 0 ? ' +' + r.gold + ' Road Gold earned.' : '');
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = '✦ Claim Reward <span class="overlay-btn-cost">+' + r.xp + ' bonus XP' + (r.gold > 0 ? ' · +' + r.gold + ' 💰' : '') + '</span>';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    fireGoldFloat('+' + r.xp + ' XP ✨');
    render();
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

// ─────────────────────────
//  ORC ENCOUNTER SYSTEM
// ─────────────────────────
// Orc triggers fire when a champion misses days — worse with longer absence
var ORC_ENCOUNTERS = [
  {
    id: 'orc_patrol',
    icon: '👹', title: 'The Orc Patrol',
    zone: 'Threat', minMissedDays: 1,
    desc: 'An orc patrol spotted your party camped without progress. They\'ve been watching for travelers who\'ve lost their rhythm — you fit the description. The sergeant looks at your log with contempt. "Skipped days," he says. "I can smell it."',
    choiceA: { label: '⚔️ Stand and fight', sub: 'Lose 1 HP — they back off, but it costs' },
    choiceB: { label: '💰 Bribe your way through', sub: 'Spend 20 Road Gold — they move on' },
    choiceC: { label: '🔥 Show your streak', sub: 'Requires 5-day streak — they respect what they see', minStreak: 5 },
    goldCost: 20
  },
  {
    id: 'orc_warchief',
    icon: '💀', title: 'Grimjaw the Warchief',
    zone: 'Danger', minMissedDays: 2,
    desc: 'Word travels fast. Grimjaw has heard your party skipped days — in his world, that\'s weakness. He\'s arrived personally. His reputation is not good. He looks at each of your champions slowly. "Soft," he concludes.',
    choiceA: { label: '🛡️ Rally your champions', sub: 'Lose 2 HP total — Grimjaw respects the resistance' },
    choiceB: { label: '💰 Pay Grimjaw\'s toll', sub: 'Spend 30 Road Gold — he takes it and leaves' },
    choiceC: { label: '🔥 Your record is your shield', sub: 'Requires 10-day streak — Grimjaw pauses, then steps aside', minStreak: 10 },
    goldCost: 30
  },
  {
    id: 'orc_ambush',
    icon: '🪓', title: 'The Road Ambush',
    zone: 'Ambush', minMissedDays: 1,
    desc: 'Three orcs, two torches, one very clear intention. They target inconsistent travelers — apparently the road keeps a list. Your party was on it. The largest one cracks his knuckles. He has done this before.',
    choiceA: { label: '⚔️ Fight through it', sub: 'Lose 1 HP — they\'re driven off' },
    choiceB: { label: '💰 Negotiate passage', sub: 'Spend 18 Road Gold — they let you pass' },
    choiceC: { label: '🔥 Regained ground', sub: 'Requires 3-day streak — you\'re back on track and they know it', minStreak: 3 },
    goldCost: 18
  },
];

function checkOrcTrigger(char) {
  // Only trigger if char missed at least 1 day and has a streak history (not brand new)
  if (!char.lastCheckIn) return;
  if (!char.bestStreak || char.bestStreak < 2) return;

  var today     = new Date().toDateString();
  var yesterday = (function() { var d = new Date(); d.setDate(d.getDate()-1); return d.toDateString(); })();

  if (char.lastCheckIn === today || char.lastCheckIn === yesterday) return; // not missed

  // Calculate days missed
  var lastDate = new Date(char.lastCheckIn);
  var todayDate = new Date(today);
  var daysMissed = Math.round((todayDate - lastDate) / (1000 * 60 * 60 * 24));
  if (daysMissed < 1) return;

  // 60% chance per missed character to trigger orc
  if (Math.random() > 0.6) return;

  var eligible = ORC_ENCOUNTERS.filter(function(o) { return o.minMissedDays <= daysMissed; });
  if (!eligible.length) return;

  var orc = eligible[Math.floor(Math.random() * eligible.length)];
  queueOverlay(function() { showOrcEncounter(orc, char, daysMissed); });
}

function showOrcEncounter(enc, char, daysMissed) {
  var def = CLASS_DEFS[char.class] || {};
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box hostile';

  var missMsg = daysMissed === 1 ? '1 day missed' : daysMissed + ' days missed';
  document.getElementById('encounter-zone').textContent  = '💢 ' + (def.personaName || def.name) + ' — ' + missMsg;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;

  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';

  var btnA = document.createElement('button');
  btnA.className = 'overlay-btn hostile-choice';
  btnA.innerHTML = enc.choiceA.label + '<span class="overlay-btn-cost">' + enc.choiceA.sub + '</span>';
  btnA.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    // Apply HP loss to the missed character
    var hpLoss = enc.id === 'orc_warchief' ? 2 : 1;
    char.hp = Math.max(0, (char.hp || 0) - hpLoss);
    char.collapsed = (char.hp <= 0);
    save(); render();
    showToast('⚔️ Fought them off — ' + hpLoss + ' HP lost.');
  };

  var gold = state.ironVault || 0;
  var btnB = document.createElement('button');
  btnB.className = 'overlay-btn';
  if (gold >= enc.goldCost) {
    btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">' + enc.choiceB.sub + '</span>';
    btnB.onclick = function() {
      document.getElementById('encounter-overlay').classList.remove('show');
      overlayDismissed();
      state.ironVault = Math.max(0, (state.ironVault || 0) - enc.goldCost);
      fireGoldFloat('-' + enc.goldCost + ' 💰');
      save(); render();
      showToast('💰 Paid ' + enc.goldCost + ' Road Gold. They moved on.');
    };
  } else {
    btnB.innerHTML = '💰 Can\'t afford to bribe them<span class="overlay-btn-cost">Not enough Road Gold — fight it out</span>';
    btnB.disabled = true;
    btnB.style.opacity = '0.4';
  }

  choices.appendChild(btnA);
  choices.appendChild(btnB);

  // choiceC — streak-based free escape
  if (enc.choiceC) {
    var bestStreak = Math.max.apply(null, (state.party || []).map(function(c) { return c.streak || 0; }));
    var minStreak = enc.choiceC.minStreak || 0;
    var hasStreak = bestStreak >= minStreak;
    var btnC = document.createElement('button');
    if (hasStreak) {
      btnC.className = 'overlay-btn primary-choice';
      btnC.innerHTML = enc.choiceC.label + '<span class="overlay-btn-cost">' + enc.choiceC.sub + ' (' + bestStreak + '-day streak)</span>';
      btnC.onclick = function() {
        document.getElementById('encounter-overlay').classList.remove('show');
        overlayDismissed();
        showToast('🔥 Your streak speaks for itself — they step aside.');
        save(); render();
      };
    } else {
      btnC.className = 'overlay-btn overlay-btn-disabled';
      btnC.innerHTML = enc.choiceC.label + '<span class="overlay-btn-cost">Needs ' + minStreak + '-day streak — you have ' + bestStreak + '</span>';
      btnC.disabled = true;
    }
    choices.appendChild(btnC);
  }

  document.getElementById('encounter-overlay').classList.add('show');
}
function showCheckinCelebration(char, def, xpGained, recoveryPenalty) {
  var overlay = document.getElementById('checkin-celebration');
  if (!overlay) return;

  // Bounce the check circle
  var checkEl = document.getElementById('check-' + char.id);
  if (checkEl) {
    checkEl.classList.add('just-checked');
    setTimeout(function() { checkEl.classList.remove('just-checked'); }, 500);
  }

  var streak = char.streak || 0;
  var particles = { Warrior: ['⚔️','🔥','💥','🛡️'], Cleric: ['💚','✨','🌿','💧'], Mage: ['✨','🔮','💫','📖'], Rogue: ['🗡️','💰','⚡','🎯'], Scribe: ['✍️','📜','✨','💫'], Ranger: ['🏹','🌲','🦅','🌿'], Monk: ['🧘','☁️','✨','🌸'], Alchemist: ['🧪','✨','💎','🌿'] };
  var emojis = particles[char.class] || ['✨','⭐','💫'];

  // Set content
  document.getElementById('cc-icon').textContent = def.icon || '⚔️';
  document.getElementById('cc-name').textContent = def.personaName || def.name || 'Champion';

  var xpEl = document.getElementById('cc-xp');
  if (recoveryPenalty) {
    xpEl.textContent = '+' + xpGained + ' XP';
    xpEl.style.color = 'var(--orange)';
    xpEl.title = 'Reduced XP — recovering from collapse';
  } else {
    xpEl.textContent = '+' + xpGained + ' XP';
    xpEl.style.color = '';
  }
  
  var msgEl = document.getElementById('cc-msg');
  if (recoveryPenalty) {
    var recoveryLeft = char.recoveryDaysLeft || 0;
    msgEl.textContent = recoveryLeft > 0
      ? (def.personaName || def.name) + ' is back on their feet. Recovery: ' + recoveryLeft + ' day' + (recoveryLeft === 1 ? '' : 's') + ' at half XP.'
      : (def.personaName || def.name) + ' has recovered. Full XP resumes.';
  } else {
    var flavors = def.checkInFlavor || [];
    msgEl.textContent = flavors.length ? flavors[Math.floor(Math.random() * flavors.length)] : 'Quest complete!';
  }

  var streakEl = document.getElementById('cc-streak');
  if (streak > 0 && !recoveryPenalty) {
    streakEl.textContent = '🔥 ' + streak + ' day streak!';
    streakEl.style.display = 'block';
  } else if (recoveryPenalty) {
    streakEl.textContent = '↺ Rising';
    streakEl.style.display = 'block';
    streakEl.style.color = 'var(--orange)';
  } else {
    streakEl.style.display = 'none';
  }

  var confettiContainer = document.getElementById('cc-confetti');
  confettiContainer.innerHTML = '';
  for (var i = 0; i < 24; i++) {
    var p = document.createElement('div');
    p.className = 'cc-particle';
    var angle = (i / 24) * Math.PI * 2;
    var dist = 80 + Math.random() * 120;
    var tx = Math.cos(angle) * dist;
    var ty = Math.sin(angle) * dist;
    var emoji = emojis[i % emojis.length];
    p.textContent = emoji;
    var delay = Math.random() * 0.15;
    var duration = 0.6 + Math.random() * 0.4;
    p.style.cssText = 'animation: cc-burst-' + i + ' ' + duration + 's ease-out ' + delay + 's both;';
    // inject keyframe dynamically
    var style = document.createElement('style');
    style.textContent = '@keyframes cc-burst-' + i + ' { 0%{transform:translate(-50%,-50%) scale(1);opacity:1} 100%{transform:translate(calc(-50% + ' + tx + 'px),calc(-50% + ' + ty + 'px)) scale(0.2);opacity:0} }';
    document.head.appendChild(style);
    confettiContainer.appendChild(p);
  }

  // Show
  overlay.classList.add('show');
  
  // Flash the XP bar
  var fill = document.getElementById('xp-fill');
  if (fill) {
    fill.classList.remove('pulse');
    void fill.offsetWidth;
    fill.classList.add('pulse');
    setTimeout(function() { fill.classList.remove('pulse'); }, 800);
  }

  // Auto-dismiss after 1.8s, then queue follow-on events
  clearTimeout(window._ccTimer);
  window._ccTimer = setTimeout(function() {
    closeCheckinCelebration();
    // NOW it's safe to queue the next thing
    _afterCelebration();
  }, 3000);
}

var _afterCelebrationFn = null;

function _afterCelebration() {
  if (_afterCelebrationFn) {
    var fn = _afterCelebrationFn;
    _afterCelebrationFn = null;
    // Small gap so celebration fade-out completes before next thing appears
    setTimeout(fn, 200);
  }
}

function closeCheckinCelebration() {
  var overlay = document.getElementById('checkin-celebration');
  if (overlay) overlay.classList.remove('show');
}


function getGlobalStreak() {
  if (!state.party || !state.party.length) return 0;
  var today = new Date().toDateString();
  // Use the highest streak among characters who have checked in today,
  // or the primary character's streak if none have checked in yet
  var checkedInToday = state.party.filter(function(c) { return c.lastCheckIn === today; });
  if (checkedInToday.length) {
    return Math.max.apply(null, checkedInToday.map(function(c) { return c.streak || 0; }));
  }
  return state.party[0].streak || 0;
}

function hasLoggedToday() {
  if (!state.party || !state.party.length) return false;
  var today = new Date().toDateString();
  // Logged today if ANY party member checked in
  return state.party.some(function(c) { return c.lastCheckIn === today; });
}

function checkStreak() {
  // Streak is now per-character — this is a no-op kept for compatibility
}

function markLoggedToday() {
  // No-op — handled by checkIn
}

// ─────────────────────────
//  RENDER PARTY CARDS
// ─────────────────────────
function renderParty() {
  var container = document.getElementById('party-cards');
  if (!container) return;
  container.innerHTML = '';
  var today = new Date().toDateString();

  (state.party || []).forEach(function(char) {
    var def         = getPersona(char);
    var checkedIn   = char.lastCheckIn === today;
    var hp          = char.hp || 0;
    var isCollapsed = char.collapsed || hp <= 0;
    var isWounded   = !isCollapsed && hp <= 2;
    var streak      = char.streak || 0;
    var alreadyMissed = char.missedToday === today;

    var card = document.createElement('div');
    card.className = 'char-card' +
      (checkedIn    ? ' checked-in' : '') +
      (isWounded    ? ' wounded'    : '') +
      (isCollapsed  ? ' collapsed'  : '') +
      (alreadyMissed && !checkedIn ? ' missed-today' : '');

    // No card-level click — only the circles are interactive

    // Left accent bar
    var accent = document.createElement('div');
    accent.className = 'char-card-accent';
    card.appendChild(accent);

    // Body
    var body = document.createElement('div');
    body.className = 'char-card-body';

    // Avatar
    var avatarDiv = document.createElement('div');
    avatarDiv.className = 'char-card-avatar' + (isWounded ? ' low-hp' : '');
    avatarDiv.textContent = def.icon;
    body.appendChild(avatarDiv);

    // Info block
    var infoDiv = document.createElement('div');
    infoDiv.className = 'char-card-info';

    // Build dots row — show last 7 streak days as dots
    var dotsHtml = '<div class="char-card-dots">';
    var dotCount = 7;
    for (var d = 0; d < dotCount; d++) {
      var isFilled = d < streak && !checkedIn;
      var isToday  = checkedIn && d < streak;
      var cls = 'streak-dot';
      if (isToday && d === streak - 1) cls += ' today';
      else if (d < streak) cls += ' filled';
      dotsHtml += '<span class="' + cls + '"></span>';
    }
    if (streak > 0) {
      dotsHtml += '<span class="streak-label-mini">🔥 ' + streak + (char.cadence === 'weekly' ? ' wk' : ' day') + '</span>';
    }
    dotsHtml += '</div>';

    // Weekly progress pips
    var weeklyHtml = '';
    if (char.cadence === 'weekly') {
      var doneThisWeek = char.checkInsThisWeek || 0;
      var target = char.weekTarget || 3;
      var remaining = target - doneThisWeek;

      // Days available this week INCLUDING today (Sun=0, Sat=6, week ends Sat)
      var todayDow = new Date().getDay();
      var daysAvailable = 7 - todayDow; // today + remaining days of week

      // Urgency states:
      // done      — already hit target
      // at_risk   — remaining === daysAvailable (must check in every single remaining day incl. today)
      // impossible — remaining > daysAvailable (mathematically can't hit target this week)
      // normal    — fine, still have slack
      var urgency = 'normal';
      if (doneThisWeek >= target) {
        urgency = 'done';
      } else if (remaining > daysAvailable) {
        urgency = 'impossible';
      } else if (remaining === daysAvailable) {
        urgency = 'at_risk';
      }

      weeklyHtml = '<div class="char-card-weekly-progress weekly-urgency-' + urgency + '">';
      for (var p = 0; p < target; p++) {
        weeklyHtml += '<div class="weekly-pip' + (p < doneThisWeek ? ' done' : '') + '"></div>';
      }

      var urgencyLabel = '';
      if (urgency === 'impossible') {
        urgencyLabel = ' <span class="weekly-urgency-label urgent">✗ Week lost</span>';
      } else if (urgency === 'at_risk') {
        var dayWord = remaining === 1 ? 'day' : 'days';
        urgencyLabel = ' <span class="weekly-urgency-label at-risk">⚠ Need ' + remaining + ' more ' + dayWord + '</span>';
      } else if (urgency === 'done') {
        urgencyLabel = ' <span class="weekly-urgency-label done">✓ Week complete</span>';
      }
      weeklyHtml += '<span class="weekly-pip-label">' + doneThisWeek + '/' + target + ' this week</span>' + urgencyLabel + '</div>';
      dotsHtml = weeklyHtml;
    }

    // Flavor text when done
    var flavorHtml = '';
    if (checkedIn) {
      var flavors = def.checkInFlavor || [];
      var flavor = flavors.length ? flavors[Math.floor(Math.random() * flavors.length)] : '';
      if (flavor) flavorHtml = '<span class="checkin-flavor">' + esc(flavor) + '</span>';
    }

    // Recovery indicator — shown when char is back up but still in penalty window
    var recoveryHtml = '';
    if (!isCollapsed && (char.recoveryDaysLeft || 0) > 0) {
      recoveryHtml = '<span class="recovery-indicator">↺ Recovering — half XP for ' + char.recoveryDaysLeft + ' more day' + (char.recoveryDaysLeft === 1 ? '' : 's') + '</span>';
    }

    infoDiv.innerHTML =
      '<div class="char-card-persona-main">' + esc(def.personaName || def.name) + '</div>' +
      '<div class="char-card-class-tag">' + esc(def.name) + '</div>' +
      '<div class="char-card-habit">' + esc(char.habit || '') + '</div>' +
      (checkedIn ? flavorHtml : (recoveryHtml || dotsHtml));

    body.appendChild(infoDiv);

    // HP hearts — compact, top-right of body
    var heartsDiv = document.createElement('div');
    heartsDiv.className = 'char-card-hp-hearts';
    var heartsRow = document.createElement('div');
    heartsRow.className = 'hp-hearts-row';
    for (var h = 1; h <= 5; h++) {
      var heart = document.createElement('span');
      heart.className = 'hp-heart' + (h > hp ? ' empty' : '');
      heart.textContent = '❤️';
      heartsRow.appendChild(heart);
    }
    heartsDiv.appendChild(heartsRow);
    body.appendChild(heartsDiv);

    // Actions: ✓ circle + ✗ circle side by side
    var actionsDiv = document.createElement('div');
    actionsDiv.className = 'char-card-actions';

    // ✓ Check circle
    var checkDiv = document.createElement('div');
    checkDiv.className = 'char-card-check';
    checkDiv.id = 'check-' + char.id;
    checkDiv.textContent = checkedIn ? '✓' : (isCollapsed ? '↺' : '✓');

    if (checkedIn) {
      // Already done — inert, styled green by CSS
    } else if (isCollapsed) {
      checkDiv.onclick = (function(cid) { return function(e) { e.stopPropagation(); checkIn(cid); }; })(char.id);
    } else if (!alreadyMissed) {
      // Active — clicking fires checkIn
      checkDiv.onclick = (function(cid) { return function(e) { e.stopPropagation(); checkIn(cid); }; })(char.id);
    } else {
      // Already missed — lock the check circle out entirely
      checkDiv.classList.add('locked-out');
    }
    actionsDiv.appendChild(checkDiv);

    // ✗ Miss circle — shown on unchecked, non-collapsed cards
    if (!checkedIn && !isCollapsed) {
      var missBtn = document.createElement('button');
      if (alreadyMissed) {
        // Already missed — inert, styled by CSS
        missBtn.className = 'char-miss-circle missed';
        missBtn.disabled = true;
      } else {
        missBtn.className = 'char-miss-circle';
        missBtn.onclick = (function(cid) { return function(e) { e.stopPropagation(); markMiss(cid); }; })(char.id);
      }
      missBtn.textContent = '✗';
      actionsDiv.appendChild(missBtn);
    }

    body.appendChild(actionsDiv);
    card.appendChild(body);

    // Collapsed banner
    if (isCollapsed) {
      var collapsedBar = document.createElement('div');
      collapsedBar.className = 'char-card-collapsed-bar';
      collapsedBar.innerHTML = '<div class="collapsed-msg">🔥 ' + esc(def.personaName || def.name) + ' is camped. Tap ↺ to begin recovery — every veteran has been here.</div>';
      card.appendChild(collapsedBar);
    }

    container.appendChild(card);
  });
}


// ─────────────────────────
//  RENDER LOG (chronicle of check-ins)
// ─────────────────────────
var LOG_PAGE_SIZE = 3;
var logVisibleCount = LOG_PAGE_SIZE;

function renderLog() {
  logVisibleCount = LOG_PAGE_SIZE;
  renderLogPage();
}

function showMoreLog() {
  logVisibleCount += LOG_PAGE_SIZE;
  renderLogPage();
}

function collapseLog() {
  logVisibleCount = LOG_PAGE_SIZE;
  renderLogPage();
  var wrap = document.querySelector('.log-list-wrap');
  if (wrap) wrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderLogPage() {
  var list = document.getElementById('log-list');
  if (!list) return;
  list.innerHTML = '';

  // Flatten all party logs into one sorted list
  var allItems = [];
  (state.party || []).forEach(function(char) {
    (char.log || []).forEach(function(entry) {
      allItems.push(entry);
    });
  });
  allItems.sort(function(a, b) {
    return new Date(b.ts) - new Date(a.ts);
  });

  if (!allItems.length) {
    var empty = document.createElement('div');
    empty.className = 'log-empty';
    empty.textContent = 'No check-ins yet. Complete your first habit above to earn XP!';
    list.appendChild(empty);
    document.getElementById('log-pagination').style.display = 'none';
    return;
  }

  var visible = allItems.slice(0, logVisibleCount);
  var total   = allItems.length;
  var showing = Math.min(logVisibleCount, total);

  visible.forEach(function(entry) {
    var el = document.createElement('div');
    el.className = 'log-item';
    var meta = entry.ts ? formatDate(entry.ts) : '';
    el.innerHTML =
      '<div class="log-icon">' + (entry.charIcon || '✦') + '</div>' +
      '<div>' +
        '<div class="log-desc">' + esc(entry.habit || 'Check-in') + '</div>' +
        (meta ? '<div class="log-meta">' + meta + '</div>' : '') +
      '</div>' +
      '<div class="log-right">' +
        '<div class="log-xp" style="font-size:16px;">+' + entry.xpGained + ' XP</div>' +
      '</div>';
    list.appendChild(el);
  });

  var pagEl     = document.getElementById('log-pagination');
  var moreBtn   = document.getElementById('log-more-btn');
  var countEl   = document.getElementById('log-pagination-count');
  var colBtn    = document.getElementById('log-collapse-btn');
  var hasMore   = showing < total;

  pagEl.style.display = 'flex';
  countEl.textContent = showing + ' of ' + total + ' entries';
  moreBtn.disabled    = !hasMore;
  moreBtn.textContent = hasMore ? 'Show more ▾' : 'All shown';
  if (colBtn) colBtn.style.display = logVisibleCount > LOG_PAGE_SIZE ? 'block' : 'none';
}

// ─────────────────────────
//  DEV TOOLS (updated)
// ─────────────────────────
function devWipeLog() {
  state.party.forEach(function(c) { c.log = []; c.lastCheckIn = null; });
  save(); render();
  showToast('Check-ins wiped.');
}

function devWipeStreak() {
  state.party.forEach(function(c) { c.streak = 0; });
  save(); render();
  showToast('Streaks reset.');
}

function devWipeLevel() {
  state.xp = 0;
  save(); render();
  showToast('Level reset to 1.');
}

function devRestart() {
  // Wipe persisted state
  localStorage.removeItem(SAVE_KEY);

  // Reset JS state
  state.name = ''; state.avatar = ''; state.party = [];
  state.xp = 0; state.mapPosition = 0; state.ironVault = 0;
  state.badges = []; state.bestStreak = 0;
  state.seenStoryEncounters = []; state.seenArrivals = [];
  state.firstRun = false;

  // Reset all onboarding vars
  obCompanions = []; obCompanionIdx = 0; obPartySize = 3;
  obAvatar = '🧔';
  obCurrentHabit = ''; obCurrentClass = ''; obCurrentUseAlt = false;
  obCurrentCadence = 'daily'; obCurrentWeekTarget = 3;
  obSuggest = '';
  _currentSuggestionKey = '';

  // Clear all input fields
  var nameInp = document.getElementById('hero-name-input');
  if (nameInp) nameInp.value = '';
  var habitInp = document.getElementById('habit-input');
  if (habitInp) habitInp.value = '';

  // Reset avatar selection to default
  document.querySelectorAll('.avatar-opt').forEach(function(o) {
    o.classList.toggle('selected', o.dataset.avatar === '🧔');
  });

  // Reset party size selection to 3
  document.querySelectorAll('.party-size-opt').forEach(function(o) {
    o.classList.toggle('selected', parseInt(o.dataset.size) === 3);
  });

  // Reset name next button
  var nameBtn = document.getElementById('name-next-btn');
  if (nameBtn) nameBtn.disabled = true;

  // Reset habit cadence inline
  selectCadenceInline('daily');

  // Hide all overlays
  ['encounter-overlay','miss-overlay','road-event-overlay','checkin-celebration'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.classList.remove('show');
  });

  // Switch to onboarding
  document.getElementById('main').style.display = 'none';
  document.getElementById('onboarding').style.display = 'block';

  // All ob-steps hidden, step-0 active
  document.querySelectorAll('.ob-step').forEach(function(el) {
    el.style.display = '';
    el.classList.remove('active');
  });
  var s0 = document.getElementById('step-0');
  if (s0) { s0.style.display = ''; s0.classList.add('active'); }

  // Reset progress bar
  var fill = document.getElementById('ob-progress-fill');
  if (fill) fill.style.width = '5%';

  save();
}

function devSimMiss() {
  // Simulate a missed day on first character
  if (state.party && state.party.length > 0) {
    var char = state.party[0];
    char.lastCheckIn = null; // clear so miss applies
    applyMiss(char);
    save(); render();
    showToast('Miss simulated: ' + char.class + ' lost HP.');
  }
}

function devOrcPatrol() {
  var char = (state.party || [])[0];
  if (!char) { showToast('No party.'); return; }
  var orc = ORC_ENCOUNTERS.find(function(o) { return o.id === 'orc_patrol'; }) || ORC_ENCOUNTERS[0];
  queueOverlay(function() { showOrcEncounter(orc, char, 1); });
  showToast('Orc Patrol triggered.');
}

function devGrimjaw() {
  var char = (state.party || [])[0];
  if (!char) { showToast('No party.'); return; }
  var orc = ORC_ENCOUNTERS.find(function(o) { return o.id === 'orc_warchief'; }) || ORC_ENCOUNTERS[1];
  queueOverlay(function() { showOrcEncounter(orc, char, 3); });
  showToast('Grimjaw triggered.');
}

function devHostile() {
  var enc = HOSTILE_ENCOUNTERS[Math.floor(Math.random() * HOSTILE_ENCOUNTERS.length)];
  queueOverlay(function() { showEncounter(enc, true); });
  showToast('Hostile encounter: ' + enc.title);
}

// ─────────────────────────
//  ADD CHARACTER (party slot unlock)
// ─────────────────────────
// Max slots by level
function getMaxSlots() {
  var level = getLevelData(state.xp).level;
  if (level >= 10) return 5;
  if (level >= 7)  return 4;
  if (level >= 4)  return 3; // zone II completion also triggers but use level for now
  if (level >= 2)  return 2;
  return 1;
}

function showAddCharacter() {
  // For now: prompt via a simple two-step overlay
  // We'll reuse the onboarding fields in a modal - TODO: full modal
  showToast('Add character coming soon — unlock by leveling up!');
}

// ─────────────────────────
//  WEATHER SYSTEM
// ─────────────────────────
var WEATHER_STATES = {
  clear:   { icon: '☀️',  label: 'Clear Skies',        desc: 'Your whole party is moving. The road opens ahead.',                        cls: 'clear'   },
  partial: { icon: '⛅',  label: 'Partly Cloudy',       desc: 'Some of your champions are still waiting on you.',                         cls: 'partial' },
  stormy:  { icon: '🌩️', label: 'Gathering Storms',    desc: 'Most of your party hasn\'t moved. The road grows dark.',                   cls: 'stormy'  },
  fog:     { icon: '☁️', label: 'Fog of Doubt',        desc: 'No one has checked in. The path ahead is invisible.',                      cls: 'fog'     },
  dark:    { icon: '🌑', label: 'A Dark Night',         desc: 'The whole party faltered today. A bad day on the road. Tomorrow they walk again.', cls: 'fog' },
  dawn:    { icon: '🌄',  label: 'The Road Awaits',     desc: 'A new day. Check in to see what lies ahead.',                              cls: 'partial' }
};

function getWeatherState() {
  if (!state.party || !state.party.length) return WEATHER_STATES.dawn;
  var today = new Date().toDateString();
  var total = state.party.length;
  var checkedIn = state.party.filter(function(c) { return c.lastCheckIn === today; }).length;
  var missedToday = state.party.filter(function(c) { return c.missedToday === today; }).length;

  if (total === 0) return WEATHER_STATES.dawn;
  // All explicitly missed — dark night state
  if (missedToday === total && checkedIn === 0) return WEATHER_STATES.dark;
  if (checkedIn === 0) return WEATHER_STATES.fog;
  if (checkedIn === total) return WEATHER_STATES.clear;
  if (checkedIn >= total - 1) return WEATHER_STATES.partial;
  return WEATHER_STATES.stormy;
}

function renderWeather() {
  var card = document.getElementById('weather-card');
  if (!card) return;
  var w = getWeatherState();
  card.className = 'weather-card ' + w.cls;
  var iconEl  = document.getElementById('weather-icon');
  var labelEl = document.getElementById('weather-label');
  var descEl  = document.getElementById('weather-desc');
  if (iconEl)  iconEl.textContent  = w.icon;
  if (labelEl) labelEl.textContent = w.label;
  if (descEl)  descEl.textContent  = w.desc;
}

// ─────────────────────────
//  PARTY OVERVIEW
// ─────────────────────────
function renderPartyOverview() {
  var container = document.getElementById('party-overview-cards');
  if (!container) return;
  container.innerHTML = '';
  var today = new Date().toDateString();
  (state.party || []).forEach(function(char) {
    var def = getPersona(char);
    var checkedIn = char.lastCheckIn === today;
    var hp = char.hp || 0;
    var isWounded = hp <= 2 && hp > 0;
    var isCollapsed = hp <= 0;
    var hpPct = (hp / 5) * 100;
    var hpColor = hp >= 4 ? 'var(--green)' : hp >= 3 ? 'var(--teal)' : hp >= 2 ? 'var(--orange)' : 'var(--red)';

    var row = document.createElement('div');
    row.className = 'party-overview-row';

    var iconDiv = document.createElement('div');
    iconDiv.className = 'pov-icon' + (isWounded || isCollapsed ? ' wounded' : checkedIn ? ' done' : '');
    iconDiv.textContent = def.icon;

    var infoDiv = document.createElement('div');
    infoDiv.className = 'pov-info';
    infoDiv.innerHTML =
      '<div class="pov-name">' + def.name + '</div>' +
      '<div class="pov-habit">' + esc(char.habit || '') + '</div>';

    var hpBar = document.createElement('div');
    hpBar.className = 'pov-hp-bar-track';
    hpBar.innerHTML = '<div class="pov-hp-bar-fill" style="width:' + hpPct + '%;background:' + hpColor + ';"></div>';

    row.appendChild(iconDiv);
    row.appendChild(infoDiv);
    row.appendChild(hpBar);
    container.appendChild(row);
  });
}

// ─────────────────────────
//  RENDER (main render)
// ─────────────────────────
function render() {
  var ld = getLevelData(state.xp);

  var avatarRaceMap = {'🧔':'Human','🧝':'Elf','👺':'Orc','🧙':'Wizard'};
  document.getElementById('char-avatar').textContent = state.avatar || '🧔';
  document.getElementById('char-name').textContent   = state.name   || 'Traveler';

  var primaryChar = (state.party && state.party[0]) || null;
  var heroClass   = primaryChar ? primaryChar.class : 'Mage';
  var raceLabel = (avatarRaceMap[state.avatar] || 'Traveler') + ' · ' + getPlayerTitle(ld.level);
  document.getElementById('char-class').textContent  = raceLabel;
  document.getElementById('level-num').textContent   = ld.level;

  document.getElementById('xp-current').textContent  = state.xp;
  document.getElementById('xp-next-val').textContent = ld.xpAtEnd;
  document.getElementById('xp-fill').style.width     = ld.pct + '%';
  document.getElementById('xp-next-msg').textContent =
    ld.level < LEVEL_XP.length
      ? ld.toNext + ' XP to Level ' + (ld.level + 1)
      : 'Maximum rank achieved!';

  // Road Gold
  var vaultEl = document.getElementById('vault-amount');
  if (vaultEl) {
    var g = state.ironVault || 0;
    vaultEl.textContent = g + ' 💰';
  }
  var mapGold = document.getElementById('map-gold-display');
  if (mapGold) mapGold.textContent = (state.ironVault || 0) + ' 💰';

  // Streak (primary character)
  var streakCount = getGlobalStreak();
  var loggedToday = hasLoggedToday();
  var today = new Date().toDateString();

  var flameEl = document.getElementById('streak-banner-flame');
  var countEl = document.getElementById('streak-count');
  var rightEl = document.getElementById('streak-banner-right');

  if (flameEl) flameEl.style.filter = streakCount > 0 ? '' : 'grayscale(0.9)';
  if (countEl) {
    countEl.textContent = streakCount;
    countEl.style.color = streakCount > 0 ? 'var(--orange)' : 'var(--text-dark)';
  }
  if (rightEl) {
    if (loggedToday) {
      rightEl.textContent = 'Active';
      rightEl.style.color = 'var(--green)';
    } else if (streakCount >= 2) {
      rightEl.textContent = '⚠ At risk';
      rightEl.style.color = 'var(--orange)';
    } else {
      rightEl.textContent = streakCount === 1 ? 'Keep it going' : 'Start today';
      rightEl.style.color = streakCount === 1 ? 'var(--teal)' : '';
    }
  }

  // XP bonus msg (hidden element for compat)
  var bonusMsg = document.getElementById('xp-bonus-msg');
  if (bonusMsg) {
    var streakBonus = Math.min(30, streakCount * 5);
    bonusMsg.textContent = streakBonus > 0 && loggedToday
      ? '🔥 Streak bonus active'
      : 'Check in to earn XP';
  }

  renderWeather();
  renderPartyOverview();
  renderParty();
  renderLog();
  renderMap();
  checkZoneBadge();

  // Add character slot
  var addWrap = document.getElementById('add-char-wrap');
  if (addWrap) {
    var maxSlots = getMaxSlots();
    var hasSlot  = maxSlots > (state.party || []).length;
    addWrap.classList.toggle('hidden', !hasSlot || (state.party || []).length === 0);
  }

  // Badge slots
  ['zone1','zone2','zone3','zone4'].forEach(function(bid) {
    var el = document.getElementById('badge-' + bid);
    if (!el) return;
    var pip = el.querySelector('.badge-pip');
    if (pip) pip.className = (state.badges||[]).indexOf(bid) !== -1 ? 'badge-pip earned' : 'badge-pip locked';
  });

  // Road bonus pips
  var daysLogged = (state.weekLogDays || []).length;
  var bonuses    = Math.min(3, state.roadBonusesThisMonth || 0);
  for (var i = 1; i <= 3; i++) {
    var pip2 = document.getElementById('road-pip-' + i);
    if (pip2) pip2.className = 'road-pip' + (i <= bonuses ? ' earned' : '');
  }
  var rbLabel = document.getElementById('road-bonus-label');
  if (rbLabel) {
    var daysNeeded = Math.max(0, 5 - daysLogged);
    if (bonuses >= 3) {
      rbLabel.textContent = '✦ All Road Bonuses earned this month';
    } else if (daysNeeded === 0) {
      rbLabel.textContent = '✦ Road Bonus earned — advancing the map!';
    } else if (daysLogged === 0) {
      rbLabel.textContent = 'Road Bonus — check in 5 days this week to advance early';
    } else {
      rbLabel.textContent = daysNeeded + ' more day' + (daysNeeded===1?'':'s') + ' this week for a Road Bonus';
    }
  }

  checkArrival();
}


// ─────────────────────────
//  XP / LEVEL HELPERS
// ─────────────────────────
function getLevelData(xp) {
  var level = 1;
  for (var i = LEVEL_XP.length - 1; i >= 0; i--) {
    if (xp >= LEVEL_XP[i]) { level = i + 1; break; }
  }
  level = Math.min(level, LEVEL_XP.length);
  var xpAtStart = LEVEL_XP[level - 1] || 0;
  var xpAtEnd   = level < LEVEL_XP.length ? LEVEL_XP[level] : LEVEL_XP[LEVEL_XP.length - 1];
  var inLevel   = xp - xpAtStart;
  var needed    = xpAtEnd - xpAtStart;
  var pct       = needed > 0 ? Math.min(100, (inLevel / needed) * 100) : 100;
  var toNext    = Math.max(0, xpAtEnd - xp);
  return { level: level, xpAtEnd: xpAtEnd, pct: pct, toNext: toNext };
}

function getTitle(heroClass, level) {
  var titles = CLASS_TITLES[heroClass] || CLASS_TITLES['Mage'];
  var idx = Math.min(Math.floor((level - 1) / 2), titles.length - 1);
  return titles[idx];
}

// ─────────────────────────
//  MAP HELPERS
// ─────────────────────────
function getMapPosition() { return state.mapPosition || 0; }

function getCurrentWaypoint() {
  var pos = getMapPosition();
  for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
    if (MAP_WAYPOINTS[i].id === pos) return MAP_WAYPOINTS[i];
  }
  return MAP_WAYPOINTS[0];
}

function advanceMap() {
  var pos = getMapPosition();
  // numeric positions: 0-10
  var maxNumeric = 10;
  if (typeof pos === 'number' && pos < maxNumeric) {
    state.mapPosition = pos + 1;
    state.lastMapPosition = pos;
    save();
    return true;
  }
  return false;
}

// ─────────────────────────
//  WEEK ROAD BONUS
// ─────────────────────────
function checkMonthReset() {
  // Monthly reset: just track month, no budget reset needed
  // Map position and XP carry forward
  // Party check-in logs can optionally be trimmed
}

function getCurrentMonth() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
}

function getWeekStart() {
  var d = new Date();
  var day = d.getDay(); // 0=Sun
  d.setDate(d.getDate() - day);
  return d.toDateString();
}

function checkWeekRoadBonus() {
  var ws = getWeekStart();
  if (state.weekStart !== ws) {
    state.weekStart   = ws;
    state.weekLogDays = [];
  }
  var today = getToday();
  if (state.weekLogDays.indexOf(today) === -1) {
    state.weekLogDays.push(today);
  }
  // 5+ unique days this week → road bonus (up to 3 per month)
  if (state.weekLogDays.length >= 5 && (state.roadBonusesThisMonth || 0) < 3) {
    state.roadBonusesThisMonth = (state.roadBonusesThisMonth || 0) + 1;
    state.weekLogDays = []; // reset so they can earn next week
    showToast('🗺️ Road Bonus earned! Advancing the map...');
    setTimeout(function() {
      if (advanceMap()) {
        render();
        checkZoneBadge();
        setTimeout(function() { checkArrival(); }, 350);
      }
    }, 1200);
  }
}

// ─────────────────────────
//  ARRIVAL POPUPS
// ─────────────────────────

// ─────────────────────────
//  ARRIVAL GOLD GIFT
// ─────────────────────────
function arrivalGoldAmount(pos) {
  if (pos <= 2) return 12;
  if (pos <= 5) return 10;
  if (pos <= 8) return 8;
  return 6;
}

function giftArrivalGold(pos) {
  var amount = arrivalGoldAmount(pos);
  state.ironVault = (state.ironVault || 0) + amount;
  save();
  render();
  setTimeout(function() {
    fireGoldFloat('+' + amount + ' 💰');
    showToast('💰 +' + amount + ' gold — the road provides.');
  }, 300);
}
function checkArrival() {
  var pos = getMapPosition();
  if (pos === state.lastMapPosition) return;
  var wp = getCurrentWaypoint();
  if (!wp) return;
  if (!Array.isArray(state.seenArrivals)) state.seenArrivals = [];
  var aid = 'arr_' + wp.id;
  if (state.seenArrivals.indexOf(aid) !== -1) return;
  state.seenArrivals.push(aid);
  save();

  if (wp.zoneComplete) {
    // already handled by checkZoneBadge
    return;
  }
  if (wp.arrival) {
    var _pos = pos; // capture for closure
    queueOverlay(function() { showStoryEncounter(wp.icon || '📍', wp.name.replace('\n',' '), wp.arrival, 'story', _pos); });
  }
}

function showStoryEncounter(icon, title, desc, type, goldPos) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box story';
  document.getElementById('encounter-zone').textContent  = '✦ New Location Reached';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = title;
  document.getElementById('encounter-desc').textContent  = desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  // Show gold reward on the button so player knows it's coming
  var goldAmt = (goldPos !== undefined) ? arrivalGoldAmount(goldPos) : 0;
  btn.innerHTML = goldAmt > 0
    ? 'Onward ⚔ <span class="overlay-btn-cost">+' + goldAmt + ' 💰 road gold</span>'
    : 'Onward ⚔';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    if (goldPos !== undefined) giftArrivalGold(goldPos);
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}


// ─────────────────────────
//  BROKEN (0 HEARTS)
// ─────────────────────────
var REVIVE_COST = 30; // gold cost to revive with 3 hearts
var XP_PENALTY  = 50; // xp lost if reviving broke

function checkBroken() {
  if ((state.hearts || 0) <= 0) {
    queueOverlay(function() { showBroken(); });
  }
}

function showBroken() {
  var gold = state.ironVault || 0;
  document.getElementById('broken-gold-display').textContent = gold + ' 💰';

  var choices = document.getElementById('broken-choices');
  choices.innerHTML = '';

  if (gold >= REVIVE_COST) {
    var btnA = document.createElement('button');
    btnA.className = 'overlay-btn primary-choice';
    btnA.style.width = '100%'; btnA.style.textAlign = 'center';
    btnA.innerHTML = '🪙 Spend ' + REVIVE_COST + ' 💰 — rise and return<span class="overlay-btn-cost">Hearts restored to full — back on the road</span>';
    btnA.onclick = function() { resolveRevive('gold'); };
    choices.appendChild(btnA);
  }

  var btnB = document.createElement('button');
  btnB.className = 'overlay-btn';
  btnB.style.width = '100%'; btnB.style.textAlign = 'center';
  btnB.innerHTML = '🔥 Push on — recovery XP mode<span class="overlay-btn-cost">Lose ' + XP_PENALTY + ' XP — hearts restored, Road Gold untouched</span>';
  btnB.onclick = function() { resolveRevive('xp'); };
  choices.appendChild(btnB);

  document.getElementById('broken-overlay').classList.add('show');
}

function resolveRevive(method) {
  document.getElementById('broken-overlay').classList.remove('show');
  overlayDismissed();
  state.hearts = 3;
  if (method === 'gold') {
    state.ironVault = Math.max(0, (state.ironVault || 0) - REVIVE_COST);
    showToast('💰 ' + REVIVE_COST + ' gold spent — back on the road.');
    fireGoldFloat('-' + REVIVE_COST + ' 💰');
  } else {
    state.xp = Math.max(0, (state.xp || 0) - XP_PENALTY);
    showToast('🔥 Recovery mode — ' + XP_PENALTY + ' XP lost. Hearts restored. The road remembers you.');
  }
  save();
  render();
}

// ─────────────────────────
//  OVERLAY QUEUE
// ─────────────────────────
var _overlayQueue = [];
var _overlayActive = false;

function queueOverlay(fn) {
  _overlayQueue.push(fn);
  _drainQueue();
}

function _drainQueue() {
  if (_overlayActive || _overlayQueue.length === 0) return;
  _overlayActive = true;
  var next = _overlayQueue.shift();
  next();
}

// Call this at the END of every overlay dismiss handler
function overlayDismissed() {
  _overlayActive = false;
  // Small gap so the transition plays out before next one appears
  setTimeout(_drainQueue, 350);
}

// ─────────────────────────
//  RANDOM ENCOUNTERS
// ─────────────────────────
function checkEncounter(amount) { amount = amount || 0;
  // Cooldown: skip if last encounter was within the last 2 logs
  if (!state.encounterLogCount) state.encounterLogCount = 0;
  state.encounterLogCount++;
  var lastAt = state.lastEncounterAtLog || 0;
  if (state.encounterLogCount - lastAt < 1) {
    maybeShowRoadEvent();
    return;
  }

  // 45% chance per eligible log for a combat/friendly encounter
  if (Math.random() > 0.55) {
    maybeShowRoadEvent();
    return;
  }

  // Mark that an encounter fired at this log count
  state.lastEncounterAtLog = state.encounterLogCount;
  save();

  // Check for unseen story encounters first (priority)
  var pos = getMapPosition();
  var zone = pos <= 2 ? 'z1' : pos <= 5 ? 'z2' : pos <= 8 ? 'z3' : 'z4';
  var storyPool = STORY_ENCOUNTERS[zone] || [];
  var available = storyPool.filter(function(e) {
    return e.minPos <= pos && (state.seenStoryEncounters || []).indexOf(e.id) === -1;
  });

  if (available.length > 0 && Math.random() < 0.75) {
    var enc = available[Math.floor(Math.random() * available.length)];
    if (!state.seenStoryEncounters) state.seenStoryEncounters = [];
    state.seenStoryEncounters.push(enc.id);
    save();
    queueOverlay(function() { showStoryEncounterFull(enc); });
    return;
  }

  // Otherwise hostile (40%) or friendly (60%)
  if (Math.random() < 0.40) {
    var hostile = HOSTILE_ENCOUNTERS[Math.floor(Math.random() * HOSTILE_ENCOUNTERS.length)];
    queueOverlay(function() { showEncounter(hostile, true); });
  } else {
    var friendly = FRIENDLY_ENCOUNTERS[Math.floor(Math.random() * FRIENDLY_ENCOUNTERS.length)];
    queueOverlay(function() { showEncounter(friendly, false); });
  }
}

function showStoryEncounterFull(enc) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box story';
  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'Keep Moving ⚔';
  btn.onclick = function() { document.getElementById('encounter-overlay').classList.remove('show'); overlayDismissed(); };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

function showEncounter(enc, isHostile) {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box ' + (isHostile ? 'hostile' : 'friendly');

  document.getElementById('encounter-zone').textContent  = enc.zone;
  document.getElementById('encounter-icon').textContent  = enc.icon;
  document.getElementById('encounter-title').textContent = enc.title;
  document.getElementById('encounter-desc').textContent  = enc.desc;

  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';

  if (isHostile) {
    var today = new Date().toDateString();
    var allCheckedIn = state.party && state.party.length > 0 &&
      state.party.every(function(c) { return c.lastCheckIn === today; });

    var btnA = document.createElement('button');
    btnA.className = 'overlay-btn hostile-choice';

    if (allCheckedIn) {
      btnA.className = 'overlay-btn primary-choice';
      btnA.innerHTML = '🛡️ Your discipline holds<span class="overlay-btn-cost">All champions checked in — you pass through unscathed</span>';
      btnA.onclick = function() { resolveHostile('shield', enc); };
    } else {
      btnA.innerHTML = enc.choiceA.label + '<span class="overlay-btn-cost">' + enc.choiceA.sub + '</span>';
      btnA.onclick = function() { resolveHostile('heart', enc); };
    }

    var btnB = document.createElement('button');
    var goldCost = enc.goldCost || 0;
    var hasGold  = (state.ironVault || 0) >= goldCost;
    if (hasGold) {
      btnB.className = 'overlay-btn';
      btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">' + enc.choiceB.sub + ' (' + (state.ironVault || 0) + ' 💰 available)</span>';
      btnB.onclick = function() { resolveHostile('gold', enc); };
    } else {
      btnB.className = 'overlay-btn overlay-btn-disabled';
      btnB.innerHTML = enc.choiceB.label + '<span class="overlay-btn-cost">Need ' + goldCost + ' 🪙 Road Gold — you have ' + (state.ironVault || 0) + '</span>';
      btnB.disabled = true;
    }

    choices.appendChild(btnA);
    choices.appendChild(btnB);

    // choiceC — streak-based free escape
    if (enc.choiceC) {
      var btnC = document.createElement('button');
      var bestStreak = Math.max.apply(null, (state.party || []).map(function(c) { return c.streak || 0; }));
      var minStreak = enc.choiceC.minStreak || 0;
      var hasStreak = bestStreak >= minStreak;
      if (hasStreak) {
        btnC.className = 'overlay-btn primary-choice';
        btnC.innerHTML = enc.choiceC.label + '<span class="overlay-btn-cost">' + enc.choiceC.sub + ' (' + bestStreak + '-day streak)</span>';
        btnC.onclick = function() { resolveHostile('streak', enc); };
      } else {
        btnC.className = 'overlay-btn overlay-btn-disabled';
        btnC.innerHTML = enc.choiceC.label + '<span class="overlay-btn-cost">Needs ' + minStreak + '-day streak — you have ' + bestStreak + '</span>';
        btnC.disabled = true;
      }
      choices.appendChild(btnC);
    }
  } else {
    var btn = document.createElement('button');
    btn.className = 'overlay-btn friendly-choice';
    btn.innerHTML = 'Accept the reward<span class="overlay-btn-cost">' + enc.rewardDesc + '</span>';
    btn.onclick = function() { resolveFriendly(enc); };
    choices.appendChild(btn);
  }

  document.getElementById('encounter-overlay').classList.add('show');
}

function resolveHostile(choice, enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  overlayDismissed();
  if (choice === 'heart') {
    state.hearts = Math.max(0, (state.hearts || 3) - 1);
    showToast('❤️ Heart spent — the threat is driven back.');
  } else if (choice === 'shield') {
    showToast('🛡️ Discipline holds — you pass through unscathed.');
  } else if (choice === 'gold') {
    var cost = enc.goldCost || 0;
    state.ironVault = Math.max(0, (state.ironVault || 0) - cost);
    showToast('💰 ' + cost + ' gold spent — problem solved.');
    fireGoldFloat('-' + cost + ' 💰');
  } else if (choice === 'streak') {
    showToast('🔥 Your streak speaks for itself — they step aside.');
  }
  save();
  render();
  checkBroken();
}

function showWelcomeEncounter() {
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box friendly';
  document.getElementById('encounter-zone').textContent  = '✦ Day One';
  document.getElementById('encounter-icon').textContent  = '🏕️';
  document.getElementById('encounter-title').textContent = 'The Road Begins';
  document.getElementById('encounter-desc').textContent  =
    'A weathered traveler at the first milestone sees your party and nods. ' +
    '"First check-in," she says. "Most people don\'t make it past the intention." ' +
    'She presses a coin into your hand. "For the road. It gets harder. Keep showing up."';
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn friendly-choice';
  btn.innerHTML = 'Accept and march on <span class="overlay-btn-cost">+20 Road Gold — first day gift</span>';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    state.ironVault = (state.ironVault || 0) + 20;
    save(); render();
    setTimeout(function() {
      fireGoldFloat('+20 💰');
      showToast('💰 +20 Road Gold — welcome to the road.');
      askNotificationPermission();
    }, 300);
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

function resolveFriendly(enc) {
  document.getElementById('encounter-overlay').classList.remove('show');
  overlayDismissed();
  if (enc.reward.type === 'xp') {
    state.xp += enc.reward.amount;
    showToast('✨ +' + enc.reward.amount + ' bonus XP!');
  } else if (enc.reward.type === 'heart') {
    // Find the weakest champion who isn't at full HP
    var wounded = (state.party || []).filter(function(c) { return (c.hp || 0) < 5; });
    wounded.sort(function(a, b) { return (a.hp || 0) - (b.hp || 0); });
    if (wounded.length > 0) {
      wounded[0].hp = Math.min(5, (wounded[0].hp || 0) + 1);
      var def = CLASS_DEFS[wounded[0].class] || {};
      showToast('❤️ ' + (def.personaName || def.name || 'Your champion') + ' recovered 1 HP!');
    } else {
      // All champions at full HP — convert to Road Gold instead
      state.ironVault = (state.ironVault || 0) + 15;
      showToast('💰 All champions healthy! Shrine blessing converts to +15 Road Gold.');
      fireGoldFloat('+15 💰');
    }
  } else if (enc.reward.type === 'gold') {
    state.ironVault = (state.ironVault || 0) + enc.reward.amount;
    showToast('💰 +' + enc.reward.amount + ' Road Gold earned!');
    fireGoldFloat('+' + enc.reward.amount + ' 💰');
  }
  save();
  render();
}

function checkZoneBadge() {
  var pos = getMapPosition();
  var badges = state.badges || [];

  if (pos >= 3 && badges.indexOf('zone1') === -1) {
    badges.push('zone1'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🛡️', 'The First Steps', 'You clear the Hearthstone Road. First zone down. It feels smaller looking back.'); });
  }
  if (pos >= 6 && badges.indexOf('zone2') === -1) {
    badges.push('zone2'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🪙', 'Disciplined Traveler', "The Merchant's Pass is behind you. You navigated the markets and kept your budget intact."); });
  }
  if (pos >= 9 && badges.indexOf('zone3') === -1) {
    badges.push('zone3'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🌿', 'Thornwood Survivor', 'Thornwood cleared. Turns out it\'s just a forest if you keep logging. You come out the other side intact.'); });
  }
  if (pos >= 10 && badges.indexOf('zone4') === -1) {
    badges.push('zone4'); state.badges = badges; save();
    queueOverlay(function() { showZoneComplete('🔒', 'Keeper of the Road', 'The Iron Keep. You\'re here. The gates open before you ask — the record speaks first. The quartermaster marks your name without looking up. "Another one," he says. That\'s all. It\'s enough.'); });
  }
}

function showZoneComplete(icon, badgeName, narrative) {
  var ZONE_GOLD = 25;
  var box = document.getElementById('encounter-box');
  box.className = 'overlay-box zone-complete';
  document.getElementById('encounter-zone').textContent  = '✦ Zone Complete';
  document.getElementById('encounter-icon').textContent  = icon;
  document.getElementById('encounter-title').textContent = 'Badge Earned: ' + badgeName;
  document.getElementById('encounter-desc').textContent  = narrative;
  var choices = document.getElementById('encounter-choices');
  choices.innerHTML = '';
  var btn = document.createElement('button');
  btn.className = 'overlay-btn primary-choice';
  btn.style.textAlign = 'center';
  btn.innerHTML = 'March Forward ⚔ <span class="overlay-btn-cost">+' + ZONE_GOLD + ' 💰 zone bonus</span>';
  btn.onclick = function() {
    document.getElementById('encounter-overlay').classList.remove('show');
    overlayDismissed();
    state.ironVault = (state.ironVault || 0) + ZONE_GOLD;
    save(); render();
    setTimeout(function() {
      fireGoldFloat('+' + ZONE_GOLD + ' 💰');
      showToast('💰 +' + ZONE_GOLD + ' gold — zone cleared!');
    }, 300);
  };
  choices.appendChild(btn);
  document.getElementById('encounter-overlay').classList.add('show');
}

// ─────────────────────────
//  RENDER MAP
// ─────────────────────────
function renderMap() {
  var pos = getMapPosition();
  var wp  = getCurrentWaypoint();

  if (wp) {
    document.getElementById('map-location-name').textContent = wp.name.replace('\n',' ');
    document.getElementById('map-zone-tag').textContent = wp.zoneName || '';
  }

  // ── MAP DIMENSIONS — full height, no scroll ─────────────────────────
  var W_base = (document.getElementById('map-viewport') || {}).offsetWidth || 340;
  var W = W_base;
  var H = Math.round(W * 2.1); // tall portrait — like a real map
  H = Math.max(460, Math.min(H, 620));

  // Pure linear zig-zag — always forward, no badge spurs
  var NODE_LAYOUT = [
    { id:0,  pct:[50,  4] },   // Hearthstone Village — center top
    { id:1,  pct:[72, 13] },   // Harvest Crossing — right
    { id:2,  pct:[30, 22] },   // Stonepath Mill — left
    { id:3,  pct:[68, 33] },   // Merchant's Gate — right
    { id:4,  pct:[32, 43] },   // Copperbridge — left
    { id:5,  pct:[65, 53] },   // Trader's Camp — right
    { id:6,  pct:[35, 63] },   // Thornwood Edge — left
    { id:7,  pct:[68, 72] },   // Darkhollow Path — right
    { id:8,  pct:[38, 81] },   // Wayward Shrine — left
    { id:9,  pct:[62, 90] },   // Iron Keep Gates — right
    { id:10, pct:[50, 97] },   // The Iron Keep — center bottom
  ];

  // Single continuous road — always forward
  var CONNECTIONS = [
    [0,1],[1,2],[2,3],[3,4],[4,5],[5,6],[6,7],[7,8],[8,9],[9,10],
  ];

  var container  = document.getElementById('node-map');
  var viewport   = document.getElementById('map-viewport');
  var inner      = document.getElementById('node-map-inner');
  var svg        = document.getElementById('map-svg');
  var moreArrow  = document.getElementById('map-more-arrow');
  if (!container || !inner || !svg || !viewport) return;

  container.style.height = H + 'px';
  viewport.style.height  = H + 'px'; // full height — no clipping
  svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
  svg.style.height = H + 'px';
  svg.style.width  = '100%';

  var posMap = {};
  NODE_LAYOUT.forEach(function(n) {
    posMap[n.id] = {
      x: Math.round(W * n.pct[0] / 100),
      y: Math.round(H * n.pct[1] / 100)
    };
  });

  // No camera pan needed — full map visible
  container.style.transform = 'none';
  if (moreArrow) moreArrow.className = 'map-more-arrow hidden';

  function isReached(id) {
    if (typeof id === 'number') return id <= pos;
    var bm = {'z1':3,'z2':6,'z3':9,'z4':10};
    return pos >= (bm[id] || 999);
  }

  // ── SVG DEFS — parchment filter + terrain symbols ──────────────────
  svg.innerHTML = '';

  var defs = document.createElementNS('http://www.w3.org/2000/svg','defs');

  // Parchment noise filter
  defs.innerHTML = [
    '<filter id="road-blur"><feGaussianBlur stdDeviation="0.8"/></filter>',
    '<radialGradient id="vignette" cx="50%" cy="50%" r="60%">',
    '<stop offset="0%" stop-color="transparent"/>',
    '<stop offset="100%" stop-color="rgba(8,6,4,0.55)"/>',
    '</radialGradient>',
    '<radialGradient id="zone1-bg" cx="50%" cy="20%" r="55%">',
    '<stop offset="0%" stop-color="#2a1f0a" stop-opacity="0.9"/>',
    '<stop offset="100%" stop-color="#1a1208" stop-opacity="0.9"/>',
    '</radialGradient>',
    '<radialGradient id="zone2-bg" cx="50%" cy="50%" r="55%">',
    '<stop offset="0%" stop-color="#251608" stop-opacity="0.9"/>',
    '<stop offset="100%" stop-color="#1a1005" stop-opacity="0.9"/>',
    '</radialGradient>',
    '<radialGradient id="zone3-bg" cx="50%" cy="50%" r="55%">',
    '<stop offset="0%" stop-color="#0a1a0e" stop-opacity="0.92"/>',
    '<stop offset="100%" stop-color="#060d08" stop-opacity="0.92"/>',
    '</radialGradient>',
    '<radialGradient id="zone4-bg" cx="50%" cy="80%" r="55%">',
    '<stop offset="0%" stop-color="#140a22" stop-opacity="0.94"/>',
    '<stop offset="100%" stop-color="#0a0614" stop-opacity="0.94"/>',
    '</radialGradient>'
  ].join('');
  svg.appendChild(defs);

  // ── ZONE BACKGROUNDS ────────────────────────────────────────────────
  var zoneBands = [
    { y1: 0,  y2: 24, fill: 'url(#zone1-bg)' },
    { y1: 24, y2: 46, fill: 'url(#zone2-bg)' },
    { y1: 46, y2: 75, fill: 'url(#zone3-bg)' },
    { y1: 75, y2: 100, fill: 'url(#zone4-bg)' },
  ];
  zoneBands.forEach(function(zb) {
    var r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', '0');
    r.setAttribute('y', Math.round(H * zb.y1/100) + '');
    r.setAttribute('width', W + '');
    r.setAttribute('height', Math.round(H * (zb.y2-zb.y1)/100) + '');
    r.setAttribute('fill', zb.fill);
    svg.appendChild(r);
  });

  // ── SUBTLE TEXTURE OVERLAY — crosshatch pattern ──────────────────────
  // Use a tiny SVG pattern for aged-parchment feel (no filter = no pixelation)
  var patDef = document.createElementNS('http://www.w3.org/2000/svg','pattern');
  patDef.setAttribute('id','hatch'); patDef.setAttribute('width','6');
  patDef.setAttribute('height','6'); patDef.setAttribute('patternUnits','userSpaceOnUse');
  var pl = document.createElementNS('http://www.w3.org/2000/svg','path');
  pl.setAttribute('d','M0,6 L6,0 M-1,1 L1,-1 M5,7 L7,5');
  pl.setAttribute('stroke','rgba(180,140,60,0.04)'); pl.setAttribute('stroke-width','0.5');
  patDef.appendChild(pl);
  defs.appendChild(patDef);
  var texRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
  texRect.setAttribute('x','0'); texRect.setAttribute('y','0');
  texRect.setAttribute('width',W+''); texRect.setAttribute('height',H+'');
  texRect.setAttribute('fill','url(#hatch)');
  svg.appendChild(texRect);

  // ── ZONE SEPARATOR RULES ────────────────────────────────────────────
  var sepPcts = [24, 46, 75];
  sepPcts.forEach(function(pct) {
    var y = Math.round(H * pct/100);
    // Decorative rule — double line with gap
    [-1,1].forEach(function(offset) {
      var l = document.createElementNS('http://www.w3.org/2000/svg','line');
      l.setAttribute('x1','8'); l.setAttribute('y1', y+offset+'');
      l.setAttribute('x2', W-8+''); l.setAttribute('y2', y+offset+'');
      l.setAttribute('stroke','rgba(196,162,74,0.18)');
      l.setAttribute('stroke-width','0.5');
      svg.appendChild(l);
    });
    // Center ornament
    var diamond = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    var cx = Math.round(W/2), cy = y;
    diamond.setAttribute('points', cx+','+( cy-4)+' '+(cx+4)+','+cy+' '+cx+','+(cy+4)+' '+(cx-4)+','+cy);
    diamond.setAttribute('fill','rgba(196,162,74,0.35)');
    svg.appendChild(diamond);
  });

  // ── ZONE NAME LABELS ────────────────────────────────────────────────
  var zoneLabels = [
    { text:'Hearthstone Road', pct: 3,  anchor:'start', x: 10 },
    { text:"Merchant's Pass",  pct: 26, anchor:'start', x: 10 },
    { text:'The Thornwood',    pct: 48, anchor:'start', x: 10 },
    { text:'The Iron Keep',    pct: 77, anchor:'start', x: 10 },
  ];
  zoneLabels.forEach(function(zl) {
    var t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', zl.x+'');
    t.setAttribute('y', Math.round(H * zl.pct/100) + 14 + '');
    t.setAttribute('fill','rgba(196,162,74,0.85)');
    t.setAttribute('font-size','11');
    t.setAttribute('font-family',"'Cinzel', serif");
    t.setAttribute('font-weight','700');
    t.setAttribute('letter-spacing','2.5');
    t.setAttribute('text-anchor', zl.anchor);
    t.setAttribute('filter','drop-shadow(0 1px 3px rgba(0,0,0,0.9))');
    t.textContent = zl.text.toUpperCase();
    svg.appendChild(t);
  });

  // ── LotR-STYLE CARTOGRAPHIC ILLUSTRATIONS ──────────────────────────

  function svgEl(tag, attrs) {
    var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (var k in attrs) el.setAttribute(k, attrs[k]);
    svg.appendChild(el);
    return el;
  }

  function line(x1,y1,x2,y2,stroke,sw,opacity) {
    svgEl('line',{x1:x1,y1:y1,x2:x2,y2:y2,stroke:stroke,'stroke-width':sw||1,opacity:opacity||1,'stroke-linecap':'round'});
  }

  // LotR-style tree: trunk + radiating branch strokes (top-down cartographic symbol)
  function cartTree(cx, cy, sz, op) {
    var col = 'rgba(45,75,40,'+op+')';
    // trunk
    line(cx, cy+sz*0.3, cx, cy-sz*0.1, col, sz*0.18);
    // canopy circle
    svgEl('circle',{cx:cx,cy:cy-sz*0.15,r:sz*0.55,fill:'rgba(35,65,32,'+(op*0.7)+')',stroke:col,'stroke-width':sz*0.12});
    // radiating lines from canopy center
    for (var a=0; a<6; a++) {
      var ang = (a/6)*Math.PI*2;
      var r1=sz*0.1, r2=sz*0.52;
      line(cx+Math.cos(ang)*r1, cy-sz*0.15+Math.sin(ang)*r1,
           cx+Math.cos(ang)*r2, cy-sz*0.15+Math.sin(ang)*r2,
           'rgba(55,90,48,'+(op*0.6)+')', sz*0.08);
    }
  }

  function treeLine(x1,y1,x2,y2,count,sz,op) {
    for (var i=0; i<count; i++) {
      var t = i/(Math.max(count-1,1));
      cartTree(x1+(x2-x1)*t, y1+(y2-y1)*t, sz, op);
    }
  }

  // LotR hill: overlapping stippled mound with contour lines
  function hill(cx, cy, rx, ry, op) {
    var col = 'rgba(110,90,60,'+op+')';
    var col2 = 'rgba(80,65,42,'+(op*0.7)+')';
    // Base ellipse
    svgEl('ellipse',{cx:cx,cy:cy,rx:rx,ry:ry*0.6,fill:'rgba(90,72,48,'+(op*0.35)+')',stroke:col,'stroke-width':0.8});
    // Contour lines — 3 progressively smaller arcs drawn as paths
    for (var t=1; t<=3; t++) {
      var scale = 1 - t*0.22;
      var yo = -ry*0.12*t;
      var path = svgEl('path',{
        d:'M '+(cx-rx*scale)+','+(cy+yo)+' Q '+cx+','+(cy-ry*scale*0.9+yo)+' '+(cx+rx*scale)+','+(cy+yo),
        fill:'none', stroke:col2, 'stroke-width':0.7, opacity:op*0.8
      });
    }
    // Stipple dots on the mound
    for (var d=0; d<8; d++) {
      var ang = (d/8)*Math.PI;
      var dx = Math.cos(ang)*rx*0.55, dy = -Math.abs(Math.sin(ang))*ry*0.45;
      svgEl('circle',{cx:cx+dx,cy:cy+dy,r:0.8,fill:col,opacity:op*0.9});
      svgEl('circle',{cx:cx-dx*0.5,cy:cy+dy*0.7,r:0.6,fill:col,opacity:op*0.7});
    }
  }

  // Keep/fortress symbol: cross-shaped fortification
  function castle(cx, cy, sz, op) {
    var col = 'rgba(130,105,70,'+op+')';
    var col2 = 'rgba(90,70,45,'+(op*0.8)+')';
    // Main keep body
    svgEl('rect',{x:cx-sz*0.35,y:cy-sz*0.7,width:sz*0.7,height:sz*0.9,fill:'rgba(100,80,55,'+(op*0.5)+')',stroke:col,'stroke-width':0.8});
    // Tower left
    svgEl('rect',{x:cx-sz*0.6,y:cy-sz*0.5,width:sz*0.28,height:sz*0.7,fill:'rgba(110,88,58,'+(op*0.4)+')',stroke:col,'stroke-width':0.7});
    // Tower right
    svgEl('rect',{x:cx+sz*0.32,y:cy-sz*0.5,width:sz*0.28,height:sz*0.7,fill:'rgba(110,88,58,'+(op*0.4)+')',stroke:col,'stroke-width':0.7});
    // Battlement notches — main keep
    for (var b=0; b<4; b++) {
      var bx = cx - sz*0.28 + b*sz*0.18;
      svgEl('rect',{x:bx,y:cy-sz*0.82,width:sz*0.1,height:sz*0.15,fill:col});
    }
    // Battlement notches — left tower
    svgEl('rect',{x:cx-sz*0.57,y:cy-sz*0.62,width:sz*0.08,height:sz*0.13,fill:col});
    svgEl('rect',{x:cx-sz*0.42,y:cy-sz*0.62,width:sz*0.08,height:sz*0.13,fill:col});
    // Gate arch
    svgEl('path',{d:'M '+(cx-sz*0.12)+','+(cy+sz*0.2)+' Q '+cx+','+(cy-sz*0.05)+' '+(cx+sz*0.12)+','+(cy+sz*0.2),
      fill:'rgba(20,14,8,'+(op*1.5)+')',stroke:col2,'stroke-width':0.5});
    // Cross window
    line(cx, cy-sz*0.45, cx, cy-sz*0.15, col2, sz*0.07, op);
    line(cx-sz*0.12, cy-sz*0.32, cx+sz*0.12, cy-sz*0.32, col2, sz*0.07, op);
  }

  // Compass rose — bottom right corner
  function compass(cx, cy, sz) {
    var col = 'rgba(196,162,74,0.55)';
    var colFaint = 'rgba(196,162,74,0.25)';
    // Cardinal spokes
    var dirs = [[0,-1],[1,0],[0,1],[-1,0]];
    dirs.forEach(function(d) {
      line(cx+d[0]*sz*0.25, cy+d[1]*sz*0.25, cx+d[0]*sz, cy+d[1]*sz, col, 0.8);
    });
    // Intercardinal spokes (shorter)
    [[1,-1],[1,1],[-1,1],[-1,-1]].forEach(function(d) {
      var n = Math.sqrt(2);
      line(cx+d[0]/n*sz*0.2, cy+d[1]/n*sz*0.2, cx+d[0]/n*sz*0.7, cy+d[1]/n*sz*0.7, colFaint, 0.6);
    });
    // N arrow tip (diamond)
    svgEl('polygon',{
      points: cx+','+(cy-sz)+' '+(cx-sz*0.15)+','+(cy-sz*0.55)+' '+cx+','+(cy-sz*0.2)+' '+(cx+sz*0.15)+','+(cy-sz*0.55),
      fill:col
    });
    // Center dot
    svgEl('circle',{cx:cx,cy:cy,r:sz*0.12,fill:col});
    // N label
    var t = svgEl('text',{x:cx,y:cy-sz*1.15,'text-anchor':'middle',fill:col,'font-size':sz*0.55,'font-family':"'Cinzel',serif",'font-weight':'700'});
    t.textContent = 'N';
  }

  // ── PLACE ILLUSTRATIONS ──────────────────────────────────────────────

  // Zone 1 — Hearthstone Road: rolling hills flanking the path
  var z1y = Math.round(H * 0.10);
  hill(Math.round(W*0.12), z1y+5, 22, 14, 0.55);
  hill(Math.round(W*0.22), z1y+12, 18, 11, 0.4);
  hill(Math.round(W*0.85), z1y+5,  22, 14, 0.55);
  hill(Math.round(W*0.75), z1y+12, 18, 11, 0.4);
  // Smaller hills mid-zone
  hill(Math.round(W*0.10), Math.round(H*0.18), 14, 9, 0.35);
  hill(Math.round(W*0.88), Math.round(H*0.18), 14, 9, 0.35);

  // Zone 2 — Merchant's Pass: sparse trees, merchant camp suggestion
  treeLine(Math.round(W*0.08), Math.round(H*0.30), Math.round(W*0.08), Math.round(H*0.42), 4, 7, 0.45);
  treeLine(Math.round(W*0.92), Math.round(H*0.30), Math.round(W*0.92), Math.round(H*0.42), 4, 7, 0.45);

  // Zone 3 — Thornwood: dense forest both sides
  treeLine(Math.round(W*0.06), Math.round(H*0.50), Math.round(W*0.10), Math.round(H*0.72), 6, 8, 0.55);
  treeLine(Math.round(W*0.14), Math.round(H*0.52), Math.round(W*0.10), Math.round(H*0.70), 4, 6, 0.38);
  treeLine(Math.round(W*0.90), Math.round(H*0.50), Math.round(W*0.88), Math.round(H*0.72), 6, 8, 0.55);
  treeLine(Math.round(W*0.82), Math.round(H*0.52), Math.round(W*0.86), Math.round(H*0.70), 4, 6, 0.38);
  // Extra tree depth
  treeLine(Math.round(W*0.06), Math.round(H*0.60), Math.round(W*0.12), Math.round(H*0.65), 3, 5, 0.28);
  treeLine(Math.round(W*0.88), Math.round(H*0.60), Math.round(W*0.94), Math.round(H*0.65), 3, 5, 0.28);

  // Zone 4 — Iron Keep: castle illustration center-top of zone
  castle(Math.round(W*0.50), Math.round(H*0.83), 20, 0.65);
  // Flanking towers (smaller)
  castle(Math.round(W*0.15), Math.round(H*0.87), 12, 0.45);
  castle(Math.round(W*0.85), Math.round(H*0.87), 12, 0.45);

  // Compass rose — bottom-right
  compass(W - 28, H - 28, 16);

  // ── ROAD CONNECTIONS — curved bezier paths ──────────────────────────
  function makePath(a, b) {
    // Gentle S-curve between two points
    var dx = b.x - a.x, dy = b.y - a.y;
    var mx1 = a.x + dx*0.25 + dy*0.08;
    var my1 = a.y + dy*0.4  - dx*0.05;
    var mx2 = b.x - dx*0.25 + dy*0.08;
    var my2 = b.y - dy*0.4  - dx*0.05;
    return 'M '+a.x+' '+a.y+' C '+mx1+' '+my1+', '+mx2+' '+my2+', '+b.x+' '+b.y;
  }

  CONNECTIONS.forEach(function(conn) {
    var a = posMap[conn[0]], b = posMap[conn[1]];
    if (!a || !b) return;
    var traveled = isReached(conn[0]) && isReached(conn[1]);

    // Road shadow (depth)
    var shadow = document.createElementNS('http://www.w3.org/2000/svg','path');
    shadow.setAttribute('d', makePath(a,b));
    shadow.setAttribute('stroke','rgba(0,0,0,0.5)');
    shadow.setAttribute('stroke-width', traveled ? '5' : '3.5');
    shadow.setAttribute('fill','none');
    shadow.setAttribute('stroke-linecap','round');
    svg.appendChild(shadow);

    // Road body
    var path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', makePath(a,b));
    if (traveled) {
      path.setAttribute('stroke','rgba(196,162,74,0.7)');
      path.setAttribute('stroke-width','2.5');
    } else {
      path.setAttribute('stroke','rgba(90,75,50,0.3)');
      path.setAttribute('stroke-width','1.8');
      path.setAttribute('stroke-dasharray','5 7');
    }
    path.setAttribute('fill','none');
    path.setAttribute('stroke-linecap','round');
    svg.appendChild(path);
  });

  // Vignette overlay
  var vig = document.createElementNS('http://www.w3.org/2000/svg','rect');
  vig.setAttribute('x','0'); vig.setAttribute('y','0');
  vig.setAttribute('width',W+''); vig.setAttribute('height',H+'');
  vig.setAttribute('fill','url(#vignette)');
  vig.setAttribute('pointer-events','none');
  svg.appendChild(vig);

  // ── NODE DOM ELEMENTS ───────────────────────────────────────────────
  inner.innerHTML = '';
  inner.style.height = H + 'px';

  NODE_LAYOUT.forEach(function(layout) {
    var wpData = null;
    for (var i = 0; i < MAP_WAYPOINTS.length; i++) {
      if (MAP_WAYPOINTS[i].id === layout.id) { wpData = MAP_WAYPOINTS[i]; break; }
    }
    if (!wpData) return;

    // Skip badge nodes — they're celebrated via overlay, not shown on map
    if (typeof layout.id === 'string') return;

    var isDone    = layout.id < pos;
    var isCurrent = layout.id === pos;

    var px = posMap[layout.id];

    var wrap = document.createElement('div');
    wrap.className = 'map-node-wrap' + (isCurrent ? ' current' : '');
    wrap.style.left = px.x + 'px';
    wrap.style.top  = px.y + 'px';

    var circle = document.createElement('div');
    var zoneClass = typeof wpData.zone === 'number' ? ' zone' + wpData.zone : '';
    var cc = 'map-node-circle' + zoneClass;
    cc += isDone ? ' done' : isCurrent ? ' current' : ' ahead';
    circle.className = cc;
    circle.textContent = wpData.icon;

    var label = document.createElement('div');
    label.className = 'map-node-label';
    label.textContent = wpData.name.replace('\n',' ');

    wrap.appendChild(circle);

    if (isCurrent) {
      var marker = document.createElement('div');
      marker.className = 'map-player-marker';
      marker.textContent = state.avatar || '🧔';
      wrap.appendChild(marker);
    }

    wrap.appendChild(label);

    // ── COHORT TRAVELER MARKERS ──────────────────────────────────────
    // Show other travelers at this node position
    var travelersHere = cohortTravelers.filter(function(t) {
      return Number(t.map_position || 0) === layout.id;
    });
    if (travelersHere.length > 0) {
      var travelerRow = document.createElement('div');
      travelerRow.className = 'map-traveler-row';
      travelersHere.forEach(function(t) {
        var entry = document.createElement('div');
        entry.className = 'map-traveler-entry';
        var avatarEl = document.createElement('div');
        avatarEl.className = 'map-traveler-avatar';
        avatarEl.textContent = t.traveler_avatar || '🧔';
        var nameEl = document.createElement('div');
        nameEl.className = 'map-traveler-name';
        nameEl.textContent = (t.traveler_name || 'Traveler').split(' ')[0];
        entry.appendChild(avatarEl);
        entry.appendChild(nameEl);
        travelerRow.appendChild(entry);
      });
      wrap.appendChild(travelerRow);
    }

    inner.appendChild(wrap);
  });

  // Road bonus pips
  var bonuses = Math.min(3, state.roadBonusesThisMonth || 0);
  for (var i = 1; i <= 3; i++) {
    var pip = document.getElementById('road-pip-' + i);
    if (pip) pip.className = 'road-pip' + (i <= bonuses ? ' earned' : '');
  }
  // Road bonus countdown label
  var rbLabel = document.getElementById('road-bonus-label');
  if (rbLabel) {
    var daysLogged = (state.weekLogDays || []).length;
    var daysNeeded = Math.max(0, 5 - daysLogged);
    if (bonuses >= 3) {
      rbLabel.textContent = '✦ All Road Bonuses earned this month';
    } else if (daysNeeded === 0) {
      rbLabel.textContent = '✦ Road Bonus earned — advancing the map!';
    } else if (daysLogged === 0) {
      rbLabel.textContent = 'Road Bonus — log 5 days this week to advance early';
    } else {
      rbLabel.textContent = daysNeeded + ' more day' + (daysNeeded === 1 ? '' : 's') + ' this week for a Road Bonus';
    }
  }

  // Road Gold in map header
  var mapGoldEl = document.getElementById('map-gold-display');
  if (mapGoldEl) mapGoldEl.textContent = (state.ironVault || 0) + ' 💰';

  // Badge slots
  ['zone1','zone2','zone3','zone4'].forEach(function(bid) {
    var el = document.getElementById('badge-' + bid);
    if (!el) return;
    var pip = el.querySelector('.badge-pip');
    if (pip) pip.className = (state.badges||[]).indexOf(bid) !== -1 ? 'badge-pip earned' : 'badge-pip locked';
  });
}

// ─────────────────────────
//  RENDER
// ─────────────────────────
function getCurrentMonth() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
}









function formatDate(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─────────────────────────
//  ONBOARDING
// ─────────────────────────
var currentStep = 0;






// ─────────────────────────
//  LOG EXPENSE
// ─────────────────────────

function fireGoldFloat(text) {
  var floatEl = document.getElementById('gold-float');
  if (!floatEl) return;
  var track = document.getElementById('vault-amount');
  if (!track) return;
  var rect = track.getBoundingClientRect();
  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top + window.scrollY) + 'px';
  floatEl.textContent = text;
  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

function fireXpFloat(text) {
  var floatEl = document.getElementById('xp-float');
  var track   = document.getElementById('xp-fill');
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

function fireCoinFloat(text) {
  var floatEl = document.getElementById('coin-float');
  var track   = document.getElementById('coin-fill');
  if (!track) return;
  var rect    = track.getBoundingClientRect();

  floatEl.style.left = Math.round(rect.left + rect.width / 2) + 'px';
  floatEl.style.top  = Math.round(rect.top  + window.scrollY + rect.height) + 'px';
  floatEl.textContent = text;

  floatEl.classList.remove('pop');
  void floatEl.offsetWidth;
  floatEl.classList.add('pop');
}

// ─────────────────────────
//  LEVEL UP
// ─────────────────────────
// ─────────────────────────
//  ROAD EVENTS (post check-in story beats)
// ─────────────────────────
var ROAD_EVENTS = [
  // Mood / atmosphere
  { zone: '✦ The Road', icon: '🌅', title: 'Morning Light',
    desc: 'The road is quiet this early. Just you and the habit. You check in, and the day opens up a little.' },
  { zone: '✦ The Road', icon: '🌙', title: 'End of the Day',
    desc: 'You checked in. The day closes with that small act in it. It always matters more than it feels like it does.' },
  { zone: '✦ The Road', icon: '🌦️', title: 'Rain on the Road',
    desc: 'Cold, wet, the kind of day that hands you a reason not to bother. You bothered anyway. That\'s actually the whole skill.' },
  { zone: '✦ The Road', icon: '❄️', title: 'First Cold',
    desc: 'The road is harder in this weather. Everything is. You went anyway. The party doesn\'t get that credit often enough.' },
  { zone: '✦ Thornwood Edge', icon: '🌲', title: 'Into the Dark',
    desc: 'The trees close in a little here. But you know the way. You\'ve been walking it long enough.' },
  { zone: '✦ The Road', icon: '🌫️', title: 'Low Visibility',
    desc: 'You can\'t see far ahead today. That\'s fine. You don\'t need to see the whole road — just the next step. You took it.' },

  // World / other travelers
  { zone: '✦ Fellow Travelers', icon: '🧭', title: 'Passing Company',
    desc: 'A traveler nods at you from across the road. They don\'t stop. Neither do you. There\'s a kind of solidarity in that.' },
  { zone: '✦ Roadside Inn', icon: '🏠', title: 'Word of You',
    desc: 'An innkeeper mentions she\'s heard a traveler has been consistent on this stretch of road. You realize she means you.' },
  { zone: '✦ The Road', icon: '👥', title: 'The Ones Who Stopped',
    desc: 'Two travelers are camped at a milestone, debating whether to go on. You pass them without slowing. You made that decision weeks ago.' },
  { zone: '✦ Crossroads', icon: '🗺️', title: 'The Other Road',
    desc: 'There\'s a faster-looking path heading south. Half the markers on it are rotted out. You stay on yours. Shortcuts announce themselves too confidently.' },
  { zone: '✦ Fellow Travelers', icon: '🧙', title: 'The Old Walker',
    desc: 'An old woman resting her feet watches you pass. "Same time yesterday," she says. "Same time the day before." You nod. She seems satisfied.' },
  { zone: '✦ The Road', icon: '🏕️', title: 'Last Night\'s Camp',
    desc: 'Someone camped here recently — fire cold, ground worn. They\'ve been on this road a long time. So have you. Different parties, same discipline.' },

  // Edge / tension / honesty
  { zone: '✦ Crossroads', icon: '↩️', title: 'You Could Turn Back',
    desc: 'Every day there\'s a version of you that doesn\'t check in. Today you weren\'t that version.' },
  { zone: '✦ The Road', icon: '⚡', title: 'A Hard Day',
    desc: 'You checked in on a day when it cost you something. Those are the ones that count double. The streak doesn\'t know that — but you do.' },
  { zone: '✦ The Road', icon: '😤', title: 'Didn\'t Feel Like It',
    desc: 'The honest version: you did not want to do this today. You did it anyway. That\'s not a small thing. That\'s actually the whole thing.' },
  { zone: '✦ Rest Stop', icon: '🪨', title: 'The Weight of It',
    desc: 'Some days the habit feels effortless. Today wasn\'t that. Today it felt like exactly what it is — something you chose over something easier. Good.' },

  // Compounding / momentum
  { zone: '✦ The Road', icon: '🌿', title: 'The Habit Holds',
    desc: 'Day after day, the same motion. It starts to feel different from the inside — less like effort, more like nature.' },
  { zone: '✦ The Road', icon: '🔥', title: 'Momentum',
    desc: 'You barely notice it building. Then one day you realize you\'d be surprised if you stopped. That day is closer than it was.' },
  { zone: '✦ Rest Stop', icon: '📍', title: 'A Marker on the Road',
    desc: 'You pause at a milestone. Behind you: a chain of days you actually kept. Not perfect — kept. That\'s the record that matters.' },
  { zone: '✦ The Road', icon: '🔗', title: 'The Chain',
    desc: 'One more link. That\'s all today is. You add it. The chain gets heavier. Harder to break. That\'s the point.' },

  // Wry / world-building
  { zone: '✦ The Road', icon: '📜', title: 'A Posted Notice',
    desc: 'Someone has nailed a notice to a milestone: "HABITS FOR SALE — slightly used, gave up after 11 days." You keep walking. You\'re at a different point in the story.' },
  { zone: '✦ Roadside Inn', icon: '🍺', title: 'Overheard',
    desc: 'Two travelers at the bar debating whether consistency or intensity matters more. The one who\'s been on the road longer drinks quietly and says nothing. That tracks.' },
  { zone: '✦ Fellow Travelers', icon: '🎒', title: 'The Overpacked Traveler',
    desc: 'A traveler with an enormous pack staggers past you. "All the gear," they pant. "Haven\'t actually started yet." You have been started for a while now.' },
];

var _lastRoadEventIdx = -1;

function getNextRoadEvent() {
  var idx;
  var maxTries = 5;
  do {
    idx = Math.floor(Math.random() * ROAD_EVENTS.length);
    maxTries--;
  } while (idx === _lastRoadEventIdx && maxTries > 0);
  _lastRoadEventIdx = idx;
  return ROAD_EVENTS[idx];
}

function showRoadEvent(evt) {
  var overlay = document.getElementById('road-event-overlay');
  if (!overlay) return;
  document.getElementById('re-zone').textContent  = evt.zone;
  document.getElementById('re-icon').textContent  = evt.icon;
  document.getElementById('re-title').textContent = evt.title;
  document.getElementById('re-desc').textContent  = evt.desc;
  overlay.classList.add('show');
}

function closeRoadEvent() {
  var overlay = document.getElementById('road-event-overlay');
  if (overlay) overlay.classList.remove('show');
  overlayDismissed();
}

function maybeShowRoadEvent() {
  // 60% chance to show a road event after check-in (if no encounter is queued)
  if (Math.random() < 0.60) {
    var evt = getNextRoadEvent();
    queueOverlay(function() { showRoadEvent(evt); });
  }
}

function showLevelUp(level) {
  save();
  // Mark as active in queue so nothing else interrupts
  _overlayActive = true;
  var heroClass = (state.party && state.party[0]) ? state.party[0].class : 'Mage';
  document.getElementById('lu-level').textContent = level;
  document.getElementById('lu-rank').textContent  = getPlayerTitle(level);
  document.getElementById('lu-msg').textContent   = LEVEL_MSGS[Math.min(level - 2, LEVEL_MSGS.length - 1)];
  document.getElementById('levelup-overlay').classList.add('show');
}

function closeLevelUp() {
  document.getElementById('levelup-overlay').classList.remove('show');
  // Level-up advances the map
  advanceMap();
  render();
  overlayDismissed(); // releases queue
  // Zone badge and arrival are queued separately with a small gap
  setTimeout(function() {
    checkZoneBadge();
    setTimeout(function() { checkArrival(); }, 300);
  }, 350);
}

// ─────────────────────────
//  TOAST
// ─────────────────────────
var toastTimer;
function showToast(msg, duration) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, duration || 3600);
}

// ─────────────────────────
//  KEYBOARD
// ─────────────────────────
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Enter') return;
  var a = document.activeElement;
  if (a && a.id === 'hero-name-input') {
    var btn = document.getElementById('name-next-btn');
    if (btn && !btn.disabled) goStep('2');
  } else if (a && a.id === 'habit-input') {
    var btn2 = document.getElementById('habit-next-btn');
    if (btn2 && !btn2.disabled) goToClassStep();
  }
});

// ─────────────────────────
//  CHECK-IN PARTICLE BURST
// ─────────────────────────
function fireParticleBurst(charClass) {
  var particles = { Warrior: ['⚔️','🔥','💥'], Cleric: ['💚','✨','🌿'], Mage: ['✨','🔮','💫'], Rogue: ['🗡️','💰','⚡'], Scribe: ['✍️','📜','✨'], Ranger: ['🏹','🌲','🦅'], Monk: ['🧘','☁️','🌸'], Alchemist: ['🧪','✨','💎'] };
  var emojis = particles[charClass] || ['✨','⭐','💫'];
  var container = document.getElementById('party-cards');
  if (!container) return;
  var rect = container.getBoundingClientRect();
  var cx = rect.left + rect.width / 2;
  var cy = rect.top + 80;
  for (var i = 0; i < 8; i++) {
    var el = document.createElement('div');
    el.className = 'checkin-particle';
    var angle = (i / 8) * Math.PI * 2;
    var dist = 40 + Math.random() * 30;
    var px = Math.cos(angle) * dist;
    var py = Math.sin(angle) * dist;
    el.style.cssText = 'left:' + (cx + px * 0.3) + 'px;top:' + (cy + py * 0.3) + 'px;' +
      '--px:' + px + 'px;--py:' + py + 'px;';
    el.textContent = emojis[i % emojis.length];
    document.body.appendChild(el);
    setTimeout(function(e) { return function() { e.remove(); }; }(el), 750);
  }
}

function toggleLore(charId) {
  var panel = document.getElementById('lore-' + charId);
  if (!panel) return;
  panel.classList.toggle('open');
}

// ─────────────────────────
//  CHECK-IN CARD FLASH
// ─────────────────────────
function flashCheckinCard() {
  var container = document.getElementById('party-cards');
  if (!container) return;
  setTimeout(function() {
    var cards = container.querySelectorAll('.char-card.checked-in');
    if (cards.length) {
      var target = cards[cards.length - 1];
      target.classList.add('checkin-flash');
      setTimeout(function() { target.classList.remove('checkin-flash'); }, 600);
    }
  }, 50);
}

// ─────────────────────────
//  BROWSER NOTIFICATIONS
// ─────────────────────────
function askNotificationPermission() {
  if (!('Notification' in window) || Notification.permission !== 'default') return;
  // Delay slightly so welcome toast clears first
  setTimeout(function() {
    var box = document.getElementById('encounter-box');
    box.className = 'overlay-box friendly';
    document.getElementById('encounter-zone').textContent  = '🔔 Stay on the Road';
    document.getElementById('encounter-icon').textContent  = '📯';
    document.getElementById('encounter-title').textContent = 'Daily Reminder';
    document.getElementById('encounter-desc').textContent  =
      'The road is easier when you don\'t forget it\'s there. ' +
      'Allow a daily nudge and your party will never be left waiting.';
    var choices = document.getElementById('encounter-choices');
    choices.innerHTML = '';
    var btnYes = document.createElement('button');
    btnYes.className = 'overlay-btn primary-choice';
    btnYes.innerHTML = '📯 Allow daily reminders <span class="overlay-btn-cost">One notification per day, 8am</span>';
    btnYes.onclick = function() {
      document.getElementById('encounter-overlay').classList.remove('show');
      overlayDismissed();
      Notification.requestPermission().then(function(perm) {
        if (perm === 'granted') {
          showToast('📯 Reminder set. The road calls at 8am.');
          scheduleNotification();
        }
      });
    };
    var btnNo = document.createElement('button');
    btnNo.className = 'overlay-btn';
    btnNo.innerHTML = 'Not now <span class="overlay-btn-cost">You can enable this later</span>';
    btnNo.onclick = function() {
      document.getElementById('encounter-overlay').classList.remove('show');
      overlayDismissed();
    };
    choices.appendChild(btnYes);
    choices.appendChild(btnNo);
    document.getElementById('encounter-overlay').classList.add('show');
  }, 2200);
}

function scheduleNotification() {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  var now = new Date();
  var next = new Date(now);
  next.setHours(8, 0, 0, 0);
  if (next <= now) next.setDate(next.getDate() + 1);
  var delay = next - now;
  setTimeout(function() {
    new Notification('HabitForge — Your party awaits', {
      body: 'The road is moving. Check in today — the Iron Keep doesn\'t get closer on its own.',
      icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚔️</text></svg>'
    });
    // Reschedule for tomorrow
    setTimeout(scheduleNotification, 1000);
  }, delay);
}

// ─────────────────────────
//  DEV TOOLS
// ─────────────────────────

// (old dev tools body removed)
</script>

</body>
</html>
